<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="J_STOCKS_VERIFY">

	<typeAlias alias="jStocksVerify" type="com.ebiz.mmt.domain.JStocksVerify" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertJStocksVerify" />
		<flushOnExecute statement="updateJStocksVerify" />
		<flushOnExecute statement="deleteJStocksVerify" />
	</cacheModel>

	<resultMap id="jStocksVerifyResultForList" class="jStocksVerify">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="BILL_SN" property="bill_sn" jdbcType="VARCHAR" />
		<result column="TRADE_TYPE" property="trade_type" jdbcType="DECIMAL" />
		<result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
		<result column="GOODS_ID" property="goods_id" jdbcType="DECIMAL" />
		<result column="STOCKS" property="stocks" jdbcType="DECIMAL" />
		<result column="VER_STOCKS" property="ver_stocks" jdbcType="DECIMAL" />
		<result column="MEMO" property="memo" jdbcType="VARCHAR" />
		<result column="OPR_DATE" property="opr_date" jdbcType="DATE" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATETIME" />
		<result column="C_ID" property="c_id" jdbcType="DECIMAL" />
		<result column="TYPE" property="type" jdbcType="DECIMAL" />
		<result column="MONEY" property="money" jdbcType="DECIMAL" />
		<result column="VER_MONEY" property="ver_money" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="jStocksVerifyResult" class="jStocksVerify" extends="jStocksVerifyResultForList">
	</resultMap>
	
	<resultMap id="jStocksVerifyResultForInventory" class="jStocksVerify" extends="jStocksVerifyResultForList">
		<result column="STORE_NAME" property="map.store_name" jdbcType="VARCHAR" />
		<result column="GOODS_NAME" property="map.goods_name" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="jStocksVerifyResultForInventoryForm" class="jStocksVerify">
		<result column="STORE_NAME" property="map.store_name" jdbcType="VARCHAR" />
		<result column="STORE_ID" property="map.store_id" jdbcType="DECIMAL" />
		<result column="GOODS_NAME" property="map.goods_name" jdbcType="VARCHAR" />
		<result column="GOODS_ID" property="map.goods_id" jdbcType="DECIMAL" />
		<result column="OPR_DATE" property="map.opr_date" jdbcType="DATE" />
		<result column="STOCKS" property="map.stocks" jdbcType="DECIMAL" />
		<result column="MONEY" property="map.money" jdbcType="DECIMAL" />
	</resultMap>

	<sql id="sf-jStocksVerify">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_sn">a.BILL_SN = #bill_sn:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trade_type">a.TRADE_TYPE = #trade_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">a.STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="goods_id">a.GOODS_ID = #goods_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="stocks">a.STOCKS = #stocks:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ver_stocks">a.VER_STOCKS = #ver_stocks:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="memo">a.MEMO = #memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="opr_date">a.OPR_DATE = #opr_date:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">a.ADD_DATE = #add_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="c_id">a.C_ID = #c_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type">a.TYPE = #type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="money">a.MONEY = #money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ver_money">a.VER_MONEY = #ver_money:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.bill_sn_like">a.BILL_SN like '%' || #map.bill_sn_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.start_date"><![CDATA[a.OPR_DATE >= to_date(#map.start_date#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_date"><![CDATA[a.OPR_DATE <= to_date(#map.end_date#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.max_date_id">a.opr_date in (select max(opr_date) from J_STOCKS_VERIFY where goods_id = #map.goods_id_value# and store_id = #map.store_id_value#)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.compare_date"><![CDATA[to_date(substr(cast(a.OPR_DATE as varchar(20)),1,10),'yyyy-MM-dd') = to_date(substr(cast(#map.compare_date# as varchar(20)),1,10),'yyyy-MM-dd')]]></isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.qdate">to_char(a.OPR_DATE,'yyyy-MM') = #map.qdate:VARCHAR#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.date_begin"><![CDATA[ a.opr_date >= to_date(#map.date_begin:VARCHAR#,'yyyy-MM-dd')]]></isNotEmpty>
        <isNotEmpty prepend=" and " property="map.date_end"><![CDATA[ a.opr_date <= to_date(#map.date_end:VARCHAR#,'yyyy-MM-dd')]]></isNotEmpty>
        <isNotEmpty prepend=" and  " property="map.hander_type_1">
            a.type in (0,2,3,4)
        </isNotEmpty>
        <isNotEmpty prepend=" and  " property="map.hander_type_0">
            a.type =1
        </isNotEmpty>
    </sql>



	<select id="selectJStocksVerify" resultMap="jStocksVerifyResult" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		select a.* from J_STOCKS_VERIFY a where 1 = 1 <![CDATA[ and rownum < 2  ]]>
		<include refid="sf-jStocksVerify" />
	</select>

	<select id="selectJStocksVerifyList" resultMap="jStocksVerifyResultForList" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select a.* from J_STOCKS_VERIFY a where 1 = 1  
		<include refid="sf-jStocksVerify" />
		<!-- order by ID asc -->
		<isNotEmpty prepend="  " property="map.order_by_opr_date_desc">order by opr_date desc</isNotEmpty>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectJStocksVerifyCount" resultClass="long" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		select count(*) from J_STOCKS_VERIFY a where 1 = 1
		<include refid="sf-jStocksVerify" />
	</select>

	<select id="selectJStocksVerifyPaginatedList" resultMap="jStocksVerifyResult" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.* from J_STOCKS_VERIFY a where 1 = 1
		<include refid="sf-jStocksVerify" />
		<!-- order by ID asc -->
		order by add_date desc, id asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<select id="selectJStocksVerifyWithStoreAndGoodsNamePaginatedList" resultMap="jStocksVerifyResultForInventory" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,jbg.GOODS_NAME,
               jbs.STORE_NAME
          FROM J_STOCKS_VERIFY a 
          left join J_BASE_GOODS jbg on jbg.GOODS_ID = a.GOODS_ID
          left join J_BASE_STORE jbs on jbs.STORE_ID = a.STORE_ID 
          where 1 = 1
		<include refid="sf-jStocksVerify" />
		<!-- order by ID asc -->
		order by add_date desc, id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 取仓库商品中最后盘点日期的记录，Renzhong，2013-06-15 -->
	<select id="selectJStocksVerifyForLastedVerify" resultMap="jStocksVerifyResult" parameterClass="jStocksVerify" cacheModel="oneDayCache">
	<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select *
		  from j_stocks_verify a
		 where opr_date in (select max(opr_date)
		                        from j_stocks_verify a
		                       where 1 = 1
		                       <include refid="sf-jStocksVerify" />)
		 <include refid="sf-jStocksVerify" />
		 <isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>		                       
	</select>
	
	<!-- 为全部盘点和结转操作的取最新的商品列表 2014-11-28 -->
	<select id="selectJStocksVerifyForInventoryCount" resultClass="long" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		SELECT count(*)
  		FROM (SELECT rank ()
               OVER (PARTITION BY a.STORE_ID, a.GOODS_ID ORDER BY a.ID DESC)
                  rn,
               a.*,
               jbg.GOODS_NAME,
               jbs.STORE_NAME
          FROM J_STOCKS_VERIFY a 
          left join J_BASE_GOODS jbg on jbg.GOODS_ID = a.GOODS_ID
          left join J_BASE_STORE jbs on jbs.STORE_ID = a.STORE_ID
         WHERE jbg.GOODS_STUTES=0
               and jbs.IS_DEL = 0
		<include refid="sf-jStocksVerify" />
               ) tt where
         tt.rn = 1 
	</select>

	<!-- 为全部盘点和结转操作的取最新的商品列表 2014-11-28 -->
	<select id="selectJStocksVerifyForInventoryList" resultMap="jStocksVerifyResultForInventory" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		SELECT tt.*
  		FROM (SELECT rank ()
               OVER (PARTITION BY a.STORE_ID, a.GOODS_ID ORDER BY a.ID DESC)
                  rn,
               a.*,
               jbg.GOODS_NAME,
               jbs.STORE_NAME
          FROM J_STOCKS_VERIFY a 
          left join J_BASE_GOODS jbg on jbg.GOODS_ID = a.GOODS_ID
          left join J_BASE_STORE jbs on jbs.STORE_ID = a.STORE_ID
         WHERE jbg.GOODS_STUTES=0
               and jbs.IS_DEL = 0
		<include refid="sf-jStocksVerify" />
		) tt where
         tt.rn = 1 
         order by tt.STORE_ID asc,tt.GOODS_NAME asc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<!-- 为全部盘点和结转操作的取最新的商品列表 2014-11-28 -->
	<select id="selectJStocksVerifyForInventoryPaginatedList" resultMap="jStocksVerifyResultForInventory" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		SELECT tt.*
  		FROM (SELECT rank ()
               OVER (PARTITION BY a.STORE_ID, a.GOODS_ID ORDER BY a.ID DESC)
                  rn,
               a.*,
               jbg.GOODS_NAME,
               jbs.STORE_NAME
          FROM J_STOCKS_VERIFY a 
          left join J_BASE_GOODS jbg on jbg.GOODS_ID = a.GOODS_ID
          left join J_BASE_STORE jbs on jbs.STORE_ID = a.STORE_ID
         WHERE jbg.GOODS_STUTES=0
               and jbs.IS_DEL = 0
		<include refid="sf-jStocksVerify" />
		) tt where
         tt.rn = 1 
         order by tt.STORE_ID asc,tt.GOODS_NAME asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 为全部盘点和结转操作的取最新的商品列表 ,添加页面，或者结转操作2014-12-01 -->
	<select id="selectJStocksVerifyForInventoryFormList" resultMap="jStocksVerifyResultForInventoryForm" parameterClass="jStocksVerify" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		<![CDATA[
			SELECT goods_name,
	       goods_id,
	       STORE_ID,
	       STORE_NAME,
	       opr_date,
	       (init_num + come_num - out_num) as stocks,
	       (init_money + come_money - sale_cost) as money
	from (
	SELECT t.goods_name,
	       t.goods_id,
	       t.STORE_ID,
	       t.STORE_NAME,
	       t.opr_date,
	       (  t.R3_NUM
	        + t.JC_NUM
	        + t.CG_NUM
	        + t.CGTH_NUM
	        + t.DB_IN_NUM
	        - t.DB_OUT_NUM+T.kcpd_in_num)
	          AS come_num,
	       (  t.R3_MONEY
	        + t.JC_MONEY
	        + t.CG_MONEY
	        - t.CGTH_MONEY
	        + t.DB_IN_MONEY
	        - t.DB_OUT_MONEY +T.kcpd_in_money)
	          AS come_money,
	       (t.SAIL_NUM + t.FX_NUM - t.FXTH_NUM + t.XS_NUM + t.XSTH_NUM +T.kcpd_out_num)
	          AS out_num,
	       (  t.SAIL_NUM_PRICE
	        + t.FX_MONEY
	        - t.FXTH_MONEY
	        + t.XS_MONEY
	        - t.XSTH_MONEY +T.kcpd_out_money)
	          AS out_money,
	       (  t.SAIL_SALE_COST
	        + t.FX_SALE_COST
	        - t.FXTH_SALE_COST
	        + t.XS_SALE_COST
	        - t.XSTH_SALE_COST)
	          AS SALE_COST,
	       t.init_num AS init_num,
	       nvl(t.init_money,0) AS init_money
	  FROM (SELECT tt.goods_name,
	               tt.goods_id,
	               tt.STORE_ID,
	               tt.STORE_NAME,
	               tt.opr_date,
	               tt.R3_NUM,
	               tt.R3_MONEY,
	               tt.JC_NUM,
	               (tt.JC_PRICE * tt.JC_NUM) AS JC_MONEY,
	               tt.SAIL_NUM,
	               tt.SAIL_NUM_PRICE,
	               tt.SAIL_SALE_COST,
	               tt.FX_NUM,
	               tt.FX_MONEY,
	               tt.FX_SALE_COST,
	               tt.FXTH_NUM,
	               tt.FXTH_MONEY,
	               tt.FXTH_SALE_COST,
	               tt.XS_NUM,
	               tt.XS_MONEY,
	               tt.XS_SALE_COST,
	               tt.XSTH_NUM,
	               tt.XSTH_MONEY,
	               tt.XSTH_SALE_COST,
	               tt.CG_NUM,
	               tt.CG_MONEY,
	               tt.CGTH_NUM,
	               tt.CGTH_MONEY,
	               tt.init_num,
	               tt.init_money,
	               tt.DB_IN_NUM,
	               tt.DB_IN_MONEY,
	               tt.DB_OUT_NUM,
	               tt.DB_OUT_MONEY,
	               tt.kcpd_in_num,
	               TT.kcpd_in_money,
	               TT.kcpd_out_num,
	               TT.kcpd_out_money
          FROM (SELECT s.VER_STOCKS AS init_num,
                       s.VER_MONEY AS init_money,
                       s.GOODS_ID,
                       s.GOODS_NAME,
                       s.STORE_ID,
                       s.STORE_NAME,
                       s.opr_date,
                       nvl (
                          (SELECT sum (COLUMN_27) AS r3_num
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_num,
                       nvl (
                          (SELECT sum (COLUMN_14) AS r3_money
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_money,
                       nvl (
                          (SELECT sum (num) AS sail_num
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num,
                       nvl (
                          (SELECT sum (ALL_PRICE) AS ALL_PRICE
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num_price,
                       nvl (
                          (SELECT sum (sale_cost) AS sale_cost
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_sale_cost,
                       nvl (
                          (SELECT sum (LFIMG1) AS jc_num
                             FROM KONKA_ZLES23_RESULT_INFO
                            WHERE 1 = 1
                                  AND KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_ZLES23_RESULT_INFO.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_num,
                       nvl (
                          (SELECT sum (kp.PRICE) AS jc_price
                             FROM    KONKA_ZLES23_RESULT_INFO kz
                                  LEFT JOIN
                                     KONKA_PRICE_MANAGER kp
                                  ON     kz.MATNR = kp.GOODS_NAME
                                     AND kz.LGORT = kp.STORE_SN
                                     AND kz.BUDAT1 >= kp.START_DATE
                                     AND kz.BUDAT1 <= kp.END_DATE
                            WHERE 1 = 1
                                  AND kz.KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND kz.MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND kz.ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   kz.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_price,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_money,
                           NVL (
                          (
                          SELECT
                              SUM (a.ver_stocks - a.stocks)
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 31
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_in_num,
                    NVL (
                          (
                          SELECT
                              SUM( a.ver_money -a.money)
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 31
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_in_money,
                    NVL (
                          (
                          SELECT
                              SUM (a.stocks - a.ver_stocks)
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 30
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_out_num,
                    NVL (
                          (
                          SELECT
                              SUM (a.money- a.ver_money )
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 30
                          AND a.type=1
                          AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_out_money
                  FROM (SELECT t.*
                          FROM (SELECT rank ()
                                       OVER (
                                          PARTITION BY a.STORE_ID, a.GOODS_ID
                                          ORDER BY a.ID DESC)
                                          rn,
                                       a.*,
                                       jbg.GOODS_NAME,
                                       jbs.STORE_NAME
                                  FROM J_STOCKS_VERIFY a
                                       LEFT JOIN J_BASE_GOODS jbg
                                          ON jbg.GOODS_ID = a.GOODS_ID
                                       LEFT JOIN J_BASE_STORE jbs
                                          ON jbs.STORE_ID = a.STORE_ID
                                 WHERE     jbg.GOODS_STUTES = 0
                                       AND jbs.IS_DEL = 0
                                       AND a.C_ID = #map.c_id:DECIMAL#
                                       and a.type !=1
                                       ) t
                         WHERE t.rn = 1) s) tt
         WHERE tt.goods_name IS NOT NULL 
        ORDER BY tt.STORE_ID ASC, tt.GOODS_NAME ASC) t)
        ]]>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	
	<!-- 	执行插入数据的SQL语句  2014-12-02-->
	<update id="AutoRunUpdateStatementForInsertJStocksVerify"  parameterClass="jStocksVerify">
	<![CDATA[
		insert into J_STOCKS_VERIFY
		(ID,BILL_SN,TRADE_TYPE,STORE_ID,GOODS_ID,STOCKS,VER_STOCKS,OPR_DATE,ADD_DATE,C_ID,TYPE,MONEY,VER_MONEY)
		SELECT   SEQ_J_BASE.nextval as ID,
         'KSXF-'||TO_CHAR(SYSDATE,'yyyyMMdd-')||lpad(SEQ_J_BILL_ID.nextval,8,'0') as bill_sn,
         0 AS trade_type,
         STORE_ID,
         goods_id,
         (init_num + come_num - out_num) AS STOCKS,
         (init_num + come_num - out_num) AS VER_STOCKS,
         SYSDATE AS OPR_DATE,
         SYSDATE AS ADD_DATE,
         c_id,
         2 AS TYPE,
         (init_money + come_money - out_money) as money,
         (init_money + come_money - out_money) as ver_money
        
	from (
	SELECT t.c_id,
         t.goods_name,
	       t.goods_id,
	       t.STORE_ID,
	       t.STORE_NAME,
	       t.opr_date,
	       (  t.R3_NUM
	        + t.JC_NUM
	        + t.CG_NUM
	        + t.CGTH_NUM
	        + t.DB_IN_NUM
	        - t.DB_OUT_NUM+T.kcpd_in_num)
	          AS come_num,
	       (  t.R3_MONEY
	        + t.JC_MONEY
	        + t.CG_MONEY
	        - t.CGTH_MONEY
	        + t.DB_IN_MONEY
	        - t.DB_OUT_MONEY +T.kcpd_in_money)
	          AS come_money,
	       (t.SAIL_NUM + t.FX_NUM - t.FXTH_NUM + t.XS_NUM + t.XSTH_NUM +T.kcpd_out_num)
	          AS out_num,
	       (  t.SAIL_NUM_PRICE
	        + t.FX_MONEY
	        - t.FXTH_MONEY
	        + t.XS_MONEY
	        - t.XSTH_MONEY +T.kcpd_out_money)
	          AS out_money,
	       (  t.SAIL_SALE_COST
	        + t.FX_SALE_COST
	        - t.FXTH_SALE_COST
	        + t.XS_SALE_COST
	        - t.XSTH_SALE_COST)
	          AS SALE_COST,
	       t.init_num AS init_num,
	       nvl(t.init_money,0) AS init_money
	  FROM (SELECT tt.c_id,
	               tt.goods_name,
	               tt.goods_id,
	               tt.STORE_ID,
	               tt.STORE_NAME,
	               tt.opr_date,
	               tt.R3_NUM,
	               tt.R3_MONEY,
	               tt.JC_NUM,
	               (tt.JC_PRICE * tt.JC_NUM) AS JC_MONEY,
	               tt.SAIL_NUM,
	               tt.SAIL_NUM_PRICE,
	               tt.SAIL_SALE_COST,
	               tt.FX_NUM,
	               tt.FX_MONEY,
	               tt.FX_SALE_COST,
	               tt.FXTH_NUM,
	               tt.FXTH_MONEY,
	               tt.FXTH_SALE_COST,
	               tt.XS_NUM,
	               tt.XS_MONEY,
	               tt.XS_SALE_COST,
	               tt.XSTH_NUM,
	               tt.XSTH_MONEY,
	               tt.XSTH_SALE_COST,
	               tt.CG_NUM,
	               tt.CG_MONEY,
	               tt.CGTH_NUM,
	               tt.CGTH_MONEY,
	               tt.init_num,
	               tt.init_money,
	               tt.DB_IN_NUM,
	               tt.DB_IN_MONEY,
	               tt.DB_OUT_NUM,
	               tt.DB_OUT_MONEY,
	               tt.kcpd_in_num,
	               TT.kcpd_in_money,
	               TT.kcpd_out_num,
	               TT.kcpd_out_money
          FROM (SELECT s.c_id,
                       s.VER_STOCKS AS init_num,
                       s.VER_MONEY AS init_money,
                       s.GOODS_ID,
                       s.GOODS_NAME,
                       s.STORE_ID,
                       s.STORE_NAME,
                       s.opr_date,
                       nvl (
                          (SELECT sum (COLUMN_27) AS r3_num
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_num,
                       nvl (
                          (SELECT sum (COLUMN_14) AS r3_money
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_money,
                       nvl (
                          (SELECT sum (num) AS sail_num
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num,
                       nvl (
                          (SELECT sum (ALL_PRICE) AS ALL_PRICE
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num_price,
                       nvl (
                          (SELECT sum (sale_cost) AS sale_cost
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_sale_cost,
                       nvl (
                          (SELECT sum (LFIMG1) AS jc_num
                             FROM KONKA_ZLES23_RESULT_INFO
                            WHERE 1 = 1
                                  AND KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_ZLES23_RESULT_INFO.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_num,
                       nvl (
                          (SELECT sum (kp.PRICE) AS jc_price
                             FROM    KONKA_ZLES23_RESULT_INFO kz
                                  LEFT JOIN
                                     KONKA_PRICE_MANAGER kp
                                  ON     kz.MATNR = kp.GOODS_NAME
                                     AND kz.LGORT = kp.STORE_SN
                                     AND kz.BUDAT1 >= kp.START_DATE
                                     AND kz.BUDAT1 <= kp.END_DATE
                            WHERE 1 = 1
                                  AND kz.KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND kz.MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND kz.ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   kz.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_price,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_money,
                       nvl (
                          (SELECT sum (e2.sale_cost) AS sale_cost
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_sale_cost,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1  AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_money,
                           NVL (
                          (
                          SELECT
                              SUM (a.ver_stocks - a.stocks)
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 31
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_in_num,
                    NVL (
                          (
                          SELECT
                              SUM( a.ver_money -a.money )
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 31
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_in_money,
                    NVL (
                          (
                          SELECT
                              SUM (a.stocks - a.ver_stocks)
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 30
                          AND a.type=1
                           AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_out_num,
                    NVL (
                          (
                          SELECT
                              SUM (a.money * a.ver_money )
                          FROM
                              J_STOCKS_VERIFY a
                          WHERE
                              1=1
                          AND a.c_id =s.C_ID
                          AND a.GOODS_ID=s.GOODS_ID
                          AND a.trade_type= 30
                          AND a.type=1
                          AND a.store_id =s.store_id
                          AND a.opr_date >=(SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                            AND vt.type !=1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.store_id)), 0) AS kcpd_out_money
                  FROM (SELECT t.*
                          FROM (SELECT rank ()
                                       OVER (
                                          PARTITION BY a.STORE_ID, a.GOODS_ID
                                          ORDER BY a.ID DESC)
                                          rn,
                                       a.*,
                                       jbg.GOODS_NAME,
                                       jbs.STORE_NAME
                                  FROM J_STOCKS_VERIFY a
                                       LEFT JOIN J_BASE_GOODS jbg
                                          ON jbg.GOODS_ID = a.GOODS_ID
                                       LEFT JOIN J_BASE_STORE jbs
                                          ON jbs.STORE_ID = a.STORE_ID
                                 WHERE     jbg.GOODS_STUTES = 0
                                       AND jbs.IS_DEL = 0
                                       and a.type !=1
                                       ) t
                         WHERE t.rn = 1) s) tt
         WHERE tt.goods_name IS NOT NULL 
        ORDER BY tt.STORE_ID ASC, tt.GOODS_NAME ASC) t)      
       ]]>
	</update>

<!-- 	执行插入数据的SQL语句  2014-12-02 这个是肖国健的，wangkl15年3月28改成上面的了-->
	<update id="AutoRunUpdateStatementForInsertJStocksVerify_old"  parameterClass="jStocksVerify">
	<![CDATA[
		insert into J_STOCKS_VERIFY
		(ID,BILL_SN,TRADE_TYPE,STORE_ID,GOODS_ID,STOCKS,VER_STOCKS,OPR_DATE,ADD_DATE,C_ID,TYPE,MONEY,VER_MONEY)
		SELECT   SEQ_J_BASE.nextval as ID,
         'KSXF-'||TO_CHAR(SYSDATE,'yyyyMMdd-')||lpad(SEQ_J_BILL_ID.nextval,8,'0') as bill_sn,
         0 AS trade_type,
         STORE_ID,
         goods_id,
         (init_num + come_num - out_num) AS STOCKS,
         (init_num + come_num - out_num) AS VER_STOCKS,
         SYSDATE AS OPR_DATE,
         SYSDATE AS ADD_DATE,
         c_id,
         2 AS TYPE,
         (init_money + come_money - out_money) as money,
         (init_money + come_money - out_money) as ver_money
        
	from (
	SELECT t.c_id,
         t.goods_name,
	       t.goods_id,
	       t.STORE_ID,
	       t.STORE_NAME,
	       t.opr_date,
	       (  t.R3_NUM
	        + t.JC_NUM
	        + t.CG_NUM
	        + t.CGTH_NUM
	        + t.DB_IN_NUM
	        - t.DB_OUT_NUM)
	          AS come_num,
	       (  t.R3_MONEY
	        + t.JC_MONEY
	        + t.CG_MONEY
	        - t.CGTH_MONEY
	        + t.DB_IN_MONEY
	        - t.DB_OUT_MONEY)
	          AS come_money,
	       (t.SAIL_NUM + t.FX_NUM - t.FXTH_NUM + t.XS_NUM + t.XSTH_NUM)
	          AS out_num,
	       (  t.SAIL_NUM_PRICE
	        + t.FX_MONEY
	        - t.FXTH_MONEY
	        + t.XS_MONEY
	        - t.XSTH_MONEY)
	          AS out_money,
	       t.init_num AS init_num,
	       nvl(t.init_money,0) AS init_money
	  FROM (SELECT tt.c_id,
                 tt.goods_name,
	               tt.goods_id,
	               tt.STORE_ID,
	               tt.STORE_NAME,
	               tt.opr_date,
	               tt.R3_NUM,
	               tt.R3_MONEY,
	               tt.JC_NUM,
	               (tt.JC_PRICE * tt.JC_NUM) AS JC_MONEY,
	               tt.SAIL_NUM,
	               tt.SAIL_NUM_PRICE,
	               tt.FX_NUM,
	               tt.FX_MONEY,
	               tt.FXTH_NUM,
	               tt.FXTH_MONEY,
	               tt.XS_NUM,
	               tt.XS_MONEY,
	               tt.XSTH_NUM,
	               tt.XSTH_MONEY,
	               tt.CG_NUM,
	               tt.CG_MONEY,
	               tt.CGTH_NUM,
	               tt.CGTH_MONEY,
	               tt.init_num,
	               tt.init_money,
	               tt.DB_IN_NUM,
	               tt.DB_IN_MONEY,
	               tt.DB_OUT_NUM,
	               tt.DB_OUT_MONEY
          FROM (SELECT s.VER_STOCKS AS init_num,
                       s.VER_MONEY AS init_money,
                       s.GOODS_ID,
                       s.GOODS_NAME,
                       s.STORE_ID,
                       s.STORE_NAME,
                       s.opr_date,
                       s.C_ID,
                       nvl (
                          (SELECT sum (COLUMN_27) AS r3_num
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_num,
                       nvl (
                          (SELECT sum (COLUMN_14) AS r3_money
                             FROM CHANNEL_DATA_IMPORT
                            WHERE 1 = 1
                                  AND COLUMN_5 IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND COLUMN_11 IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND column_26 >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   CHANNEL_DATA_IMPORT.COLUMN_5
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS r3_money,
                       nvl (
                          (SELECT sum (num) AS sail_num
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num,
                       nvl (
                          (SELECT sum (ALL_PRICE) AS ALL_PRICE
                             FROM KONKA_MOBILE_SAIL_DATA
                            WHERE 1 = 1
                                  AND sdf_r3_code IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND model_name IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND report_date >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_MOBILE_SAIL_DATA.SDF_R3_CODE
                                                                AND IS_DEL =
                                                                       0))
                                  AND is_del = 0
                                  AND all_price IS NOT NULL
                                  AND all_price != 0),
                          0)
                          AS sail_num_price,
                       nvl (
                          (SELECT sum (LFIMG1) AS jc_num
                             FROM KONKA_ZLES23_RESULT_INFO
                            WHERE 1 = 1
                                  AND KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   KONKA_ZLES23_RESULT_INFO.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_num,
                       nvl (
                          (SELECT sum (kp.PRICE) AS jc_price
                             FROM    KONKA_ZLES23_RESULT_INFO kz
                                  LEFT JOIN
                                     KONKA_PRICE_MANAGER kp
                                  ON     kz.MATNR = kp.GOODS_NAME
                                     AND kz.LGORT = kp.STORE_SN
                                     AND kz.BUDAT1 >= kp.START_DATE
                                     AND kz.BUDAT1 <= kp.END_DATE
                            WHERE 1 = 1
                                  AND kz.KUNNR IN
                                         (SELECT SALE_R3_CODE
                                            FROM J_BASE_STORE_R3
                                           WHERE STORE_ID = s.STORE_ID
                                                 AND IS_DEL = 0)
                                  AND kz.MATNR IN
                                         (SELECT goods_name
                                            FROM J_BASE_GOODS
                                           WHERE goods_id = s.GOODS_ID
                                                 AND s.C_ID = c_id)
                                  AND kz.ERDAT >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.goods_id
                                                 AND vt.store_id IN
                                                        (SELECT store_id
                                                           FROM J_BASE_STORE_R3
                                                          WHERE sale_r3_code =
                                                                   kz.KUNNR
                                                                AND IS_DEL =
                                                                       0))),
                          0)
                          AS jc_price,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 40
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fx_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 42
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS fxth_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 20
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xs_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 21
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS xsth_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 10
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cg_money,
                       nvl (
                          (SELECT sum (e2.NUM)
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_num,
                       nvl (
                          (SELECT sum (e2.MONEY) AS MONEY
                             FROM    j_bill e1
                                  LEFT JOIN
                                     J_Bill_Details e2
                                  ON e1.bill_id = e2.BILL_ID
                            WHERE     1 = 1
                                  AND e1.c_id = s.C_ID
                                  AND e2.GOODS_ID = s.GOODS_ID
                                  AND e1.bill_type = 11
                                  AND e2.store_id = s.STORE_ID
                                  AND e1.ADD_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        e2.STORE_ID)),
                          0)
                          AS cgth_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.IN_R3_CODE IN (SELECT b.R3_CODE
                                                         FROM KONKA_R3_SHOP b
                                                        WHERE b.ID = s.C_ID)
                                  AND a.IN_GOODS_ID = s.GOODS_ID
                                  AND a.in_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.IN_STORE_ID)),
                          0)
                          AS db_in_money,
                       nvl (
                          (SELECT sum (a.IN_NUM)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_num,
                       nvl (
                          (SELECT sum (a.IN_MONEY)
                             FROM JXC_OUT_IN_DETAIL a
                            WHERE     a.IS_DEL = 0
                                  AND a.STATE = 1
                                  AND a.OUT_R3_CODE IN (SELECT b.R3_CODE
                                                          FROM KONKA_R3_SHOP b
                                                         WHERE b.ID = s.C_ID)
                                  AND a.OUT_GOODS_ID = s.GOODS_ID
                                  AND a.out_store_id = s.STORE_ID
                                  AND a.CONFIRM_DATE >=
                                         (SELECT max (vt.OPR_DATE)
                                            FROM J_STOCKS_VERIFY vt
                                           WHERE 1 = 1
                                                 AND vt.GOODS_ID = s.GOODS_ID
                                                 AND vt.store_id =
                                                        a.OUT_STORE_ID)),
                          0)
                          AS db_out_money
                  FROM (SELECT t.*
                          FROM (SELECT rank ()
                                       OVER (
                                          PARTITION BY a.STORE_ID, a.GOODS_ID
                                          ORDER BY a.ID DESC)
                                          rn,
                                       a.*,
                                       jbg.GOODS_NAME,
                                       jbs.STORE_NAME
                                  FROM J_STOCKS_VERIFY a
                                       LEFT JOIN J_BASE_GOODS jbg
                                          ON jbg.GOODS_ID = a.GOODS_ID
                                       LEFT JOIN J_BASE_STORE jbs
                                          ON jbs.STORE_ID = a.STORE_ID
                                 WHERE     jbg.GOODS_STUTES = 0
                                       AND jbs.IS_DEL = 0
                                    --   AND a.TYPE not in (2,4)
                                      
                                    --   AND a.OPR_DATE < (VALUES DATE(to_char(LAST_DAY(sysdate - 2 months) + 25,'yyyy-MM-dd')))
                                       ) t
                         WHERE t.rn = 1) s) tt
         WHERE tt.goods_name IS NOT NULL 
        ORDER BY tt.STORE_ID ASC, tt.GOODS_NAME ASC) t)      
       ]]>
	</update>

    <!--这是统计盘点的问题的代码-->


    <resultMap id="JStocksVerifyForManagerResult" class="jStocksVerify">
        <result column="OPR_TYPE" property="map.opr_type"  jdbcType="DECIMAL"/>
        <result column="FGS_NAME" property="map.fgs_name"  jdbcType="VARCHAR"/>
        <result column="JB_NAME" property="map.jb_name"  jdbcType="VARCHAR"/>
        <result column="CUSTOMER_NAME" property="map.customer_name"  jdbcType="VARCHAR"/>
        <result column="R3_CODE" property="map.r3_code"  jdbcType="VARCHAR"/>
        <result column="PAR_CUSTOMER_TYPE_NAME" property="map.par_customer_type_name"  jdbcType="VARCHAR"/>
        <result column="CUSTOMER_TYPE_NAME" property="map.customer_type_name"  jdbcType="VARCHAR"/>
        <result column="GOODS_NAME" property="map.goods_name"  jdbcType="VARCHAR"/>
        <result column="STORE_NAME" property="map.store_name"  jdbcType="VARCHAR"/>
        <result column="VER_STOCKS" property="ver_stocks"  jdbcType="DECIMAL"/>
        <result column="VER_MONEY" property="ver_money"  jdbcType="DECIMAL"/>
        <result column="OPR_DATE" property="opr_date"  jdbcType="DATETIME"/>
        <result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
        <result column="GOODS_ID" property="goods_id" jdbcType="DECIMAL" />
        <result column="C_ID" property="c_id" jdbcType="DECIMAL" />

    </resultMap>


    <sql id="sf-jStocksVerify-a">
        <isNotEmpty prepend=" and " property="map.customer_type1">b.PAR_CUSTOMER_TYPE = #map.customer_type1:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.customer_type2">b.CUSTOMER_TYPE = #map.customer_type2:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.customer_name_like">b.customer_name like '%' || #map.customer_name_like:VARCHAR # || '%'</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.fgs_dept_id">b.dept_id = #map.fgs_dept_id:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.l4_dept_id">b.l4_dept_id = #map.l4_dept_id:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.l5_dept_id">b.cur_dept_id = #map.l4_dept_id:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.r3_code_like">UPPER(b.r3_code) like '%'||UPPER(#map.r3_code_like:VARCHAR#)|| '%'</isNotEmpty>

        <isNotEmpty prepend=" and " property="map.r3_code_like">UPPER(b.r3_code) like '%'||UPPER(#map.r3_code_like:VARCHAR#)|| '%'</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.date_begin"><![CDATA[ a.opr_date >= to_date(#map.date_begin:VARCHAR#,'yyyy-MM-dd')]]></isNotEmpty>
        <isNotEmpty prepend=" and " property="map.date_end"><![CDATA[ a.opr_date <= to_date(#map.date_end:VARCHAR#,'yyyy-MM-dd')]]></isNotEmpty>

        <isNotEmpty prepend=" and " property="map.store_name_like">d.store_name like '%'||#map.store_name_like:VARCHAR#||'%'</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.goods_name_like">UPPER(c.goods_name) like '%'||UPPER(#map.goods_name_like:VARCHAR#)||'%'</isNotEmpty>



        <isNotEmpty prepend=" " property="type">
        <isEqual prepend=" and " property="type" compareValue="0">
            a.type =1
        </isEqual>
        <isEqual prepend=" and " property="type" compareValue="1">
            a.type in (0,2,3,4)
        </isEqual>
        </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.dept_id_start">
            (b.user_id is not null and c.user_id in (
            select id from konka_pe_prod_user u
            where u.dept_id in (
            select dept_id from konka_dept start with dept_id in (
            SELECT DISTINCT (dept_id)
            FROM KONKA_ROLE_DATA_LEVEL
            WHERE role_id IN (SELECT role_id
            FROM KONKA_PE_ROLE_USER
            WHERE user_id = #map.session_user_id#)
            ) or dept_id = #map.dept_id_start#
            connect by prior dept_id = par_id
            )
            )
            )
        </isNotEmpty>

        <isNotEmpty prepend=" and " property="map.filter_by_ywy_id_eq">
            b.user_id = #map.filter_by_ywy_id_eq#
        </isNotEmpty>

    </sql>

    <select id="selectJStocksVerifyForManagerCount" parameterClass="jStocksVerify" resultClass="long">
        select count(1) from (
        SELECT goods_id
        FROM (
        SELECT RANK() OVER (PARTITION BY a.GOODS_ID,a.c_id
        <isNotEmpty prepend="," property="map.store_flag" >a.store_id</isNotEmpty> ORDER BY a.ID DESC) AS rn,a.store_id, a.ver_stocks, a.ver_money, a.goods_id, a.c_id
        , a.opr_date, a.type, b.dept_name, b.l4_dept_name, b.customer_name
        , b.r3_code, b.PAR_CUSTOMER_TYPE_NAME, b.CUSTOMER_TYPE_NAME, c.GOODS_NAME, d.store_name
        FROM J_STOCKS_VERIFY a
        LEFT JOIN mv_org_of_customer_all b ON a.c_id = b.konka_r3_id
        LEFT JOIN j_base_goods c ON a.goods_id = c.goods_id
        LEFT JOIN j_base_store d ON   a.store_id = d.store_id
        WHERE 1= 1 and c.goods_stutes=0 and d.is_del=0
        <include refid="sf-jStocksVerify-a" />
        )
        WHERE rn = 1
        )
    </select>

    <select id="selectJStocksVerifyForManagerPaginatedList" parameterClass="jStocksVerify" resultMap="JStocksVerifyForManagerResult">
        <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
        SELECT type opr_type,dept_name AS fgs_name, l4_dept_name AS jb_name, customer_name AS
        customer_name,r3_code AS r3_code
        , PAR_CUSTOMER_TYPE_NAME AS PAR_CUSTOMER_TYPE_NAME, CUSTOMER_TYPE_NAME AS CUSTOMER_TYPE_NAME,
        GOODS_NAME AS goods_name,goods_id,c_id,
        <isNotEmpty property="map.store_flag">store_name AS store_name,store_id,</isNotEmpty>
        <isEmpty property="map.store_flag">'' as store_name,'' as store_id,</isEmpty>
        ver_stocks AS ver_stocks ,ver_money AS ver_money, opr_date AS opr_date
        FROM (
        SELECT RANK() OVER (PARTITION BY a.GOODS_ID,a.c_id
        <isNotEmpty prepend="," property="map.store_flag">a.store_id</isNotEmpty>
        ORDER BY a.ID DESC) AS rn,a.store_id,a.ver_stocks, a.ver_money, a.goods_id, a.c_id
        , a.opr_date, a.type, b.dept_name, b.l4_dept_name, b.customer_name
        , b.r3_code, b.PAR_CUSTOMER_TYPE_NAME, b.CUSTOMER_TYPE_NAME, c.GOODS_NAME, d.store_name
        FROM J_STOCKS_VERIFY a
        LEFT JOIN mv_org_of_customer_all b ON a.c_id = b.konka_r3_id
        LEFT JOIN j_base_goods c ON a.goods_id = c.goods_id
        LEFT JOIN j_base_store d ON   a.store_id = d.store_id
        WHERE 1= 1 and c.goods_stutes=0 and d.is_del=0
        <include refid="sf-jStocksVerify-a"/>
        )
        WHERE rn = 1
        <![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
    </select>

    <!--这是统计盘点的问题的代码-->



	<insert id="insertJStocksVerify" parameterClass="jStocksVerify">
		<selectKey resultClass="long" keyProperty="id">select SEQ_J_BASE.nextval as id from dual </selectKey>
		<![CDATA[insert into J_STOCKS_VERIFY (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="bill_sn">BILL_SN</isNotNull>	
			<isNotNull prepend="," property="trade_type">TRADE_TYPE</isNotNull>	
			<isNotNull prepend="," property="store_id">STORE_ID</isNotNull>	
			<isNotNull prepend="," property="goods_id">GOODS_ID</isNotNull>	
			<isNotNull prepend="," property="stocks">STOCKS</isNotNull>	
			<isNotNull prepend="," property="ver_stocks">VER_STOCKS</isNotNull>	
			<isNotNull prepend="," property="memo">MEMO</isNotNull>	
			<isNotNull prepend="," property="opr_date">OPR_DATE</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="c_id">C_ID</isNotNull>	
			<isNotNull prepend="," property="type">TYPE</isNotNull>	
			<isNotNull prepend="," property="money">MONEY</isNotNull>	
			<isNotNull prepend="," property="ver_money">VER_MONEY</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_sn">#bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="trade_type">#trade_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_id">#store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_id">#goods_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stocks">#stocks:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ver_stocks">#ver_stocks:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="memo">#memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="opr_date">#opr_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="c_id">#c_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type">#type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">#money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ver_money">#ver_money:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateJStocksVerify" parameterClass="JStocksVerify">
		update J_STOCKS_VERIFY
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_sn">BILL_SN = #bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="trade_type">TRADE_TYPE = #trade_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_id">STORE_ID = #store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_id">GOODS_ID = #goods_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stocks">STOCKS = #stocks:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ver_stocks">VER_STOCKS = #ver_stocks:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="memo">MEMO = #memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="opr_date">OPR_DATE = #opr_date:DATE#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="c_id">C_ID = #c_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type">TYPE = #type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">MONEY = #money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ver_money">VER_MONEY = #ver_money:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteJStocksVerify" parameterClass="JStocksVerify">
		delete from J_STOCKS_VERIFY where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>