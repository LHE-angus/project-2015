<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="FILES">

	<typeAlias alias="files" type="com.ebiz.mmt.domain.KonkaoaFiles" />
	<typeAlias alias="ssuedDocument" type="com.ebiz.mmt.domain.KonkaoaSsuedDocument" />

	<resultMap id="filesResultForList" class="files">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="APPLY_USER_NAME" property="apply_user_name" jdbcType="VARCHAR" />
		<result column="APPLY_USER_TEL" property="apply_user_tel" jdbcType="VARCHAR" />
		<result column="SUBMIT_DEPT" property="submit_dept" jdbcType="VARCHAR" />
		<result column="SUBMIT_DEPT_ID" property="submit_dept_id" jdbcType="DECIMAL" />
		<result column="SUBMIT_USER" property="submit_user" jdbcType="VARCHAR" />
		<result column="SUBMIT_USER_ID" property="submit_user_id" jdbcType="DECIMAL" />
		<result column="IS_STAMP" property="is_stamp" jdbcType="DECIMAL" />
		<result column="IS_FORWARD" property="is_forward" jdbcType="DECIMAL" />
		<result column="FILE_TITLE" property="file_title" jdbcType="VARCHAR" />
		<result column="APPLY_PEOPLE" property="apply_people" jdbcType="VARCHAR" />
		<result column="SUBMIT_DATETIME" property="submit_datetime" jdbcType="DATETIME" />
		<result column="CUR_AUDIT_USER_ID" property="cur_audit_user_id" jdbcType="DECIMAL" />
		<result column="FILE_STATUS" property="file_status" jdbcType="DECIMAL" />
		<result column="ARCHIVE_DATETIME" property="archive_datetime" jdbcType="DATETIME" />
		<result column="ORDER_VALUE" property="order_value" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="FILE_NO" property="file_no" jdbcType="VARCHAR" />
		<result column="FILE_DENSE" property="file_dense" jdbcType="DECIMAL" />
		<result column="TIME_LIMIT" property="time_limit" jdbcType="DECIMAL" />
		<result column="DOC_ID" property="doc_id" jdbcType="DECIMAL" />
		<result column="AUDIT_TYPE" property="audit_type" jdbcType="DECIMAL" />
		<result column="FILE_TYPE" property="file_type" jdbcType="DECIMAL" />
		<result column="AUDIT_NODE_ID" property="audit_node_id" jdbcType="DECIMAL" />
		<result column="IS_NODE" property="is_node" jdbcType="DECIMAL" />
		<result column="LINK_ID" property="link_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="filesResult" class="files" extends="filesResultForList">
		<result column="CONTENT" property="content" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="filesResultForPaginatedList" class="files" extends="filesResultForList" groupBy="id">
		<result column="B_NAME_12" property="map.b_name_12" jdbcType="VARCHAR" />
		<result column="LINK_ID_COUNT" property="map.link_id_count" jdbcType="DECIMAL" />
		<!--  <result property="categoryList" resultMap="KONKAOA_category.categoryResultForAuditFilesList" /> -->
	</resultMap>

	<resultMap id="filesResultForArchive" class="files" extends="filesResultForList" groupBy="id">
		<result column="OPER_TYPE" property="map.oper_type" jdbcType="DECIMAL" />
		<result column="OPER_DATETIME" property="oper_datetime" jdbcType="DATETIME" />
		<result column="B_NAME_12" property="map.b_name_12" jdbcType="VARCHAR" />
		<!--  <result property="categoryList" resultMap="KONKAOA_category.categoryResultForAuditFilesList" /> -->
	</resultMap>

	<resultMap id="filesResultForAuditList" class="files" extends="filesResultForList" groupBy="id">
		<result column="B_NAME_12" property="map.b_name_12" jdbcType="VARCHAR" />
		<result column="CUR_AUDIT_USER_NAME" property="map.cur_audit_user_name" jdbcType="VARCHAR" />
		<result column="AGENT_AUDIT" property="map.agent_audit" jdbcType="DECIMAL" />
		<!--  <result property="categoryList" resultMap="KONKAOA_category.categoryResultForAuditFilesList" /> -->
	</resultMap>

	<resultMap id="filesResultForAuditIngList" class="files" extends="filesResultForList" groupBy="id">
		<result column="CUR_AUDIT_USER_NAME" property="map.cur_audit_user_name" jdbcType="VARCHAR" />
		<result column="LAST_AUDIT_DATE_TIME" property="map.last_audit_date_time" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-files">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="submit_dept">SUBMIT_DEPT = #submit_dept:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="submit_dept_id">SUBMIT_DEPT_ID = #submit_dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="submit_user">SUBMIT_USER = #submit_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="submit_user_id">SUBMIT_USER_ID = #submit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_forward">IS_FORWARD = #is_forward:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_title">FILE_TITLE = #file_title:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="apply_people">APPLY_PEOPLE = #apply_people:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="submit_datetime">SUBMIT_DATETIME = #submit_datetime:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cur_audit_user_id">CUR_AUDIT_USER_ID = #cur_audit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_status">FILE_STATUS = #file_status:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_stamp">IS_STAMP = #is_stamp:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="archive_datetime">ARCHIVE_DATETIME = #archive_datetime:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.lt_file_status"><![CDATA[FILE_STATUS < #map.lt_file_status#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.gt_file_status"><![CDATA[FILE_STATUS > #map.gt_file_status#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.file_title_like">FILE_TITLE like '%' || #map.file_title_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.submit_user_like">SUBMIT_USER like '%' || #map.submit_user_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_no">FILE_NO like '%' || #file_no:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_dense">FILE_DENSE = #file_dense:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="time_limit">TIME_LIMIT = #time_limit:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="doc_id">a.DOC_ID = #doc_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_type">FILE_TYPE = #file_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_node_id">AUDIT_NODE_ID = #audit_node_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_node">IS_NODE = #is_node:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.map_file_status">
			FILE_STATUS in ($map.map_file_status$)
		</isNotEmpty>

		<isNotEmpty prepend=" and " property="map.cur_audit_user_ids">
			CUR_AUDIT_USER_ID in
			<iterate close=")" open="(" conjunction="," property="map.cur_audit_user_ids">#map.cur_audit_user_ids[]#</iterate>
		</isNotEmpty>

		<isNotEmpty property="map.st_submit_datetime">
			<isNotEmpty prepend=" and " property="map.en_submit_datetime">
				<![CDATA[ to_char(SUBMIT_DATETIME, 'yyyy-MM-dd') >= #map.st_submit_datetime# and to_char(SUBMIT_DATETIME, 'yyyy-MM-dd') <= #map.en_submit_datetime#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_submit_datetime">
				to_char(SUBMIT_DATETIME, 'yyyy-MM-dd') >= #map.st_submit_datetime#
			</isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_submit_datetime">
			<isNotEmpty prepend=" and " property="map.en_submit_datetime">
				<![CDATA[ 
				to_char(SUBMIT_DATETIME, 'yyyy-MM-dd') <= #map.en_submit_datetime#
				]]>
			</isNotEmpty>
		</isEmpty>
		<!-- 		审批 -->
		<isNotEmpty property="map.st_archive_datetime">
			<isNotEmpty prepend=" and " property="map.en_archive_datetime">
                 <![CDATA[ archive_datetime >= to_char (#map.st_archive_datetime#,'yyyy-MM-dd') ]]>
        	</isNotEmpty>
        	<isEmpty prepend=" and " property="map.en_archive_datetime">
				 <![CDATA[ archive_datetime >= to_date (#map.en_archive_datetime#, 'yyyy-mm-dd') ]]>
			</isEmpty>
        </isNotEmpty>
        <isEmpty property="map.st_submit_datetime">
			<isNotEmpty prepend=" and " property="map.en_archive_datetime">
				<![CDATA[ 
				archive_datetime <= to_date (#map.en_archive_datetime#, 'yyyy-mm-dd')
				]]>
			</isNotEmpty>
		</isEmpty>
		
		
		<isNotEmpty property="map.st_input_time">
			<isNotEmpty prepend=" and " property="map.en_input_time">
          <![CDATA[ to_char(INPUT_TIME, 'yyyy-mm-dd') >= #map.st_input_time# and to_char(INPUT_TIME, 'yyyy-mm-dd') <= #map.en_input_time#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_input_time">
				to_char(INPUT_TIME, 'yyyy-mm-dd') >= #map.st_input_time#
         </isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_input_time">
			<isNotEmpty prepend=" and " property="map.en_input_time">
          <![CDATA[ 
          to_char(INPUT_TIME, 'yyyy-mm-dd') <= #map.en_input_time#
          ]]>
			</isNotEmpty>
		</isEmpty>
		
		<!--请假为空走之前的但是不要过滤掉请假的-->
		<isEmpty prepend=" and " property="map.qingjia" >
			 <![CDATA[ FILE_TYPE<> 2 ]]> 
		</isEmpty>
		
        <!--请假不为空走查请假的估计值为2-->
	    <isNotEmpty prepend=" and " property="map.qingjia" >
			FILE_TYPE = 2 
		</isNotEmpty>
	</sql>

	<select id="selectKonkaoaFiles" resultMap="filesResult" parameterClass="files" >
		select a.*, b.content from (select * from KONKAOA_FILES where 1 = 1
		<include refid="sf-files" />
		) a left join KONKAOA_FILES_CONTENT b ON a.id = b.link_id
		where 1 = 1
		<isNotEmpty prepend=" and " property="file_type">a.FILE_TYPE = #file_type:DECIMAL#</isNotEmpty>
		 order by a.id desc
	</select>
	
	<sql id="sf-selectFilesListForArchive">
		<![CDATA[select *
 			 from (select d.id,
 			   OFS.SUBMIT_USER_ID,
		       ofs.submit_user,
		       ofs.file_title,
		       ofs.file_no,
		       ofs.file_status,
		       ofs.time_limit,
		       ofs.is_del,
               D.AUDIT_USER_ID,
		       d.audit_user,
		       to_char(d.audit_datetime, 'yyyy-MM-dd HH24:mi:ss') as audit_datetime,
		       to_char(d.previous_approval_time, 'yyyy-MM-dd HH24:mi:ss') as previous_approval_time,
		       to_char(d.previous_countersign_time, 'yyyy-MM-dd HH24:mi:ss') as previous_countersign_time,
		       to_char(ofs.submit_datetime, 'yyyy-MM-dd HH24:mi:ss') as submit_datetime
		  from (select a.*,
		                (select audit_datetime
		                  from (select *
		                          from KONKAOA_FILES_AUDIT_NODE
		                         where audit_type = 0
		                         order by audit_datetime desc) b
		                 where b.link_id = a.link_id
		                   and a.audit_level > = 2
		                   and a.id <> b.id
		                   and b.audit_datetime is not null
		                   and rownum < 2) as previous_approval_time,
		               (select audit_datetime
		                  from (select *
		                          from KONKAOA_FILES_AUDIT_NODE
		                         where audit_type = 1
		                         order by audit_datetime desc) b
		                 where b.link_id = a.link_id
		                   and rownum < 2) as previous_countersign_time
		          from KONKAOA_FILES_AUDIT_NODE a
		         where a.audit_type = 0 ]]>
		<isNotEmpty prepend=" and " property="map.audit_note_id"><![CDATA[ a.id > #map.audit_note_id# ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="id">a.link_id = #id:DECIMAL#</isNotEmpty>
		<![CDATA[ ) d
		  left join KONKAOA_FILES ofs
		    on d.link_id = ofs.id
		  where 1 = 1 ]]>
		<isNotEmpty prepend=" and " property="map.st_submit_datetime">
			<![CDATA[ to_char(ofs.SUBMIT_DATETIME, 'yyyy-MM-dd') >= #map.st_submit_datetime#]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.en_submit_datetime">
			<![CDATA[ to_char(ofs.SUBMIT_DATETIME, 'yyyy-MM-dd') <= #map.en_submit_datetime#]]>
		</isNotEmpty>
		<![CDATA[ 
		    and ( (audit_datetime - previous_approval_time > ofs.time_limit and
		       audit_datetime is not null and previous_approval_time is not null)
		    or (sysdate - previous_approval_time > ofs.time_limit and audit_datetime is null and
		       previous_approval_time is not null)
		    or (audit_datetime - previous_countersign_time > ofs.time_limit and
		       audit_datetime is not null and
		       previous_approval_time is null and
		       previous_countersign_time is not null)
		    or (sysdate - previous_countersign_time > ofs.time_limit and
		       audit_datetime is null and
		       previous_approval_time is null and
		       previous_countersign_time is not null)
		    or (audit_datetime - ofs.submit_datetime > ofs.time_limit and
		       audit_datetime is not null and
		       previous_approval_time is null and
		       previous_countersign_time is null)
		    or (sysdate - ofs.submit_datetime > ofs.time_limit and
		       audit_datetime is null and
		       previous_approval_time is null and
		       previous_countersign_time is null))
		   ) where file_status > 0
		   	   and is_del = 0 ]]>
		<isNotEmpty prepend=" and " property="map.file_no">file_no = #map.file_no#</isNotEmpty>
	</sql>

	<select id="selectKonkaoaFilesListForArchiveCount" resultClass="long" parameterClass="files" >
		select count(*) from (
		   <include refid="sf-selectFilesListForArchive" />
		)
	</select>

	<select id="selectKonkaoaFilesListForArchive" resultClass="java.util.HashMap" parameterClass="files" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			<include refid="sf-selectFilesListForArchive" />
			order by id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<select id="selectKonkaoaFilesListForAuditIngCount" resultClass="long" parameterClass="files">
		<![CDATA[
		select count(*) from (select distinct id
					          from (select t_.*
					                  from (select f.*, u.user_name as cur_audit_user_name
					                          from (select a.*
					                                  from (select *
					                                          from KONKAOA_FILES   where 1 = 1	
					                                          ]]>
		<include refid="sf-files" />
		) a left join KONKAOA_FILES_audit_node b on a.id = b.link_id where 1=1
		<isNotEmpty prepend=" and " property="map.is_xxzx"> b.audit_user_id = #map.audit_user_id:DECIMAL#</isNotEmpty>
		union
		select * from KONKAOA_FILES where 1=1
		<include refid="sf-files" />
		<isNotEmpty prepend=" and " property="map.is_xxzx">SUBMIT_USER_ID = #map.audit_user_id:DECIMAL#</isNotEmpty>
	    <![CDATA[) f 
	    left join konka_pe_prod_user u on f.cur_audit_user_id = u.id
	    ]]>
			where 1=1
			<isNotEmpty prepend=" and " property="map.konka_dept_id"> f.submit_user_id in (select id from konka_pe_prod_user u where is_xx_user =0 and dept_id in(select dept_id from konka_dept
				t start with t.dept_id =#map.konka_dept_id# connect by prior t.dept_id =t.par_id))</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.user_dept_id"> f.submit_user_id in (select id from konka_pe_prod_user u where is_xx_user =0 and dept_id in(select dept_id from konka_dept
				t1 start with t1.dept_id =#map.user_dept_id# connect by prior t1.dept_id =t1.par_id))</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.ywy_user_id"> f.submit_user_id = #map.ywy_user_id#</isNotEmpty>
			   <![CDATA[ ) t_ ) a ]]>
			<isEmpty property="map.dept_id"> ) </isEmpty>
</select>
	
	<!-- 正在审核的单据 -->
	<select id="selectKonkaoaFilesPaginatedListForAuditIng" resultMap="filesResultForAuditIngList" parameterClass="files">
		select * from ( select t_.*
		<isEmpty prepend=" , " property="map.not_have_query">rownum rn_</isEmpty>
		from ( select a.* from ( select t_.*
		<isNotEmpty prepend=" , " property="map.not_have_query">rownum rn_</isNotEmpty>
		from (select f.*, u.user_name as cur_audit_user_name ,(SELECT max (g.audit_datetime)
                                  FROM KONKAOA_FILES_AUDIT_NODE g
                                 WHERE g.link_id = f.ID) last_audit_date_time from (select a.*
		from (select * from KONKAOA_FILES where 1 = 1
		<include refid="sf-files" />
		) a left join KONKAOA_FILES_audit_node b on a.id = b.link_id where 1=1
		<isNotEmpty prepend=" and " property="map.is_xxzx">b.audit_user_id = #map.audit_user_id:DECIMAL#</isNotEmpty>
		union
		select * from KONKAOA_FILES where 1=1
		 <include refid="sf-files" />
		<isEmpty property="map.dept_id">
			<isNotEmpty prepend=" and " property="map.is_xxzx">SUBMIT_USER_ID = #map.audit_user_id:DECIMAL#</isNotEmpty>
		</isEmpty>
	    ) f 
	    left join konka_pe_prod_user u on f.cur_audit_user_id = u.id 
	    where 1 = 1
	    <!--根据部门ID查询其部门下人员提交的文件  -->
	    <isNotEmpty prepend=" and " property="map.konka_dept_id"> f.submit_user_id in (select id from konka_pe_prod_user u where is_xx_user =0 and dept_id in(select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.dept_id =t.par_id))</isNotEmpty>
	   	<!-- 用户所在部门 -->
	   	<isNotEmpty prepend=" and " property="map.user_dept_id"> f.submit_user_id in (select id from konka_pe_prod_user u where is_xx_user =0 and dept_id in(select dept_id from konka_dept t1 start with t1.dept_id =#map.user_dept_id# connect by prior t1.dept_id =t1.par_id))</isNotEmpty>
	   	
	   	<isNotEmpty prepend=" and " property="map.ywy_user_id"> f.submit_user_id = #map.ywy_user_id#</isNotEmpty>
	  
	    <isNotEmpty property="map.r3_shop_id">and f.id in (select e.file_id from konka_expense_claims e where e.r3_shop_id = #map.r3_shop_id#)</isNotEmpty>) t_ ) a  where 1 = 1
	    <isNotEmpty prepend=" and " property="map.pks">
			a.ID in <iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
		</isNotEmpty>
		<isEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ order by last_audit_date_time desc ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isEmpty>
		<isNotEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ ) t_ where rn_ <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaoaFilesPaginatedListForAudit" resultMap="filesResultForAuditList" parameterClass="files" >
		select * from ( select t_.*
		<isEmpty prepend=" , " property="map.not_have_query">rownum rn_</isEmpty>
		from ( select a.*, b.c_name as b_name_12, c.c_index, c.c_name
		from (select t1.*, t2.user_name as cur_audit_user_name
		from (select a.*
		<isNotEmpty prepend=" , " property="map.not_have_query">rownum rn_</isNotEmpty>
		from (select t.*, 0 as agent_audit
		from KONKAOA_FILES t where 1 = 1
		<include refid="sf-files" />
		union
		select t2.*, -1 as agent_audit
		from (select *
		from KONKAOA_FILES_audit_node
		where audit_user_id = #cur_audit_user_id#
		and audit_type = 1
		and (audit_result is null or audit_result = 0)) t1
		left join KONKAOA_FILES t2 on t1.link_id = t2.id
		where t2.id is not null) a
		<isNotEmpty prepend=" union " property="map.agentAuditFileIds">
			select b.*, 1 as agent_audit
			from KONKAOA_FILES b
			where id in
			<iterate close=")" open="(" conjunction="," property="map.agentAuditFileIds">#map.agentAuditFileIds[]#</iterate>
		</isNotEmpty>		
			<![CDATA[) t1 left join konka_pe_prod_user t2 on t1.cur_audit_user_id = t2.id ) a
					  left join (select p.link_id, c.c_index, c.c_name
					               from KONKAOA_FILES_property p
					               left join KONKAOA_category c on p.c_index = c.c_index
					              where p.c_type = 12) b on a.id = b.link_id
					  left join (select p.link_id, c.c_index, c.c_name
					               from KONKAOA_FILES_property p
					               left join KONKAOA_category c on p.c_index = c.c_index
					              where p.c_type = 11) c on a.id = c.link_id where 1 = 1
		]]>
		<isNotEmpty prepend=" and " property="map.c_index_11">c.c_index = #map.c_index_11:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.c_index_12">b.c_index = #map.c_index_12:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.file_type_not_1"> <![CDATA[a.file_type<>1]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="file_type">a.file_type = #file_type:DECIMAL#</isNotEmpty>
		order by a.ID desc, c.c_index desc
		<isEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isEmpty>
		<isNotEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ ) t_ where rn_ <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaoaFilesCountForAudit" resultClass="long" parameterClass="files" >
		select count(*) from(select distinct id from (
		select t1.*, t2.user_name as cur_audit_user_name from (select a.* from
		(select t.*, 0 as agent_audit
		from KONKAOA_FILES t where 1 = 1
		<include refid="sf-files" />
		union
		select t2.*, -1 as agent_audit
		from (select *
		from KONKAOA_FILES_audit_node
		where audit_user_id = #cur_audit_user_id#
		and audit_type = 1
		and (audit_result is null or audit_result = 0)) t1
		left join KONKAOA_FILES t2 on t1.link_id = t2.id
		where t2.id is not null)a
		<isNotEmpty prepend=" union " property="map.agentAuditFileIds">
			select b.*, 1 as agent_audit
			from KONKAOA_FILES b
			where id in
			<iterate close=")" open="(" conjunction="," property="map.agentAuditFileIds">#map.agentAuditFileIds[]#</iterate>
		</isNotEmpty>		
			<![CDATA[) t1 left join konka_pe_prod_user t2 on t1.cur_audit_user_id = t2.id ) a
					  left join (select p.link_id, c.c_index, c.c_name
					               from KONKAOA_FILES_property p
					               left join KONKAOA_category c on p.c_index = c.c_index
					              where p.c_type = 12) b on a.id = b.link_id
					  left join (select p.link_id, c.c_index, c.c_name
					               from KONKAOA_FILES_property p
					               left join KONKAOA_category c on p.c_index = c.c_index
					              where p.c_type = 11) c on a.id = c.link_id where 1 = 1
		]]>
		<isNotEmpty prepend=" and " property="map.c_index_11">c.c_index = #map.c_index_11:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.c_index_12">b.c_index = #map.c_index_12:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.file_type_not_1"> <![CDATA[a.file_type<>1]]></isNotEmpty>
		)
	</select>

	<select id="selectKonkaoaFilesList" resultMap="filesResultForList" parameterClass="files" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKAOA_FILES where 1 = 1
		<include refid="sf-files" />
		order by ID desc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaoaFilesPaginatedListFirst" resultMap="filesResultForList" parameterClass="files" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		<![CDATA[
		select * from KONKAOA_FILES where 1 = 1 ]]>
		<include refid="sf-files" /> 
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<select id="selectKonkaoaFilesCount" resultClass="long" parameterClass="files" >
		select count(*) from KONKAOA_FILES where 1 = 1
		<include refid="sf-files" />
	</select>

	<select id="selectKonkaoaFilesCountForPaginatedList" resultClass="long" parameterClass="files" >
	<![CDATA[
			select count(*) from (select distinct id
			  from (select * from KONKAOA_FILES where 1 = 1 ]]>
		<include refid="sf-files" /> 
		<![CDATA[ order by ID desc) a
			  left join (select p.link_id, c.c_index, c.c_name
			               from KONKAOA_FILES_property p
			               left join KONKAOA_category c on p.c_index = c.c_index
			              where p.c_type = 12) b on a.id = b.link_id
			  left join (select p.link_id, c.c_index, c.c_name
			               from KONKAOA_FILES_property p
			               left join KONKAOA_category c on p.c_index = c.c_index
			              where p.c_type = 11) c on a.id = c.link_id where 1=1
		]]>
		<isNotEmpty prepend=" and " property="map.c_index_11">c.c_index = #map.c_index_11:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.c_index_12">b.c_index = #map.c_index_12:DECIMAL#</isNotEmpty>
		)
	</select>

	<select id="selectKonkaoaFilesPaginatedList" resultMap="filesResultForPaginatedList" parameterClass="files" >
		select * from ( select t_.*
		<isEmpty prepend=" , " property="map.not_have_query">rownum rn_</isEmpty>
		from ( select a.*, b.c_name as b_name_12, c.c_index, c.c_name,
		nvl((SELECT COUNT(*) FROM KONKAOA_FILES WHERE LINK_ID=a.ID),0) link_id_count
		 from (select t.*
		<isNotEmpty prepend=" , " property="map.not_have_query">rownum rn_</isNotEmpty>
		from (select * from KONKAOA_FILES where 1 = 1
		<include refid="sf-files" /> 
		<![CDATA[ order by ID desc) t ) a
			  left join (select p.link_id, c.c_index, c.c_name
			               from KONKAOA_FILES_property p
			               left join KONKAOA_category c on p.c_index = c.c_index
			              where p.c_type = 12) b on a.id = b.link_id
			  left join (select p.link_id, c.c_index, c.c_name
			               from KONKAOA_FILES_property p
			               left join KONKAOA_category c on p.c_index = c.c_index
			              where p.c_type = 11) c on a.id = c.link_id where 1=1
		]]>
		<isNotEmpty prepend=" and " property="map.c_index_11">c.c_index = #map.c_index_11:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.c_index_12">b.c_index = #map.c_index_12:DECIMAL#</isNotEmpty>
		order by a.id desc
		<isEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isEmpty>
		<isNotEmpty prepend=" " property="map.not_have_query">
			<![CDATA[ ) t_ where rn_ <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaoaFilesNoMax" resultClass="long" parameterClass="files" >
		select 
		<isNotEmpty prepend=""  property="map.file_no_length">
		max(substr(file_no,$map.file_no_length$ + 1)) 
		</isNotEmpty>
			<isEmpty prepend=""  property="map.file_no_length">
			max(substr(file_no,7)) 
			</isEmpty> from KONKAOA_FILES where 1=1 
		<include refid="sf-files" />
		<isNotEmpty prepend=" and " property="map.file_no_lm">
			<isNotEmpty prepend=""  property="map.file_no_length">
			substr(file_no,0,$map.file_no_length$)=#map.file_no_lm#
		</isNotEmpty>
		<isEmpty prepend=""  property="map.file_no_length">
			substr(file_no,0,6)=#map.file_no_lm#
		</isEmpty>
		</isNotEmpty>
	</select>

	<select id="selectBaseKonkaoaFilesPaginatedList" resultMap="filesResultForList" parameterClass="files" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			select * from KONKAOA_FILES where 1 = 1
			<isNotEmpty prepend=" and " property="submit_user_id">SUBMIT_USER_ID = #submit_user_id:DECIMAL#</isNotEmpty>
			<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
			order by SUBMIT_DATETIME desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	
	<resultMap id="ssuedDocumentForList" class="ssuedDocument">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="TITLE" property="title" jdbcType="VARCHAR" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATETIME" />
		<result column="mod_type" property="mod_type" jdbcType="DECIMAL" />
		<result column="MOD_NAME" property="mod_name" jdbcType="VARCHAR" />
		
		<result column="part_name" property="part_name" jdbcType="VARCHAR" />
		<result column="file_code" property="file_code" jdbcType="VARCHAR" />
		<result column="pass_man" property="pass_man" jdbcType="VARCHAR" />
		<result column="pass_man_name" property="pass_man_name" jdbcType="VARCHAR" />
	</resultMap>


	<sql id="sf-SsuedDocument">
		<isNotEmpty prepend=" and " property="id">t.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_code">t.file_code like '%'|| #file_code:VARCHAR# ||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="title">t.title like '%'|| #title:VARCHAR# ||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_type">t.mod_type =  #mod_type:VARCHAR# </isNotEmpty>
		<isNotEmpty prepend=" and " property="pass_man_name">t.PASS_MAN_NAME = #pass_man_name:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="part_name">t.part_name = #part_name:VARCHAR#</isNotEmpty>
		<isNotEmpty property="map.add_starttime">
			<isNotEmpty prepend=" and " property="map.add_endtime">
				<![CDATA[ to_char(ADD_DATE, 'yyyy-MM-dd') >= #map.add_starttime# and to_char(ADD_DATE, 'yyyy-MM-dd') <= #map.add_endtime#]]>
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.part_name_in">t.part_name in (select t.dept_name from konka_dept t 
					 start with t.dept_name = #map.part_name_in:VARCHAR# connect by prior t.dept_id=t.par_id) 
		</isNotEmpty>
	</sql>

	<select id="selectKonkaoaSsuedDocumentCount" resultClass="long" parameterClass="ssuedDocument">
	select count(*) from (
			          select o.*,p.dept_name as part_name from 
                (select m.id,m.file_code,m.title,m.mod_type,m.mod_name,m.add_date,n.id as pass_man,n.dept_id,m.pass_man_name from 
                (select a.id,a.file_no as file_code,a.title,'notice' as mod_type,'公告通知' as mod_name,a.add_time as add_date,a.draft_man as pass_man_name,a.add_user_id
                        from KONKAOA_DOC_INFO a left join KONKAOA_DOC_RECIPIENT b on a.id = b.link_id
                        where 1 = 1 and ((b.receive_user_type = 0 and b.receive_id = #map.uid:DECIMAL#) or 
                            (b.receive_user_type = 1 and b.receive_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior par_id  = dept_id))  or 
                            (a.receive_type = 0 and (select dept_id from KONKA_PE_PROD_USER where id=a.add_user_id) in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior par_id = dept_id))) and a.IS_DEL = 0
                             order by a.add_time desc
                        )m left join konka_pe_prod_user n on m.add_user_id = n.id
                         )o left join KONKA_DEPT p on o.dept_id=p.dept_id 
            union 
                  select DISTINCT(a.id),a.file_no as file_code,a.file_title as title ,case
                  when a.file_type = 0 then
                   'file'
                  when a.file_type = 1 then
                   'expense'
                  else
                   ''
                end as mod_type,case
                  when a.file_type = 0 then
                   '下发文件'
                  when a.file_type = 1 then
                   '费用申请'
                  else
                   '其它文件'
                end as mod_name,a.submit_datetime as add_date  ,
                 a.id as pass_man ,a.submit_dept_id as org_id,b.real_name as pass_man_name,a.SUBMIT_DEPT as part_name
                    from(select n.* from 
						(select *
						  from KONKAOA_FILES_RECIPIENT t
						 where (t.receive_user_type = 0 and t.receive_id = #map.uid:DECIMAL#)
						    or (t.receive_user_type = 1 and t.receive_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL#  connect by prior par_id = dept_id )))m 
						     left join KONKAOA_FILES n on m.link_id = n.id where n.file_status=2 and n.is_del=0)a left join konka_pe_prod_user b
                               on a.cur_audit_user_id=b.id 
                  )t where 1=1 
            <include refid="sf-SsuedDocument" />
            <!-- update by zhou  select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.par_id =t.dept_id -->
            <isNotEmpty prepend=" and " property="map.konka_dept_id"> t.dept_id in (select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.par_id =t.dept_id)</isNotEmpty>
	   		<isNotEmpty prepend=" and " property="map.ywy_user_id"> t.pass_man = #map.ywy_user_id#</isNotEmpty>
	</select>

	<select id="selectKonkaoaSsuedDocumentPaginatedList" resultMap="ssuedDocumentForList" parameterClass="ssuedDocument">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			    select * from (
			          select o.*,p.dept_name as part_name from 
                (select m.id,m.file_code,m.title,m.mod_type,m.mod_name,m.add_date,n.id as pass_man,n.dept_id,m.pass_man_name from 
                (select a.id,a.file_no as file_code,a.title,'notice' as mod_type,'公告通知' as mod_name,a.add_time as add_date,a.draft_man as pass_man_name,a.add_user_id
                        from KONKAOA_DOC_INFO a left join KONKAOA_DOC_RECIPIENT b on a.id = b.link_id
                        where 1 = 1 and ((b.receive_user_type = 0 and b.receive_id = #map.uid:DECIMAL#) or 
                            (b.receive_user_type = 1 and b.receive_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior par_id  = dept_id))  or 
                            (a.receive_type = 0 and (select dept_id from KONKA_PE_PROD_USER where id=a.add_user_id) in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior par_id  = dept_id))) and a.IS_DEL = 0
                             order by a.add_time desc
                        )m left join konka_pe_prod_user n on m.add_user_id = n.id
                         )o left join KONKA_DEPT p on o.dept_id=p.dept_id 
            union 
                  select DISTINCT(a.id),a.file_no as file_code,a.file_title as title ,case
                  when a.file_type = 0 then
                   'file'
                  when a.file_type = 1 then
                   'expense'
                  else
                   ''
                end as mod_type,case
                  when a.file_type = 0 then
                   '下发文件'
                  when a.file_type = 1 then
                   '费用申请'
                  else
                   '其它文件'
                end as mod_name,a.submit_datetime as add_date  ,
                 a.id as pass_man ,a.submit_dept_id as org_id,b.real_name as pass_man_name,a.SUBMIT_DEPT as part_name
                    from(select n.* from 
						(select *
						  from KONKAOA_FILES_RECIPIENT t
						 where (t.receive_user_type = 0 and t.receive_id = #map.uid:DECIMAL#)
						    or (t.receive_user_type = 1 and t.receive_id in (select dept_id from KONKA_DEPT start with dept_id =#map.receive_org_id:DECIMAL# connect by prior par_id = dept_id)))m 
						     left join KONKAOA_FILES n on m.link_id = n.id where n.file_status=2 and n.is_del=0)a left join konka_pe_prod_user b
                               on a.cur_audit_user_id=b.id 
                  )t where 1=1 
            <include refid="sf-SsuedDocument" />
            <!-- update by zhou  select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.par_id =t.dept_id -->
            <isNotEmpty prepend=" and " property="map.konka_dept_id"> t.dept_id in (select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.par_id =t.dept_id)</isNotEmpty>
	   		<isNotEmpty prepend=" and " property="map.ywy_user_id"> t.pass_man = #map.ywy_user_id#</isNotEmpty>
	   		<isNotEmpty prepend=" and " property="map.start_date"> <![CDATA[t.ADD_DATE >= to_date(#map.start_date#,'yyyy-mm-dd hh24:mi:ss')]]></isNotEmpty>
			order by add_date desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectKonkaoaFilesArchiveCount" resultClass="long" parameterClass="ssuedDocument">
		select count(*) from (
               select o.*,p.dept_name as part_name from 
                (select m.id,m.file_code,m.title,m.mod_type,m.mod_name,m.add_date,n.id as pass_man,n.dept_id,m.pass_man_name from 
                (select a.id,a.file_no as file_code,a.title,'notice' as mod_type,'公告通知' as mod_name,a.add_time as add_date,a.draft_man as pass_man_name
                        from KONKAOA_DOC_INFO a left join KONKAOA_DOC_RECIPIENT b on a.id = b.link_id
                        where 1 = 1 and a.add_user_id in (select id from KONKA_PE_PROD_USER where dept_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior dept_id = par_id)) and a.IS_DEL = 0
                             order by a.add_time desc
                        )m left join konka_pe_prod_user n on m.pass_man_name = n.real_name 
                         )o left join KONKA_DEPT p on o.dept_id=p.dept_id 
            union 
                  select DISTINCT(a.id),a.file_no as file_code,a.file_title as title ,case
                  when a.file_type = 0 then
                   'file'
                  when a.file_type = 1 then
                   'expense'
                  else
                   ''
                end as mod_type,case
                  when a.file_type = 0 then
                   '下发文件'
                  when a.file_type = 1 then
                   '费用申请'
                  else
                   '其它文件'
                end as mod_name,a.submit_datetime as add_date  ,
                 a.submit_user_id as pass_man ,a.submit_dept_id as org_id,b.real_name as pass_man_id,a.SUBMIT_DEPT as part_name
                    from(select n.* from  KONKAOA_FILES n where n.file_status=2 and n.is_del=0 
                          and n.submit_user_id in (select id from KONKA_PE_PROD_USER where dept_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior dept_id = par_id)))a left join konka_pe_prod_user b
                               on a.submit_user_id = b.id 
         )t where 1 = 1 
		<include refid="sf-SsuedDocument" />
		 <!--根据部门ID查询其部门下人员提交的文件  -->
	    <isNotEmpty prepend=" and " property="map.konka_dept_id"> t.dept_id in (select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.dept_id =t.par_id)</isNotEmpty>
	   	<isNotEmpty prepend=" and " property="map.ywy_user_id"> t.pass_man = #map.ywy_user_id#</isNotEmpty>
	  
	</select>
	
	<select id="selectKonkaoaFilesArchivePaginatedList" resultMap="ssuedDocumentForList" parameterClass="ssuedDocument">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			   select * from (
               select o.*,p.dept_name as part_name from 
                (select m.id,m.file_code,m.title,m.mod_type,m.mod_name,m.add_date,n.id as pass_man,n.dept_id,m.pass_man_name from 
                (select a.id,a.file_no as file_code,a.title,'notice' as mod_type,'公告通知' as mod_name,a.add_time as add_date,a.add_user_name as pass_man_name
                        from KONKAOA_DOC_INFO a left join KONKAOA_DOC_RECIPIENT b on a.id = b.link_id
                        where 1 = 1 and a.add_user_id in (select id from KONKA_PE_PROD_USER where dept_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior dept_id = par_id)) and a.IS_DEL = 0
                             order by a.add_time desc
                        )m left join konka_pe_prod_user n on m.pass_man_name = n.real_name 
                         )o left join KONKA_DEPT p on o.dept_id=p.dept_id 
            union 
                  select DISTINCT(a.id),a.file_no as file_code,a.file_title as title ,case
                  when a.file_type = 0 then
                   'file'
                  when a.file_type = 1 then
                   'expense'
                  else
                   ''
                end as mod_type,case
                  when a.file_type = 0 then
                   '下发文件'
                  when a.file_type = 1 then
                   '费用申请'
                  else
                   '其它文件'
                end as mod_name,a.submit_datetime as add_date  ,
                 a.submit_user_id as pass_man ,a.submit_dept_id as org_id,b.real_name as pass_man_id,a.SUBMIT_DEPT as part_name
                    from(select n.* from  KONKAOA_FILES n where n.file_status=2 and n.is_del=0 
                          and n.submit_user_id in (select id from KONKA_PE_PROD_USER where dept_id in (select dept_id from KONKA_DEPT start with dept_id = #map.receive_org_id:DECIMAL# connect by prior dept_id = par_id)))a left join konka_pe_prod_user b
                              on a.submit_user_id = b.id
         )t where 1 = 1 
            <include refid="sf-SsuedDocument" />
             <!--根据部门ID查询其部门下人员提交的文件  -->
	    <isNotEmpty prepend=" and " property="map.konka_dept_id"> t.dept_id in (select dept_id from konka_dept t start with t.dept_id =#map.konka_dept_id# connect by prior t.dept_id =t.par_id)</isNotEmpty>
	   	<isNotEmpty prepend=" and " property="map.ywy_user_id"> t.pass_man = #map.ywy_user_id#</isNotEmpty>
	   	<!-- 根据申请人查询 -->
	   	<isNotEmpty prepend=" and " property="map.apply_man"> t.PASS_MAN_NAME like '%'|| #map.apply_man:VARCHAR# ||'%'</isNotEmpty>
	  	
			order by add_date desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>


	<select id="selectKonkaoaFilesForExpenseClaims" resultMap="filesResult" parameterClass="files" >
		select a.*, b.content from (select * from KONKAOA_FILES where 1=1
			<include refid="sf-files" />
			) a left join KONKAOA_FILES_CONTENT b ON a.id = b.link_id order by a.id desc
	</select>
	
	
	<select id="selectMyAuditOfKonkaoaFilesPaginatedList" resultMap="filesResultForList" parameterClass="files" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			SELECT a.*
				  FROM KONKAOA_FILES a
				 WHERE a.FILE_STATUS IN (1, 2)
				 	   and a.ID IN
				          (SELECT DISTINCT LINK_ID
				             FROM KONKAOA_FILES_AUDIT_NODE b
				            WHERE (b.AUDIT_USER_ID = #map.audit_user_id# OR b.AGENT_AUDIT_USER_ID = #map.agent_audit_user_id#)
				                  <![CDATA[and nvl(b.AUDIT_DATETIME,sysdate) >= to_char(#map.audit_datetime#,'YYYY-MM-DD HH24:MI:SS')]]>
				                  )
				       <isNotEmpty prepend=" and " property="file_title">a.FILE_TITLE like '%'|| #file_title# ||'%'</isNotEmpty>
					   <isNotEmpty prepend=" and " property="file_no">a.FILE_NO = #file_no#</isNotEmpty>
			order by a.SUBMIT_DATETIME desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectMyAuditOfKonkaoaFilesCount"  resultClass="long" parameterClass="files" >
			select count(1) from (
				SELECT a.*
					  FROM KONKAOA_FILES a
					 WHERE a.FILE_STATUS IN (1, 2)
				 	   and a.ID IN
					          (SELECT DISTINCT LINK_ID
					             FROM KONKAOA_FILES_AUDIT_NODE b
					            WHERE (b.AUDIT_USER_ID = #map.audit_user_id# OR b.AGENT_AUDIT_USER_ID = #map.agent_audit_user_id#)
					                  <![CDATA[and nvl(b.AUDIT_DATETIME,sysdate) >= to_char(#map.audit_datetime#,'YYYY-MM-DD HH24:MI:SS')]]>
					                  )
					       <isNotEmpty prepend=" and " property="file_title">a.FILE_TITLE like '%'|| #file_title# ||'%'</isNotEmpty>
					       <isNotEmpty prepend=" and " property="file_no">a.FILE_NO = #file_no#</isNotEmpty>
			)
	</select>
	

	<insert id="insertKonkaoaFiles" parameterClass="files">
		<selectKey resultClass="long" keyProperty="id">select KONKAOA_FILES_SEQ.nextval as id from dual</selectKey>	
		<![CDATA[insert into KONKAOA_FILES (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>
			<isNotNull prepend="," property="apply_user_name">APPLY_USER_NAME</isNotNull>
			<isNotNull prepend="," property="apply_user_tel">APPLY_USER_TEL</isNotNull>
			<isNotNull prepend="," property="submit_dept">SUBMIT_DEPT</isNotNull>
			<isNotNull prepend="," property="submit_dept_id">SUBMIT_DEPT_ID</isNotNull>
			<isNotNull prepend="," property="submit_user">SUBMIT_USER</isNotNull>
			<isNotNull prepend="," property="submit_user_id">SUBMIT_USER_ID</isNotNull>
			<isNotNull prepend="," property="is_forward">IS_FORWARD</isNotNull>
			<isNotNull prepend="," property="file_title">FILE_TITLE</isNotNull>
			<isNotNull prepend="," property="apply_people">APPLY_PEOPLE</isNotNull>
			<isNotNull prepend="," property="submit_datetime">SUBMIT_DATETIME</isNotNull>
			<isNotNull prepend="," property="cur_audit_user_id">CUR_AUDIT_USER_ID</isNotNull>
			<isNotNull prepend="," property="file_status">FILE_STATUS</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE</isNotNull>
			<isNotNull prepend="," property="is_stamp">IS_STAMP</isNotNull>
			<isNotNull prepend="," property="archive_datetime">ARCHIVE_DATETIME</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>
			<isNotNull prepend="," property="file_no">FILE_NO</isNotNull>
			<isNotNull prepend="," property="file_dense">FILE_DENSE</isNotNull>
			<isNotNull prepend="," property="time_limit">TIME_LIMIT</isNotNull>
			<isNotNull prepend="," property="doc_id">DOC_ID</isNotNull>
			<isNotNull prepend="," property="audit_type">AUDIT_TYPE</isNotNull>
			<isNotNull prepend="," property="file_type">FILE_TYPE</isNotNull>
			<isNotNull prepend="," property="audit_node_id">AUDIT_NODE_ID</isNotNull>
			<isNotNull prepend="," property="is_node">IS_NODE</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="apply_user_name">#apply_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="apply_user_tel">#apply_user_tel:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_dept">#submit_dept:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_dept_id">#submit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="submit_user">#submit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_user_id">#submit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_forward">#is_forward:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_title">#file_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="apply_people">#apply_people:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_datetime">#submit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="cur_audit_user_id">#cur_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_status">#file_status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="order_value">#order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_stamp">#is_stamp:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="archive_datetime">#archive_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_no">#file_no:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_dense">#file_dense:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="time_limit">#time_limit:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="doc_id">#doc_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_type">#audit_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_type">#file_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_node_id">#audit_node_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_node">#is_node:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaoaFiles" parameterClass="files">
		update KONKAOA_FILES
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="apply_user_name">APPLY_USER_NAME = #apply_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="apply_user_tel">APPLY_USER_TEL = #apply_user_tel:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_dept">SUBMIT_DEPT = #submit_dept:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_dept_id">SUBMIT_DEPT_ID = #submit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="submit_user">SUBMIT_USER = #submit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_user_id">SUBMIT_USER_ID = #submit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_forward">IS_FORWARD = #is_forward:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_title">FILE_TITLE = #file_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="apply_people">APPLY_PEOPLE = #apply_people:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="submit_datetime">SUBMIT_DATETIME = #submit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="cur_audit_user_id">CUR_AUDIT_USER_ID = #cur_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_status">FILE_STATUS = #file_status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_stamp">IS_STAMP = #is_stamp:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="archive_datetime">ARCHIVE_DATETIME = #archive_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="file_no">FILE_NO = #file_no:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_dense">FILE_DENSE = #file_dense:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="time_limit">TIME_LIMIT = #time_limit:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="doc_id">DOC_ID = #doc_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="file_type">FILE_TYPE = #file_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_node_id">AUDIT_NODE_ID = #audit_node_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_node">IS_NODE = #is_node:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaoaFiles" parameterClass="files">
		update KONKAOA_FILES set is_del = 1 where
		<!--  <isNotEmpty prepend=" " property="file_no">FILE_NO = #file_no:VARCHAR#</isNotEmpty> -->
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
</sqlMap>