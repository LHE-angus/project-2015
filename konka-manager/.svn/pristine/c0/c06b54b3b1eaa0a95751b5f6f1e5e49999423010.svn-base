<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_ORDER_INFO_AUDIT">

	<typeAlias alias="konkaOrderInfoAudit" type="com.ebiz.mmt.domain.KonkaOrderInfoAudit" />

	

	<resultMap id="konkaOrderInfoAuditResultForList" class="konkaOrderInfoAudit">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="LINK_ID" property="link_id" jdbcType="DECIMAL" />
		<result column="AUDIT_TYPE" property="audit_type" jdbcType="DECIMAL" />
		<result column="AUDIT_LEVEL" property="audit_level" jdbcType="DECIMAL" />
		<result column="AUDIT_USER_ID" property="audit_user_id" jdbcType="DECIMAL" />
		<result column="AUDIT_USER" property="audit_user" jdbcType="VARCHAR" />
		<result column="AUDIT_COMMENT" property="audit_comment" jdbcType="VARCHAR" />
		<result column="AUDIT_DATETIME" property="audit_datetime" jdbcType="DATETIME" />
		<result column="AGENT_AUDIT_USER_ID" property="agent_audit_user_id" jdbcType="DECIMAL" />
		<result column="AGENT_AUDIT_USER" property="agent_audit_user" jdbcType="VARCHAR" />
		<result column="AUDIT_RESULT" property="audit_result" jdbcType="DECIMAL" />
		<result column="AUDIT_DEPT_ID" property="audit_dept_id" jdbcType="DECIMAL" />
		<result column="AUDIT_DEPT_NAME" property="audit_dept_name" jdbcType="VARCHAR" />
		<result column="AGENT_AUDIT_DEPT_ID" property="agent_audit_dept_id" jdbcType="DECIMAL" />
		<result column="AGENT_AUDIT_DEPT_NAME" property="agent_audit_dept_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="konkaOrderInfoAuditResult" class="konkaOrderInfoAudit" extends="konkaOrderInfoAuditResultForList">
	</resultMap>
	
	<resultMap id="konkaOrderInfoAuditWithRoleInfoResultForList" class="konkaOrderInfoAudit" extends="konkaOrderInfoAuditResultForList">
		<result column="ROLE_ID" property="map.role_id" jdbcType="DECIMAL" />
		<result column="ROLE_NAME" property="map.role_name" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-konkaOrderInfoAudit">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">a.LINK_ID = #link_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_type">a.AUDIT_TYPE = #audit_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_level">a.AUDIT_LEVEL = #audit_level:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_user_id">a.AUDIT_USER_ID = #audit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_user">a.AUDIT_USER = #audit_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_comment">a.AUDIT_COMMENT = #audit_comment:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_datetime">a.AUDIT_DATETIME = #audit_datetime:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_user_id">a.AGENT_AUDIT_USER_ID = #agent_audit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_user">a.AGENT_AUDIT_USER = #agent_audit_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_result">a.AUDIT_RESULT = #audit_result:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_dept_id">a.AUDIT_DEPT_ID = #audit_dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_dept_name">a.AUDIT_DEPT_NAME = #audit_dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_dept_id">a.AGENT_AUDIT_DEPT_ID = #agent_audit_dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_dept_name">a.AGENT_AUDIT_DEPT_NAME = #agent_audit_dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.fgs_dept_id">
			a.AUDIT_DEPT_ID in (
				select dept_id  from KONKA_DEPT
                  start with dept_id = #map.fgs_dept_id#
                  connect by prior dept_id = par_id
			)
		</isNotEmpty>
	
	
	</sql>

	<select id="selectKonkaOrderInfoAudit" resultMap="konkaOrderInfoAuditResult" parameterClass="konkaOrderInfoAudit" >
		select * from KONKA_ORDER_INFO_AUDIT a where 1 = 1
		<include refid="sf-konkaOrderInfoAudit" />
	</select>

	<select id="selectKonkaOrderInfoAuditList" resultMap="konkaOrderInfoAuditResultForList" parameterClass="konkaOrderInfoAudit" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_ORDER_INFO_AUDIT a where 1 = 1
		<include refid="sf-konkaOrderInfoAudit" />
		<!-- order by ID asc -->
		order by a.audit_datetime , a.id 
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaOrderInfoAuditCount" resultClass="long" parameterClass="konkaOrderInfoAudit" >
		select count(*) from KONKA_ORDER_INFO_AUDIT a where 1 = 1
		<include refid="sf-konkaOrderInfoAudit" />
	</select>

	<select id="selectKonkaOrderInfoAuditPaginatedList" resultMap="konkaOrderInfoAuditResult" parameterClass="konkaOrderInfoAudit" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_ORDER_INFO_AUDIT a where 1 = 1
		<include refid="sf-konkaOrderInfoAudit" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- add by Li Ka 2011-12-08  订单对应的审核记录包含角色名称和ID -->
	<select id="selectKonkaOrderInfoAuditWithRoleInfoList" resultMap="konkaOrderInfoAuditWithRoleInfoResultForList" parameterClass="konkaOrderInfoAudit" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select distinct a.*, ri.role_id, ri.role_name
		  from KONKA_ORDER_INFO_AUDIT a
		  left join konka_dept_tree b on a.audit_dept_id=b.dept_id
		  left join KONKA_ORDER_AUDIT_PROCESS c on c.add_dept_id = b.root_id
		  left join KONKA_ORDER_AUDIT_PROCESS_NODE d on d.audit_proces_id = c.id and d.audit_level = a.audit_level
		  left join konka_pe_role_user ru on a.audit_user_id = ru.user_id
		  left join konka_pe_role_info ri on ru.role_id = ri.role_id and d.role_id = ri.role_id
		 where ri.role_id is not null
		<include refid="sf-konkaOrderInfoAudit" />
		<!-- order by ID asc -->
		order by a.audit_datetime desc , a.id desc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	<!-- @2011-12-26  author张续峰  订单对应的审核记录中最高的审核级别 -->
	<select id="selectKonkaOrderInfoAuditWithMaxAuditLevel" resultClass="long" parameterClass="konkaOrderInfoAudit" >
		select max(a.audit_level)
		  from KONKA_ORDER_INFO_AUDIT a
			 where 1 = 1
		     and a.link_id = #map.link_id#
	</select>

	<insert id="insertKonkaOrderInfoAudit" parameterClass="konkaOrderInfoAudit">
		<selectKey resultClass="long" keyProperty="id">select SEQ_KONKA_ORDER.nextval as id from dual</selectKey>
		<![CDATA[insert into KONKA_ORDER_INFO_AUDIT (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>	
			<isNotNull prepend="," property="audit_type">AUDIT_TYPE</isNotNull>	
			<isNotNull prepend="," property="audit_level">AUDIT_LEVEL</isNotNull>	
			<isNotNull prepend="," property="audit_user_id">AUDIT_USER_ID</isNotNull>	
			<isNotNull prepend="," property="audit_user">AUDIT_USER</isNotNull>	
			<isNotNull prepend="," property="audit_comment">AUDIT_COMMENT</isNotNull>	
			<isNotNull prepend="," property="audit_datetime">AUDIT_DATETIME</isNotNull>	
			<isNotNull prepend="," property="agent_audit_user_id">AGENT_AUDIT_USER_ID</isNotNull>	
			<isNotNull prepend="," property="agent_audit_user">AGENT_AUDIT_USER</isNotNull>	
			<isNotNull prepend="," property="audit_result">AUDIT_RESULT</isNotNull>	
			<isNotNull prepend="," property="audit_dept_id">AUDIT_DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="audit_dept_name">AUDIT_DEPT_NAME</isNotNull>	
			<isNotNull prepend="," property="agent_audit_dept_id">AGENT_AUDIT_DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="agent_audit_dept_name">AGENT_AUDIT_DEPT_NAME</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_type">#audit_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_level">#audit_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user_id">#audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user">#audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_comment">#audit_comment:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_datetime">#audit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user_id">#agent_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user">#agent_audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_result">#audit_result:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_dept_id">#audit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_dept_name">#audit_dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="agent_audit_dept_id">#agent_audit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_dept_name">#agent_audit_dept_name:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaOrderInfoAudit" parameterClass="konkaOrderInfoAudit">
		update KONKA_ORDER_INFO_AUDIT
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_level">AUDIT_LEVEL = #audit_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user_id">AUDIT_USER_ID = #audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user">AUDIT_USER = #audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_comment">AUDIT_COMMENT = #audit_comment:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_datetime">AUDIT_DATETIME = #audit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user_id">AGENT_AUDIT_USER_ID = #agent_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user">AGENT_AUDIT_USER = #agent_audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_result">AUDIT_RESULT = #audit_result:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_dept_id">AUDIT_DEPT_ID = #audit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_dept_name">AUDIT_DEPT_NAME = #audit_dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="agent_audit_dept_id">AGENT_AUDIT_DEPT_ID = #agent_audit_dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_dept_name">AGENT_AUDIT_DEPT_NAME = #agent_audit_dept_name:VARCHAR#</isNotNull>
		</dynamic>
		where 1 = 1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" and " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaOrderInfoAudit" parameterClass="konkaOrderInfoAudit">
		delete from KONKA_ORDER_INFO_AUDIT where 1 = 1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" and " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>