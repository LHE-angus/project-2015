<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_AUDIT_LIST_INFO">

	<typeAlias alias="konkaAuditListInfo" type="com.ebiz.mmt.domain.KonkaAuditListInfo" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaAuditListInfo" />
		<flushOnExecute statement="updateKonkaAuditListInfo" />
		<flushOnExecute statement="deleteKonkaAuditListInfo" />
	</cacheModel>

	<resultMap id="konkaAuditListInfoResultForList" class="konkaAuditListInfo">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="BACK_ID" property="back_id" jdbcType="VARCHAR" />
		<result column="LINK_ID" property="link_id" jdbcType="DECIMAL" />
		<result column="LINK_TYPE" property="link_type" jdbcType="VARCHAR" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="OPER_TYPE" property="oper_type" jdbcType="VARCHAR" />
		<result column="OPER_REASON" property="oper_reason" jdbcType="VARCHAR" />
		<result column="STATUS" property="status" jdbcType="VARCHAR" />
		<result column="SQ_NAME" property="sq_name" jdbcType="VARCHAR" />
		<result column="CUR_AUDIT_ROLE_ID" property="cur_audit_role_id" jdbcType="DECIMAL" />
		<result column="CREATE_DATE" property="create_date" jdbcType="TIMESTAMP" />
		<result column="MODIFY_DATE" property="modify_date" jdbcType="TIMESTAMP" />
		<result column="CREATE_USER_ID" property="create_user_id" jdbcType="DECIMAL" />
		<result column="MODIFY_USER_ID" property="modify_user_id" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="konkaAuditListInfoResult" class="konkaAuditListInfo" extends="konkaAuditListInfoResultForList">
	</resultMap>
	
	<resultMap id="konkaAuditListInfoResultone" class="konkaAuditListInfo" extends="konkaAuditListInfoResultForList">
		<result column="REAL_NAME" property="map.real_name" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="konkaAuditListInfoResultHistory" class="konkaAuditListInfo" extends="konkaAuditListInfoResultForList">
		<result column="CREATE_NAME" property="map.create_name" jdbcType="VARCHAR" />
		<result column="MODIFY_NAME" property="map.modify_name" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-konkaAuditListInfo">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="back_id">a.BACK_ID = #back_id:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">a.LINK_ID = #link_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_type">a.LINK_TYPE = #link_type:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">a.DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="oper_type">a.OPER_TYPE = #oper_type:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="oper_reason">a.OPER_REASON = #oper_reason:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="status">a.STATUS = #status:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sq_name">a.SQ_NAME = #sq_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cur_audit_role_id">a.CUR_AUDIT_ROLE_ID = #cur_audit_role_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="create_date">a.CREATE_DATE = #create_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="modify_date">a.MODIFY_DATE = #modify_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="create_user_id">a.CREATE_USER_ID = #create_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="modify_user_id">a.MODIFY_USER_ID = #modify_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">a.IS_DEL = #is_del:DECIMAL#</isNotEmpty>
	</sql>

	<select id="selectKonkaAuditListInfo" resultMap="konkaAuditListInfoResultone" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		select a.*,b.real_name from KONKA_AUDIT_LIST_INFO a 
		left join konka_pe_prod_user b on a.CREATE_USER_ID=b.id where 1 = 1
		<include refid="sf-konkaAuditListInfo" />
	</select>

	<select id="selectKonkaAuditListInfoList" resultMap="konkaAuditListInfoResultHistory" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select a.*,u1.user_name create_name,u2.user_name modify_name from ( ]]>
		</isNotEmpty>
		select a.*,u1.user_name create_name,u2.user_name modify_name from KONKA_AUDIT_LIST_INFO a 
		left join konka_pe_prod_user u1 on u1.id=a.create_user_id
		left join konka_pe_prod_user u2 on u2.id=a.modify_user_id
		where 1 = 1
		<include refid="sf-konkaAuditListInfo" />
		<!-- order by ID asc -->
		order by CREATE_DATE desc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaAuditListInfoCount" resultClass="long" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		select count(*) from KONKA_AUDIT_LIST_INFO a 
		<isNotEmpty property="map.audited" prepend=" ">
		   left join (select * from KONKAOA_FILES_AUDIT_NODE where NODE_TYPE=4 
		   <isNotEmpty property="map.role1" prepend=" and ">
		       AUDIT_LEVEL=1
		   </isNotEmpty>
		   <isNotEmpty property="map.role2" prepend=" and ">
		       AUDIT_LEVEL=2
		   </isNotEmpty>
		   ) b on a.id=b.link_id 
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.link_shop">
		    left join konka_r3_shop shop on shop.id=a.link_id
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.link_store">
		    left join konka_r3_store store on store.store_id=a.link_id
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.link_agent">
		    left join j_base_partner agent on agent.PARTNER_ID=a.link_id
		</isNotEmpty>
		where 1 = 1
		<include refid="sf-konkaAuditListInfo" />
		<isNotEmpty property="map.wait_audit" prepend=" ">
		    <isNotEmpty property="map.role_id" prepend=" and ">a.CUR_AUDIT_ROLE_ID = #map.role_id:DECIMAL#</isNotEmpty>
		    and a.STATUS != 2
		</isNotEmpty>
		<isNotEmpty property="map.audited" prepend=" and ">
		    b.link_id is not null
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.name_like">
		    <isNotEmpty prepend=" " property="map.link_shop">
			    shop.customer_name like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
			<isNotEmpty prepend=" " property="map.link_store">
			    store.STORE_NAME like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
			<isNotEmpty prepend=" " property="map.link_agent">
			    agent.PARTNER_NAME like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.ope_date_begin">
		    <![CDATA[to_char(a.CREATE_DATE,'yyyy-MM-dd') >= #map.ope_date_begin:VARCHAR#]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.ope_date_end">
		    <![CDATA[to_char(a.CREATE_DATE,'yyyy-MM-dd') <= #map.ope_date_end:VARCHAR#]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaAuditListInfoPaginatedList" resultMap="konkaAuditListInfoResult" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_AUDIT_LIST_INFO a where 1 = 1
		<include refid="sf-konkaAuditListInfo" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaAuditListInfo" parameterClass="konkaAuditListInfo">
		<selectKey resultClass="long" keyProperty="id">select SEQ_KONKA_AUDIT_LIST.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_AUDIT_LIST_INFO (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="back_id">BACK_ID</isNotNull>	
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>	
			<isNotNull prepend="," property="link_type">LINK_TYPE</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="oper_type">OPER_TYPE</isNotNull>	
			<isNotNull prepend="," property="oper_reason">OPER_REASON</isNotNull>	
			<isNotNull prepend="," property="status">STATUS</isNotNull>	
			<isNotNull prepend="," property="sq_name">SQ_NAME</isNotNull>	
			<isNotNull prepend="," property="cur_audit_role_id">CUR_AUDIT_ROLE_ID</isNotNull>	
			<isNotNull prepend="," property="create_date">CREATE_DATE</isNotNull>	
			<isNotNull prepend="," property="modify_date">MODIFY_DATE</isNotNull>	
			<isNotNull prepend="," property="create_user_id">CREATE_USER_ID</isNotNull>	
			<isNotNull prepend="," property="modify_user_id">MODIFY_USER_ID</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="back_id">#back_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_type">#link_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="oper_type">#oper_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="oper_reason">#oper_reason:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="status">#status:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="sq_name">#sq_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="cur_audit_role_id">#cur_audit_role_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="create_date">#create_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="modify_date">#modify_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="create_user_id">#create_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="modify_user_id">#modify_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaAuditListInfo" parameterClass="KonkaAuditListInfo">
		update KONKA_AUDIT_LIST_INFO
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="back_id">BACK_ID = #back_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_type">LINK_TYPE = #link_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="oper_type">OPER_TYPE = #oper_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="oper_reason">OPER_REASON = #oper_reason:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="status">STATUS = #status:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="sq_name">SQ_NAME = #sq_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="cur_audit_role_id">CUR_AUDIT_ROLE_ID = #cur_audit_role_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="create_date">CREATE_DATE = #create_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="modify_date">MODIFY_DATE = #modify_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="create_user_id">CREATE_USER_ID = #create_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="modify_user_id">MODIFY_USER_ID = #modify_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>
	
	<!-- 更加类型，id更新数据 -->
	<update id="modifyKonkaAuditListInfoForNew" parameterClass="KonkaAuditListInfo">
		update KONKA_AUDIT_LIST_INFO
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="back_id">BACK_ID = #back_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_type">LINK_TYPE = #link_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="oper_type">OPER_TYPE = #oper_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="oper_reason">OPER_REASON = #oper_reason:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="status">STATUS = #status:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="sq_name">SQ_NAME = #sq_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="cur_audit_role_id">CUR_AUDIT_ROLE_ID = #cur_audit_role_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="create_date">CREATE_DATE = #create_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="modify_date">MODIFY_DATE = #modify_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="create_user_id">CREATE_USER_ID = #create_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="modify_user_id">MODIFY_USER_ID = #modify_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
		</dynamic>
		where 1=1
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_type">LINK_TYPE = #link_type#</isNotEmpty>
	</update>

	<delete id="deleteKonkaAuditListInfo" parameterClass="KonkaAuditListInfo">
		delete from KONKA_AUDIT_LIST_INFO where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

	<!-- 查询审批列表返回map -->
	<select id="selectKonkaAuditListInfoListForMap" resultClass="java.util.HashMap" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		 select a.*,to_char(a.CREATE_DATE,'yyyy-MM-dd') as add_date,d.dept_name,decode(a.LINK_TYPE,'r3_shop','客户','store','门店','agent','网点') AUDIT_TYPE,
		 <isNotEmpty prepend=" " property="map.r3_shop">
		     s.customer_name as TYPE_NAME,s.r3_code as TYPE_CODE,
		 </isNotEmpty>
		 <isNotEmpty prepend=" " property="map.store">
		     s.STORE_NAME as TYPE_NAME, s.store_id as TYPE_CODE,
		 </isNotEmpty>
		 <isNotEmpty prepend=" " property="map.agent">
		     p.PARTNER_NAME as TYPE_NAME,p.partner_sn as TYPE_CODE,
		 </isNotEmpty>
		 decode(a.OPER_TYPE,'modify','变更','stop','停用','start','启用') OPER_NAME,
		 u.user_name as CREAT_NAME,u1.user_name as MODIFY_NAME
		 from KONKA_AUDIT_LIST_INFO a
		 left join konka_dept d on a.dept_id = d.dept_id
		 left join konka_pe_prod_user u on a.create_user_id=u.id
		 left join konka_pe_prod_user u1 on a.modify_user_id=u1.id
		 <isNotEmpty prepend=" " property="map.r3_shop">
		     left join konka_r3_shop s on a.link_id=s.id
		 </isNotEmpty>
		 <isNotEmpty prepend=" " property="map.store">
		     left join konka_r3_store s on a.link_id=s.STORE_ID
		 </isNotEmpty>
		 <isNotEmpty prepend=" " property="map.agent">
		     left join j_base_partner p on a.link_id=p.PARTNER_ID
		 </isNotEmpty>
		 <isNotEmpty property="map.audited" prepend=" ">
		   left join (select * from KONKAOA_FILES_AUDIT_NODE where NODE_TYPE=4 
		   <isNotEmpty property="map.role1" prepend=" and ">
		       AUDIT_LEVEL=1
		   </isNotEmpty>
		   <isNotEmpty property="map.role2" prepend=" and ">
		       AUDIT_LEVEL=2
		   </isNotEmpty>
		   ) b on a.id=b.link_id 
		</isNotEmpty>
		 where 1 = 1
		<include refid="sf-konkaAuditListInfo" />
		<isNotEmpty property="map.wait_audit" prepend=" ">
		    <isNotEmpty property="map.role_id" prepend=" and ">a.CUR_AUDIT_ROLE_ID = #map.role_id:DECIMAL#</isNotEmpty>
		    and a.STATUS != 2
		</isNotEmpty>
		<isNotEmpty property="map.audited" prepend=" and ">
		    b.link_id is not null
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.name_like">
		    <isNotEmpty prepend=" " property="map.link_shop">
			    s.customer_name like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
			<isNotEmpty prepend=" " property="map.link_store">
			    s.STORE_NAME like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
			<isNotEmpty prepend=" " property="map.link_agent">
			    p.PARTNER_NAME like '%'|| #map.name_like:VARCHAR# || '%'
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.ope_date_begin">
		    <![CDATA[to_char(a.CREATE_DATE,'yyyy-MM-dd') >= #map.ope_date_begin:VARCHAR#]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.ope_date_end">
		    <![CDATA[to_char(a.CREATE_DATE,'yyyy-MM-dd') <= #map.ope_date_end:VARCHAR#]]>
		</isNotEmpty>
		order by id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 返回申请详情 -->
	<select id="selectKonkaAuditListInfoForMap" resultClass="java.util.HashMap" parameterClass="konkaAuditListInfo" cacheModel="oneDayCache">
		select A.ID, A.BACK_ID, A.LINK_ID, A.LINK_TYPE, A.DEPT_ID, A.OPER_TYPE, A.OPER_REASON, A.STATUS, A.SQ_NAME, A.CUR_AUDIT_ROLE_ID, 
			TO_CHAR(A.CREATE_DATE,'yyyy-mm-dd hh24:mi:ss') AS CREATE_DATE, TO_CHAR(A.modify_date,'yyyy-mm-dd hh24:mi:ss') AS modify_date, 
			A.CREATE_USER_ID, A.MODIFY_USER_ID,D.DEPT_NAME,U.USER_NAME
			from KONKA_AUDIT_LIST_INFO A
			LEFT JOIN KONKA_DEPT D ON A.DEPT_ID=D.DEPT_ID
			LEFT JOIN KONKA_PE_PROD_USER U ON U.ID=A.CREATE_USER_ID
		where 1 = 1
		<isNotEmpty prepend=" and " property="id">A.ID = #id:DECIMAL#</isNotEmpty>
	</select>
</sqlMap>