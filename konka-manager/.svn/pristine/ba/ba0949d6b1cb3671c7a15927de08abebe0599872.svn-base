<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_YJGL_PLAN_FP">

	<typeAlias alias="konkaYjglPlanFp" type="com.ebiz.mmt.domain.KonkaYjglPlanFp" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaYjglPlanFp" />
		<flushOnExecute statement="updateKonkaYjglPlanFp" />
		<flushOnExecute statement="deleteKonkaYjglPlanFp" />
	</cacheModel>

	<resultMap id="konkaYjglPlanFpResultForList" class="konkaYjglPlanFp">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="PLAN_ID" property="plan_id" jdbcType="DECIMAL" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="PLAN_YEAR" property="plan_year" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="PD_ID" property="pd_id" jdbcType="DECIMAL" />
		<result column="PD_NAME" property="pd_name" jdbcType="VARCHAR" />
		<result column="NUM" property="num" jdbcType="DECIMAL" />
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="IS_CONFIRM" property="is_confirm" jdbcType="DECIMAL" />
		<result column="CONFIRM_USER_ID" property="confirm_user_id" jdbcType="DECIMAL" />
		<result column="CONFIRM_DATE" property="confirm_date" jdbcType="TIMESTAMP" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="TYPE_ID" property="type_id" jdbcType="DECIMAL" />
		<result column="SY_DATE" property="sy_date" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="konkaYjglPlanFpResult" class="konkaYjglPlanFp" extends="konkaYjglPlanFpResultForList">
	</resultMap>
	
	<resultMap id="konkaYjglPlanFpAndDeptNameResult" class="konkaYjglPlanFp" extends="konkaYjglPlanFpResultForList">
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
		<result column="USER_NAME" property="map.user_name" jdbcType="VARCHAR" />
		<result column="STORE_NAME" property="map.store_name" jdbcType="VARCHAR" />
		<result column="TYPE_NAME" property="map.type_name" jdbcType="VARCHAR" />
		<result column="SY_NUM" property="map.sy_num" jdbcType="DECIMAL" />
		<result column="XY_NUM" property="map.xy_num" jdbcType="DECIMAL" />
	</resultMap>
	
	<resultMap id="konkaYjglPlanFpAndTjResult" class="konkaYjglPlanFp" >
		<result column="BRA_NAME" property="map.bra_name" jdbcType="VARCHAR" />
		<result column="STORE_NAME" property="map.store_name" jdbcType="VARCHAR" />
		<result column="STORE_ID" property="map.store_id" jdbcType="DECIMAL" />
		<result column="DEPT_ID" property="map.dept_id" jdbcType="DECIMAL" />
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
		<result column="PD_NAME" property="map.pd_name" jdbcType="VARCHAR" />
		<result column="SY_DATE" property="map.sy_date" jdbcType="TIMESTAMP" />
		<result column="ID" property="map.id" jdbcType="DECIMAL" />
		<result column="SY_NUM" property="map.sy_num" jdbcType="DECIMAL" />
		<result column="XY_NUM" property="map.xy_num" jdbcType="DECIMAL" />
		<result column="UP_DATE" property="map.up_date" jdbcType="TIMESTAMP" />
		<result column="FJ_ID" property="map.fj_id" jdbcType="DECIMAL" />
		<result column="CXY_NAME" property="map.cxy_name" jdbcType="VARCHAR" />
		<result column="CXY_PHONE" property="map.cxy_phone" jdbcType="VARCHAR" />
		<result column="YWY_NAME" property="map.ywy_name" jdbcType="VARCHAR" />
		<result column="YWY_PHONE" property="map.ywy_phone" jdbcType="VARCHAR" />
		<result column="WC_NUM" property="map.wc_num" jdbcType="DECIMAL" />
		<result column="NUM" property="map.num" jdbcType="DECIMAL" />
		<result column="SAVE_PATH" property="map.save_path" jdbcType="VARCHAR" />
		<result column="IS_TQ" property="map.is_tq" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-konkaYjglPlanFp">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_id">PLAN_ID = #plan_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_year">PLAN_YEAR = #plan_year:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_name">PD_NAME = #pd_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="num">NUM = #num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="shop_id">SHOP_ID = #shop_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_confirm">IS_CONFIRM = #is_confirm:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="confirm_user_id">CONFIRM_USER_ID = #confirm_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="confirm_date">CONFIRM_DATE = #confirm_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="remark">REMARK = #remark:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type_id">TYPE_ID = #type_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sy_date">SY_DATE = #sy_date:TIMESTAMP#</isNotEmpty>
	
		<isNotEmpty prepend=" and " property="map.pd_name_like">PD_NAME like '%' || #map.pd_name_like:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.store_name_like">SHOP_ID in (select store_id from konka_r3_store  where store_name like '%' || #map.store_name_like:VARCHAR# || '%' ) </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.startime"><![CDATA[ SY_DATE >= to_date(#map.startime#,'yyyy-MM-dd') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.endtime"><![CDATA[ SY_DATE <= to_date(#map.endtime#,'yyyy-MM-dd') ]]></isNotEmpty>
	</sql>
	
	<sql id="sf-konkaYjglPlanFp-t">
		<isNotEmpty prepend=" and " property="id">tt.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_id">tt.PLAN_ID = #plan_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">tt.DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_year">tt.PLAN_YEAR = #plan_year:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">tt.IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">tt.ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">tt.ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">tt.PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_name">tt.PD_NAME = #pd_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="num">tt.NUM = #num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="shop_id">tt.SHOP_ID = #shop_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_confirm">tt.IS_CONFIRM = #is_confirm:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="confirm_user_id">tt.CONFIRM_USER_ID = #confirm_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="confirm_date">tt.CONFIRM_DATE = #confirm_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="remark">tt.REMARK = #remark:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type_id">tt.TYPE_ID = #type_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sy_date">tt.SY_DATE = #sy_date:TIMESTAMP#</isNotEmpty>
	
	
	    <isNotEmpty prepend=" and " property="map.startime"><![CDATA[ tt.SY_DATE >= to_date(#map.startime#,'yyyy-MM-dd') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.endtime"><![CDATA[ tt.SY_DATE <= to_date(#map.endtime#,'yyyy-MM-dd') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.pd_name_like">tt.PD_NAME like '%' || #map.pd_name_like:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.store_name_like">tt.SHOP_ID in (select store_id from konka_r3_store  where store_name like '%' || #map.store_name_like:VARCHAR# || '%' ) </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.store_ids"> 
				tt.shop_id in
				<iterate close=")" open="(" conjunction="," property="map.store_ids">#map.store_ids[]#</iterate>
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.no_confirm">tt.IS_CONFIRM=0</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.wait_sy"><![CDATA[tt.IS_CONFIRM=1 and tt.sy_num=0 and ( tt.num > tt.sy_num + tt.xy_num ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.have_sy"><![CDATA[tt.IS_CONFIRM=1 and (tt.num>tt.sy_num ) and tt.sy_num>0]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.sy_ing"><![CDATA[tt.IS_CONFIRM=1 and tt.num=tt.sy_num and tt.num>0 ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_down"><![CDATA[tt.IS_CONFIRM=1 and tt.sy_num=0 and tt.num=tt.xy_num ]]></isNotEmpty>
		
	</sql>

	<select id="selectKonkaYjglPlanFp" resultMap="konkaYjglPlanFpResult" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		select * from KONKA_YJGL_PLAN_FP where 1 = 1
		<include refid="sf-konkaYjglPlanFp" />
	</select>

	<select id="selectKonkaYjglPlanFpList" resultMap="konkaYjglPlanFpResultForList" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_YJGL_PLAN_FP where 1 = 1
		<include refid="sf-konkaYjglPlanFp" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaYjglPlanFpCount" resultClass="long" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		select count(*) from KONKA_YJGL_PLAN_FP where 1 = 1
		<include refid="sf-konkaYjglPlanFp" />
	</select>

	<select id="selectKonkaYjglPlanFpPaginatedList" resultMap="konkaYjglPlanFpResult" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_YJGL_PLAN_FP where 1 = 1
		<include refid="sf-konkaYjglPlanFp" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectKonkaYjglPlanFpAndDeptNameCount" resultClass="long" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		select count(*) from ( 	
		select tt.* from (
		select t.*,  
		<![CDATA[(select count(*) from KONKA_MOBILE_TEST_DATA x where x.STATUS=0 and x.PLAN_FP_ID=t.id and ( x.UP_DATE <= sysdate and (sysdate <= x.DOWN_DATE or x.DOWN_DATE IS NULL))) as sy_num,
        (select count(*) from KONKA_MOBILE_TEST_DATA x where  x.STATUS=0 and x.PLAN_FP_ID=t.id and ( x.UP_DATE > sysdate or sysdate > x.DOWN_DATE or x.UP_DATE is null )) as xy_num  ]]>
         from KONKA_YJGL_PLAN_FP t
       LEFT JOIN konka_dept a
          ON t.DEPT_ID = a.DEPT_ID
       LEFT JOIN KONKA_PE_PROD_USER b
          ON t.ADD_USER_ID = b.ID
       LEFT JOIN KONKA_R3_STORE c
          ON t.SHOP_ID = c.STORE_ID
       LEFT JOIN KONKA_BASE_TYPE_DATA d
          ON t.TYPE_ID = d.TYPE_ID where 1 = 1 
		 ) tt where 1=1 <include refid="sf-konkaYjglPlanFp-t" /> )
	</select>

	<select id="selectKonkaYjglPlanFpAndDeptNamePaginatedList" resultMap="konkaYjglPlanFpAndDeptNameResult" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select tt.* from (	
		SELECT t.*,
	   <![CDATA[  ( select count(*) from KONKA_MOBILE_TEST_DATA x where x.STATUS=0 and x.PLAN_FP_ID=t.id and ( x.UP_DATE <= sysdate and (sysdate <= x.DOWN_DATE or x.DOWN_DATE IS NULL))) as sy_num,
         ( select count(*) from KONKA_MOBILE_TEST_DATA x where  x.STATUS=0 and x.PLAN_FP_ID=t.id and ( x.UP_DATE > sysdate or sysdate > x.DOWN_DATE or x.UP_DATE is null )) as xy_num,	  ]]>
       a.DEPT_NAME AS dept_name,
       b.USER_NAME AS user_name,
       c.STORE_NAME AS store_name,
       d.TYPE_NAME AS type_name
  FROM KONKA_YJGL_PLAN_FP t
       LEFT JOIN konka_dept a
          ON t.DEPT_ID = a.DEPT_ID
       LEFT JOIN KONKA_PE_PROD_USER b
          ON t.ADD_USER_ID = b.ID
       LEFT JOIN KONKA_R3_STORE c
          ON t.SHOP_ID = c.STORE_ID
       LEFT JOIN KONKA_BASE_TYPE_DATA d
          ON t.TYPE_ID = d.TYPE_ID where 1 = 1	
		<!-- order by ID asc -->
		 ) tt where 1=1  <include refid="sf-konkaYjglPlanFp-t" /> ) t_ <![CDATA[ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectKonkaYjglPlanFpAndTjCount" resultClass="long" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
	 <![CDATA[ select count(*) from (
	   SELECT xx.bra_name,
       xx.store_name,
       xx.store_id,
       xx.dept_id,
       xx.dept_name,
       xx.pd_name,
       xx.sy_date,
       xx.id,
       xx.sy_num,
       xx.xy_num,
       xx.up_date,
       xx.fj_id,
       xx.cxy_name,
       xx.cxy_phone,
       xx.wc_num,
       xx.ywy_name,
       xx.ywy_phone,
       xx.num,
       xx.save_path,
        (select 
       case 
        when xx.up_date is not null and to_char(xx.up_date,'yyyy-MM-dd') <= to_char(xx.sy_date,'yyyy-MM-dd')   then  '否' 
        when xx.up_date is not null and to_char(xx.up_date,'yyyy-MM-dd') > to_char(xx.sy_date,'yyyy-MM-dd')   then  '是' 
        when xx.up_date is null and to_char(xx.sy_date,'yyyy-MM-dd') >= to_char(sysdate,'yyyy-MM-dd') then  '否'
        when xx.up_date is null and to_char(xx.sy_date,'yyyy-MM-dd') < to_char(sysdate,'yyyy-MM-dd') then  '是'  
       else '未知' end from dual) as is_tq 
  FROM (SELECT tt.*, (tt.NUM - tt.sy_num - tt.xy_num) AS wc_num, ss.SAVE_PATH
          FROM    (SELECT decode (b.BRANCH_NAME,
                                  1,
                                  '白电',
                                  2,
                                  '多媒体',
                                  '未维护')
                             AS bra_name,
                          a.store_id,
                          a.dept_id,
                          a.STORE_NAME,
                          c.DEPT_NAME,
                          d.PD_NAME,
                          d.SY_DATE,
                          d.ID,
                          d.NUM,
                          (SELECT count (*)
                             FROM KONKA_MOBILE_TEST_DATA aa
                            WHERE   (  UP_DATE <= sysdate
                                   AND (sysdate <= DOWN_DATE
                                        OR DOWN_DATE IS NULL))
                                  AND aa.STATUS = 0
                                  AND aa.PLAN_FP_ID = d.ID)
                             AS sy_num,
                          (SELECT count (*)
                             FROM KONKA_MOBILE_TEST_DATA aa
                            WHERE (UP_DATE > sysdate OR sysdate > DOWN_DATE)
                                  AND aa.STATUS = 0
                                  AND aa.PLAN_FP_ID = d.ID)
                             AS xy_num,
                          (SELECT max (UP_DATE)
                             FROM KONKA_MOBILE_TEST_DATA
                            WHERE PLAN_FP_ID = d.ID)
                             AS up_date,
                          (SELECT max (id)
                             FROM KONKA_MOBILE_TEST_DATA
                            WHERE PLAN_FP_ID = d.ID)
                             AS fj_id,
                          decode (dd.CXY_NAME,
                                  NULL,
                                  '未维护',
                                  dd.CXY_NAME)
                             AS cxy_name,
                          decode (dd.CXY_PHONE,
                                  NULL,
                                  '未维护',
                                  dd.CXY_PHONE)
                             AS cxy_phone,
                          ee.USER_NAME AS ywy_name,
                          decode (ee.LINK_PHONE,
                                  NULL,
                                  decode (ee.LINK_TEL,
                                          NULL,
                                          '未维护',
                                          ee.LINK_TEL),
                                  ee.LINK_PHONE)
                             AS ywy_phone
                     FROM KONKA_YJGL_PLAN_FP d
                          LEFT JOIN konka_r3_store a
                             ON d.SHOP_ID = a.STORE_ID
                          LEFT JOIN konka_r3_shop b
                             ON a.R3_CODE = b.R3_CODE
                          LEFT JOIN konka_dept c
                             ON a.DEPT_ID = c.DEPT_ID
                          LEFT JOIN (SELECT bb.SHOP_ID,
                                            to_char (
                                               listagg (cc.user_name, ','))
                                               AS cxy_name,
                                            to_char (
                                               listagg (
                                                  decode (
                                                     cc.LINK_PHONE,
                                                     NULL,
                                                     decode (cc.LINK_TEL,
                                                             NULL,
                                                             '未维护',
                                                             cc.LINK_TEL),
                                                     cc.LINK_PHONE),
                                                  ','))
                                               AS cxy_phone
                                       FROM    Konka_Mobile_Sp_Relation bb
                                            LEFT JOIN
                                               konka_pe_prod_user cc
                                            ON bb.SELLER_ID = cc.ID
                                      WHERE cc.IS_DEL = 0
                                            AND bb.SHOP_ID IS NOT NULL
                                     GROUP BY bb.SHOP_ID) dd
                             ON a.DEPT_ID = dd.SHOP_ID
                          LEFT JOIN konka_pe_prod_user ee
                             ON a.YWY_JOB_ID = ee.JOB_ID
                    WHERE 1 = 1) tt
               LEFT JOIN
                  (SELECT f.LINK_ID,
                          listagg (f.save_path || '&' || f.FILE_DESC, ',') 
                             AS save_path
                     FROM ATTACHMENT f
                    WHERE f.LINK_TAB = 'KONKA_MOBILE_TEST_DATA'
                          AND f.DEL_MARK = 0
                   GROUP BY LINK_ID) ss
               ON tt.fj_id = ss.LINK_ID) xx where 1 = 1  ]]> 
               
               <isNotEmpty prepend=" and " property="map.dept_id"  >
               		xx.dept_id = #map.dept_id#
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.cxy_name_like"  >
               		xx.cxy_name like '%'||#map.cxy_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.store_name_like"  >
               		xx.store_name  like '%'||#map.store_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.pd_name_like"  >
               		xx.pd_name  like '%'||#map.pd_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.add_time_start"><![CDATA[ xx.sy_date >= to_date(#map.add_time_start#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
				<isNotEmpty prepend=" and " property="map.add_time_end"><![CDATA[ xx.sy_date <= to_date(#map.add_time_end#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
               
                <isNotEmpty prepend=" and " property="map.is_cy"  >
               		xx.up_date is not null
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.is_not_cy"  >
               		xx.up_date is null
               </isNotEmpty>
               
               )xxx  where 1 =1 
                <isNotEmpty prepend=" and " property="map.is_tq"  >
               		xxx.is_tq = #map.is_tq#
               </isNotEmpty> 
	</select>
	
	
	<select id="selectKonkaYjglPlanFpAndTjPaginatedList" resultMap="konkaYjglPlanFpAndTjResult" parameterClass="konkaYjglPlanFp" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		<![CDATA[ SELECT xx.bra_name,
       xx.store_name,
       xx.store_id,
       xx.dept_id,
       xx.dept_name,
       xx.pd_name,
       xx.sy_date,
       xx.id,
       xx.sy_num,
       xx.xy_num,
       xx.up_date,
       xx.fj_id,
       xx.cxy_name,
       xx.cxy_phone,
       xx.wc_num,
       xx.num,
       xx.ywy_name,
       xx.ywy_phone,
       xx.save_path,
        (select 
       case 
        when xx.up_date is not null and to_char(xx.up_date,'yyyy-MM-dd') <= to_char(xx.sy_date,'yyyy-MM-dd')   then  '否' 
        when xx.up_date is not null and to_char(xx.up_date,'yyyy-MM-dd') > to_char(xx.sy_date,'yyyy-MM-dd')   then  '是' 
        when xx.up_date is null and to_char(xx.sy_date,'yyyy-MM-dd') >= to_char(sysdate,'yyyy-MM-dd') then  '否'
        when xx.up_date is null and to_char(xx.sy_date,'yyyy-MM-dd') < to_char(sysdate,'yyyy-MM-dd') then  '是' 
       else '未知' end from dual) as is_tq 
  FROM (SELECT tt.*, (tt.NUM - tt.sy_num - tt.xy_num) AS wc_num, ss.SAVE_PATH
          FROM    (SELECT decode (b.BRANCH_NAME,
                                  1,
                                  '白电',
                                  2,
                                  '多媒体',
                                  '未维护')
                             AS bra_name,
                          a.store_id,
                          a.dept_id,
                          a.STORE_NAME,
                          c.DEPT_NAME,
                          d.PD_NAME,
                          d.SY_DATE,
                          d.ID,
                          d.NUM,
                          (SELECT count (*)
                             FROM KONKA_MOBILE_TEST_DATA aa
                            WHERE   (  UP_DATE <= sysdate
                                   AND (sysdate <= DOWN_DATE
                                        OR DOWN_DATE IS NULL))
                                  AND aa.STATUS = 0
                                  AND aa.PLAN_FP_ID = d.ID)
                             AS sy_num,
                          (SELECT count (*)
                             FROM KONKA_MOBILE_TEST_DATA aa
                            WHERE (UP_DATE > sysdate OR sysdate > DOWN_DATE)
                                  AND aa.STATUS = 0
                                  AND aa.PLAN_FP_ID = d.ID)
                             AS xy_num,
                          (SELECT max (UP_DATE)
                             FROM KONKA_MOBILE_TEST_DATA
                            WHERE PLAN_FP_ID = d.ID)
                             AS up_date,
                          (SELECT max (id)
                             FROM KONKA_MOBILE_TEST_DATA
                            WHERE PLAN_FP_ID = d.ID)
                             AS fj_id,
                          decode (dd.CXY_NAME,
                                  NULL,
                                  '未维护',
                                  dd.CXY_NAME)
                             AS cxy_name,
                          decode (dd.CXY_PHONE,
                                  NULL,
                                  '未维护',
                                  dd.CXY_PHONE)
                             AS cxy_phone,
                          ee.USER_NAME AS ywy_name,
                          decode (ee.LINK_PHONE,
                                  NULL,
                                  decode (ee.LINK_TEL,
                                          NULL,
                                          '未维护',
                                          ee.LINK_TEL),
                                  ee.LINK_PHONE)
                             AS ywy_phone
                     FROM KONKA_YJGL_PLAN_FP d
                          LEFT JOIN konka_r3_store a
                             ON d.SHOP_ID = a.STORE_ID
                          LEFT JOIN konka_r3_shop b
                             ON a.R3_CODE = b.R3_CODE
                          LEFT JOIN konka_dept c
                             ON a.DEPT_ID = c.DEPT_ID
                          LEFT JOIN (SELECT bb.SHOP_ID,
                                            to_char (
                                               listagg (cc.user_name, ','))
                                               AS cxy_name,
                                            to_char (
                                               listagg (
                                                  decode (
                                                     cc.LINK_PHONE,
                                                     NULL,
                                                     decode (cc.LINK_TEL,
                                                             NULL,
                                                             '未维护',
                                                             cc.LINK_TEL),
                                                     cc.LINK_PHONE),
                                                  ','))
                                               AS cxy_phone
                                       FROM    Konka_Mobile_Sp_Relation bb
                                            LEFT JOIN
                                               konka_pe_prod_user cc
                                            ON bb.SELLER_ID = cc.ID
                                      WHERE cc.IS_DEL = 0
                                            AND bb.SHOP_ID IS NOT NULL
                                     GROUP BY bb.SHOP_ID) dd
                             ON a.DEPT_ID = dd.SHOP_ID
                          LEFT JOIN konka_pe_prod_user ee
                             ON a.YWY_JOB_ID = ee.JOB_ID
                    WHERE 1 = 1) tt
               LEFT JOIN
                  (SELECT f.LINK_ID,
                          listagg (f.save_path || '&' || f.FILE_DESC, ',') 
                             AS save_path
                     FROM ATTACHMENT f
                    WHERE f.LINK_TAB = 'KONKA_MOBILE_TEST_DATA'
                          AND f.DEL_MARK = 0
                   GROUP BY LINK_ID) ss
               ON tt.fj_id = ss.LINK_ID) xx where 1 = 1]]>
                <isNotEmpty prepend=" and " property="map.dept_id"  >
               		xx.dept_id = #map.dept_id#
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.cxy_name_like"  >
               		xx.cxy_name like '%'||#map.cxy_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.store_name_like"  >
               		xx.store_name  like '%'||#map.store_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.pd_name_like"  >
               		xx.pd_name  like '%'||#map.pd_name_like#||'%'
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.add_time_start"><![CDATA[ xx.sy_date >= to_date(#map.add_time_start#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
				<isNotEmpty prepend=" and " property="map.add_time_end"><![CDATA[ xx.sy_date <= to_date(#map.add_time_end#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
               
                <isNotEmpty prepend=" and " property="map.is_cy"  >
               		xx.up_date is not null
               </isNotEmpty>
                <isNotEmpty prepend=" and " property="map.is_not_cy"  >
               		xx.up_date is null
               </isNotEmpty>
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)]]>
		<isNotEmpty prepend=" and " property="map.is_tq"  >
               		t_.is_tq = #map.is_tq#
               </isNotEmpty>
		<![CDATA[) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	

	<insert id="insertKonkaYjglPlanFp" parameterClass="konkaYjglPlanFp">
		<selectKey resultClass="long" keyProperty="id">select KONKA_YJGL_PLAN_FP_SEQ.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_YJGL_PLAN_FP (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="plan_id">PLAN_ID</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="plan_year">PLAN_YEAR</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="pd_id">PD_ID</isNotNull>	
			<isNotNull prepend="," property="pd_name">PD_NAME</isNotNull>	
			<isNotNull prepend="," property="num">NUM</isNotNull>	
			<isNotNull prepend="," property="shop_id">SHOP_ID</isNotNull>	
			<isNotNull prepend="," property="is_confirm">IS_CONFIRM</isNotNull>	
			<isNotNull prepend="," property="confirm_user_id">CONFIRM_USER_ID</isNotNull>	
			<isNotNull prepend="," property="confirm_date">CONFIRM_DATE</isNotNull>	
			<isNotNull prepend="," property="remark">REMARK</isNotNull>	
			<isNotNull prepend="," property="type_id">TYPE_ID</isNotNull>	
			<isNotNull prepend="," property="sy_date">SY_DATE</isNotNull>
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_id">#plan_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_year">#plan_year:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">#pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_name">#pd_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="num">#num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shop_id">#shop_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_confirm">#is_confirm:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="confirm_user_id">#confirm_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="confirm_date">#confirm_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">#remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="type_id">#type_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sy_date">#sy_date:TIMESTAMP#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaYjglPlanFp" parameterClass="KonkaYjglPlanFp">
		update KONKA_YJGL_PLAN_FP
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_id">PLAN_ID = #plan_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_year">PLAN_YEAR = #plan_year:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_name">PD_NAME = #pd_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="num">NUM = #num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shop_id">SHOP_ID = #shop_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_confirm">IS_CONFIRM = #is_confirm:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="confirm_user_id">CONFIRM_USER_ID = #confirm_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="confirm_date">CONFIRM_DATE = #confirm_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">REMARK = #remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="type_id">TYPE_ID = #type_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sy_date">SY_DATE = #sy_date:TIMESTAMP#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaYjglPlanFp" parameterClass="KonkaYjglPlanFp">
		delete from KONKA_YJGL_PLAN_FP where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>