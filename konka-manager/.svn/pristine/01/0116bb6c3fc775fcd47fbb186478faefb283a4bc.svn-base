<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head xmlns="">
<title>上报历史</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0;user-scalable=0;" />
<link rel="stylesheet" type="text/css" href="css/common.css" />
</head>
<body>
<!--head start -->
<div class="top4 head_class">
  <div class="jiantou"><a ><img src="images/jiantou_09.jpg" onclick="javascript:history.back();" /></a></div>
  <div class="topzi" style="float:left; display:inline; width:100px; padding-left:15%"><img alt="上报历史" src="images/uptit.png" /></div>
</div>
<div class="headtab31 head_class"></div>
<table width="100%" border="0"  class="rtab1">
  <tr>
    <td width="9%" align="center"><input name="button" type="button" class="but_month" id="p_month" value="上月" /></td>
    <td width="82%" align="center"><span id="year"></span>年<span id="month"></span>月</td>
    <td width="9%" align="center"><input name="button2" type="button" class="but_month" id="n_month" value="下月" /></td>
  </tr>
</table>
<div class="botnav"><ul><li style="cursor:pointer;" class="status" id="status_0">未登记销售历史</li><li class="cur status" style="cursor:pointer;" id="status_">全部销售历史</li></ul></div>
<table width="100%" border="0"  class="rtab1">
  <tr>
    <td colspan="2" class="rtongji"><span>总金额：<font id="all_money"></font>元</span>总数量：<font id="all_count"></font>台 </td>
  </tr>
  <tbody id="tbody">
	  <tr style="display:none;">
	    <td width="90%" align="left">好万家旗舰店<br /><span class="leixi">时间：2013-05-25</span><span class="leixi">数量：2</span><br /><span class="leixi">型号：LED42008300PDF</span><span class="leixi">金额：50000</span></td>
	    <td width="10%" align="center"><span class="xt_sp"><a href="#"><img src="images/but_see.png" width="49" height="30" /></a></span></td>
	  </tr>
  </tbody>
</table>


<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="js/lhgdialog.min.js?skin=idialog"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript">//<![CDATA[
//防止缓存每次都加载JS    
document.write("<s" + "cript type='text/javascript' src='js/base-data.js?" + Math.random() + "'></scr" + "ipt>");

$(document).ready(function(){
	// 获取参数
	var username  = getQueryString("username");
	var userpass = getQueryString("userpass");
	var status  = getQueryString("status");
	var from_pc = getQueryString("from_pc");

	// 如果是pc端需要隐藏头部
	if("1" == from_pc){
		$(".head_class").hide();
	}

	// status 状态(传0时，将只会返回销售数据中为未完整填报的记录集)
	if(status  == null || status == "null" || status == ""){
		status = ""; // 默认全部
		$("#status_").attr("class", "").attr("class", "cur status");
		$("#status_0").attr("class", "").attr("class", "status");
	} else {
		$("#status_0").attr("class", "").attr("class", "cur status");
		$("#status_").attr("class", "").attr("class", "status");
	}
	
	// 处理月份，因为静态页面月份只能以浏览器系统时间为准
	var year = new Date().format('yyyy');
	$("#year").html(year);
	var month = new Date().format('MM');
	$("#month").html(month);
	
	// 查询记录开始时间，结束时间
	var startime = "" + year + "-" + month + "-01" ;
	var endtime = "" + year + "-" + month + "-" + getLastDay(year, month) + "" ;
	
	// 如果访问地址携带用户名和密码则初始化相关信息
	if(username != null && userpass != null && username != "null" && userpass != "null" && username != "" && userpass != ""){
		// 根据用户名和密码查询历史信息
		data_init(username, userpass, status, startime, endtime);
	} else {
		show_login();
	}
	
	// 上一个月点击
	$("#p_month").click(function(){
		$("#tbody").empty(); // 清空现有记录
		
		if(month == "01"){ month = "12"; year = parseInt(year) - 1; } else if(month <= "10"){ month = "0" + (parseInt(month) - 1); } else{ month = parseInt(month) - 1; }
		$("#year").html(year);
		$("#month").html(month);
		startime = "" + year + "-" + month + "-01" ;
		endtime = "" + year + "-" + month + "-" + getLastDay(year, month) + "" ;
		
		// 根据用户名和密码查询历史信息
		data_init(username, userpass, status, startime, endtime);
	});

	// 下一个月点击
	$("#n_month").click(function(){
		$("#tbody").empty(); // 清空现有记录
		
		if(month <= 8){ month = "0" + (parseInt(month) + 1); } else{ if(month == "12"){ month = "01"; year = parseInt(year) + 1; } else{ month = parseInt(month) + 1; } } 
		$("#year").html(year);
		$("#month").html(month);
		startime = "" + year + "-" + month + "-01" ;
		endtime = "" + year + "-" + month + "-" + getLastDay(year, month) + "" ;
		
		// 根据用户名和密码查询历史信息
		data_init(username, userpass, status, startime, endtime);
	});

	// 全部销售和未登记切换
	$(".status").click(function(){
		// 清空页面数据
		$("#all_count").html("");
		$("#all_money").html("");
		$("#tbody").empty();
		
		if($(this).attr("id") == "status_0"){
			$("#status_0").attr("class", "").attr("class", "cur status");
			$("#status_").attr("class", "").attr("class", "status");
			status = "0";
		} else {
			$("#status_").attr("class", "").attr("class", "cur status");
			$("#status_0").attr("class", "").attr("class", "status");
			status = "";
		}

		// 根据用户名和密码查询历史信息
		data_init(username, userpass, status, startime, endtime);
	});

	
	// 根据用户名和密码查询历史信息
	function data_init(username, userpass, status, startime, endtime){
		// 正在加载数据层
	    var load_data = $.dialog({content: '数据加载中...', max: false, min: false, icon: 'loading.gif', title: '提示！'});
		
		$.ajax({
			type: "POST",
			url: host_url + "/MobileList.do?method=GetHis&from_html=1",
			data: { "username":encodeURI(username), "userpass":encodeURI(userpass), "type":"1", "startime":startime, "endtime":endtime, "status":status, "timestamp":new Date().getTime() },
			dataType: "jsonp",
			jsonp: "jsonpcallback",
			error: function (xhr, ajaxOptions, thrownError) { alert("数据加载请求失败【" + xhr.statusText + "," + xhr.responseText + "," + xhr.status + "," + thrownError +"】！"); },
			success: function(result) {
			  // 关闭-正在加载数据层
		  	  load_data.close();
				
			  if (result.status == "-1"){
			        $.dialog({
					    max: false, min: false, fixed: true,
					    content: result.msg,
					    init: function () {
					        var that = this, i = 8;
					        var fn = function () {
					            that.title(i + '秒后关闭');
					            !i && that.close();
					            i--;
					        };
					        timer = setInterval(fn, 1000);
					        fn();
					    },
					    close: function () {
					        clearInterval(timer);
					    }
					});
		      } else {
			      var all_count = 0; // 总销量
			      var all_money = 0; // 总销额
			      
		    	  $("#tbody").empty();
		  		  for(var i = 0; i < result.length; i++){
		  			  var id = result[i].id;
			  		  var detp_name = result[i].dept_name;
			  		  var num = result[i].num;
			  		  var sale_date = result[i].sale_date;
			  		  var model_name = result[i].model_name;
			  		  var all_price = result[i].all_price;
			  		  var can_edit = result[i].map.can_edit; // 标识是否是2天内的数据，如果是可以编辑
                      var attment=result[i].map.attachment.length;
			  		  var  attment_flag="是";//是
			  		  if(attment<1){
			  			attment_flag="否";//没有
			  		  }
			  		  // 计算总销额，销量
			  		  all_count += num;
			  		  all_money += parseFloat(all_price);
			  		  
			  		  if(status == "0") {
		  			  
			  				var content = '<tr><td width="90%" align="left">' + detp_name +'<br /><span class="leixi">时间：' + sale_date + '</span><span class="leixi">数量：' + num + '</span><br /><span class="leixi">型号：' + model_name + '</span><span class="leixi">金额：' + all_price + '</span><br/><span class="leixi">是否有附件：' + attment_flag + '</span></td><td width="10%" align="center"><span class="xt_sp"><a ><img src="images/but_edit.png" width="49" height="30" data="1" class="class_id" id="' + id + '" /></a></span></td></tr>';
							$(content).appendTo("#tbody");
			  		  } else {
			  			  if("1" == can_edit){
			  				var content = '<tr><td width="90%" align="left">' + detp_name +'<br /><span class="leixi">时间：' + sale_date + '</span><span class="leixi">数量：' + num + '</span><br /><span class="leixi">型号：' + model_name + '</span><span class="leixi">金额：' + all_price + '</span><br/><span class="leixi">是否有附件：' + attment_flag + '</span></td><td width="10%" align="center"><span class="xt_sp"><a ><img src="images/but_edit.png" width="49" height="30" data="1" class="class_id" id="' + id + '" /></a></span></td></tr>';
							$(content).appendTo("#tbody");
			  			  } else {
			  				var content = '<tr><td width="90%" align="left">' + detp_name +'<br /><span class="leixi">时间：' + sale_date + '</span><span class="leixi">数量：' + num + '</span><br /><span class="leixi">型号：' + model_name + '</span><span class="leixi">金额：' + all_price + '</span><br/><span class="leixi">是否有附件：' + attment_flag + '</span></td><td width="10%" align="center"><span class="xt_sp"><a ><img src="images/but_see.png" width="49" height="30" data="0" class="class_id" id="' + id + '" /></a>&nbsp;<a ><img src="images/but_edit_view.png" width="49" height="30" data="-1" class="class_id" id="' + id + '" /></a></span></td></tr>';
							$(content).appendTo("#tbody");
			  			  }
			  		  }
			  		  
			  	  }

		  		  $("#all_count").html(all_count);
		  		  $("#all_money").html(all_money.toFixed(2));
		  		  
		  		//iframe高度自适应
		  		try{ window.parent.resizeFrameHeight('mainFrame', 3); }catch(e){}
			  }
			}
		});
	}
	
	// 点击查看详细或者是编辑
	 $(document).delegate(".class_id", "click", function(){
		 var method; 
		 if(status == "0") {
			 if("1" == $(this).attr("data")){
				 method = "shuj_edit";
			 } else {
				 if("-1" == $(this).attr("data")){
					 method = "shuj_edit_view";
				 } else {
					 method = "shuj_view";
				 }
			 }
		 }else {
			 if("1" == $(this).attr("data")){
				 method = "shuj_edit";
			 } else {
				 if("-1" == $(this).attr("data")){
					 method = "shuj_edit_view";
				 } else {
					 method = "shuj_view";
				 }
			 }
		 }
		 location.href = method + ".html?username=" + escape(username) + "&userpass=" + escape(userpass) + "&id=" + $(this).attr("id") + "&from_pc=" + from_pc + "&timestamp=" + new Date().getTime();	
	 });
	
	// 登陆层
	function show_login(){	
		// cookie, 2013-06-27
		if(cookie_enable){ // 在base-data.js中定义状态
		  var cookie_name = $.cookie("cookie_name");	
		  var cookie_pass = $.cookie("cookie_pass");	
		  if(cookie_name != null && cookie_pass != null){
			username = cookie_name;
			userpass = cookie_pass;
			// 根据用户名和密码查询历史信息
			data_init(username, userpass, status, startime, endtime);
			return false;
		  }
		}
		  
	  $.dialog({
			id: 'login-window',
			title: '登录',
			content: '帐&nbsp;&nbsp;号：<input id="login-na" type="text" maxlength="20" value="" />' + '<br /><br />密&nbsp;&nbsp;码：<input id="login-pw" type="password" maxlength="20" value="" />',
			initialize: function () {
				document.getElementById('login-na').focus();
			},
			fixed: true, max:false, min:false,
			ok: function () {
				var na = document.getElementById('login-na');
				var pw = document.getElementById('login-pw');
				if(na.value == ""){
					alert("提示，请填写账号！");
					na.select();
					return false;
				}
				if(pw.value == ""){
					alert("提示，请填写密码！");
					pw.select();
					return false;
				}
				// 用户名和密码赋值
				username = na.value;
				userpass = pw.value;
				
				// 根据用户名和密码查询历史信息
				data_init(username, userpass, status, startime, endtime);
				
				// cookie,2013-06-27
				if(cookie_enable){ // 在base-data.js中定义状态
					$.cookie("cookie_name", username);	
					$.cookie("cookie_pass", userpass);	
				}
			},
			okValue: '登录',
			cancel: function () {}
		});
	}
});

//时间格式化
Date.prototype.format = function(format){
   var o = {
	 "M+" : this.getMonth()+1, //month
	 "d+" : this.getDate(),    //day
	 "h+" : this.getHours(),   //hour
	 "m+" : this.getMinutes(), //minute
	 "s+" : this.getSeconds(), //second
	 "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
	 "S" : this.getMilliseconds() //millisecond
   };
   if(/(y+)/.test(format)) format=format.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
   for(var k in o) if(new RegExp("("+ k +")").test(format)) format = format.replace(RegExp.$1, RegExp.$1.length==1 ? o[k] : ("00"+ o[k]).substr((""+ o[k]).length));
   return format;
};
//]]></script>
</div>
</body>
</html>