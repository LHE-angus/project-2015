<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_SP_ACTIVITY_ADDR">

	<typeAlias alias="konkaSpActivityAddr" type="com.ebiz.mmt.domain.KonkaSpActivityAddr" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaSpActivityAddr" />
		<flushOnExecute statement="updateKonkaSpActivityAddr" />
		<flushOnExecute statement="deleteKonkaSpActivityAddr" />
	</cacheModel>

	<resultMap id="konkaSpActivityAddrResultForList" class="konkaSpActivityAddr">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="ADDR_INDEX" property="addr_index" jdbcType="VARCHAR" />
		<result column="ADDR" property="addr" jdbcType="VARCHAR" />
		<result column="ADDR_MEMO" property="addr_memo" jdbcType="VARCHAR" />
		<result column="ADDR_HEADER" property="addr_header" jdbcType="VARCHAR" />
		<result column="R3_CODE" property="r3_code" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="customer_name" jdbcType="VARCHAR" />
		<result column="STATE" property="state" jdbcType="DECIMAL" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="ADD_USER_NAME" property="add_user_name" jdbcType="VARCHAR" />
		<result column="UPDATE_USER_NAME" property="update_user_name" jdbcType="VARCHAR" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="UPDATE_DATE" property="update_date" jdbcType="TIMESTAMP" />
		<result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
		<result column="STORE_NAME" property="store_name" jdbcType="VARCHAR" />
	</resultMap>
	
	

	<resultMap id="konkaSpActivityAddrPaginatedResult" class="konkaSpActivityAddr" extends="konkaSpActivityAddrResultForList">
	<result column="FJ_PATHS" property="map.fj_paths" jdbcType="VARCHAR" />
	<result column="DEPT_ID" property="map.dept_id" jdbcType="VARCHAR" />
	<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
	<result column="L4_DEPT_ID" property="map.l4_dept_id" jdbcType="VARCHAR" />
	<result column="L4_DEPT_NAME" property="map.l4_dept_name" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="konkaSpActivityAddrResult" class="konkaSpActivityAddr" extends="konkaSpActivityAddrResultForList">
	</resultMap>

	<sql id="sf-konkaSpActivityAddr">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_index">ADDR_INDEX = #addr_index:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr">ADDR = #addr:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_memo">ADDR_MEMO = #addr_memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_header">ADDR_HEADER = #addr_header:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="state">STATE = #state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_name">UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_name">STORE_NAME = #store_name:VARCHAR#</isNotEmpty>
		
	</sql>
	<sql id="sf-konkaSpActivityAddr-a">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_index">a.ADDR_INDEX = #addr_index:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr">a.ADDR = #addr:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_memo">a.ADDR_MEMO = #addr_memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="addr_header">a.ADDR_HEADER = #addr_header:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">a.R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">a.CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="state">a.STATE = #state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">a.ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_name">a.ADD_USER_NAME = #add_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_name">a.UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">a.ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_date">a.UPDATE_DATE = #update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">a.STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_name">a.STORE_NAME = #store_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.add_date_start">
		<![CDATA[a.ADD_DATE >= to_date(#map.add_date_start#,'yyyy-MM-dd hh24:mi:ss')]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.add_date_end">
		<![CDATA[a.ADD_DATE <= to_date(#map.add_date_end#,'yyyy-MM-dd hh24:mi:ss')]]>
		</isNotEmpty>
<!--		String	addr_index_like=(String) dynaBean.get("addr_index_like");-->
<!--		String	add_user_like=(String) dynaBean.get("add_user_like");-->
<!--		String	hander_user_like=(String) dynaBean.get("hander_user_like");-->
<!--		String	r3_code=(String) dynaBean.get("r3_code");-->
<!--		String	customer_name_like=(String) dynaBean.get("customer_name_like");-->
		<!--以下为扩展的条件  -->
		<isNotEmpty prepend=" and " property="map.addr_index_like">a.ADDR_INDEX like '%'||#map.addr_index_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.add_user_like">a.ADD_USER_NAME '%'||#map.add_user_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.hander_user_like">a.ADDR_HEADER like '%'||#map.hander_user_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.customer_name_like">a.CUSTOMER_NAME like '%'||#map.customer_name_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.store_name_like">a.STORE_NAME like '%'||#map.store_name_like:VARCHAR#||'%'</isNotEmpty>
<!--		<isNotEmpty prepend=" and " property="map.dept_id_in">-->
<!--		exists (select 1 from konka_pe_prod_user where id= a.add_user_id and-->
<!--		dept_id in (select dept_id from KONKA_DEPT start with dept_id =-->
<!--			#map.dept_id_in# connect by prior dept_id = par_id))-->
<!--		</isNotEmpty>-->
		 <isNotEmpty prepend=" and " property="map.dept_id_start">
			(b.cur_dept_id is not null and  b.cur_dept_id in (
						select dept_id from konka_dept start with dept_id in (
						SELECT DISTINCT (dept_id)
		  							FROM KONKA_ROLE_DATA_LEVEL
		 							WHERE role_id IN (SELECT role_id
		                     			FROM KONKA_PE_ROLE_USER
		                    			WHERE user_id = #map.session_user_id#)
						) or dept_id = #map.dept_id_start# 
						connect by prior dept_id = par_id 
					)
			)
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.filter_by_ywy_id_eq">
			<![CDATA[ (b.user_id = #map.filter_by_ywy_id_eq# or t.ywy_job_id = (select job_id from konka_pe_prod_user where id = #map.filter_by_ywy_id_eq# and rownum<2))]]>
		</isNotEmpty> 
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			b.cur_dept_id in ( select dept_id from KONKA_DEPT start with dept_id = #map.par_dept_id:DECIMAL# connect by prior dept_id = par_id)
		</isNotEmpty>
	</sql>
	<select id="selectKonkaSpActivityAddr" resultMap="konkaSpActivityAddrResult" parameterClass="konkaSpActivityAddr" cacheModel="oneDayCache">
		select * from KONKA_SP_ACTIVITY_ADDR where 1 = 1
		<include refid="sf-konkaSpActivityAddr" />
	</select>

	<select id="selectKonkaSpActivityAddrList" resultMap="konkaSpActivityAddrResultForList" parameterClass="konkaSpActivityAddr" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_SP_ACTIVITY_ADDR where 1 = 1
		<include refid="sf-konkaSpActivityAddr" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaSpActivityAddrCount" resultClass="long" parameterClass="konkaSpActivityAddr" cacheModel="oneDayCache">
		select count(*) from KONKA_SP_ACTIVITY_ADDR a
		left join konka_r3_store t on  a.store_id=t.store_id
		left join MV_ORG_OF_CUSTOMER_ALL b 
		on a.r3_code=b.r3_code
		 where 1 = 1
		<include refid="sf-konkaSpActivityAddr-a" />
	</select>

	<select id="selectKonkaSpActivityAddrPaginatedList" resultMap="konkaSpActivityAddrPaginatedResult" parameterClass="konkaSpActivityAddr" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.dept_id,b.dept_name,b.l4_dept_id,b.l4_dept_name,(select
		listagg(f.save_path, ',') within group (order by		f.LINK_ID)		from		ATTACHMENT f		
		where		f.LINK_TAB='KONKA_SP_ACTIVITY_ADDR' and f.DEL_MARK =0 and
		f.LINK_ID=a.id		group by		LINK_ID ) fj_paths from KONKA_SP_ACTIVITY_ADDR a
		left join konka_r3_store t on  a.store_id=t.store_id
		left join MV_ORG_OF_CUSTOMER_ALL b 
		on a.r3_code=b.r3_code
		where 1 = 1
		<include refid="sf-konkaSpActivityAddr-a" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaSpActivityAddr" parameterClass="konkaSpActivityAddr">
		<selectKey resultClass="long" keyProperty="id">select SEQ_KONKA_SP_ACTIVITY_ADDR.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_SP_ACTIVITY_ADDR (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="addr_index">ADDR_INDEX</isNotNull>	
			<isNotNull prepend="," property="addr">ADDR</isNotNull>	
			<isNotNull prepend="," property="addr_memo">ADDR_MEMO</isNotNull>	
			<isNotNull prepend="," property="addr_header">ADDR_HEADER</isNotNull>	
			<isNotNull prepend="," property="r3_code">R3_CODE</isNotNull>	
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME</isNotNull>	
			<isNotNull prepend="," property="state">STATE</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="update_user_name">UPDATE_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="update_date">UPDATE_DATE</isNotNull>	
			<isNotNull prepend="," property="store_id">STORE_ID</isNotNull>	
			<isNotNull prepend="," property="store_name">STORE_NAME</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="addr_index">#addr_index:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr">#addr:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr_memo">#addr_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr_header">#addr_header:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="r3_code">#r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">#customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="state">#state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">#add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="update_user_name">#update_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="update_date">#update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="store_id">#store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_name">#store_name:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaSpActivityAddr" parameterClass="KonkaSpActivityAddr">
		update KONKA_SP_ACTIVITY_ADDR
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="addr_index">ADDR_INDEX = #addr_index:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr">ADDR = #addr:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr_memo">ADDR_MEMO = #addr_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="addr_header">ADDR_HEADER = #addr_header:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="state">STATE = #state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="update_user_name">UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="store_id">STORE_ID = #store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_name">STORE_NAME = #store_name:VARCHAR#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaSpActivityAddr" parameterClass="KonkaSpActivityAddr">
		delete from KONKA_SP_ACTIVITY_ADDR where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>