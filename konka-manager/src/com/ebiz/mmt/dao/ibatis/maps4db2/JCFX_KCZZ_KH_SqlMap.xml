<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="JCFX_KCZZ_KH">

	<typeAlias alias="jcfxKczzKh" type="com.ebiz.mmt.domain.JcfxKczzKh" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertJcfxKczzKh" />
		<flushOnExecute statement="updateJcfxKczzKh" />
		<flushOnExecute statement="deleteJcfxKczzKh" />
	</cacheModel>

	<resultMap id="jcfxKczzKhResultForList" class="jcfxKczzKh">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="COUSTMER_NAME" property="coustmer_name" jdbcType="VARCHAR" />
		<result column="CUST_ID" property="cust_id" jdbcType="DECIMAL" />
		<result column="R3_CODE" property="r3_code" jdbcType="VARCHAR" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="ADD_USER_NAME" property="add_user_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="jcfxKczzKhResult" class="jcfxKczzKh" extends="jcfxKczzKhResultForList">
	</resultMap>

	<sql id="sf-jcfxKczzKh">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="coustmer_name">COUSTMER_NAME = #coustmer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cust_id">CUST_ID = #cust_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="remark">REMARK = #remark:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
			<isNotEmpty prepend=" and " property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map._r3_code_like">
	       	 R3_CODE like '%' || #map._r3_code_like:VARCHAR# || '%'
		 </isNotEmpty>
		<isNotEmpty prepend=" and " property="map._customer_name_like">
	       	 COUSTMER_NAME like '%' || #map._customer_name_like:VARCHAR# || '%'
		 </isNotEmpty>
		 
		 <isNotEmpty prepend=" and " property="map._is_del">IS_DEL = #map._is_del:DECIMAL#</isNotEmpty>
		 
		<isNotEmpty prepend=" and " property="map.begin_add_date"><![CDATA[ ADD_DATE >= to_date(#map.begin_add_date#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_add_date"><![CDATA[ ADD_DATE <= to_date(#map.begin_add_date#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map._add_user_name">ADD_USER_NAME like '%' || #map._add_user_name:VARCHAR# || '%'</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map._khfz_id">
		    CUST_ID not in(SELECT CUST_ID
                             FROM JCFX_KCZZ_KHFZ_LINK
                            WHERE KHFZ_ID = #map._khfz_id:DECIMAL#)
        </isNotEmpty>
		
	</sql>

	<select id="selectJcfxKczzKh" resultMap="jcfxKczzKhResult" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		select * from JCFX_KCZZ_KH where 1 = 1
		<include refid="sf-jcfxKczzKh" />
	</select>

	<select id="selectJcfxKczzKhList" resultMap="jcfxKczzKhResultForList" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from JCFX_KCZZ_KH where 1 = 1
		<include refid="sf-jcfxKczzKh" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectJcfxKczzKhCount" resultClass="long" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		select count(*) from JCFX_KCZZ_KH where 1 = 1
		<include refid="sf-jcfxKczzKh" />
	</select>

	<select id="selectJcfxKczzKhPaginatedList" resultMap="jcfxKczzKhResult" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from JCFX_KCZZ_KH where 1 = 1
		<include refid="sf-jcfxKczzKh" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>


<!--         财务部库存周转率计算count-->
	<select id="selectJcfxCwbkczzlPaginatedList" resultClass="HashMap" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			 SELECT 
				<isEmpty prepend="  " property="map.select_by_field">
		       			  type.c_index,type.c_name,
		       </isEmpty>
 				<isNotEmpty prepend="  " property="map.select_by_field">
		       			 $map.select_by_field$ ,
		       </isNotEmpty>
		       
		       NVL(SUM ((data.INIT_NUM) * DATA.CASH_PRICE),0) / 10000 INIT_MONEY,
		       NVL(SUM (data.COME_NUM * DATA.CASH_PRICE),0) / 10000 COMM_MONEY,
		       NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0) / 10000 OUT_MONEY,
		       NVL(SUM (data.PRE_OUT_NUM * DATA.pre_cash_price),0) / 10000 PRE_OUT_MONEY,
		       NVL(SUM ((data.INIT_NUM* data.CASH_PRICE+data.COME_NUM* data.CASH_PRICE-data.OUT_NUM* data.CASH_PRICE) ),0) / 10000 END_MONEY,
		      
		        decode(NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0),0,0, 
		     			30*(NVL(SUM ((data.INIT_NUM* data.CASH_PRICE+data.COME_NUM* data.CASH_PRICE-data.OUT_NUM* data.CASH_PRICE) ),0) + NVL(SUM ((data.INIT_NUM) * DATA.CASH_PRICE),0))
		     			/ (NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0)  * 2)) CUR_DAY,

	           decode(NVL(SUM (data.pre_OUT_NUM * data.pre_CASH_PRICE),0),0,0,
	           	 30*(NVL(SUM ((data.pre_INIT_NUM* data.pre_CASH_PRICE+data.pre_COME_NUM* data.pre_CASH_PRICE-data.pre_OUT_NUM* data.pre_CASH_PRICE) ),0) + NVL(SUM ((data.pre_INIT_NUM) * data.pre_CASH_PRICE),0))
		     		 / (NVL(SUM (data.pre_OUT_NUM * data.pre_CASH_PRICE),0)  * 2)) UP_DAY
		      
	              
		  FROM    (
		        SELECT SHOP.CUSTOMER_TYPE,
                  SHOP.R3_CODE,
                  SHOP.CUSTOMER_NAME,
                  SHOP.BRANCH_AREA_NAME_2,
                  summary.INIT_NUM,
                  summary.OUT_NUM,
                  summary.COME_NUM,
                  (SELECT CASH_PRICE
                     FROM KONKA_PD_MODEL_PRICES
                    WHERE     PD_NAME = summary.goods_name
<!--                          AND price_month = '201312'-->
                          <isNotEmpty prepend=" and " property="map.cur_month">price_month = #map.cur_month:VARCHAR#</isNotEmpty>
                          <![CDATA[ AND rownum < 2]]>)
                     cash_price,
                  summary_pre.INIT_NUM pre_INIT_NUM,
                  summary_pre.COME_NUM pre_COME_NUM,
                  summary_pre.OUT_NUM pre_OUT_NUM,
                  (SELECT CASH_PRICE
                     FROM KONKA_PD_MODEL_PRICES
                    WHERE     PD_NAME = summary.goods_name
<!--                          AND price_month = '201311'-->
                          <isNotEmpty prepend=" and " property="map.up_month">price_month = #map.up_month:VARCHAR#</isNotEmpty>
                         <![CDATA[ AND rownum < 2]]>)
                     pre_cash_price
             FROM 
             <isNotEmpty prepend=" " property="map.is_cur_month">
              (SELECT rank () OVER (ORDER BY a.opr_date DESC) rn, a.*
                      FROM J_STOCKS_SUMMARY a
                     WHERE 1 = 1 AND type = 0
                         AND c_ID IN (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
						LEFT JOIN
						JCFX_KCZZ_KHFZ_LINK khlink
						ON kh.CUST_ID = khlink.CUST_ID
						WHERE  1=1
                             <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
                             <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)
                     <isNotEmpty prepend=" and " property="map.cur_month">to_char (a.opr_date, 'YYYYMM') = #map.cur_month:VARCHAR#</isNotEmpty>
                     ) summary
		       </isNotEmpty>
               <isEmpty prepend=" " property="map.is_cur_month">
	            (SELECT  rank() over(order by a.opr_date desc) rn,a.*
				  FROM J_STOCKS_SUMMARY a
				 WHERE a.TYPE = 1 
				   AND c_ID IN (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
										LEFT JOIN
										JCFX_KCZZ_KHFZ_LINK khlink
										ON kh.CUST_ID = khlink.CUST_ID
										WHERE  1=1
		                               <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
		                               <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)
			 	 <isNotEmpty prepend=" and " property="map.cur_month">to_char (a.opr_date, 'YYYYMM') = #map.cur_month:VARCHAR#</isNotEmpty>
			     ) summary
               </isEmpty>
                  LEFT JOIN (SELECT *
                               FROM KONKA_R3_SHOP
                              WHERE ID IN (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
										LEFT JOIN
										JCFX_KCZZ_KHFZ_LINK khlink
										ON kh.CUST_ID = khlink.CUST_ID
										WHERE 1=1
		                               <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
		                               <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)) SHOP
                     ON summary.R3_CODE = SHOP.R3_CODE
                  LEFT JOIN (
                      SELECT rank () OVER (ORDER BY a.opr_date DESC) rn, a.*
		                        FROM J_STOCKS_SUMMARY a
		                       WHERE 1 = 1 AND type = 1
                                       and c_ID IN
                                       (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
										LEFT JOIN
										JCFX_KCZZ_KHFZ_LINK khlink
										ON kh.CUST_ID = khlink.CUST_ID
										WHERE 1=1
		                               <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
		                               <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)
                                       <isNotEmpty prepend=" and " property="map.up_month">to_char(a.opr_date,'YYYYMM') = #map.up_month:VARCHAR#</isNotEmpty>
                     ) summary_pre
                     ON     summary_pre.R3_CODE = shop.R3_CODE
                        AND summary.r3_code = summary_pre.r3_code
                        AND summary.GOODS_ID = summary_pre.GOODS_ID
            WHERE 1 = 1
		          ) data
		       LEFT JOIN
		          (SELECT *
		             FROM KONKA_CATEGORY
		            WHERE C_TYPE = 10) type
		       ON data.CUSTOMER_TYPE = type.C_INDEX
		       
		       left join konka_r3_shop krs
		       on krs.r3_code = data.r3_code
		       

		       
			where 1=1
				
				<isNotEmpty prepend=" and " property="map.c_index">
		       			 type.c_index=#map.c_index:DECIMAL#
		       </isNotEmpty>
		       
		       <isNotEmpty prepend=" and " property="map.dept_sn">
		       			 krs.branch_area_name_2=#map.dept_sn#
		       </isNotEmpty>
		       
				<isEmpty prepend="  " property="map.group_field_name">
		       			GROUP BY  type.c_index,type.c_name
		       </isEmpty>
 				<isNotEmpty prepend="  " property="map.group_field_name">
		       			GROUP BY  $map.group_field_name$  
		       </isNotEmpty>
		       
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
    <!--全国连锁渠道周转情况分公司排名汇总表-->
	<select id="selectJcfxQglsqdzzqkfgspmPaginatedList" resultClass="HashMap" parameterClass="jcfxKczzKh" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			 SELECT 
			      max(data.AREA_CODE)AREA_CODE,
		          data.AREA_NAME,
		          data.BRANCH_AREA_NAME,
		          max(data.BRANCH_AREA_NAME_2)BRANCH_AREA_NAME_2,
				       NVL(SUM ((data.INIT_NUM) * DATA.CASH_PRICE),0) / 10000 INIT_MONEY,
				       NVL(SUM (data.COME_NUM * DATA.CASH_PRICE),0) / 10000 COMM_MONEY,
				       NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0) / 10000 OUT_MONEY,
				       NVL(SUM ((data.INIT_NUM+data.COME_NUM-data.OUT_NUM) * data.CASH_PRICE),0) / 10000 END_MONEY,
				       decode(NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0),0,0, 
		     			30*(NVL(SUM ((data.INIT_NUM* data.CASH_PRICE+data.COME_NUM* data.CASH_PRICE-data.OUT_NUM* data.CASH_PRICE) ),0) + NVL(SUM ((data.INIT_NUM) * DATA.CASH_PRICE),0))
		     			/ (NVL(SUM (data.OUT_NUM * DATA.CASH_PRICE),0)  * 2)) CUR_DAY
				      FROM(
				          SELECT 
				          shop.CUSTOMER_TYPE,
			              shop.R3_CODE,
			              shop.AREA_CODE,
		                  shop.AREA_NAME,
		                  shop.BRANCH_AREA_NAME_2,
		                  shop.BRANCH_AREA_NAME,
		                  summary.INIT_NUM,
		                  summary.OUT_NUM,
		                  summary.COME_NUM,
		                  (SELECT CASH_PRICE
		                     FROM KONKA_PD_MODEL_PRICES
		                    WHERE     PD_NAME = summary.goods_name
<!--		                          AND price_month = '201312'-->
                           <isNotEmpty prepend=" and " property="map.cur_month">price_month = #map.cur_month:VARCHAR#</isNotEmpty>
		                          <![CDATA[ AND rownum < 2 ]]>)
		                     cash_price
		             FROM <isNotEmpty prepend=" " property="map.is_cur_month">
				              (SELECT rank () OVER (ORDER BY a.opr_date DESC) rn, a.*
		                        FROM J_STOCKS_SUMMARY a
		                       WHERE 1 = 1 AND type = 0
		                        and c_ID IN
                                       (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
										LEFT JOIN
										JCFX_KCZZ_KHFZ_LINK khlink
										ON kh.CUST_ID = khlink.CUST_ID
										WHERE 1=1
		                               <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
		                               <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)
		                       ) summary
		                   </isNotEmpty>
		                   <isEmpty prepend=" " property="map.is_cur_month">
				              (SELECT rank () OVER (ORDER BY a.opr_date DESC) rn, a.*
								  FROM J_STOCKS_SUMMARY a
								 WHERE a.TYPE = 1 
								 and c_ID IN
                                       (SELECT kh.CUST_ID FROM JCFX_KCZZ_KH  kh
										LEFT JOIN
										JCFX_KCZZ_KHFZ_LINK khlink
										ON kh.CUST_ID = khlink.CUST_ID
										WHERE 1=1
		                               <isNotEmpty prepend=" and " property="map.fz_id">khlink.KHFZ_ID = #map.fz_id:DECIMAL#</isNotEmpty>
		                               <isNotEmpty prepend=" and " property="map.add_user_id">kh.ADD_USER_ID = #map.add_user_id:DECIMAL#</isNotEmpty>)
		                               
								  <isNotEmpty prepend=" and " property="map.cur_month">to_char (a.opr_date, 'YYYYMM') = #map.cur_month:VARCHAR#</isNotEmpty>
								 ) summary
		                   </isEmpty>
		                  LEFT JOIN  KONKA_R3_SHOP shop
		                     ON summary.R3_CODE = shop.R3_CODE
		            WHERE 1 = 1 
		             <isNotEmpty prepend=" and " property="map.branch_area_name_2">shop.BRANCH_AREA_NAME_2 = #map.branch_area_name_2:VARCHAR#</isNotEmpty>
				  ) data
				GROUP BY data.AREA_NAME,data.BRANCH_AREA_NAME
<!--		<include refid="sf-jcfxKczzKh" />-->
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<insert id="insertJcfxKczzKh" parameterClass="jcfxKczzKh">
		<selectKey resultClass="long" keyProperty="id">select JCFX_KCZZ_KH_SEQ.nextval as id from dual </selectKey>
		<![CDATA[insert into JCFX_KCZZ_KH (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="coustmer_name">COUSTMER_NAME</isNotNull>	
			<isNotNull prepend="," property="cust_id">CUST_ID</isNotNull>	
			<isNotNull prepend="," property="r3_code">R3_CODE</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="remark">REMARK</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="coustmer_name">#coustmer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="cust_id">#cust_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">#r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">#remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">#add_user_name:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateJcfxKczzKh" parameterClass="JcfxKczzKh">
		update JCFX_KCZZ_KH
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="coustmer_name">COUSTMER_NAME = #coustmer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="cust_id">CUST_ID = #cust_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">REMARK = #remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteJcfxKczzKh" parameterClass="JcfxKczzKh">
		delete from JCFX_KCZZ_KH where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>