<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="BASE_PROVINCE_LIST">

	<typeAlias alias="baseProvinceList" type="com.ebiz.mmt.domain.BaseProvinceList" />

	<resultMap id="baseProvinceListResultForList" class="baseProvinceList">
		<result column="P_INDEX" property="p_index" jdbcType="DECIMAL" />
		<result column="P_NAME" property="p_name" jdbcType="VARCHAR" />
		<result column="S_NAME" property="s_name" jdbcType="VARCHAR" />
		<result column="PAR_INDEX" property="par_index" jdbcType="DECIMAL" />
		<result column="P_LEVEL" property="p_level" jdbcType="DECIMAL" />
		<result column="ALONE" property="alone" jdbcType="DECIMAL" />
		<result column="ROOT_CODE" property="root_code" jdbcType="DECIMAL" />
		<result column="P_MAG" property="p_mag" jdbcType="DECIMAL" />
		<result column="P_CODE" property="p_code" jdbcType="VARCHAR" />
		<result column="IS_WEST" property="is_west" jdbcType="DECIMAL" />
		<result column="ORDER_SORT" property="order_sort" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATE" />
		<result column="DEL_MARK" property="del_mark" jdbcType="DECIMAL" />
		<result column="DEL_DATE" property="del_date" jdbcType="DATE" />
		<result column="FULL_NAME" property="full_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="baseProvinceListResult" class="baseProvinceList" extends="baseProvinceListResultForList">
	</resultMap>

	<resultMap id="baseProvinceListResultForPaginatedList" class="baseProvinceList" extends="baseProvinceListResultForList">
		<result column="PAR_NAME" property="map.par_name" jdbcType="VARCHAR" />
		<result column="ROOT_NAME" property="map.root_name" jdbcType="VARCHAR" />
	</resultMap>


	<sql id="sf-baseProvinceList">
		<isNotEmpty prepend=" and " property="p_index">P_INDEX = #p_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="del_mark">DEL_MARK = #del_mark:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_level">P_LEVEL = #p_level:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_name">P_NAME like '%' || #p_name:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="p_code">P_CODE = #p_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.pdShow"><![CDATA[ p_level <= 1 ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="par_index">PAR_INDEX = #par_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_index_li">PAR_INDEX = #par_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_index_gt">PAR_INDEX > #map.par_index_gt:DECIMAL#</isNotEmpty>

		<isNotEmpty prepend=" and " property="map.p_index_in">
			p_index in
			<iterate close=")" open="(" conjunction="," property="map.p_index_in">#map.p_index_in[]#</iterate>
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.many_p_index">P_INDEX in ($map.many_p_index$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_index_like">P_INDEX like '34%'</isNotEmpty>

		<isNotEmpty prepend=" and " property="map.is_managered">
			(select count(kd.m_areas_ids) as is_used from konka_dept kd where kd.DEPT_TYPE=3 and instr(kd.m_areas_ids,bp.p_index)>0)=0
		</isNotEmpty>

	</sql>

	<select id="selectBaseProvinceList" resultMap="baseProvinceListResult" parameterClass="baseProvinceList">
		select * from KONKA_BASE_PROVINCE_LIST_FOUR where 1 = 1
		<include refid="sf-baseProvinceList" />
	</select>

	<select id="selectBaseProvinceListList" resultMap="baseProvinceListResultForList" parameterClass="baseProvinceList">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_BASE_PROVINCE_LIST_FOUR bp where 1 = 1
		<include refid="sf-baseProvinceList" />
		order by ORDER_SORT
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>


	<select id="selectBaseProvinceListParentList" resultMap="baseProvinceListResultForList" parameterClass="baseProvinceList">
		select * from KONKA_BASE_PROVINCE_LIST_FOUR r
		where r.del_mark = 0
		start with p_index = $p_index$ and del_mark = 0 connect by prior par_index = p_index
		order by level desc
	</select>

	<select id="selectBaseProvinceListChildrenList" resultMap="baseProvinceListResultForList" parameterClass="baseProvinceList">
		select * from KONKA_BASE_PROVINCE_LIST_FOUR r
		where r.del_mark = 0 and p_level = $p_level$
		start with p_index = $p_index$ and del_mark = 0 connect by prior p_index = par_index
		order by level desc
	</select>

	<select id="selectBaseProvinceListCount" resultClass="long" parameterClass="baseProvinceList">
		select count(*) from (
		select distinct *
		from KONKA_BASE_PROVINCE_LIST_FOUR
		where del_mark = 0
		<isNotEmpty prepend=" and " property="p_code">
			(p_code = #p_code:VARCHAR#)
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_index">
			(p_index = #p_index:DECIMAL# or par_index = #p_index:DECIMAL# or root_code = #p_index:DECIMAL#)
		</isNotEmpty>
		start with 1 = 1
		and DEL_MARK = 0
		and (1 = 0
		<isNotEmpty prepend=" or " property="p_index">P_INDEX = #p_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" or " property="p_name">P_NAME like '%' || #p_name:VARCHAR# || '%' </isNotEmpty>
		<isEmpty prepend=" " property="p_index">
			<isEmpty prepend=" " property="p_name">or 1 = 1</isEmpty>
		</isEmpty>
		)
		connect by prior p_index = par_index
		order by p_index )
	</select>

	<select id="selectBaseProvinceListPaginatedList" resultMap="baseProvinceListResultForPaginatedList" parameterClass="baseProvinceList">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			select t.*, t1.p_name as PAR_NAME, t2.p_name as ROOT_NAME
			from (select distinct *
			from KONKA_BASE_PROVINCE_LIST_FOUR
			where del_mark = 0
			<isNotEmpty prepend=" and " property="p_code">
				(p_code = #p_code:VARCHAR#)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="p_index">
				(p_index = #p_index:DECIMAL# or par_index = #p_index:DECIMAL# or root_code = #p_index:DECIMAL#)
			</isNotEmpty>
			start with 1 = 1
			and DEL_MARK = 0
			and (1 = 0
			<isNotEmpty prepend=" or " property="p_index">p_index = #p_index:DECIMAL# or par_index = #p_index:DECIMAL# or root_code = #p_index:DECIMAL#</isNotEmpty>
			<isNotEmpty prepend=" or " property="p_name">P_NAME like '%' || #p_name:VARCHAR# || '%' </isNotEmpty>
			<isEmpty prepend=" " property="p_index">
				<isEmpty prepend=" " property="p_name">or 1 = 1</isEmpty>
			</isEmpty>
			)
			connect by prior p_index = par_index
			order by p_index) t
			left join KONKA_BASE_PROVINCE_LIST_FOUR t1 on t.par_index = t1.p_index
			left join KONKA_BASE_PROVINCE_LIST_FOUR t2 on t.root_code = t2.p_index
			order by t.p_index asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<!-- 根据p_index查找上级P_index Li,Ka 2011-11-28 -->
	<select id="selectBaseProvinceListAllParPindexByPindex" resultMap="baseProvinceListResultForList" parameterClass="baseProvinceList">
		select a.*
		from KONKA_BASE_PROVINCE_LIST_FOUR a
		where del_mark = 0
		start with a.p_index = #map.shop_p_index:DECIMAL#
		connect by prior a.par_index =a.p_index
		order by a.p_level asc,a.p_index desc
	</select>

	<update id="updateBaseProvinceList" parameterClass="baseProvinceList">
		update KONKA_BASE_PROVINCE_LIST_FOUR
		<dynamic prepend="set">
			<isNotNull prepend="," property="p_name">P_NAME = #p_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="s_name">S_NAME = #s_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="par_index">PAR_INDEX = #par_index:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_level">P_LEVEL = #p_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="alone">ALONE = #alone:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="root_code">ROOT_CODE = #root_code:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_mag">P_MAG = #p_mag:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_code">P_CODE = #p_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_west">IS_WEST = #is_west:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="order_sort">ORDER_SORT = #order_sort:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:DATE#</isNotNull>
			<isNotNull prepend="," property="del_mark">DEL_MARK = #del_mark:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="del_date">DEL_DATE = #del_date:DATE#</isNotNull>
			<isNotNull prepend="," property="full_name">FULL_NAME = #full_name:VARCHAR#</isNotNull>
		</dynamic>
		where P_INDEX = #p_index:DECIMAL#
	</update>

</sqlMap>