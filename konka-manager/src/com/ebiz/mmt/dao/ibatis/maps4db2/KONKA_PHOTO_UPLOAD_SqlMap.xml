<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_PHOTO_UPLOAD">

	<typeAlias alias="konkaPhotoUpload" type="com.ebiz.mmt.domain.KonkaPhotoUpload" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaPhotoUpload" />
		<flushOnExecute statement="updateKonkaPhotoUpload" />
		<flushOnExecute statement="deleteKonkaPhotoUpload" />
	</cacheModel>

	<resultMap id="konkaPhotoUploadResultForList" class="konkaPhotoUpload">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="TYPE_ID" property="type_id" jdbcType="DECIMAL" />
		<result column="DEPT_NAME" property="dept_name" jdbcType="VARCHAR" />
		<result column="R3_CODE" property="r3_code" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="customer_name" jdbcType="VARCHAR" />
		<result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
		<result column="STORE_NAME" property="store_name" jdbcType="VARCHAR" />
		<result column="REPORT_USER_ID" property="report_user_id" jdbcType="DECIMAL" />
		<result column="REPORT_USER_NAME" property="report_user_name" jdbcType="VARCHAR" />
		<result column="REPORT_MEMO" property="report_memo" jdbcType="VARCHAR" />
		<result column="REPORT_DATE" property="report_date" jdbcType="TIMESTAMP" />
		<result column="UPDATE_USER_ID" property="update_user_id" jdbcType="DECIMAL" />
		<result column="UPDATE_USER_NAME" property="update_user_name" jdbcType="VARCHAR" />
		<result column="UPDATE_DATE" property="update_date" jdbcType="TIMESTAMP" />
		<result column="REMARK" property="remark" jdbcType="VARCHAR" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="TYPE" property="type" jdbcType="DECIMAL" />
		<result column="STATUS" property="status" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="konkaPhotoUploadResult" class="konkaPhotoUpload" extends="konkaPhotoUploadResultForList">
	</resultMap>
	
    <resultMap id="konkaPhotoUploadResultLB" class="konkaPhotoUpload" extends="konkaPhotoUploadResultForList">
	    <result column="TYPE_TILTE" property="map.type_tilte" jdbcType="VARCHAR" />
	    <result column="fj_paths" property="map.fj_paths" jdbcType="VARCHAR" />
	    <result column="POSITION_X" property="map.position_x" jdbcType="VARCHAR" />
	    <result column="POSITION_Y" property="map.position_y" jdbcType="VARCHAR" />
	    <result column="ADDR" property="map.addr" jdbcType="VARCHAR" />
	</resultMap>
	<sql id="sf-konkaPhotoUpload">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type_id">TYPE_ID = #type_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_name">STORE_NAME = #store_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_user_id">REPORT_USER_ID = #report_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_user_name">REPORT_USER_NAME = #report_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_memo">REPORT_MEMO = #report_memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_id">UPDATE_USER_ID = #update_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_name">UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="remark">REMARK = #remark:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type">TYPE = #type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="status">STATUS = #status:DECIMAL#</isNotEmpty>
	</sql>

   <sql id="sf-konkaPhotoUploadLB">
		<isNotEmpty prepend=" and " property="id">upload.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type_id">upload.TYPE_ID = #type_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name">upload.DEPT_NAME = #dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">upload.R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">upload.CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">upload.STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_name">upload.STORE_NAME = #store_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_user_id">upload.REPORT_USER_ID = #report_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_user_name">upload.REPORT_USER_NAME = #report_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_memo">upload.REPORT_MEMO = #report_memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_date">upload.REPORT_DATE = #report_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_id">upload.UPDATE_USER_ID = #update_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_user_name">upload.UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_date">upload.UPDATE_DATE = #update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="remark">upload.REMARK = #remark:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">upload.IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">upload.DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type">upload.TYPE = #type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="status">upload.STATUS = #status:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map._dept_id">upload.DEPT_ID = #map._dept_id:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.id">upload.ID = #map.id:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map._r3_code_like">
			   upload.R3_CODE like '%' || #map._r3_code_like:VARCHAR# || '%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map._store_id_like">
		       upload.STORE_ID like '%' || #map._store_id_like:VARCHAR# || '%'
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map._customer_name_like">
			   upload.CUSTOMER_NAME like '%' || #map._customer_name_like:VARCHAR# || '%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map._store_name_like">
		       upload.STORE_NAME like '%' || #map._store_name_like:VARCHAR# || '%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map._report_user_name_like">
		       upload.REPORT_USER_NAME like '%' || #map._report_user_name_like:VARCHAR# || '%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map._begin_report_date">
                 <![CDATA[ upload.REPORT_DATE >= to_date (#map._begin_report_date:VARCHAR#, 'yyyy-mm-dd hh24:mi:ss') ]]>
	    </isNotEmpty>
	    <isNotEmpty prepend=" and " property="map._end_report_date">
	         <![CDATA[ upload.REPORT_DATE <= to_date (#map._end_report_date:VARCHAR#, 'yyyy-mm-dd hh24:mi:ss') ]]>
	    </isNotEmpty>
	     <isNotEmpty prepend=" and " property="map.dept_id_start">
			       upload.REPORT_USER_ID IN
			              (SELECT deptDownUser.ID
			                 FROM KONKA_PE_PROD_USER deptDownUser
			                WHERE deptDownUser.DEPT_ID IN
			                         (SELECT dept_id
			                            FROM konka_dept
			                          START WITH dept_id IN
			                                        (SELECT DISTINCT (dept_id)
			                                           FROM KONKA_ROLE_DATA_LEVEL
			                                          WHERE role_id IN
			                                                   (SELECT role_id
			                                                      FROM KONKA_PE_ROLE_USER
			                                                     WHERE user_id = #map.session_user_id:DECIMAL#))
			                                     OR dept_id = #map.dept_id_start#
			                          CONNECT BY PRIOR dept_id = par_id))
			       OR upload.REPORT_USER_ID = #map.session_user_id:DECIMAL#  
		</isNotEmpty>
			 
	</sql>
	
	<select id="selectKonkaPhotoUpload" resultMap="konkaPhotoUploadResult" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		select * from KONKA_PHOTO_UPLOAD where 1 = 1
		<include refid="sf-konkaPhotoUpload" />
	</select>

	<select id="selectKonkaPhotoUploadList" resultMap="konkaPhotoUploadResultForList" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_PHOTO_UPLOAD where 1 = 1
		<include refid="sf-konkaPhotoUpload" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaPhotoUploadCount" resultClass="long" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		select count(*) from KONKA_PHOTO_UPLOAD where 1 = 1
		<include refid="sf-konkaPhotoUpload" />
	</select>

	<select id="selectKonkaPhotoUploadPaginatedList" resultMap="konkaPhotoUploadResult" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_PHOTO_UPLOAD where 1 = 1
		<include refid="sf-konkaPhotoUpload" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
    <!--连表-->
    <select id="selectKonkaPhotoUploadLBCount" resultClass="long" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		SELECT count(*)
       FROM    KONKA_PHOTO_UPLOAD upload
       LEFT JOIN
          KONKA_PHOTO_UPLOAD_TYPE type
       ON upload.TYPE_ID = type.ID
       where 1=1
		<include refid="sf-konkaPhotoUploadLB" />
	</select>
    <!--连表-->
	<select id="selectKonkaPhotoUploadLBPaginatedList" resultMap="konkaPhotoUploadResultLB" parameterClass="konkaPhotoUpload" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		SELECT type.TYPE_TILTE,
			(select
			listagg(f.save_path, ',') within group (order by
			f.LINK_ID)
			from
			ATTACHMENT f
			where
			f.LINK_TAB='KONKA_PHOTO_UPLOAD' and f.DEL_MARK =0 and
			f.LINK_ID=upload.ID
			group by
			LINK_ID ) fj_paths,
			upload.*,
			gps.POSITION_X,
		    gps.POSITION_Y,
		    gps.ADDR
			  FROM    KONKA_PHOTO_UPLOAD upload
	        LEFT JOIN
	          KONKA_PHOTO_UPLOAD_TYPE type
	        ON upload.TYPE_ID = type.ID
	        Left join KONKA_MOBILE_CUST_VISIT_GPS gps
            on upload.ID=gps.LINK_ID and gps.LINK_TAB='KONKA_PHOTO_UPLOAD'
			where 1=1
		<include refid="sf-konkaPhotoUploadLB" />
		 order by upload.REPORT_DATE desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaPhotoUpload" parameterClass="konkaPhotoUpload">
		<selectKey resultClass="long" keyProperty="id">select KONKA_PHOTO_UPLOAD_SEQ.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_PHOTO_UPLOAD (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="type_id">TYPE_ID</isNotNull>	
			<isNotNull prepend="," property="dept_name">DEPT_NAME</isNotNull>	
			<isNotNull prepend="," property="r3_code">R3_CODE</isNotNull>	
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME</isNotNull>	
			<isNotNull prepend="," property="store_id">STORE_ID</isNotNull>	
			<isNotNull prepend="," property="store_name">STORE_NAME</isNotNull>	
			<isNotNull prepend="," property="report_user_id">REPORT_USER_ID</isNotNull>	
			<isNotNull prepend="," property="report_user_name">REPORT_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="report_memo">REPORT_MEMO</isNotNull>	
			<isNotNull prepend="," property="report_date">REPORT_DATE</isNotNull>	
			<isNotNull prepend="," property="update_user_id">UPDATE_USER_ID</isNotNull>	
			<isNotNull prepend="," property="update_user_name">UPDATE_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="update_date">UPDATE_DATE</isNotNull>	
			<isNotNull prepend="," property="remark">REMARK</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="type">TYPE</isNotNull>
			<isNotNull prepend="," property="status">STATUS</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type_id">#type_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_name">#dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="r3_code">#r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">#customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="store_id">#store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_name">#store_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_user_id">#report_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_user_name">#report_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_memo">#report_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_date">#report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="update_user_id">#update_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_user_name">#update_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="update_date">#update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">#remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type">#type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="status">#status:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaPhotoUpload" parameterClass="KonkaPhotoUpload">
		update KONKA_PHOTO_UPLOAD
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type_id">TYPE_ID = #type_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="store_id">STORE_ID = #store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_name">STORE_NAME = #store_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_user_id">REPORT_USER_ID = #report_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_user_name">REPORT_USER_NAME = #report_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_memo">REPORT_MEMO = #report_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="update_user_id">UPDATE_USER_ID = #update_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_user_name">UPDATE_USER_NAME = #update_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="remark">REMARK = #remark:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="type">TYPE = #type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="status">STATUS = #status:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaPhotoUpload" parameterClass="KonkaPhotoUpload">
		delete from KONKA_PHOTO_UPLOAD where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>