<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<!-- Code by AutoGenerated Builder -->
<!-- AutoGenerated Builder Version 2.1 -->
<!-- @author Hui,Gang -->
<!-- @datetime 2011-12-01 09:21:56 -->
<sqlMap namespace="KONKA_EXPENSE_CLAIMS">

	<typeAlias alias="konkaExpenseClaims" type="com.ebiz.mmt.domain.KonkaExpenseClaims" />

	

	<resultMap id="konkaExpenseClaimsResultForList" class="konkaExpenseClaims">
		<result column="FILE_ID" property="file_id" jdbcType="DECIMAL" />
		<result column="COLUMN_1" property="column_1" jdbcType="VARCHAR" />
		<result column="COLUMN_2" property="column_2" jdbcType="DECIMAL" />
		<result column="C_TYPE" property="c_type" jdbcType="DECIMAL" />
		<result column="COLUMN_4" property="column_4" jdbcType="VARCHAR" />
		<result column="COLUMN_5" property="column_5" jdbcType="VARCHAR" />
		<result column="COLUMN_6" property="column_6" jdbcType="DECIMAL" />
		<result column="COLUMN_7" property="column_7" jdbcType="VARCHAR" />
		<result column="COLUMN_8" property="column_8" jdbcType="DATE" />
		<result column="COLUMN_9" property="column_9" jdbcType="DATE" />
		<result column="COLUMN_9" property="column_9" jdbcType="DATE" />
		<result column="R3_SHOP_ID" property="r3_shop_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="expenseClaimsResult" class="konkaExpenseClaims" extends="konkaExpenseClaimsResultForList">
		<result column="FILE_NO" property="map.file_no" jdbcType="VARCHAR" />
		<result column="FILE_TITLE" property="map.file_title" jdbcType="VARCHAR" />
		<result column="SUBMIT_DATETIME" property="submit_datetime" jdbcType="DATETIME" />
		<result column="SUBMIT_USER" property="map.submit_user" jdbcType="VARCHAR" />
		<result column="FILE_STATUS" property="map.file_status" jdbcType="VARCHAR" />
		<result column="SUBMIT_USER" property="map.submit_user" jdbcType="VARCHAR" />
		<result column="IS_NODE" property="map.is_node" jdbcType="VARCHAR" />
	</resultMap>
	
	

	<resultMap id="konkaExpenseClaimsResult" class="konkaExpenseClaims" extends="konkaExpenseClaimsResultForList">
	</resultMap>
	<sql id="sf-konkaExpenseClaims">
		<isNotEmpty prepend=" and " property="file_id">FILE_ID = #file_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_1">COLUMN_1 = #column_1:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_2">COLUMN_2 = #column_2:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="c_type">C_TYPE = #c_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_4">COLUMN_4 = #column_4:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_5">COLUMN_5 = #column_5:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_6">COLUMN_6 = #column_6:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_7">COLUMN_7 = #column_7:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_8">COLUMN_8 = #column_8:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="column_9">COLUMN_9 = #column_9:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_shop_id">R3_SHOP_ID = #r3_shop_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.file_no">b.FILE_NO like '%' || #map.file_no:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.file_title_like">b.FILE_TITLE like '%' || #map.file_title_like:VARCHAR# || '%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.map_file_status">
			b.FILE_STATUS in ($map.map_file_status$)
		</isNotEmpty>

		<isNotEmpty property="map.st_submit_datetime">
			<isNotEmpty prepend=" and " property="map.en_submit_datetime">
				<![CDATA[ to_char(b.SUBMIT_DATETIME, 'yyyy-MM-dd') >= #map.st_submit_datetime# and to_char(b.SUBMIT_DATETIME, 'yyyy-MM-dd') <= #map.en_submit_datetime#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_submit_datetime">
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM-dd') >= #map.st_submit_datetime#
			</isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_submit_datetime">
			<isNotEmpty prepend=" and " property="map.en_submit_datetime">
				<![CDATA[ 
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM-dd') <= #map.en_submit_datetime#
				]]>
			</isNotEmpty>
		</isEmpty>
	</sql>

	<select id="selectKonkaExpenseClaims" resultMap="konkaExpenseClaimsResult" parameterClass="konkaExpenseClaims"
		>
		select * from KONKA_EXPENSE_CLAIMS where 1 = 1
		<include refid="sf-konkaExpenseClaims" />
	</select>

	<select id="selectKonkaExpenseClaimsList" resultMap="konkaExpenseClaimsResultForList" parameterClass="konkaExpenseClaims"
		>
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_EXPENSE_CLAIMS where 1 = 1
		<include refid="sf-konkaExpenseClaims" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaExpenseClaimsCount" resultClass="long" parameterClass="konkaExpenseClaims" >
		select count(*) from KONKA_EXPENSE_CLAIMS a left join konkaoa_files b on a.file_id= b.id
		where 1 = 1
		and b.file_type = 1
		<isNotEmpty property="map.submit_user" prepend=" and ">b.submit_user =#map.submit_user#</isNotEmpty>
		<isNotEmpty property="map.submit_user_id" prepend=" and ">b.submit_user_id =#map.submit_user_id#</isNotEmpty>
		<include refid="sf-konkaExpenseClaims" />
	</select>

	<select id="selectKonkaExpenseClaimsPaginatedList" resultMap="expenseClaimsResult" parameterClass="konkaExpenseClaims"
		>
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.file_no,b.file_title,b.submit_user,b.submit_datetime,b.file_status,b.is_node from
		KONKA_EXPENSE_CLAIMS a left join konkaoa_files b on a.file_id= b.id
		where 1 = 1
		and b.file_type= 1
		<isNotEmpty property="map.selectR3Shop">and a.file_id in (select e.file_id from konka_expense_claims e 
		                                                               where e.r3_shop_id in (select id from konka_r3_shop r 
		                                                               where 1=1  
		                                                               <isNotEmpty property="map.r3_code" prepend=" and ">r.r3_code like '%' ||#map.r3_code#|| '%'</isNotEmpty>
		                                                               <isNotEmpty property="map.customer_name" prepend=" and ">r.customer_name like '%' || #map.customer_name# || '%'</isNotEmpty>
		                                                              ))
		 </isNotEmpty>
		<isNotEmpty property="map.submit_user" prepend=" and ">b.submit_user =#map.submit_user#</isNotEmpty>
		<isNotEmpty property="map.submit_user_id" prepend=" and ">b.submit_user_id =#map.submit_user_id#</isNotEmpty>
		<include refid="sf-konkaExpenseClaims" />
		order by file_id desc 
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaExpenseClaims" parameterClass="konkaExpenseClaims">
		<![CDATA[insert into KONKA_EXPENSE_CLAIMS (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="file_id">FILE_ID</isNotNull>
			<isNotNull prepend="," property="column_1">COLUMN_1</isNotNull>
			<isNotNull prepend="," property="column_2">COLUMN_2</isNotNull>
			<isNotNull prepend="," property="c_type">C_TYPE</isNotNull>
			<isNotNull prepend="," property="column_4">COLUMN_4</isNotNull>
			<isNotNull prepend="," property="column_5">COLUMN_5</isNotNull>
			<isNotNull prepend="," property="column_6">COLUMN_6</isNotNull>
			<isNotNull prepend="," property="column_7">COLUMN_7</isNotNull>
			<isNotNull prepend="," property="column_8">COLUMN_8</isNotNull>
			<isNotNull prepend="," property="column_9">COLUMN_9</isNotNull>
			<isNotNull prepend="," property="r3_shop_id">R3_SHOP_ID</isNotNull>
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="file_id">#file_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_1">#column_1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_2">#column_2:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="c_type">#c_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_4">#column_4:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_5">#column_5:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_6">#column_6:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_7">#column_7:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_8">#column_8:DATE#</isNotNull>
			<isNotNull prepend="," property="column_9">#column_9:DATE#</isNotNull>
			<isNotNull prepend="," property="r3_shop_id">#r3_shop_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaExpenseClaims" parameterClass="konkaExpenseClaims">
		update KONKA_EXPENSE_CLAIMS
		<dynamic prepend="set">
			<isNotNull prepend="," property="file_id">FILE_ID = #file_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_1">COLUMN_1 = #column_1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_2">COLUMN_2 = #column_2:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="c_type">C_TYPE = #c_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_4">COLUMN_4 = #column_4:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_5">COLUMN_5 = #column_5:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_6">COLUMN_6 = #column_6:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="column_7">COLUMN_7 = #column_7:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="column_8">COLUMN_8 = #column_8:DATE#</isNotNull>
			<isNotNull prepend="," property="column_9">COLUMN_9 = #column_9:DATE#</isNotNull>
			<isNotNull prepend="," property="r3_shop_id">R3_SHOP_ID = #r3_shop_id:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="file_id">FILE_ID = #file_id#</isNotEmpty>
		<isEmpty prepend=" " property="file_id">
			<isNotEmpty prepend=" " property="map.pks">
				FILE_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaExpenseClaims" parameterClass="konkaExpenseClaims">
		delete from KONKA_EXPENSE_CLAIMS where
		<isNotEmpty prepend=" " property="file_id">FILE_ID = #file_id#</isNotEmpty>
		<isEmpty prepend=" " property="file_id">
			<isNotEmpty prepend=" " property="map.pks">
				FILE_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
	
	
	
	
	<!-- 费用统计 -->
	<select id="selectKonkaExpenseClaimsCountList" resultClass="java.util.HashMap" parameterClass="konkaExpenseClaims" remapResults="true">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>  
	     select  
	    sum(c.amount) as count, 
	    sum(a.column_6) as all_price,
        count(1) as num 
	    <isNotNull prepend="," property="map.selected01">b.submit_user as submit_user</isNotNull>
	    <isNotNull prepend="," property="map.selected02">e.customer_name as r3_shop_id</isNotNull>
		<isNotNull prepend="," property="map.selected03">to_char(b.submit_datetime, 'yyyy-MM') as submit_date</isNotNull>
		<isNotNull prepend="," property="map.selected04">d.c_name as c_index</isNotNull>
		
        from KONKA_EXPENSE_CLAIMS a 
		left join konkaoa_files b on a.file_id= b.id
		left join KONKAOA_FILES_PROPERTY c on c.link_id=a.file_id
		left join KONKAOA_CATEGORY d on d.c_index=c.c_index
		left join KONKA_R3_SHOP e on e.id=a.r3_shop_id
		left join v_org_of_cxy f on f.r3_code=e.r3_code
		where 1 = 1 
		and b.file_type= 1 and b.file_status is not null 
		<isNotEmpty prepend=" " property="map.is_not_admin">
		<isNotEmpty prepend=" and " property="map.is_fgs_gly">dept_id =  #map.dept_value#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_fgs_user">
			     		( f.l4_dept_id in( SELECT DISTINCT (dept_id)
			  							FROM KONKA_ROLE_DATA_LEVEL
			 							WHERE role_id IN (SELECT role_id
			                     			FROM KONKA_PE_ROLE_USER
			                    			WHERE user_id = #map.fgs_user_id#))
			  			or f.l4_dept_id = #map.fgs_dept_id#)
		</isNotEmpty>
		</isNotEmpty>
		<include refid="sf-konkaExpenseClaims" />
		<isNotEmpty property="map.customer_name" prepend=" and ">e.customer_name like '%' || #map.customer_name# || '%'</isNotEmpty>
		<isNotEmpty property="map.submit_user_id" prepend=" and ">b.submit_user like '%' || #map.submit_user_id# || '%'</isNotEmpty>
		<isNotEmpty property="map.dept_id" prepend=" and ">f.dept_id = #map.dept_id#</isNotEmpty>
		<isNotEmpty property="map.r3_code" prepend=" and ">f.r3_code = #map.r3_code#</isNotEmpty>
		<isNotEmpty property="map.dept_sn" prepend=" and ">f.dept_sn = #map.dept_sn#</isNotEmpty>
		<isNotEmpty property="map.l4_dept_id" prepend=" and ">f.l4_dept_id = #map.l4_dept_id#</isNotEmpty>
		<isNotEmpty property="map.l5_dept_id" prepend=" and ">f.l5_dept_id = #map.l5_dept_id#</isNotEmpty>
		<isNotEmpty property="map.c_index" prepend=" and ">d.c_name like '%' || #map.c_index# || '%'</isNotEmpty>
		<isNotEmpty property="map.st_submit_date">
			<isNotEmpty prepend=" and " property="map.en_submit_date">
				<![CDATA[ to_char(b.SUBMIT_DATETIME, 'yyyy-MM') >= #map.st_submit_date# and to_char(b.SUBMIT_DATETIME, 'yyyy-MM') <= #map.en_submit_date#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_submit_date">
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM') >= #map.st_submit_date#
			</isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_submit_date">
			<isNotEmpty prepend=" and " property="map.en_submit_date">
				<![CDATA[ 
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM') <= #map.en_submit_date#
				]]>
			</isNotEmpty>
		</isEmpty>
		group by  1
		<isNotNull prepend="," property="map.selected01">b.submit_user</isNotNull>
	    <isNotNull prepend="," property="map.selected02">e.customer_name</isNotNull>
		<isNotNull prepend="," property="map.selected03">to_char(submit_datetime, 'yyyy-MM')</isNotNull>
		<isNotNull prepend="," property="map.selected04">d.c_name</isNotNull>
		having sum(a.column_6) is not null
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	
	<!--总条数,分页用 -->
	<select id="selectKonkaExpenseClaimsCountListCount" resultClass="long" parameterClass="konkaExpenseClaims" >
		<![CDATA[ select count(1) from ( ]]>
	     select  
	    sum(c.amount) as count, 
	    sum(a.column_6) as all_price,
        count(1) as num 
	    <isNotNull prepend="," property="map.selected01">b.submit_user as submit_user</isNotNull>
	    <isNotNull prepend="," property="map.selected02">e.customer_name as r3_shop_id</isNotNull>
		<isNotNull prepend="," property="map.selected03">to_char(b.submit_datetime, 'yyyy-MM') as submit_date</isNotNull>
		<isNotNull prepend="," property="map.selected04">d.c_name as c_index</isNotNull>
		
        from KONKA_EXPENSE_CLAIMS a 
		left join konkaoa_files b on a.file_id= b.id
		left join KONKAOA_FILES_PROPERTY c on c.link_id=a.file_id
		left join KONKAOA_CATEGORY d on d.c_index=c.c_index
		left join KONKA_R3_SHOP e on e.id=a.r3_shop_id
		left join v_org_of_cxy f on f.r3_code=e.r3_code
		where 1 = 1 
		and b.file_type= 1 and b.file_status is not null 
		<isNotEmpty prepend=" " property="map.is_not_admin">
		<isNotEmpty prepend=" and " property="map.is_fgs_gly">dept_id =  #map.dept_value#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_fgs_user">
			     		( f.l4_dept_id in( SELECT DISTINCT (dept_id)
			  							FROM KONKA_ROLE_DATA_LEVEL
			 							WHERE role_id IN (SELECT role_id
			                     			FROM KONKA_PE_ROLE_USER
			                    			WHERE user_id = #map.fgs_user_id#))
			  			or f.l4_dept_id = #map.fgs_dept_id#)
		</isNotEmpty>
		</isNotEmpty>
		<include refid="sf-konkaExpenseClaims" />
		<isNotEmpty property="map.customer_name" prepend=" and ">e.customer_name like '%' || #map.customer_name# || '%'</isNotEmpty>
		<isNotEmpty property="map.submit_user_id" prepend=" and ">b.submit_user like '%' || #map.submit_user_id# || '%'</isNotEmpty>
		<isNotEmpty property="map.dept_id" prepend=" and ">f.dept_id = #map.dept_id#</isNotEmpty>
		<isNotEmpty property="map.r3_code" prepend=" and ">f.r3_code = #map.r3_code#</isNotEmpty>
		<isNotEmpty property="map.dept_sn" prepend=" and ">f.dept_sn = #map.dept_sn#</isNotEmpty>
		<isNotEmpty property="map.l4_dept_id" prepend=" and ">f.l4_dept_id = #map.l4_dept_id#</isNotEmpty>
		<isNotEmpty property="map.l5_dept_id" prepend=" and ">f.l5_dept_id = #map.l5_dept_id#</isNotEmpty>
		<isNotEmpty property="map.c_index" prepend=" and ">d.c_name like '%' || #map.c_index# || '%'</isNotEmpty>
		<isNotEmpty property="map.st_submit_date">
			<isNotEmpty prepend=" and " property="map.en_submit_date">
				<![CDATA[ to_char(b.SUBMIT_DATETIME, 'yyyy-MM') >= #map.st_submit_date# and to_char(b.SUBMIT_DATETIME, 'yyyy-MM') <= #map.en_submit_date#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_submit_date">
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM') >= #map.st_submit_date#
			</isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_submit_date">
			<isNotEmpty prepend=" and " property="map.en_submit_date">
				<![CDATA[ 
				to_char(b.SUBMIT_DATETIME, 'yyyy-MM') <= #map.en_submit_date#
				]]>
			</isNotEmpty>
		</isEmpty>
		group by  1
		<isNotNull prepend="," property="map.selected01">b.submit_user</isNotNull>
	    <isNotNull prepend="," property="map.selected02">e.customer_name</isNotNull>
		<isNotNull prepend="," property="map.selected03">to_char(b.submit_datetime, 'yyyy-MM')</isNotNull>
		<isNotNull prepend="," property="map.selected04">d.c_name</isNotNull>
		having sum(a.column_6) is not null
		<![CDATA[ )]]>
	</select>
</sqlMap>