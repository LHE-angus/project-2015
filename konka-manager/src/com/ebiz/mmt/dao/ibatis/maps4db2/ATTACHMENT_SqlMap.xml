<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ATTACHMENT">

	<typeAlias alias="attachment" type="com.ebiz.mmt.domain.Attachment" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertAttachment" />
		<flushOnExecute statement="updateAttachment" />
		<flushOnExecute statement="deleteAttachment" />
	</cacheModel>

	<resultMap id="attachmentResultForList" class="attachment">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="LINK_ID" property="link_id" jdbcType="DECIMAL" />
		<result column="LINK_TAB" property="link_tab" jdbcType="VARCHAR" />
		<result column="FILE_NAME" property="file_name" jdbcType="VARCHAR" />
		<result column="FILE_TYPE" property="file_type" jdbcType="VARCHAR" />
		<result column="FILE_SIZE" property="file_size" jdbcType="DECIMAL" />
		<result column="SAVE_PATH" property="save_path" jdbcType="VARCHAR" />
		<result column="SAVE_NAME" property="save_name" jdbcType="VARCHAR" />
		<result column="FILE_DESC" property="file_desc" jdbcType="VARCHAR" />
		<result column="DEL_MARK" property="del_mark" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="attachmentResult" class="attachment" extends="attachmentResultForList">
	</resultMap>

	<sql id="sf-attachment">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_tab">LINK_TAB = #link_tab:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_name">FILE_NAME = #file_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_type">FILE_TYPE = #file_type:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_size">FILE_SIZE = #file_size:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="save_path">SAVE_PATH = #save_path:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="save_name">SAVE_NAME = #save_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_desc">FILE_DESC = #file_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="del_mark">DEL_MARK = #del_mark:DECIMAL#</isNotEmpty>
	</sql>

	<select id="selectAttachment" resultMap="attachmentResult" parameterClass="attachment" cacheModel="oneDayCache">
		select * from ATTACHMENT where 1 = 1
		<include refid="sf-attachment" />
	</select>

	<select id="selectAttachmentList" resultMap="attachmentResultForList" parameterClass="attachment" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from ATTACHMENT where 1 = 1
		<include refid="sf-attachment" />
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
		<isNotEmpty property="map.sort">order by file_desc</isNotEmpty>
		<isEmpty property="map.sort">order by id desc </isEmpty>
	</select>

	<select id="selectAttachmentCount" resultClass="long" parameterClass="attachment" cacheModel="oneDayCache">
		select count(*) from ATTACHMENT where 1 = 1
		<include refid="sf-attachment" />
	</select>

	<select id="selectAttachmentPaginatedList" resultMap="attachmentResult" parameterClass="attachment" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from ATTACHMENT where 1 = 1
		<include refid="sf-attachment" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertAttachment" parameterClass="attachment">
		<selectKey resultClass="java.lang.Long" keyProperty="id">select base_sequence.nextval as id from dual
		</selectKey>
		<![CDATA[
		insert into ATTACHMENT 
		(
			ID,
			LINK_ID,
			LINK_TAB,
			FILE_NAME,
			FILE_TYPE,
			FILE_SIZE,
			SAVE_PATH,
			SAVE_NAME,
			FILE_DESC,
			DEL_MARK
		) 
		values 
		(
			#id:DECIMAL#,
			#link_id:DECIMAL#,
			#link_tab:VARCHAR#,
			#file_name:VARCHAR#,
			#file_type:VARCHAR#,
			#file_size:DECIMAL#,
			#save_path:VARCHAR#,
			#save_name:VARCHAR#,
			#file_desc:VARCHAR#,
			#del_mark:DECIMAL#
		)
		]]>
	</insert>

	<update id="updateAttachment" parameterClass="attachment">
		update ATTACHMENT
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_tab">LINK_TAB = #link_tab:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_name">FILE_NAME = #file_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_type">FILE_TYPE = #file_type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_size">FILE_SIZE = #file_size:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="save_path">SAVE_PATH = #save_path:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="save_name">SAVE_NAME = #save_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="file_desc">FILE_DESC = #file_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">DEL_MARK = #del_mark:DECIMAL#</isNotNull>
		</dynamic>
		where ID = #id:DECIMAL#
	</update>

	<delete id="deleteAttachment" parameterClass="attachment">
		update ATTACHMENT set DEL_MARK = 1 where 1=1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" and " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
		<isNotEmpty prepend=" and " property="link_id">
			LINK_ID =#link_id:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="file_desc">
			FILE_DESC =#file_desc:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_tab">
			LINK_TAB =#link_tab:VARCHAR#
		</isNotEmpty>
	</delete>

</sqlMap>