<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head xmlns="">
<title>数据上报</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0;user-scalable=0;" />
<link rel="stylesheet" type="text/css" href="css/common.css" />
</head>
<body>
<!--head start -->
<div class="top4 head_class">
  <div class="jiantou"><a ><img src="images/jiantou_09.jpg" onclick="javascript:history.back();" /></a></div>
  <div class="topzi" style="float:left; display:inline; width:100px; padding-left:15%"><img src="images/shujushagnb.png" /></div>
</div>
<div class="headtab31 head_class"></div>
<form action="#" name="temp_form" id="temp_form" method="post" enctype="multipart/form-data">
<input type="hidden" name="method" value="SaveAttachment" />
<input type="hidden" id="lid" name="lid" value="" />
<input type="hidden" id="username" name="username" value="" />
<input type="hidden" id="userpass" name="userpass" value="" />
<table width="100%" border="0"  class="rtab3">
  <tr>
    <th colspan="2" align="right"><span id="sj_his" style="cursor:pointer;">历史记录　</span></th>
  </tr>
  <tr>
    <td width="25%" align="center">分公司</td>
    <td width="75%" align="left"><span id="subcomp_name" style="color:blue;font-weight:normal;font-size:16px;"></span><br /></td>
  </tr>
  <tr>
    <td align="center">门店</td>
    <td align="left"><span id="dept_name" style="color:blue;font-weight:normal;font-size:16px;"></span><br /></td>
  </tr>
  <tr>
    <td align="center">型号</td>
    <td align="left"><input type="hidden" name="select-choice-2" id="select-choice-2" value="" />
    	<input class="selblue422" type="text" name="select-choice-1" id="select-choice-1" maxlength="50" />
    	<span class="red16px">*</span><br /></td>
  </tr>
  <tr>
    <td align="center">数量</td>
    <td align="left"><input class="selblue41" type="text" name="sales_count" id="sales_count" value="" onfocus="javascript:setOnlyNum(this);" maxlength="4" />
      台 <span class="red16px">*</span><br /></td>
  </tr>
  <tr>
    <td align="center">单价</td>
    <td align="left"><input class="selblue41" type="text" name="single_price" id="single_price" value="" onfocus="javascript:setOnlyNum(this);" maxlength="8" />
      元 <span class="red16px">*</span><br /></td>
  </tr>
  <tr>
    <td align="center">金额</td>
    <td align="left"><input class="selblue411" type="text" name="sales_price" id="sales_price" value="" onfocus="javascript:setOnlyNum(this);" maxlength="9" />
      元 <span class="red16px">*</span><br /></td>
  </tr>
  <tr>
    <td align="center">上报人</td>
    <td align="left"><span id="report_name" style="color:blue;font-weight:normal;font-size:16px;"></span><br /></td>
  </tr>
  <tr>
    <td align="center">上报时间</td>
    <td align="left"><span id="report_date" style="color:blue;font-weight:normal;font-size:16px;"></span><br /></td>
  </tr>
  <tr>
    <td align="center">备注</td>
    <td align="left"><textarea name="memo" id="memo" cols="5" rows="5" class="qs1"></textarea>
    <div id="info_tip" style="color:#0066FF;font-size:12px;display:none"><img src="images/tishi.gif" style="vertical-align:middle;" /></div>
      <br /></td>
  </tr>
  <tr>
    <td align="center">顾客姓名</td>
    <td align="left"><input class="selblue41" type="text" name="realname" id="realname" maxlength="20" />
      <br /></td>
  </tr>
  <tr>
    <td align="center">顾客电话</td>
    <td align="left"><input class="selblue41" type="text" name="phonenum" id="phonenum" maxlength="12" onfocus="javascript:setOnlyNum(this);" />
      <br /></td>
  </tr>
  <tr>
    <td align="center">顾客地址</td>
    <td align="left"><input class="selblue4" type="text" name="addresss" id="addresss" maxlength="100" />
      <br /></td>
  </tr>
  <tr>
    <td nowrap="nowrap" align="center">顾客身份证 </td>
    <td align="left"><input class="selblue42" type="text" name="mastercode" id="mastercode" maxlength="19" />
      <br /></td>
  </tr>
  <tr>
      <td align="center" nowrap="nowrap">上传附件</td>
      <td ><div id="divFileHidden" style="display: none;">
          <input name="file_hidden" type="file" id="file_hidden" style="width: 250px;" />
          <img src="../../images/x.gif" style="vertical-align:middle; cursor: pointer;" id="imgDelTr" title="删除"/></div>
        <div id="divFile">
          <input name="file_show" type="file" id="file_show" style="width: 250px;" />
          <img src="../../images/+.gif" style="vertical-align:middle; cursor: pointer;" id="imgAddTr" title="再添加一个" /></div>
      </td>
  </tr>
  <tr>
    <td align="center" nowrap="nowrap">已有附件 </td>
    <td align="left" nowrap="nowrap" id="fj"></td>
  </tr>
  
</table>
<div class="xt_fenye1"><a id="btn_sub"><img src="images/shagnbao.jpg" alt="" width="93" height="38" /></a>　　 
<a onclick="document.temp_form.reset();"><img src="images/xt_chongzhi.jpg" alt="" width="93" height="38" /></a></div>
</form>
<!--head end --> 
<!--first start -->

</div>

<!-- footer start--> 
<!-- footer end-->
<script type="text/javascript" src="js/jquery-1.6.4.min.js"></script>
<script type="text/javascript" src="js/lhgdialog.min.js?skin=idialog"></script>
<script type="text/javascript" src="js/jquery.cookie.js"></script>
<script type="text/javascript" src="js/validator.js"></script>
<script type="text/javascript" src="js/jquery.textbox.js"></script>
<script type="text/javascript">//<![CDATA[
//防止缓存每次都加载JS    
document.write("<s" + "cript type='text/javascript' src='js/base-data.js?" + Math.random() + "'></scr" + "ipt>");

$(document).ready(function(){

	// 定义AJAX获取的型号信息
	var pd_module_data;
	
	// 浏览器参数获取用户名和密码
	var username  = getQueryString("username");
	var userpass = getQueryString("userpass");
	var id = getQueryString("id");
	if(id == null || id  == "null" || id == ""){
		// 正在加载数据层
		$.dialog({ fixed: true, max: false, min: false, title: '提示！', content: '对不起，ID丢失不能加载数据！' });
		return;
	}
	var from_pc = getQueryString("from_pc");
	// 如果是pc端需要隐藏头部
	if("1" == from_pc){
		$(".head_class").hide();
	}

	
	
	// 如果访问地址携带用户名和密码则初始化相关信息
	if(username != null && userpass != null && username != "null" && userpass != "null" && username != "" && userpass != ""){
		// 初始化品牌
		pd_module_init(username, userpass);
		
		// 读取数据
		data_init(username, userpass, id , "1");
	} else { // 否则强制要求输入用户和密码
		show_login();
	}

	// 型号改变进行注册监听
	$("#select-choice-1").bind("input propertychange", function() {
		initAutoDiv(0);
	});

	
	$("#sales_count" ).attr("dataType", "Require").attr("msg", "请填写数量！");
	//如果价格为空，不判断是否为空
	if($("#single_price").val() != "")
		$("#single_price").attr("dataType", "Require").attr("msg", "请填写单价！");
	
	$("#sales_price" ).attr("dataType", "Require").attr("msg", "请填写金额！");


	$("#imgAddTr").click(function (){
        $("#divFileHidden").clone().find("#file_hidden").attr("name", "file_" + new Date().getTime()).end().appendTo($("#divFile")).show();
        resizeFrameHeight();
        $("img[id='imgDelTr']").each(function(){
            $(this).click(function (){
                $(this).parent().remove();
                resizeFrameHeight();
            });
        });
 });  



	 // 修改数据使用的参数
	 var store_id;

	 // 提交数据
	 $("#btn_sub").click(function(){
		// 判断是否有用户名和密码
		if(username == null || userpass == null || username == "null" || userpass == "null" || username == "" || userpass == ""){
			show_login();
			return false;
		}
		
		if(Validator.Validate($("#temp_form")[0], 2)){
		  var select_choice_2 = $("#select-choice-2").val();
		  var sales_count = $("#sales_count").val();
		  var sales_price = $("#sales_price").val();
		  var single_price = $("#single_price").val();
		  var memo = $("#memo").val();
		  var realname = $("#realname").val();
		  var phonenum = $("#phonenum").val();
		  var addresss = $("#addresss").val();
		  var mastercode = $("#mastercode").val();

		  // 正在加载数据层
		  var load_data = $.dialog({content: '数据加载中...', fixed: true, max: false, min: false, icon: 'loading.gif', title: '提示！'});
		  
			$.ajax({
				type: "GET",
				url: host_url + "/MobileSubmit.do?method=DoSubmit01&from_html=1",
				data: {
					"username":encodeURI(username), "userpass":encodeURI(userpass), "id":id, "store_id":store_id, "select-choice-2":select_choice_2, "sales_count":sales_count,
					"sales_price":sales_price, "memo":encodeURI(memo), "realname":encodeURI(realname), "phonenum":phonenum, "addresss":encodeURI(addresss), "mastercode":mastercode,
					"timestamp":new Date().getTime()
				},
				dataType: "jsonp",
				jsonp: "jsonpcallback",
				//sync: false, // jsonp不支持同步
				error: function (xhr, ajaxOptions, thrownError) { alert("数据加载请求失败【" + xhr.statusText + "," + xhr.responseText + "," + xhr.status + "," + thrownError +"】！"); },
				success: function(result) {
				  var strs= new Array();
				  strs=result.msg.split(":");
				 // load_data.close();
				  if (result.msg.indexOf('success')>-1){
					  /**  $.dialog({
						    max: false,
						    min: false,
						    fixed: true, 
						    content: '恭喜，数据修改成功！',
						    init: function () {
						        var that = this, i = 5;
						        var fn = function () {
						            that.title(i + '秒后关闭');
						            !i && that.close();
						            i--;
						        };
						        timer = setInterval(fn, 1000);
						        fn();
						    },
						    close: function () {
						        clearInterval(timer);
						        $("#sj_his").click();
						    }
						});*/
					    $("#lid").val(strs[1]);	
						$("#username").val(username);	
						$("#userpass").val(userpass);	
				        document.temp_form.action=host_url +'/MobileSubmit.do';
				        document.temp_form.submit();
				      //  $("#sj_his").click();
			       
                  
			       } else {
						$.dialog({
						    max: false, min: false, fixed: true,
						    content: result.msg,
						    init: function () {
						        var that = this, i = 8;
						        var fn = function () {
						            that.title(i + '秒后关闭');
						            !i && that.close();
						            i--;
						        };
						        timer = setInterval(fn, 1000);
						        fn();
						    },
						    close: function () {
						        clearInterval(timer);
						        $("#sj_his").click();
						    }
						});
						
				   }
				  
				}
				
			});
			
		}
		
	});


	// 历史记录
	$("#sj_his").click(function(){
		location.href = "shuj_his.html?username=" + escape(username) + "&userpass=" + escape(userpass) + "&from_pc=" + from_pc + "&timestamp=" + new Date().getTime();		
	});
	
	// 数量，单价改变计算总金额
	$("#sales_count, #single_price").change(function(){
		cal_all_price();
	});
	
	// 总价改变计算单价
	$("#sales_price").change(function(){
		cal_single_price();
	});

	// 数量或者单价改变计算总价
    function cal_all_price(){
		var sales_count = $("#sales_count").val();
		var single_price = $("#single_price").val();
		if((sales_count * single_price).toFixed(2) > 999999999 || -999999999 > (sales_count * single_price).toFixed(2)){
			 $.dialog.alert("计算金额超出范围！",function(){});
			return;
		}
		$("#sales_price").val((sales_count * single_price).toFixed(2));
		  
    }

	// 总价改变计算单价
    function cal_single_price(){
		var sales_count = $("#sales_count").val();
		var sales_price = $("#sales_price").val();
		$("#single_price").val((sales_price / sales_count).toFixed(2));
    }
	
	// 登陆层
	function show_login(){	
		// cookie, 2013-06-27
		if(cookie_enable){ // 在base-data.js中定义状态
		  var cookie_name = $.cookie("cookie_name");	
		  var cookie_pass = $.cookie("cookie_pass");	
		  if(cookie_name != null && cookie_pass != null){
			username = cookie_name;
			userpass = cookie_pass;
			// 读取数据
			data_init(username, userpass, id , "1");
			return false;
		  }
		}
		  
	  $.dialog({
			id: 'login-window',
			title: '登录',
			content: '帐&nbsp;&nbsp;号：<input id="login-na" type="text" maxlength="20" value="" />' + '<br /><br />密&nbsp;&nbsp;码：<input id="login-pw" type="password" maxlength="20" value="" />',
			initialize: function () {
				document.getElementById('login-na').focus();
			},
			fixed: true, max:false, min:false,
			ok: function () {
				var na = document.getElementById('login-na');
				var pw = document.getElementById('login-pw');
				if(na.value == ""){
					alert("提示，请填写账号！");
					na.select();
					return false;
				}
				if(pw.value == ""){
					alert("提示，请填写密码！");
					pw.select();
					return false;
				}
				// 用户名和密码赋值
				username = na.value;
				userpass = pw.value;
				
				// 读取数据
				data_init(username, userpass, id , "1");
				
				// 读取数据
				data_init(username, userpass, id , "1");
				
				// cookie,2013-06-27
				if(cookie_enable){ // 在base-data.js中定义状态
					$.cookie("cookie_name", username);	
					$.cookie("cookie_pass", userpass);	
				}	
			},
			okValue: '登录',
			cancel: function () {}
		});
	}

	

	// 查找销售明细信息
	function data_init(username, userpass, id , type){
		// 正在加载数据层
		var load_data = $.dialog({content: '数据加载中...', max: false, min: false, icon: 'loading.gif', title: '提示！'});
		
		$.ajax({
			type: "POST",
			url: host_url + "/MobileList.do?method=GetModel&from_html=1",
			data: {"username":encodeURI(username), "userpass":encodeURI(userpass), "id":id, "type":type, "timestamp":new Date().getTime() },
			dataType: "jsonp",
			jsonp: "jsonpcallback",
			error: function (xhr, ajaxOptions, thrownError) { alert("数据加载请求失败【" + xhr.statusText + "," + xhr.responseText + "," + xhr.status + "," + thrownError +"】！"); },
			success: function(result) {
			  // 关闭-正在加载数据层
		  	  load_data.close();
				
			  if (result.status == "-1"){
			        $.dialog({
					    max: false, min: false, fixed: true,
					    content: result.msg,
					    init: function () {
					        var that = this, i = 8;
					        var fn = function () {
					            that.title(i + '秒后关闭');
					            !i && that.close();
					            i--;
					        };
					        timer = setInterval(fn, 1000);
					        fn();
					    },
					    close: function () {
					        clearInterval(timer);
					    }
					});
		      } else {
			      // 初始化修改使用的参数
		    	  store_id = result.dept_id;

			      // 回显使用
			      $("#subcomp_name").html(result.subcomp_name);
			      $("#dept_name").html(result.dept_name);
			      $("#select-choice-1").val(result.model_name);
			      $("#select-choice-2").val(result.model_id);
			      if(result.model_name == ""){
				     // $("#select-choice-1").attr("readOnly","true");
				     // $("#select-choice-2").attr("readOnly","true");
			      }
			      var date_diff = (new Date() - new Date(result.report_date.replace(/-/g,'/')))/(1000*60*60*24);
				
			      if(date_diff>2){
					      $("#select-choice-1").attr("readOnly","true");
					      $("#select-choice-2").attr("readOnly","true");	
					      $("#sales_count").attr("readOnly","true");
					      $("#single_price").attr("readOnly","true");
					      $("#sales_price").attr("readOnly","true");
			      }
			      $("#sales_count").val(result.num);
			      $("#single_price").val(result.single_price);
			      $("#sales_price").val(result.all_price);
			      $("#report_name").html(result.report_name);
			      $("#report_date").html(result.report_date);
			      $("#memo").val(result.memo);
			      $("#realname").val(result.realname);
				  $("#phonenum").val(result.phonenum);
				  $("#addresss").val(result.addresss);
				  $("#mastercode").val(result.mastercode);
				  var at=result.map.attachment;
				  url1 = host_url + "/MobileList.do?method=downloadFile1&save_name="
				  if(at.length>0){
					  for ( var x in at) {
						  $("#fj").append("<span>"+"<a href='"+url1+at[x].save_name+"'"+"target='_blank'"+">"+at[x].file_name+"</a>"+"<span id='"+at[x].id+"'"+" onclick="+"'yy("+at[x].id+")'>"+"删除"+"</span>"+"</br></span>");
							resizeFrameHeight();
					  }
				  }else{
					  $("#fj").parent().remove(); 
				  }
		      }
			}
		});
		
	}

	

	// 根据用户名和密码初始化型号信息
	function pd_module_init(username, userpass){
		// 正在加载数据层
		var load_data = $.dialog({content: '数据加载中...', max: false, min: false, icon: 'loading.gif', title: '提示！'});
		
		$.ajax({
			type: "POST",
			url: host_url + "/MobileList.do?method=GetList04&from_html=1",
			data: { "username":encodeURI(username), "userpass":encodeURI(userpass), "timestamp":new Date().getTime() },
			dataType: "jsonp",
			jsonp: "jsonpcallback",
			error: function (xhr, ajaxOptions, thrownError) { alert("数据加载请求失败【" + xhr.statusText + "," + xhr.responseText + "," + xhr.status + "," + thrownError +"】！"); },
			success: function(result) {
			  // 关闭-正在加载数据层
		  	  load_data.close();	
				
			  if (result.status == "-1"){
			        $.dialog.alert(result.msg,function(){});
		      } else {
		    	pd_module_data = result;
			  }
			}
		});
	}

	 function resizeFrameHeight(offset, min_height) {
			// frame id can be found in page /konka-wd/WebContent/manager/admin/Frames2/indexFrame.jsp, and search 'iframe' to get.
			$("#mainFrame", window.parent.document).height(Math.max((min_height || 0), $(document).find("body").height(), $(document).children().height()) + (offset || 0));
		}  

	
	$("#memo").textbox({
		maxLength: 100,
		onInput: function(event, status) {
			var img = '<img src="images/tishi.gif" style="vertical-align:middle;" />';
			$("#info_tip").slideDown("fast").html(img + " 请将字数限制在：" + status.maxLength + " 个字内，您还可以输入：<b style='color:red;'>" + status.leftLength + "</b> 个字。");
		}
	}).blur(function() {
		$("#info_tip").slideUp("normal");
	});

	
	
	// 输入关键字搜索
	function initAutoDiv(){
		// 隐藏下拉框
		if($("#auto_prompt_div"))
	        $("#auto_prompt_div").remove();
        // 输入框有改变将型号置为空
        $("#select-choice-2").val("");
        
		if($.trim($("#select-choice-1").val()).length >= 2){
			var val = $.trim($("#select-choice-1").val());
			var count = 0;
			for(var i = 0; i < pd_module_data.length; i++){
				var id = pd_module_data[i].id;
				var name = pd_module_data[i].name;
				if(name.toLowerCase().indexOf(val.toLowerCase()) != -1)
					count++;
			}

			var top = $("#select-choice-1").offset().top;
	        var left = $("#select-choice-1").offset().left;
	        var width = $("#select-choice-1").width();
	        var auto_prompt_div = $("<div />").width(width).css("position", "absolute").css("backgroundColor", "white").css("left", left).css("top", top + $("#select-choice-1").height() + 6).css("border", "1px solid #1C86EE").attr("id", "auto_prompt_div");
	        var table = $("<table width='100%' id=\"div_table\" />").attr("cellpadding", "0").attr("cellspacing", "0");
	        
			// 满足条件控制在30个内，如果超过30个则不显示
			if(count != 0){
				for(var i = 0; i < pd_module_data.length; i++){
					var id = pd_module_data[i].id;
					var name = pd_module_data[i].name;
					if(name.toLowerCase().indexOf(val.toLowerCase()) != -1){
	                    var tr = $("<tr />").css("cursor", "pointer").attr("class", "tr_value").mouseout(function(){
	                        $(this).css("backgroundColor", "white").css("color", "black");
	                    }).mouseover(function(){
	                        $(this).css("backgroundColor", "#1C86EE").css("color", "white");
	                    }).click(function(){
	                        $("#select-choice-1").val($(this).find("td").eq(0).html());
	                        $("#select-choice-2").val($(this).find("td").eq(0).attr("id"));
	                	    $("#auto_prompt_div").remove();
	                    });
	                    var td = $("<td class=\"td_class\" />").html(name).css("fontSize", "12px").css("margin", "5px 5px 5px 5px").css("padding-left", "6px").attr("align", "left").attr("id", id);
	                    tr.append(td);
	                    table.append(tr);
				    }
				}
			} else {
                var tr = $("<tr />").css("cursor", "pointer").attr("class", "tr_value").mouseout(function(){
                    $(this).css("backgroundColor", "white").css("color", "black");
                }).mouseover(function(){
                    $(this).css("backgroundColor", "#1C86EE").css("color", "white");
                });
                var td = $("<td />").html("提示，您搜索的型号“" + val + "”，共检索到 " + count + " 条数据，请精确搜索条件！").css("fontSize", "12px").css("margin", "5px 5px 5px 5px").css("padding-left", "6px").attr("align", "left");
                tr.append(td);
                table.append(tr);
			}

			auto_prompt_div.append(table);
	        $(document.body).append(auto_prompt_div);
		}
	}

});

function yy(id){
	if(!confirm('确实要删除此附件？')) return;
	$.ajax({
		type: "POST",
		url: host_url + "/MobileList.do?method=deleteFile",
		data: {"id":id},
		dataType: "jsonp",
		jsonp: "jsonpcallback",
		error: function (xhr, ajaxOptions, thrownError) { alert("数据加载请求失败【" + xhr.statusText + "," + xhr.responseText + "," + xhr.status + "," + thrownError +"】！"); },
		success: function(result) {
			if (result.msg=="success"){
		  	  alert("恭喜您，删除附件成功!");
	  	 	  $("#"+id).parent().remove();
	  	  } 	
	  		  else alert(" 很抱歉，删除附件出错!"); 
		}
	});
}


//]]></script>
</body>
</html>