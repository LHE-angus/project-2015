<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="MDAS_SHOP_BRANDSALES">

	<typeAlias alias="mdasShopBrandsales" type="com.ebiz.mmt.domain.MdasShopBrandsales" />

	

	<resultMap id="mdasShopBrandsalesResultForList" class="mdasShopBrandsales">
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="P_INDEX" property="p_index" jdbcType="DECIMAL" />
		<result column="PD_TYPE" property="pd_type" jdbcType="DECIMAL" />
		<result column="PD_NAME" property="pd_name" jdbcType="VARCHAR" />
		<result column="BRAND_ID" property="brand_id" jdbcType="DECIMAL" />
		<result column="BRAND_NAME" property="brand_name" jdbcType="VARCHAR" />
		<result column="XL" property="xl" jdbcType="DECIMAL" />
		<result column="XE" property="xe" jdbcType="DECIMAL" />
		<result column="PER_XL" property="per_xl" jdbcType="DECIMAL" />
		<result column="PER_XE" property="per_xe" jdbcType="DECIMAL" />
		<result column="AXL" property="axl" jdbcType="DECIMAL" />
		<result column="AXE" property="axe" jdbcType="DECIMAL" />
		<result column="ORDER_AXL" property="order_axl" jdbcType="DECIMAL" />
		<result column="ORDER_AXE" property="order_axe" jdbcType="DECIMAL" />
	</resultMap>
	
	<resultMap id="mdasShopBrandsalesResultForPdTypeAndBrand" class="mdasShopBrandsales">
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="PD_TYPE" property="pd_type" jdbcType="DECIMAL" />
		<result column="PD_NAME" property="pd_name" jdbcType="VARCHAR" />
		<result column="BRAND_ID" property="brand_id" jdbcType="DECIMAL" />
		<result column="BRAND_NAME" property="brand_name" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- add by Jiang,JiaYong 2011-08-16 for entp_shop sell order  -->
	<resultMap id="mdasShopBrandsalesResultForSellOrder" class="mdasShopBrandsales">
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="AXE" property="axe" jdbcType="DECIMAL" />
		<result column="SHOP_NAME" property="map.shop_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="mdasShopBrandsalesResult" class="mdasShopBrandsales" extends="mdasShopBrandsalesResultForList">
	</resultMap>

	<sql id="sf-mdasShopBrandsales">
		<isNotEmpty prepend=" and " property="shop_id">SHOP_ID = #shop_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_index">P_INDEX = #p_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_type">PD_TYPE = #pd_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_name">PD_NAME = #pd_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="brand_id">BRAND_ID = #brand_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="brand_name">BRAND_NAME = #brand_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="xl">XL = #xl:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="xe">XE = #xe:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="per_xl">PER_XL = #per_xl:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="per_xe">PER_XE = #per_xe:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="axl">AXL = #axl:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="axe">AXE = #axe:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_axl">ORDER_AXL = #order_axl:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_axe">ORDER_AXE = #order_axe:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.p_index_like">P_INDEX like '%' || #map.p_index_like:VARCHAR# || '%'</isNotEmpty>
		<!-- 作战地图.销售额 Cheng,Bing 2011.11.4 -->
		<isNotEmpty prepend=" and " property="map.p_index_like2">P_INDEX like #map.p_index_like2:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_index_String">P_INDEX in ($map.p_index_String$)</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.pd_type_max"><![CDATA[ PD_TYPE <= #map.pd_type_max# ]]></isNotEmpty>
	    <isNotEmpty prepend=" and " property="map.p_index_in">
	        P_INDEX in (SELECT p_index FROM KONKA_BASE_PROVINCE_LIST_FOUR r WHERE r.del_mark = 0 START WITH p_index =#map.p_index_in# AND del_mark= 0
             CONNECT BY prior p_index = par_index)
        </isNotEmpty>
	

	</sql>
	<!-- 作战地图.区域销售统计 Cheng,Bing 2011.11.4 -->
	<resultMap id="mdasShopBrandsalesForArea" class="mdasShopBrandsales">
		<result column="PD_TYPE" property="pd_type" jdbcType="VARCHAR" />
		<result column="PD_NAME" property="pd_name" jdbcType="DECIMAL" />
		<result column="SUM_XL" property="map.sum_xl" jdbcType="DECIMAL" />
		<result column="SUM_XE" property="map.sum_xe" jdbcType="DECIMAL" />
	</resultMap>

	<!-- 作战地图.区域销售统计 Cheng,Bing 2011.11.4 -->
	<select id="selectMdasShopBrandsalesForAreaList" resultMap="mdasShopBrandsalesForArea"
		parameterClass="mdasShopBrandsales" >
		<isNotEmpty property="row.count">
           <![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select t1.*
		from (select pd_type, pd_name, sum(xl) as sum_xl, sum(xe) as sum_xe
		from
		<isNotEmpty prepend=" " property="map.use_arr">
		  (<iterate open=" " close=" " conjunction="union" property="map.year_month_arr">
		    select *from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month_arr[]$
		  </iterate>)
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.year_month">
		    chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ 
		</isNotEmpty>
		where 1=1
		<include refid="sf-mdasShopBrandsales" />
		group by pd_type,pd_name) t1
		<isNotEmpty prepend=" " property="map.pd_type_order">
			order by t1.pd_type $map.pd_type_order$
        </isNotEmpty>
		<isNotEmpty prepend=" " property="map.xl_order">
			order by t1.sum_xl $map.xl_order$
        </isNotEmpty>
		<isNotEmpty prepend=" " property="map.xe_order">
			order by t1.sum_xe $map.xe_order$
        </isNotEmpty>
		<isNotEmpty property="row.count">
             <![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	<!-- 作战地图.网点销量排名 Cheng,Bing 2011.11.4 -->
	<resultMap id="mdasShopBrandsalesForShopOrder" class="mdasShopBrandsales">
		<result column="SHOP_NAME" property="map.shop_name" jdbcType="VARCHAR" />
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="SUM_XL" property="map.sum_xl" jdbcType="DECIMAL" />
		<result column="SUM_XE" property="map.sum_xe" jdbcType="DECIMAL" />
	</resultMap>

	<!-- 作战地图.网点销量排名 Cheng,Bing 2011.11.4 -->
	<select id="selectMdasShopBrandsalesForShopOrderList" resultMap="mdasShopBrandsalesForShopOrder"
		parameterClass="mdasShopBrandsales" >
		<isNotEmpty property="row.count">
             <![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select t1.*,t2.shop_name
		from (select shop_id, sum(xl) as sum_xl, sum(xe) as sum_xe
		from 
		<isNotEmpty prepend=" " property="map.use_arr">
		  (<iterate open=" " close=" " conjunction="union" property="map.year_month_arr">
		    select *from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month_arr[]$
		  </iterate>)
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.year_month">
		    chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ 
		</isNotEmpty>
		where 1=1
		<include refid="sf-mdasShopBrandsales" />
		group by shop_id) t1
		left join entp_shop t2 on t1.shop_id = t2.shop_id
		<isNotEmpty prepend=" " property="map.xl_order">
			order by t1.sum_xl $map.xl_order$
        </isNotEmpty>
		<isNotEmpty prepend=" " property="map.xe_order">
			order by t1.sum_xe $map.xe_order$
        </isNotEmpty>
		<isNotEmpty property="row.count">
             <![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<select id="selectMdasShopBrandsales" resultMap="mdasShopBrandsalesResult" parameterClass="mdasShopBrandsales" >
		select * from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ where 1 = 1
		<include refid="sf-mdasShopBrandsales" />
	</select>

	<select id="selectMdasShopBrandsalesList" resultMap="mdasShopBrandsalesResultForList" parameterClass="mdasShopBrandsales" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ where 1 = 1
		<include refid="sf-mdasShopBrandsales" />
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.pd_type_order">
			 order by PD_TYPE $map.map.pd_type_order$
		</isNotEmpty>
		<isNotEmpty prepend=" " property="map.xl_order">
			 order by XL $map.xl_order$
		</isNotEmpty>	
	</select>
	
	<select id="selectMdasShopBrandsalesForXs" resultClass="Long" parameterClass="mdasShopBrandsales" >
		select sum(xe) from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ where 1 = 1
		and shop_id = #shop_id#
		group by shop_id
	</select>
	
	<!-- add by Jiang,JiaYong 2011-08-16 for entp_shop sell order  -->
	<select id="selectMdasShopBrandsalesForSellOrderList" resultMap="mdasShopBrandsalesResultForSellOrder" parameterClass="mdasShopBrandsales" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select t1.*,t2.shop_name
		  from (select shop_id, max(axe) axe
		          from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$
		         where 1=1
		         <include refid="sf-mdasShopBrandsales" />
		         group by shop_id) t1
		         left join entp_shop t2 on t1.shop_id = t2.shop_id
		 order by t1.axe desc		
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<!-- 简化查询，保持和买买提中的表一致 -->
	<select id="selectMdasShopBrandsalesForPdTypeAndBrandList" resultMap="mdasShopBrandsalesResultForPdTypeAndBrand" parameterClass="mdasShopBrandsales" >
	<![CDATA[ select t.* from ( ]]>
	<iterate close="" open="" conjunction=" union " property="map.shop_names">
	select max(t.shop_id) shop_id,t.pd_type,t.pd_name,t.brand_id,t.brand_name from chea_fill.$map.shop_names[]$ t where t.shop_id = #shop_id:DECIMAL# group by t.pd_type ,t.pd_name,t.brand_id,t.brand_name</iterate>
	   ) t order by t.pd_type asc
    </select>
	
	<select id="selectMdasShopBrandsalesCount" resultClass="long" parameterClass="mdasShopBrandsales" >
		select count(*) from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ where 1 = 1
		<include refid="sf-mdasShopBrandsales" />
	</select>
	
	<!-- Jiang,JiaYong@2011-08-19 -->
	<select id="selectMdasShopBrandsalesForShopRank" resultClass="long" parameterClass="mdasShopBrandsales" >
		select t1.rank_num
		  from (select rownum rank_num, t.*
		          from (select shop_id, axe
		                  from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$
		                 where 1 = 1
		                 <include refid="sf-mdasShopBrandsales" />
		                 group by shop_id, axe
		                 order by axe desc) t) t1 where t1.shop_id = #map.shop_id:DECIMAL#
	</select>

	<select id="selectMdasShopBrandsalesPaginatedList" resultMap="mdasShopBrandsalesResult" parameterClass="mdasShopBrandsales" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$ where 1 = 1
		<include refid="sf-mdasShopBrandsales" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 新版网点情报站地区网点销售额排名查询，RenZhong, 2011-09-21 -->
	<resultMap id="mdasShopBrandsalesTopResult" class="mdasShopBrandsales">
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="AXE" property="axe" jdbcType="DECIMAL" />
		<result column="SHOP_NAME" property="map.shop_name" jdbcType="VARCHAR" />
		<result column="RN" property="map.rn" jdbcType="DECIMAL" />
	</resultMap>
	
	<select id="selectMdasShopBrandsalesTopResultList" resultMap="mdasShopBrandsalesTopResult" parameterClass="mdasShopBrandsales" >
		select *
  		  from (select shop_id, axe, shop_name, rownum rn
          		  from (select t1.*, t2.shop_name
                  		  from (select shop_id, max(axe) axe
                          		  from chea_fill.MDAS_SHOP_BRANDSALES_$map.year_month$
                         		 where 1 = 1
                           		   <include refid="sf-mdasShopBrandsales" />
                         		 group by shop_id) t1
                  		  left join entp_shop t2 on t1.shop_id = t2.shop_id
                 		 order by t1.axe desc)) x
 		 where 1 = 1
 		 <isNotEmpty prepend=" and " property="map.shop_self_id">x.shop_id = #map.shop_self_id#</isNotEmpty>
	</select>
	
	<!-- 将mmt数据库中的含有字段为MDAS_SHOP_BRANDSALES的表查出来 ，方便 id为selectMdasShopBrandsalesForPdTypeAndBrandList的查询方法的执行，保持和买买提数据库中的表一致 ChenShunhua 2012-02-15-->
	<select id="selectMdasShopNamesForQuery" parameterClass="mdasShopBrandsales"  resultClass="String"  >
		<![CDATA[ select lower(table_name) from all_all_tables where table_name like '%' || #map.shop_name# || '%' ]]>
	</select>
</sqlMap>