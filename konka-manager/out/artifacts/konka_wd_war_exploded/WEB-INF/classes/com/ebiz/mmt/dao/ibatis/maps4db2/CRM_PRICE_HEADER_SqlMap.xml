<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CRM_PRICE_HEADER">

	<typeAlias alias="crmPriceHeader" type="com.ebiz.mmt.domain.CrmPriceHeader" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertCrmPriceHeader" />
		<flushOnExecute statement="updateCrmPriceHeader" />
		<flushOnExecute statement="deleteCrmPriceHeader" />
	</cacheModel>
 
	<resultMap id="crmPriceHeaderResultForList" class="crmPriceHeader">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="PRICE_TYPE" property="price_type" jdbcType="VARCHAR" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="GROUPCODE" property="groupcode" jdbcType="VARCHAR" />
		<result column="PRICE_CODE" property="price_code" jdbcType="VARCHAR" />
		<result column="PRICE_NAME" property="price_name" jdbcType="VARCHAR" />
		<result column="BEGIN_DATE" property="begin_date" jdbcType="TIMESTAMP" />
		<result column="END_DATE" property="end_date" jdbcType="TIMESTAMP" />
		<result column="CREATED_BY" property="created_by" jdbcType="DECIMAL" />
		<result column="CREATED_DATE" property="created_date" jdbcType="TIMESTAMP" />
		<result column="UPDATED_BY" property="updated_by" jdbcType="DECIMAL" />
		<result column="UPDATED_DATE" property="updated_date" jdbcType="TIMESTAMP" />
		<result column="ISDEL" property="isdel" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="crmPriceHeaderResult" class="crmPriceHeader" extends="crmPriceHeaderResultForList">
	</resultMap>
	
	<resultMap id="nextIdResult" class="java.lang.String" >
		<result property="nextId"/>
	</resultMap>
	
	<resultMap id="crmPriceHeaderResult2" class="crmPriceHeader" extends="crmPriceHeaderResultForList">
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
		<result column="HOWMANY" property="map.howmany" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-crmPriceHeader">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="price_type">PRICE_TYPE = #price_type:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="groupcode">GROUPCODE like '%' || #groupcode:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="price_code">PRICE_CODE like '%' || #price_code:VARCHAR# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="price_name">PRICE_NAME like '%' || #price_name:VARCHAR# || '%'</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.price_code_eq">PRICE_CODE = #map.price_code_eq:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.price_name_eq">PRICE_NAME = #map.price_name_eq:VARCHAR#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="begin_date"><![CDATA[BEGIN_DATE >= to_char(#begin_date#,'YYYY-MM-DD HH24:MI:SS')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="end_date"><![CDATA[END_DATE <= to_char(#end_date#,'YYYY-MM-DD HH24:MI:SS')]]></isNotEmpty>
		
		<isNotEmpty prepend=" and " property="created_by">CREATED_BY = #created_by:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="updated_by">UPDATED_BY = #updated_by:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="created_date"><![CDATA[CREATED_DATE >= to_char(#created_date#,'YYYY-MM-DD HH24:MI:SS')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="updated_date"><![CDATA[UPDATED_DATE <= to_char(#updated_date#,'YYYY-MM-DD HH24:MI:SS')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="isdel">ISDEL = #isdel:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.modelcode_line"><![CDATA[ id IN (SELECT DISTINCT headid FROM crm_price_lines c WHERE upper(c.modelcode) = upper(#map.modelcode_line:VARCHAR#) ) ]]></isNotEmpty>
	</sql>
	
	
	<select id="selectNextIdFromSeq" resultMap="nextIdResult" >
		select CRM_PRICE_HEADER_S.nextval from dual 
	</select>
	
	
	<select id="selectCrmPriceHeader" resultMap="crmPriceHeaderResult" parameterClass="crmPriceHeader" cacheModel="oneDayCache">
		select * from CRM_PRICE_HEADER where 1 = 1
		<include refid="sf-crmPriceHeader" />
		<isNotEmpty property="map.effective_flag">
			<![CDATA[ 
			AND to_char (nvl (BEGIN_DATE, sysdate), 'YYYY-MM-DD') <= to_char (sysdate, 'YYYY-MM-DD')
       		AND to_char (sysdate, 'YYYY-MM-DD') <= to_char (nvl (END_DATE, sysdate), 'YYYY-MM-DD')
			]]> 
		</isNotEmpty>
	</select>
	
	<!-- 过时 -->
	<select id="selectCrmPriceHeaderListFilterByTime" resultMap="crmPriceHeaderResult" parameterClass="crmPriceHeader" cacheModel="oneDayCache">
		select * from CRM_PRICE_HEADER where 1 = 1
		<include refid="sf-crmPriceHeader" />
		<isNotEmpty property="map.filter_time">
			<![CDATA[ 
			AND ( BEGIN_DATE >= to_char (#map.begin_date#, 'YYYY-MM-DD HH24:MI:SS')
               AND BEGIN_DATE <= to_char (#map.end_date#, 'YYYY-MM-DD HH24:MI:SS')
            	OR END_DATE >= to_char (#map.begin_date#, 'YYYY-MM-DD HH24:MI:SS')
               AND END_DATE <= to_char (#map.end_date#, 'YYYY-MM-DD HH24:MI:SS')
            	OR BEGIN_DATE <= to_char (#map.begin_date# , 'YYYY-MM-DD HH24:MI:SS')
               AND END_DATE >= to_char (#map.end_date#, 'YYYY-MM-DD HH24:MI:SS'))
			]]> 
		</isNotEmpty>
	</select>
	
	<select id="selectCrmPriceHeaderList" resultMap="crmPriceHeaderResult" parameterClass="crmPriceHeader" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from CRM_PRICE_HEADER where 1 = 1
		<include refid="sf-crmPriceHeader" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<select id="selectListOfDeptIdGroupCodePriceTypeAndTime" resultMap="crmPriceHeaderResult" parameterClass="java.util.HashMap" cacheModel="oneDayCache">
			<![CDATA[ 
			SELECT t.*
			  FROM CRM_PRICE_HEADER t
			 WHERE     t.ISDEL = 0
			       AND t.DEPT_ID = #dept_id#
			       AND t.PRICE_TYPE = #price_type#
			       AND t.GROUPCODE = #group_code#
			       AND ( (to_char (t.BEGIN_DATE, 'YYYY-MM-DD') <= to_char (#begin_date#, 'YYYY-MM-DD') 
			       			 AND to_char (#begin_date#, 'YYYY-MM-DD') <= to_char (nvl (t.END_DATE, sysdate), 'YYYY-MM-DD'))
			            OR (to_char (t.BEGIN_DATE, 'YYYY-MM-DD') <= to_char (#end_date#, 'YYYY-MM-DD')
			                AND to_char (#end_date#, 'YYYY-MM-DD') <= to_char (nvl (t.END_DATE, sysdate), 'YYYY-MM-DD'))
			            OR (to_char (t.END_DATE, 'YYYY-MM-DD') <= to_char (#end_date#, 'YYYY-MM-DD')
			                AND to_char (#begin_date#, 'YYYY-MM-DD') <= to_char (t.BEGIN_DATE, 'YYYY-MM-DD')))
			 ]]>
	</select>

	<select id="selectCrmPriceHeaderCount" resultClass="long" parameterClass="crmPriceHeader" cacheModel="oneDayCache">
		select count(*) from CRM_PRICE_HEADER where 1 = 1
		<include refid="sf-crmPriceHeader" />
	</select>

	<select id="selectCrmPriceHeaderPaginatedList" resultMap="crmPriceHeaderResult2" parameterClass="crmPriceHeader" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		 select * from (
			 select a.* 
			      ,b.DEPT_NAME
			      ,(select count(1)
			        from   CRM_PRICE_LINES c
			        where  c.HEADID = a.ID) HOWMANY
			from   CRM_PRICE_HEADER a left join KONKA_DEPT b on a.DEPT_ID = b.DEPT_ID
		 ) where 1 = 1
		<include refid="sf-crmPriceHeader" />
		order by id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertCrmPriceHeader" parameterClass="crmPriceHeader">
		<selectKey resultClass="long" keyProperty="id">select CRM_PRICE_HEADER_S.nextval as id from dual </selectKey>
		<![CDATA[insert into CRM_PRICE_HEADER (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="groupcode">GROUPCODE</isNotNull>	
			<isNotNull prepend="," property="price_code">PRICE_CODE</isNotNull>	
			<isNotNull prepend="," property="price_name">PRICE_NAME</isNotNull>	
			<isNotNull prepend="," property="begin_date">BEGIN_DATE</isNotNull>	
			<isNotNull prepend="," property="end_date">END_DATE</isNotNull>	
			<isNotNull prepend="," property="created_by">CREATED_BY</isNotNull>	
			<isNotNull prepend="," property="created_date">CREATED_DATE</isNotNull>	
			<isNotNull prepend="," property="updated_by">UPDATED_BY</isNotNull>	
			<isNotNull prepend="," property="updated_date">UPDATED_DATE</isNotNull>	
			<isNotNull prepend="," property="isdel">ISDEL</isNotNull>	
			<isNotNull prepend="," property="price_type">PRICE_TYPE</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="groupcode">#groupcode:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="price_code">#price_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="price_name">#price_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="begin_date">#begin_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="end_date">#end_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="created_by">#created_by:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="created_date">#created_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="updated_by">#updated_by:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="updated_date">#updated_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="isdel">#isdel:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="price_type">#price_type:VARCHAR#</isNotNull>	
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateCrmPriceHeader" parameterClass="CrmPriceHeader">
		update CRM_PRICE_HEADER
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="groupcode">GROUPCODE = #groupcode:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="price_code">PRICE_CODE = #price_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="price_name">PRICE_NAME = #price_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="begin_date">BEGIN_DATE = #begin_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="end_date">END_DATE = #end_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="created_by">CREATED_BY = #created_by:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="created_date">CREATED_DATE = #created_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="updated_by">UPDATED_BY = #updated_by:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="updated_date">UPDATED_DATE = #updated_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="isdel">ISDEL = #isdel:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="price_type">price_type = #price_type:VARCHAR#</isNotNull>	
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update> 

	<delete id="deleteCrmPriceHeader" parameterClass="CrmPriceHeader">
		delete from CRM_PRICE_HEADER where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>