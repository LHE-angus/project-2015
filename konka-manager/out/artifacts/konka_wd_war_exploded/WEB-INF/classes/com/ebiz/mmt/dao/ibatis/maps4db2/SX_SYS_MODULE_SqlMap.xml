<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<!-- @author Xu,ZhengYang -->
<!-- @version 2010-11-11 02:47:12 -->
<sqlMap namespace="SYS_MODULE">

	<typeAlias alias="sysModule" type="com.ebiz.mmt.domain.SysModule" />

	<resultMap id="sysModuleResultForList" class="sysModule">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="MOD_ID" property="mod_id" jdbcType="DECIMAL" />
		<result column="PAR_ID" property="par_id" jdbcType="DECIMAL" />
		<result column="MOD_NAME" property="mod_name" jdbcType="VARCHAR" />
		<result column="MOD_DESC" property="mod_desc" jdbcType="VARCHAR" />
		<result column="MOD_URL" property="mod_url" jdbcType="VARCHAR" />
		<result column="ICON_PATH" property="icon_path" jdbcType="VARCHAR" />
		<result column="PPDM_CODE" property="ppdm_code" jdbcType="DECIMAL" />
		<result column="ORDER_VALUE" property="order_value" jdbcType="DECIMAL" />
		<result column="IS_PUBLIC" property="is_public" jdbcType="DECIMAL" />
		<result column="IS_MSG" property="is_msg" jdbcType="DECIMAL" />
		<result column="IS_LOCK" property="is_lock" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="TREE_LEVEL" property="tree_level" jdbcType="DECIMAL" />
		<result column="ROOT_ID" property="root_id" jdbcType="DECIMAL" />
		<result column="IS_VIEW" property="is_view" jdbcType="DECIMAL" />
		<result column="LEVEL_BY_DEPT" property="level_by_dept" jdbcType="DECIMAL" />
		<result column="FGS_AUTH_FLAG" property="fgs_auth_flag" jdbcType="DECIMAL" />
		
	</resultMap>

	<resultMap id="sysModuleResultForModPopedom" class="sysModule" extends="sysModuleResultForList">
		<result column="LEVEL" property="map.level" jdbcType="DECIMAL" />
		<result column="PPDM_DETAIL" property="map.ppdm_detail" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="sysModuleResultForSubPpdmDetail" class="sysModule" extends="sysModuleResultForList">
		<result column="LEVEL" property="map.level" jdbcType="DECIMAL" />
		<result column="PPDM_DETAIL" property="map.ppdm_detail" jdbcType="VARCHAR" />
		<result column="SUB_PPDM_DETAIL" property="map.sub_ppdm_detail" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="sysModuleResult" class="sysModule" extends="sysModuleResultForList">
	</resultMap>

	<sql id="sf-sysModule">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_id">MOD_ID = #mod_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="par_id">PAR_ID = #par_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_name">MOD_NAME = #mod_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_desc">MOD_DESC = #mod_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_url">MOD_URL = #mod_url:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="icon_path">ICON_PATH = #icon_path:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ppdm_code">PPDM_CODE = #ppdm_code:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_public">IS_PUBLIC = #is_public:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_msg">IS_MSG = #is_msg:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_lock">IS_LOCK = #is_lock:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_admin">IS_ADMIN = #is_admin:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="root_id">ROOT_ID = #root_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_view">IS_VIEW = #is_view:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="level_by_dept">LEVEL_BY_DEPT = #level_by_dept:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="fgs_auth_flag">FGS_AUTH_FLAG = #fgs_auth_flag:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.min_mod_id"><![CDATA[mod_id > #map.min_mod_id#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.max_mod_id"><![CDATA[mod_id < #map.max_mod_id#]]></isNotEmpty>
		<isNotEmpty prepend=" " property="map.is_cust">start with PAR_ID = -1 connect by prior MOD_ID = PAR_ID</isNotEmpty>
	</sql>

	<select id="selectSysModule" resultMap="sysModuleResult" parameterClass="sysModule" >
		select * from KONKA_SYS_MODULE where 1 = 1
		<include refid="sf-sysModule" />
	</select>

	<select id="selectSysModuleList" resultMap="sysModuleResultForList" parameterClass="sysModule" >
		<isNotEmpty property="row.count">
		<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_SYS_MODULE where 1 = 1
		<isNotEmpty prepend=" and " property="map.is_admin_show">
			is_admin in ($map.is_admin_show$)
		</isNotEmpty>
		<include refid="sf-sysModule" />
		<isNotEmpty prepend=" " property="map.mod_id">
			start with mod_id = #map.mod_id#
			connect by prior par_id = mod_id
		</isNotEmpty>
		order by 
		<isNotEmpty prepend=" " property="map.setnav">
		tree_level,
		</isNotEmpty>
		order_value, id
		<isNotEmpty property="row.count">
		<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectSysModuleCount" resultClass="long" parameterClass="sysModule" >
		select count(*) from KONKA_SYS_MODULE where 1 = 1
		<include refid="sf-sysModule" />
	</select>

	<select id="selectSysModulePaginatedList" resultMap="sysModuleResult" parameterClass="sysModule" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_SYS_MODULE where 1 = 1
		<include refid="sf-sysModule" />
		order by order_value, mod_id
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<select id="selectSysModuleListForModPopedom" resultMap="sysModuleResultForSubPpdmDetail" parameterClass="sysModule">
			select * from (
			select aa.*, 
			<isNotEmpty prepend=" " property="map.role_id">cc.ppdm_detail sub_ppdm_detail,</isNotEmpty>
			<isEmpty prepend=" " property="map.role_id">null sub_ppdm_detail,</isEmpty>
			bb.ppdm_detail
			  from (select a.*, level
			          from KONKA_SYS_MODULE a
			         where is_public != 1
		<isNotEmpty prepend=" and " property="map.is_zmd">mod_id between 800000 and 899999 or mod_id between 902000 and 902999</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_nothing"><![CDATA[(mod_id < 800000 or mod_id > 899999)]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_pec"><![CDATA[(mod_id like '50%' or mod_id between 902000 and 902999)]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_cxy"><![CDATA[(mod_id between 712000 and 712070 or mod_id = 710000 or mod_id = 700000)]]></isNotEmpty>
		<include refid="sf-sysModule" />
			 start with par_id = #map.par_id#
			        connect by prior mod_id = par_id) aa
			  left join KONKA_BASE_POPEDOM bb on aa.ppdm_code = bb.ppdm_code
	    <isNotEmpty prepend=" " property="map.role_id">
			  left join (select a.*, b.ppdm_detail
				  from KONKA_MOD_POPEDOM a, KONKA_BASE_POPEDOM b
				 where a.ppdm_code = b.ppdm_code
				   and a.ROLE_ID = #map.role_id#) cc on cc.mod_id = aa.mod_id
	    </isNotEmpty>
	    )t start with t.par_id = #map.par_id#
			        connect by prior t.mod_id = t.par_id order siblings by t.ID
	</select>
	
	<select id="selectSysModuleListForChildModPopedom" resultMap="sysModuleResultForModPopedom" parameterClass="sysModule">
		<![CDATA[
			select aa.*, bb.ppdm_code as ppdm_code2, cc.ppdm_detail
			  from (select distinct a.*, level
			          from KONKA_SYS_MODULE a
			          where is_del = 0
			         start with mod_id in (select mod_id
			                                 from konka_mod_popedom a
			                                where a.role_id = #map.role_id#
			                                   or user_id = #map.user_id#)
			        connect by prior par_id = mod_id) aa
			  left join (select mod_id, ppdm_code
			               from konka_mod_popedom a
			              where a.role_id = #map.role_id#
			                 or user_id = #map.user_id#) bb on aa.mod_id = bb.mod_id
			  left join konka_base_popedom cc on bb.ppdm_code = cc.ppdm_code
			 order by aa.id asc
		]]>
	</select>

	<select id="selectSysModuleListForLeftTree" resultMap="sysModuleResult" parameterClass="sysModule">
		<![CDATA[
		 select * from ( select distinct a.*]]>
			  from KONKA_SYS_MODULE a
			 where is_del = 0 and mod_id not between 700000 and 799999
			<isNotEmpty prepend=" and " property="map.bi_hidden">
			 mod_id not in ( select mod_id from KONKA_SYS_MODULE  START WITH MOD_ID = 900900  CONNECT BY PRIOR  MOD_ID=PAR_ID)
			</isNotEmpty>
			 start with mod_id in
			            (select distinct mod_id
			               from KONKA_mod_popedom m
			           <![CDATA[   where m.user_id = #map.user_id#]]>
								<isNotEmpty prepend=" or " property="map.role_ids">
									m.role_id in
									<iterate close=")" open="(" conjunction="," property="map.role_ids">#map.role_ids[]#</iterate>
								</isNotEmpty>
								union
								select mod_id from KONKA_SYS_MODULE s where s.is_public = 1
								<isNotEmpty prepend=" or " property="map.is_admin"> is_admin = 1 </isNotEmpty>   
						) connect by prior PAR_ID = MOD_ID
					 )
		start with par_id = 0  connect by prior MOD_ID = PAR_ID
		order siblings by order_value desc,  MOD_ID
	</select>

	<select id="selectSysModuleSonList" resultMap="sysModuleResultForList" parameterClass="sysModule" >
		select * from KONKA_SYS_MODULE where IS_DEL=0 start with 1 = 1
		<isNotEmpty prepend=" and " property="par_id">PAR_ID = #par_id:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_ids">
			PAR_ID in
			<iterate close=")" open="(" conjunction="," property="map.par_ids">#map.par_ids[]#</iterate>
		</isNotEmpty>
		connect by prior MOD_ID = PAR_ID 
		order siblings by order_value desc,  MOD_ID
	</select>

	<select id="selectSysModuleParentList" resultMap="sysModuleResultForList" parameterClass="sysModule" >
		select * from KONKA_SYS_MODULE where IS_DEL=0 start with MOD_ID = #mod_id:VARCHAR# connect by prior PAR_ID = MOD_ID
		order siblings by order_value desc,  MOD_ID
	</select>

	<select id="selectSysModuleListForMobileRole" resultMap="sysModuleResultForList" parameterClass="sysModule" >
	<![CDATA[
		select bb.*
		  from (select *
		          from konka_mod_popedom t
		         where t.role_id = #map.role_id#
		           and mod_id between 700000 and 799999) aa
		  left join konka_sys_module bb on aa.mod_id = bb.mod_id
		order by bb.id asc
  	]]>
	</select>
	
	<insert id="insertSysModule" parameterClass="sysModule">
		<![CDATA[insert into KONKA_SYS_MODULE (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="mod_id">ID</isNotNull>
			<isNotNull prepend="," property="mod_id">MOD_ID</isNotNull>
			<isNotNull prepend="," property="par_id">PAR_ID</isNotNull>
			<isNotNull prepend="," property="mod_name">MOD_NAME</isNotNull>
			<isNotNull prepend="," property="mod_desc">MOD_DESC</isNotNull>
			<isNotNull prepend="," property="mod_url">MOD_URL</isNotNull>
			<isNotNull prepend="," property="icon_path">ICON_PATH</isNotNull>
			<isNotNull prepend="," property="ppdm_code">PPDM_CODE</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE</isNotNull>
			<isNotNull prepend="," property="is_public">IS_PUBLIC</isNotNull>
			<isNotNull prepend="," property="is_msg">IS_MSG</isNotNull>
			<isNotNull prepend="," property="is_lock">IS_LOCK</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>
			<isNotNull prepend="," property="root_id">ROOT_ID</isNotNull>
			<isNotNull prepend="," property="is_view">IS_VIEW</isNotNull>
			<isNotNull prepend="," property="level_by_dept">LEVEL_BY_DEPT</isNotNull>
			<isNotNull prepend="," property="fgs_auth_flag">FGS_AUTH_FLAG</isNotNull>
			
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="mod_id">#mod_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mod_id">#mod_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="par_id">#par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mod_name">#mod_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_desc">#mod_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_url">#mod_url:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="icon_path">#icon_path:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="ppdm_code">#ppdm_code:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="order_value">#order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_public">#is_public:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_msg">#is_msg:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_lock">#is_lock:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="root_id">#root_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_view">#is_view:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="level_by_dept">#level_by_dept:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="fgs_auth_flag">#fgs_auth_flag:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateSysModule" parameterClass="sysModule">
		update KONKA_SYS_MODULE 
		<dynamic prepend="set">
			<isNotNull prepend="," property="mod_id">MOD_ID = #mod_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="par_id">PAR_ID = #par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mod_name">MOD_NAME = #mod_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_desc">MOD_DESC = #mod_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_url">MOD_URL = #mod_url:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="icon_path">ICON_PATH = #icon_path:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="ppdm_code">PPDM_CODE = #ppdm_code:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_public">IS_PUBLIC = #is_public:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_msg">IS_MSG = #is_msg:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_lock">IS_LOCK = #is_lock:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="root_id">ROOT_ID = #root_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_view">IS_VIEW = #is_view:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="level_by_dept">LEVEL_BY_DEPT = #level_by_dept:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="fgs_auth_flag">FGS_AUTH_FLAG = #fgs_auth_flag:DECIMAL#</isNotNull>
		</dynamic>
		where 1 = 1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" and " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="map.is_fgs_1">
			  IS_DEL = 0
			  and IS_PUBLIC = 0
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="map.pks_mod_id">
				MOD_ID  in
				<iterate close=")" open="(" conjunction="," property="map.pks_mod_id">#map.pks_mod_id[]#</iterate>
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="map.update_by_mod_id">
				MOD_ID =  #map.update_by_mod_id#
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="map.pks_mod_id_not">
				MOD_ID not in
				<iterate close=")" open="(" conjunction="," property="map.pks_mod_id_not">#map.pks_mod_id_not[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteSysModule" parameterClass="sysModule">
		delete from KONKA_SYS_MODULE where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
			
		</isEmpty>
	</delete>

</sqlMap>