<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="STATISTICAL_DIMENSION_RETAIL_DATA">

	<typeAlias alias="statisticalDimensionRetailData" type="com.ebiz.mmt.domain.StatisticalDimensionRetailData" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertStatisticalDimensionRetailData" />
		<flushOnExecute statement="updateStatisticalDimensionRetailData" />
		<flushOnExecute statement="deleteStatisticalDimensionRetailData" />
	</cacheModel>

	<resultMap id="statisticalDimensionRetailDataResultForList" class="statisticalDimensionRetailData">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="DEPT_NAME" property="dept_name" jdbcType="VARCHAR" />
		<result column="MODEL_ID" property="model_id" jdbcType="DECIMAL" />
		<result column="MODEL_NAME" property="model_name" jdbcType="VARCHAR" />
		<result column="CUSTOMER_ID" property="customer_id" jdbcType="DECIMAL" />
		<result column="CUSTOMER_NAME" property="customer_name" jdbcType="VARCHAR" />
		<result column="CUSTOMER_R3_CODE" property="customer_r3_code" jdbcType="VARCHAR" />
		<result column="TIME_ID" property="time_id" jdbcType="DECIMAL" />
		<result column="NUM" property="num" jdbcType="DECIMAL" />
		<result column="MONEY" property="money" jdbcType="DECIMAL" />
		<result column="PRICE" property="price" jdbcType="DECIMAL" />
		<result column="CASH_PRICE" property="cash_price" jdbcType="DECIMAL" />
		<result column="SALE_PRICE" property="sale_price" jdbcType="DECIMAL" />
		<result column="PRICE_DUAN" property="price_duan" jdbcType="DECIMAL" />
		<result column="DATA_SOURCE" property="data_source" jdbcType="DECIMAL" />
		<result column="REPORT_DATE" property="report_date" jdbcType="TIMESTAMP" />
		<result column="REPORT_ID" property="report_id" jdbcType="DECIMAL" />
		<result column="REPORT_NAME" property="report_name" jdbcType="VARCHAR" />
		<result column="REPORT_TYPE" property="report_type" jdbcType="DECIMAL" />
		<result column="MASTERCODE" property="mastercode" jdbcType="VARCHAR" />
		<result column="AGE" property="age" jdbcType="DECIMAL" />
		<result column="SEX" property="sex" jdbcType="DECIMAL" />
		<result column="CK_ID" property="ck_id" jdbcType="DECIMAL" />
		<result column="AUDIT_STATE" property="audit_state" jdbcType="DECIMAL" />
		<result column="RETAIL_ID" property="retail_id" jdbcType="DECIMAL" />
		<result column="UPDATE_DATE" property="update_date" jdbcType="TIMESTAMP" />
		<result column="RETAIL_UPDATE_DATE" property="retail_update_date" jdbcType="TIMESTAMP" />
		<result column="SETTLE_MONEY" property="settle_money" jdbcType="DECIMAL" />
		<result column="SETTLE_NUM" property="settle_num" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="statisticalDimensionRetailDataResult" class="statisticalDimensionRetailData" extends="statisticalDimensionRetailDataResultForList">
	</resultMap>

	<sql id="sf-statisticalDimensionRetailData">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="model_id">MODEL_ID = #model_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="model_name">MODEL_NAME = #model_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_id">CUSTOMER_ID = #customer_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_r3_code">CUSTOMER_R3_CODE = #customer_r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="time_id">TIME_ID = #time_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="num">NUM = #num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="money">MONEY = #money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="price">PRICE = #price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cash_price">CASH_PRICE = #cash_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sale_price">SALE_PRICE = #sale_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="price_duan">PRICE_DUAN = #price_duan:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="data_source">DATA_SOURCE = #data_source:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_id">REPORT_ID = #report_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_name">REPORT_NAME = #report_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_type">REPORT_TYPE = #report_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mastercode">MASTERCODE = #mastercode:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="age">AGE = #age:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sex">SEX = #sex:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ck_id">CK_ID = #ck_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_state">AUDIT_STATE = #audit_state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="retail_id">RETAIL_ID = #retail_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="retail_update_date">RETAIL_UPDATE_DATE = #retail_update_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="settle_money">SETTLE_MONEY = #settle_money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="settle_num">SETTLE_NUM = #settle_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
	</sql>

	<select id="selectStatisticalDimensionRetailData" resultMap="statisticalDimensionRetailDataResult" parameterClass="statisticalDimensionRetailData" cacheModel="oneDayCache">
		select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1 = 1
		<include refid="sf-statisticalDimensionRetailData" />
	</select>

	<select id="selectStatisticalDimensionRetailDataList" resultMap="statisticalDimensionRetailDataResultForList" parameterClass="statisticalDimensionRetailData" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1 = 1
		<include refid="sf-statisticalDimensionRetailData" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectStatisticalDimensionRetailDataCount" resultClass="long" parameterClass="statisticalDimensionRetailData" cacheModel="oneDayCache">
		select count(*) from STATISTICAL_DIMENSION_RETAIL_DATA where 1 = 1
		<include refid="sf-statisticalDimensionRetailData" />
	</select>

	<select id="selectStatisticalDimensionRetailDataPaginatedList" resultMap="statisticalDimensionRetailDataResult" parameterClass="statisticalDimensionRetailData" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1 = 1
		<include refid="sf-statisticalDimensionRetailData" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 删除三天之内的数据 2014-12-10-->
	<update id="AutoRunStatisticalDimensionRetailDataDelete"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		delete from STATISTICAL_DIMENSION_RETAIL_DATA a 
		where a.REPORT_DATE>=DATE(to_char(sysdate - 3 day,'yyyy-MM-dd')||' 00:00:00') 
		and a.REPORT_DATE<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59') 
		and a.settle_num is null
		and a.data_source not in (5,6)
	]]>
	</update>
	
	<!-- 插入三天之内的数据 2014-12-10-->
	<update id="AutoRunStatisticalDimensionRetailDataInsert"  parameterClass="StatisticalDimensionData">
	<![CDATA[
	insert into STATISTICAL_DIMENSION_RETAIL_DATA(ID,DEPT_ID,DEPT_NAME,MODEL_ID,MODEL_NAME,CUSTOMER_ID,CUSTOMER_NAME,
	CUSTOMER_R3_CODE,TIME_ID,NUM,MONEY,PRICE,CASH_PRICE,SALE_PRICE,PRICE_DUAN,DATA_SOURCE,REPORT_DATE,
	REPORT_ID,REPORT_NAME,REPORT_TYPE,MASTERCODE,AGE,SEX,CK_ID,AUDIT_STATE,RETAIL_ID,UPDATE_DATE,IS_DEL
	)
		SELECT
		SEQ_STATISTICAL_DIMENSION_RETAIL_DATA.NEXTVAL ID,
		a.DEPT_ID,
		       a.DEPT_NAME,
		       a.MODEL_ID,
		       a.MODEL_NAME,
		       a.CUSTOMER_ID,
		       a.CUSTOMER_NAME,
		       a.CUSTOMER_R3_CODE,
		       sdtd.ID as TIME_ID,
		       nvl(a.NUM,0) as NUM,
		       nvl(a.ALL_PRICE,0) MONEY,
		       nvl(a.SINGLE_PRICE,0) as PRICE,
		       kpmp.CASH_PRICE,
		       kpmp.SALE_PRICE,
		       case when a.SINGLE_PRICE is null then 0
		       when a.SINGLE_PRICE<1000 then 0
		       when a.SINGLE_PRICE>=1000 and a.SINGLE_PRICE<2000 then 1
		       when a.SINGLE_PRICE>=2000 and a.SINGLE_PRICE<3000 then 2
		       when a.SINGLE_PRICE>=3000 and a.SINGLE_PRICE<4000 then 3
		       when a.SINGLE_PRICE>=4000 and a.SINGLE_PRICE<5000 then 4
		       when a.SINGLE_PRICE>=5000 and a.SINGLE_PRICE<7000 then 5
		       when a.SINGLE_PRICE>=7000 and a.SINGLE_PRICE<10000 then 6
		       when a.SINGLE_PRICE>=10000 and a.SINGLE_PRICE<15000 then 7
		       when a.SINGLE_PRICE>=15000 then 8
		       end as PRICE_DUAN,
		       a.DATA_SOURCE,
		       a.REPORT_DATE,
		       a.REPORT_ID,
		       a.REPORT_NAME,
		       a.REPORT_TYPE,
		       a.MASTERCODE,
		       case when a.MASTERCODE!=null and LENGTH(a.MASTERCODE)=18 and (LENGTH(TRIM(TRANSLATE(a.MASTERCODE,' ','0123456789' )))=0 OR (LENGTH(TRIM(TRANSLATE(a.MASTERCODE,' ','0123456789' )))=1)) then  to_char(sysdate,'yyyy')-substr(a.MASTERCODE,7,4)
		       else NULL
		       end as AGE,
		       case when a.MASTERCODE!=null and LENGTH(a.MASTERCODE)=18 and (LENGTH(TRIM(TRANSLATE(a.MASTERCODE,' ','0123456789' )))=0 OR (LENGTH(TRIM(TRANSLATE(a.MASTERCODE,' ','0123456789' )))=1)) then  mod(to_number(substr(a.MASTERCODE,17,1)),2)
		       else NULL
		       end as SEX,
		       krs.CK_ID,
		       a.AUDIT_STATE,
		       a.ID RETAIL_ID,
		       sysdate UPDATE_DATE,
		       a.IS_DEL
		  FROM KONKA_MOBILE_SAIL_DATA a
		  left join STATISTICAL_DIMENSION_TIME_DAY sdtd on substr(sdtd.DAY,1,10) = substr(a.REPORT_DATE,1,10) 
		  LEFT JOIN KONKA_R3_STORE krs
		    ON krs.STORE_ID = a.DEPT_ID
		  left join KONKA_PD_MODEL_PRICES kpmp on kpmp.PD_NAME = a.MODEL_NAME and kpmp.PRICE_MONTH = to_char(a.REPORT_DATE,'yyyyMM')
		  where a.REPORT_DATE>=DATE(to_char(sysdate - 3 day,'yyyy-MM-dd')||' 00:00:00') and a.REPORT_DATE<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59') 
	
	]]>
	</update>
	
	<!-- 同步无效的数据 2014-12-10-->
	<update id="deleteStatisticalDimensionRetailDataByIDs"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		UPDATE STATISTICAL_DIMENSION_RETAIL_DATA a
		   SET IS_DEL = 1
		 WHERE RETAIL_ID IN
		          (SELECT b.ID
		             FROM KONKA_MOBILE_SAIL_DATA b
		            WHERE b.REPORT_DATE <
		                     DATE (
		                        to_char (sysdate - 3 DAY, 'yyyy-MM-dd')
		                        || ' 00:00:00')
		                  AND b.IS_DEL = 1
		                  AND b.UPDATE_DATE IS NOT NULL
		                  AND b.UPDATE_DATE >=
		                         DATE (
		                            to_char (sysdate - 3 DAY, 'yyyy-MM-dd')
		                            || ' 00:00:00')
		                  AND b.UPDATE_DATE <=
		                         DATE (
		                            to_char (sysdate - 1 DAY, 'yyyy-MM-dd')
		                            || ' 23:59:59'))
		       AND a.IS_DEL = 0
		       AND a.settle_num IS NULL
		       AND a.data_source NOT IN (5, 6, 7, 8)
	]]>
	</update>
	
	<!-- 插入三天之内的客户端零售和分销数据 2014-12-11-->
	<update id="AutoRunStatisticalDimensionRetailDataInsertForLsAndFx"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		insert into STATISTICAL_DIMENSION_RETAIL_DATA(ID,DEPT_ID,DEPT_NAME,MODEL_ID,MODEL_NAME,CUSTOMER_ID,CUSTOMER_NAME,
			CUSTOMER_R3_CODE,TIME_ID,NUM,MONEY,PRICE,CASH_PRICE,SALE_PRICE,PRICE_DUAN,DATA_SOURCE,REPORT_DATE,CK_ID,RETAIL_ID,UPDATE_DATE,IS_DEL
			)
			select 
			SEQ_STATISTICAL_DIMENSION_RETAIL_DATA.NEXTVAL ID,
			vo.DEPT_ID,
			vo.DEPT_NAME,
			kppm.PD_ID as MODEL_ID,
			kppm.MD_NAME AS MODEL_NAME,
			jb.C_ID CUSTOMER_ID,
			vo.CUSTOMER_NAME,
			vo.R3_CODE as CUSTOMER_R3_CODE,
			sdtd.ID as TIME_ID,
			a.NUM,
			a.MONEY,
			a.PRICE,
			kpmp.CASH_PRICE,
			kpmp.SALE_PRICE,
			case when a.PRICE<1000 then 0
			 when a.PRICE>=1000 and a.PRICE<2000 then 1
			 when a.PRICE>=2000 and a.PRICE<3000 then 2
			 when a.PRICE>=3000 and a.PRICE<4000 then 3
			 when a.PRICE>=4000 and a.PRICE<5000 then 4
			 when a.PRICE>=5000 and a.PRICE<7000 then 5
			 when a.PRICE>=7000 and a.PRICE<10000 then 6
			 when a.PRICE>=10000 and a.PRICE<15000 then 7
			 when a.PRICE>=15000 then 8
			 end as price_duan,
			 case jb.BILL_TYPE
			 when 20 then 5
			 when 21 then 5
			 when 40 then 6
			 when 42 then 6
			 end as DATA_SOURCE,
			 jb.OPR_DATE as REPORT_DATE,
			 a.STORE_ID as CK_ID,
			 a.BILL_ITEM_ID AS RETAIL_ID,
			 sysdate as UPDATE_DATE,
		      0 AS IS_DEL
			from J_BILL_DETAILS a
			left join j_bill jb on jb.BILL_ID = a.BILL_ID
			left join MV_ORG_OF_CUSTOMER vo on vo.KONKA_R3_ID = jb.C_ID
			left join J_BASE_GOODS jbg on jbg.GOODS_ID = a.GOODS_ID
			left join KONKA_PE_PD_MODEL kppm on kppm.MD_NAME = jbg.GOODS_NAME
			left join KONKA_PD_MODEL_PRICES kpmp on kpmp.PD_NAME = jbg.GOODS_NAME and kpmp.PRICE_MONTH = to_char(jb.OPR_DATE,'yyyyMM')
			left join STATISTICAL_DIMENSION_TIME_DAY sdtd on substr(sdtd.DAY,1,10) = substr(jb.OPR_DATE,1,10)
			where jb.BILL_TYPE in (20,21,40,42)
		  		and jb.OPR_DATE>=DATE(to_char(sysdate - 3 day,'yyyy-MM-dd')||' 00:00:00') 
				and jb.OPR_DATE<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59') 
	
	]]>
	</update>
	
	<!-- 删除31天之内地采数据 2014-12-11-->
	<update id="AutoRunStatisticalDimensionRetailDataDeleteForDiCai"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		delete from STATISTICAL_DIMENSION_RETAIL_DATA a 
		where a.REPORT_DATE>=DATE(to_char(sysdate - 31 day,'yyyy-MM-dd')||' 00:00:00') 
		and a.REPORT_DATE<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59') 
		and a.num is null
		and a.data_source=7
	]]>
	</update>
	
	<!-- 在删除31天之内的地采数据之后，同步31天的结算数据(地采)到本表中 2014-12-11-->
	<update id="AutoRunStatisticalDimensionRetailDataInsertForDiCai"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		insert into STATISTICAL_DIMENSION_RETAIL_DATA(ID,DEPT_ID,DEPT_NAME,MODEL_ID,MODEL_NAME,CUSTOMER_ID,CUSTOMER_NAME,
		CUSTOMER_R3_CODE,TIME_ID,SETTLE_NUM,SETTLE_MONEY,PRICE,CASH_PRICE,SALE_PRICE,PRICE_DUAN,DATA_SOURCE,REPORT_DATE,
		CK_ID,RETAIL_ID,UPDATE_DATE
		)
		SELECT
		SEQ_STATISTICAL_DIMENSION_RETAIL_DATA.NEXTVAL ID,
		vo.DEPT_ID,
		vo.DEPT_NAME,
		kppm.PD_ID as MODEL_ID,
		kppm.MD_NAME AS MODEL_NAME,
		vo.KONKA_R3_ID CUSTOMER_ID,
		vo.CUSTOMER_NAME,
		vo.R3_CODE as CUSTOMER_R3_CODE,
		sdtd.ID as TIME_ID,
		a.COLUMN_12 SETTLE_NUM,
		a.COLUMN_14 SETTLE_MONEY,
		a.column_13 PRICE,
		kpmp.CASH_PRICE,
		kpmp.SALE_PRICE,
		case when a.column_13<1000 then 0
		 when a.column_13>=1000 and a.column_13<2000 then 1
		 when a.column_13>=2000 and a.column_13<3000 then 2
		 when a.column_13>=3000 and a.column_13<4000 then 3
		 when a.column_13>=4000 and a.column_13<5000 then 4
		 when a.column_13>=5000 and a.column_13<7000 then 5
		 when a.column_13>=7000 and a.column_13<10000 then 6
		 when a.column_13>=10000 and a.column_13<15000 then 7
		 when a.column_13>=15000 then 8
		 end as PRICE_DUAN,
		 7 as DATA_SOURCE,
		 a.column_26 as REPORT_DATE,
		 jbsr.STORE_ID as CK_ID,
		 a.ID AS RETAIL_ID,
		 sysdate as UPDATE_DATE
		from CHANNEL_DATA_IMPORT a
		left join MV_ORG_OF_CUSTOMER vo on vo.R3_CODE = a.column_1
		left join KONKA_PE_PD_MODEL kppm on kppm.MD_NAME = a.COLUMN_11
		left join KONKA_PD_MODEL_PRICES kpmp on kpmp.PD_NAME = a.COLUMN_11 and kpmp.PRICE_MONTH = to_char(a.column_26,'yyyyMM')
		left join STATISTICAL_DIMENSION_TIME_DAY sdtd on substr(sdtd.DAY,1,10) = substr(a.column_26,1,10)
		left join J_BASE_STORE_R3 jbsr on jbsr.R3_CODE = a.COLUMN_1 and jbsr.SALE_R3_CODE = a.COLUMN_5
		WHERE a.column_26>=DATE(to_char(sysdate - 31 day,'yyyy-MM-dd')||' 00:00:00') 
				and a.column_26<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59')
	]]>
	</update>
	
	<!--  删除31天之内集采数据 2014-12-11-->
	<update id="AutoRunStatisticalDimensionRetailDataDeleteForJiCai"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		delete from STATISTICAL_DIMENSION_RETAIL_DATA a 
		where a.REPORT_DATE>=DATE(to_char(sysdate - 31 day,'yyyy-MM-dd')||' 00:00:00') 
		and a.REPORT_DATE<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59') 
		and a.num is null
		and a.data_source=8
	]]>
	</update>
	
	<!-- 在同步结算数据之后同步结算数据(集采)到本表中 2014-12-11-->
	<update id="AutoRunStatisticalDimensionRetailDataInsertForJiCai"  parameterClass="StatisticalDimensionData">
	<![CDATA[
		insert into STATISTICAL_DIMENSION_RETAIL_DATA(ID,DEPT_ID,DEPT_NAME,MODEL_ID,MODEL_NAME,CUSTOMER_ID,CUSTOMER_NAME,
		CUSTOMER_R3_CODE,TIME_ID,SETTLE_NUM,SETTLE_MONEY,PRICE,CASH_PRICE,SALE_PRICE,PRICE_DUAN,DATA_SOURCE,REPORT_DATE,
		CK_ID,RETAIL_ID,UPDATE_DATE,IS_DEL
		)
		SELECT
		SEQ_STATISTICAL_DIMENSION_RETAIL_DATA.NEXTVAL ID,
		vo.DEPT_ID,
		vo.DEPT_NAME,
		kppm.PD_ID as MODEL_ID,
		kppm.MD_NAME AS MODEL_NAME,
		vo.KONKA_R3_ID CUSTOMER_ID,
		vo.CUSTOMER_NAME,
		vo.R3_CODE as CUSTOMER_R3_CODE,
		sdtd.ID as TIME_ID,
		a.LFIMG1 SETTLE_NUM,
		kp.PRICE*a.LFIMG1 SETTLE_MONEY,
		kp.PRICE,
		kpmp.CASH_PRICE,
		kpmp.SALE_PRICE,
		case when kp.PRICE<1000 then 0
		 when kp.PRICE>=1000 and kp.PRICE<2000 then 1
		 when kp.PRICE>=2000 and kp.PRICE<3000 then 2
		 when kp.PRICE>=3000 and kp.PRICE<4000 then 3
		 when kp.PRICE>=4000 and kp.PRICE<5000 then 4
		 when kp.PRICE>=5000 and kp.PRICE<7000 then 5
		 when kp.PRICE>=7000 and kp.PRICE<10000 then 6
		 when kp.PRICE>=10000 and kp.PRICE<15000 then 7
		 when kp.PRICE>=15000 then 8
		 end as PRICE_DUAN,
		 8 as DATA_SOURCE,
		 a.ERDAT as REPORT_DATE,
		 jbsr.STORE_ID as CK_ID,
		 a.ID AS RETAIL_ID,
		 sysdate as UPDATE_DATE,
		 0 AS IS_DEL
		from KONKA_ZLES23_RESULT_INFO a
		left join KONKA_PRICE_MANAGER  kp on a.MATNR=kp.GOODS_NAME and a.LGORT=kp.STORE_SN 
		and a.BUDAT1 >=kp.START_DATE and a.BUDAT1<=kp.END_DATE
		left join KONKA_PARTERSHIP kps on kps.SONGDF_ID = a.KUNNR
		left join MV_ORG_OF_CUSTOMER vo on vo.R3_CODE = kps.SHOUDF_ID
		left join KONKA_PE_PD_MODEL kppm on kppm.MD_NAME = a.MATNR
		left join KONKA_PD_MODEL_PRICES kpmp on kpmp.PD_NAME = a.MATNR and kpmp.PRICE_MONTH = to_char(a.ERDAT,'yyyyMM')
		left join STATISTICAL_DIMENSION_TIME_DAY sdtd on substr(sdtd.DAY,1,10) = substr(a.ERDAT,1,10)
		left join J_BASE_STORE_R3 jbsr on jbsr.R3_CODE = kps.SHOUDF_ID and jbsr.SALE_R3_CODE = a.KUNNR
		WHERE a.ERDAT>=DATE(to_char(sysdate - 31 day,'yyyy-MM-dd')||' 00:00:00') 
				and a.ERDAT<=DATE(to_char(sysdate - 1 day,'yyyy-MM-dd')||' 23:59:59')
	
	]]>
	</update>

	<insert id="insertStatisticalDimensionRetailData" parameterClass="statisticalDimensionRetailData">
		<selectKey resultClass="long" keyProperty="id">select SEQ_STATISTICAL_DIMENSION_RETAIL_DATA.nextval as id from dual </selectKey>
		<![CDATA[insert into STATISTICAL_DIMENSION_RETAIL_DATA (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="dept_name">DEPT_NAME</isNotNull>	
			<isNotNull prepend="," property="model_id">MODEL_ID</isNotNull>	
			<isNotNull prepend="," property="model_name">MODEL_NAME</isNotNull>	
			<isNotNull prepend="," property="customer_id">CUSTOMER_ID</isNotNull>	
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME</isNotNull>	
			<isNotNull prepend="," property="customer_r3_code">CUSTOMER_R3_CODE</isNotNull>	
			<isNotNull prepend="," property="time_id">TIME_ID</isNotNull>	
			<isNotNull prepend="," property="num">NUM</isNotNull>	
			<isNotNull prepend="," property="money">MONEY</isNotNull>	
			<isNotNull prepend="," property="price">PRICE</isNotNull>	
			<isNotNull prepend="," property="cash_price">CASH_PRICE</isNotNull>	
			<isNotNull prepend="," property="sale_price">SALE_PRICE</isNotNull>	
			<isNotNull prepend="," property="price_duan">PRICE_DUAN</isNotNull>	
			<isNotNull prepend="," property="data_source">DATA_SOURCE</isNotNull>	
			<isNotNull prepend="," property="report_date">REPORT_DATE</isNotNull>	
			<isNotNull prepend="," property="report_id">REPORT_ID</isNotNull>	
			<isNotNull prepend="," property="report_name">REPORT_NAME</isNotNull>	
			<isNotNull prepend="," property="report_type">REPORT_TYPE</isNotNull>	
			<isNotNull prepend="," property="mastercode">MASTERCODE</isNotNull>	
			<isNotNull prepend="," property="age">AGE</isNotNull>	
			<isNotNull prepend="," property="sex">SEX</isNotNull>	
			<isNotNull prepend="," property="ck_id">CK_ID</isNotNull>	
			<isNotNull prepend="," property="audit_state">AUDIT_STATE</isNotNull>	
			<isNotNull prepend="," property="retail_id">RETAIL_ID</isNotNull>	
			<isNotNull prepend="," property="update_date">UPDATE_DATE</isNotNull>	
			<isNotNull prepend="," property="retail_update_date">RETAIL_UPDATE_DATE</isNotNull>
			<isNotNull prepend="," property="settle_money">SETTLE_MONEY</isNotNull>	
			<isNotNull prepend="," property="settle_num">SETTLE_NUM</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>		
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_name">#dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="model_id">#model_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="model_name">#model_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_id">#customer_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="customer_name">#customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_r3_code">#customer_r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="time_id">#time_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="num">#num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">#money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="price">#price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="cash_price">#cash_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sale_price">#sale_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="price_duan">#price_duan:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="data_source">#data_source:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_date">#report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="report_id">#report_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_name">#report_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_type">#report_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mastercode">#mastercode:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="age">#age:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sex">#sex:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ck_id">#ck_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_state">#audit_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="retail_id">#retail_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_date">#update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="retail_update_date">#retail_update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="settle_money">#settle_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="settle_num">#settle_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateStatisticalDimensionRetailData" parameterClass="StatisticalDimensionRetailData">
		update STATISTICAL_DIMENSION_RETAIL_DATA
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="model_id">MODEL_ID = #model_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="model_name">MODEL_NAME = #model_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_id">CUSTOMER_ID = #customer_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_r3_code">CUSTOMER_R3_CODE = #customer_r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="time_id">TIME_ID = #time_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="num">NUM = #num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">MONEY = #money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="price">PRICE = #price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="cash_price">CASH_PRICE = #cash_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sale_price">SALE_PRICE = #sale_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="price_duan">PRICE_DUAN = #price_duan:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="data_source">DATA_SOURCE = #data_source:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="report_id">REPORT_ID = #report_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="report_name">REPORT_NAME = #report_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_type">REPORT_TYPE = #report_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mastercode">MASTERCODE = #mastercode:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="age">AGE = #age:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sex">SEX = #sex:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ck_id">CK_ID = #ck_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_state">AUDIT_STATE = #audit_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="retail_id">RETAIL_ID = #retail_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_date">UPDATE_DATE = #update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="retail_update_date">RETAIL_UPDATE_DATE = #retail_update_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="settle_money">SETTLE_MONEY = #settle_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="settle_num">SETTLE_NUM = #settle_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteStatisticalDimensionRetailData" parameterClass="StatisticalDimensionRetailData">
		delete from STATISTICAL_DIMENSION_RETAIL_DATA where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
	
	<!-- 指定省份下各城市尺寸段零售量 -->
	<select id="selectSizeOfCityList" resultClass="java.util.HashMap" parameterClass="StatisticalDimensionRetailData" cacheModel="oneDayCache">
		select c.CITY_NAME,d.RANGE_SIZE,sum(a.all_num) as nums from (select dept_id,MODEL_ID,sum(num) as all_num  from STATISTICAL_DIMENSION_RETAIL_DATA 
		where 1=1
		<isNotEmpty prepend=" and " property="map.begin_date"><![CDATA[REPORT_DATE >= #map.begin_date#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_date"><![CDATA[REPORT_DATE <= #map.end_date#]]></isNotEmpty>
		group by dept_id,MODEL_ID) a
		left join STATISTICAL_DIMENSION_STORE b on a.dept_id=b.store_id
		left join ( select * from STATISTICAL_DIMENSION_AREA 
		where 1=1
		<isNotEmpty prepend=" and " property="map.province">PROVINCE_ID = #map.province#</isNotEmpty>
		and CITY_NAME is not null) c on b.p_index=c.p_index
		left join (select MD_ID,
		<![CDATA[(case when (MD_SIZE<32) then 1 when (MD_SIZE>=32 and MD_SIZE<=36) then 2 when (MD_SIZE>=37 and MD_SIZE<=39) then 3
        	when (MD_SIZE>=40 and MD_SIZE<=45) then 4 when (MD_SIZE>=46 and MD_SIZE<=50) then 5 when (MD_SIZE>=51 and MD_SIZE<=59) then 6
        	when (MD_SIZE>=60 and MD_SIZE<=69) then 7 when (MD_SIZE>=70) then 8  when MD_SIZE IS NULL THEN 9 END) as range_size 
        ]]>
        from STATISTICAL_DIMENSION_MD) d on a.MODEL_ID=d.MD_ID
		where 1=1 and d.md_id is not null and c.city_name is not null
		group by c.CITY_NAME,d.RANGE_SIZE
	</select>
	
	<!-- 指定城市前10销量机型 -->
	<select id="selectTop10CityList" resultClass="java.util.HashMap" parameterClass="StatisticalDimensionRetailData" cacheModel="oneDayCache">
		select * from (Select rank() over(order by nums desc) as ranks,t.*
		from (select c.CITY_NAME,a.MODEL_NAME,sum(nvl(a.num,0)) nums,
		decode(sum(nvl(a.num,0)),0,0,round((sum(nvl(a.money,0))/sum(nvl(a.num,0))),2)) moneys
		from (select dept_id,MODEL_NAME,num,money from STATISTICAL_DIMENSION_RETAIL_DATA
		where 1=1 and num is not null and money is not null and MODEL_NAME is not null and dept_id is not null
		<isNotEmpty prepend=" and " property="map.begin_date"><![CDATA[REPORT_DATE >= #map.begin_date#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_date"><![CDATA[REPORT_DATE <= #map.end_date#]]></isNotEmpty>
		) a 
		left join STATISTICAL_DIMENSION_STORE  b on a.dept_id=b.store_id
		left join STATISTICAL_DIMENSION_AREA c on b.p_index=c.p_index
		where 1=1 
		<isNotEmpty prepend=" and " property="map.city_id">c.city_id = #map.city_id#</isNotEmpty>
		<![CDATA[group by c.CITY_NAME,a.MODEL_NAME) t) where rownum<=10]]>
	</select>
	
	
	<!-- 根据城市id获取各机型销售数据 -->
	<select id="selectModleDataList" resultClass="java.util.HashMap" parameterClass="StatisticalDimensionRetailData" cacheModel="oneDayCache">
	   <!--  (select a.MODEL_NAME,sum(nvl(a.NUM,0)) nums,sum(nvl(a.MONEY,0)) moneys,decode(sum(nvl(a.num,0)),0,0,round((sum(nvl(a.money,0))/sum(nvl(a.num,0))),2)) prices
		from (select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1=1 and MODEL_NAME is not null
		<isNotEmpty prepend=" and " property="map.begin_date"><![CDATA[REPORT_DATE >= #map.begin_date#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_date"><![CDATA[REPORT_DATE <= #map.end_date#]]></isNotEmpty>
		) a
		left join STATISTICAL_DIMENSION_STORE b on a.dept_id=b.store_id
		left join STATISTICAL_DIMENSION_AREA c on b.p_index=c.p_index
		where 1=1
		<isNotEmpty prepend=" and " property="map.city_id">c.city_id = #map.city_id#</isNotEmpty>
		group by a.MODEL_NAME) t -->
		
		select t.*,m.IS_4K,m.IS_YTV from
		(select cur.MODEL_NAME,cur.nums,cur.moneys,cur.prices,nvl(par.par_nums,0) par_num,nvl(par.par_moneys,0) par_money,
			(case when (nvl(par.par_nums,0)=0 and cur.nums>0) then 1 when (nvl(par.par_nums,0)>0 and cur.nums=0) then -1
			when (nvl(par.par_nums,0)=0 and cur.nums=0) then 0 else ((cur.nums-nvl(par.par_nums,0))/nvl(par.par_nums,0)) end) per_num,
			(case when (nvl(par.par_moneys,0)=0 and cur.moneys>0) then 1 when (nvl(par.par_moneys,0)>0 and cur.moneys=0) then -1
			when (nvl(par.par_moneys,0)=0 and cur.moneys=0) then 0 else ((cur.moneys-nvl(par.par_moneys,0))/nvl(par.par_moneys,0)) end) per_money
 		from (select a.MODEL_NAME,sum(nvl(a.NUM,0)) nums,sum(nvl(a.MONEY,0)) moneys,decode(sum(nvl(a.num,0)),0,0,round((sum(nvl(a.money,0))/sum(nvl(a.num,0))),2)) prices
			from (select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1=1
			<isNotEmpty prepend=" and " property="map.begin_date"><![CDATA[REPORT_DATE >= #map.begin_date#]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.end_date"><![CDATA[REPORT_DATE <= #map.end_date#]]></isNotEmpty>
			) a
			left join STATISTICAL_DIMENSION_STORE b on a.dept_id=b.store_id
			left join STATISTICAL_DIMENSION_AREA c on b.p_index=c.p_index
			where 1=1 and a.MODEL_NAME is not null
			<isNotEmpty prepend=" and " property="map.city_id">c.city_id = #map.city_id#</isNotEmpty>
			group by a.MODEL_NAME) cur
		left join (select a.MODEL_NAME,sum(nvl(a.NUM,0)) par_nums,sum(nvl(a.MONEY,0)) par_moneys
			from (select * from STATISTICAL_DIMENSION_RETAIL_DATA where 1=1
			<isNotEmpty prepend=" and " property="map.par_begin_date"><![CDATA[REPORT_DATE >= #map.par_begin_date#]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.par_end_date"><![CDATA[REPORT_DATE <= #map.par_end_date#]]></isNotEmpty>
			) a
			left join STATISTICAL_DIMENSION_STORE b on a.dept_id=b.store_id
			left join STATISTICAL_DIMENSION_AREA c on b.p_index=c.p_index
			where 1=1 and a.MODEL_NAME is not null
			<isNotEmpty prepend=" and " property="map.city_id">c.city_id = #map.city_id#</isNotEmpty>
		group by a.MODEL_NAME) par on cur.MODEL_NAME=par.MODEL_NAME) t
		left join STATISTICAL_DIMENSION_MD m on m.MD_NAME=t.MODEL_NAME
	</select>
	
</sqlMap>