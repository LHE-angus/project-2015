<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_STOCK_DETAILS">

	<typeAlias alias="konkaStockDetails" type="com.ebiz.mmt.domain.KonkaStockDetails" />

	

	<resultMap id="konkaStockDetailsResultForList" class="konkaStockDetails">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="R3_CODE" property="r3_code" jdbcType="VARCHAR" />
		<result column="PD_ID" property="pd_id" jdbcType="DECIMAL" />
		<result column="STOCK_COUNT" property="stock_count" jdbcType="DECIMAL" />
		<result column="STOCK_COST" property="stock_cost" jdbcType="DECIMAL" />
		<result column="REGULATION" property="regulation" jdbcType="DECIMAL" />
		<result column="CURRENT_COST" property="current_cost" jdbcType="DECIMAL" />
		<result column="CURRENT_COUNT" property="current_count" jdbcType="DECIMAL" />
		<result column="STOCK_DATE" property="stock_date" jdbcType="DATETIME" />
	</resultMap>

	<resultMap id="konkaStockDetailsResult" class="konkaStockDetails" extends="konkaStockDetailsResultForList">
		<result column="MD_NAME" property="map.md_name" jdbcType="VARCHAR" />
	</resultMap>

	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<resultMap id="konkaStockDetailsResultForStatistics" class="konkaStockDetails">
		<result column="STOCK_COUNT" property="stock_count" jdbcType="DECIMAL" />
		<result column="DEPT_SN" property="map.dept_sn" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
		<result column="CUS_SN" property="map.cus_sn" jdbcType="VARCHAR" />
		<result column="PD_NAME" property="map.pd_name" jdbcType="VARCHAR" />
		<result column="STOCK_DATE" property="map.stock_date" jdbcType="VARCHAR" />
	</resultMap>
	
	<sql id="sf-konkaStockDetails">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">a.R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">a.PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="stock_count">a.STOCK_COUNT = #stock_count:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="stock_cost">a.STOCK_COST = #stock_cost:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="regulation">a.REGULATION = #regulation:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="current_cost">a.CURRENT_COST = #current_cost:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="current_count">a.CURRENT_COUNT = #current_count:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="stock_date">a.STOCK_DATE = #stock_date:DATETIME#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.stock_date_start"><![CDATA[a.STOCK_DATE >= to_date(#map.stock_date_start#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.stock_date_end"><![CDATA[a.STOCK_DATE <= to_date(#map.stock_date_end#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.handle_name">a.r3_code in (select r3_code from konka_r3_shop r where r.handle_name like '%' || #map.handle_name# || '%')</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.branch_area_name">a.r3_code in (select r3_code from konka_r3_shop r where r.branch_area_name like '%' || #map.branch_area_name# || '%')</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.md_name_like">a.pd_id in (select pd_id from konka_pe_pd_model where md_name like'%'|| #map.md_name_like# ||'%')</isNotEmpty>		
	</sql>

	<select id="selectKonkaStockDetails" resultMap="konkaStockDetailsResult" parameterClass="konkaStockDetails" >
		select a.*,(select md_name from KONKA_PE_PD_MODEL b WHERE a.pd_id = b.pd_id) as md_name from KONKA_STOCK_DETAILS a where 1 = 1
		<include refid="sf-konkaStockDetails" />
	</select>

	<select id="selectKonkaStockDetailsList" resultMap="konkaStockDetailsResult" parameterClass="konkaStockDetails" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select a.*,(select md_name from KONKA_PE_PD_MODEL b WHERE a.pd_id = b.pd_id) as md_name from KONKA_STOCK_DETAILS a where 1 = 1
		<include refid="sf-konkaStockDetails" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaStockDetailsCount" resultClass="long" parameterClass="konkaStockDetails" >
		select count(a.*) from KONKA_STOCK_DETAILS a where 1 = 1
		<include refid="sf-konkaStockDetails" />
	</select>
	
	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<select id="selectKonkaStockDetailsForStatisticsCount" resultClass="long" parameterClass="konkaStockDetails" >
		select count(1)
		  from (select t2.add_dept_id, t2.cus_sn, t1.pd_id, t1.stock_count, t2.stock_date
		          from KONKA_STOCK_DETAILS t1,
		               (select t.s_id, t.cus_sn, t.add_dept_id, t.stock_date
		                  from KONKA_STOCK t
		                 where 1 = 1 
		                   <isNotEmpty prepend=" and " property="map.is_leader_dept_id">t.add_user_id in (select k.user_id from konka_user k where k.dept_id in (select dept_id from konka_dept d start with d.dept_id in (select dept_id from konka_dept a where dept_id = #map.is_leader_dept_id:DECIMAL#) connect by prior d.dept_id = d.par_id))</isNotEmpty>
						   <isNotEmpty prepend=" and " property="map.add_user_id">t.add_user_id = #map.add_user_id:DECIMAL#</isNotEmpty>
		                   and <![CDATA[STOCK_DATE >= to_date(#map.stock_date_start#,'yyyy-MM-dd hh24:mi:ss')]]>
		                   and <![CDATA[STOCK_DATE <= to_date(#map.stock_date_end#,'yyyy-MM-dd hh24:mi:ss')]]>
		                   and t.is_del = 0
		                   and (t.state = 1 or t.state = 2)) t2
		         where t1.s_id = t2.s_id) t3
		  left join KONKA_PD_MODEL t4 on t3.pd_id = t4.pd_id
		  left join KONKA_DEPT t5 on t3.add_dept_id = t5.dept_id
	</select>

	<select id="selectKonkaStockDetailsPaginatedList" resultMap="konkaStockDetailsResultForList" parameterClass="konkaStockDetails" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.* from KONKA_STOCK_DETAILS a where 1 = 1
		<include refid="sf-konkaStockDetails" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<select id="selectKonkaStockDetailsForStatisticsPaginatedList" resultMap="konkaStockDetailsResultForStatistics" parameterClass="konkaStockDetails" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			select 
			(select dept_sn from KONKA_DEPT where dept_id = t3.add_dept_id) as dept_sn,
            (select dept_name from KONKA_DEPT where dept_id = t3.add_dept_id) as dept_name,
			t3.cus_sn,t4.pd_name,t3.stock_count,t3.stock_date
			  from (select t2.add_dept_id, t2.cus_sn, t1.pd_id, t1.stock_count, t2.stock_date
			          from KONKA_STOCK_DETAILS t1,
			               (select t.s_id, t.cus_sn, t.add_dept_id, t.stock_date
			                  from KONKA_STOCK t
			                 where 1 = 1 
			                   <isNotEmpty prepend=" and " property="map.is_leader_dept_id">t.add_user_id in (select k.user_id from konka_user k where k.dept_id in (select dept_id from konka_dept d start with d.dept_id in (select dept_id from konka_dept a where dept_id = #map.is_leader_dept_id:DECIMAL#) connect by prior d.dept_id = d.par_id))</isNotEmpty>
							   <isNotEmpty prepend=" and " property="map.add_user_id">t.add_user_id = #map.add_user_id:DECIMAL#</isNotEmpty>
			                   and <![CDATA[STOCK_DATE >= to_date(#map.stock_date_start#,'yyyy-MM-dd hh24:mi:ss')]]>
			                   and <![CDATA[STOCK_DATE <= to_date(#map.stock_date_end#,'yyyy-MM-dd hh24:mi:ss')]]>
			                   and t.is_del = 0
			                   and (t.state = 1 or t.state = 2)) t2
			         where t1.s_id = t2.s_id) t3
			  left join KONKA_PD_MODEL t4 on t3.pd_id = t4.pd_id
			  <isNotEmpty prepend=" " property="map.dept_id">
			  where t3.add_dept_id in (select t5.dept_id from KONKA_DEPT t5  where 1 = 1
         start with dept_id =#map.dept_id#  connect by prior   t5.dept_id = t5.par_id )
         </isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaStockDetails" parameterClass="konkaStockDetails">
		<selectKey resultClass="long" keyProperty="id">select KONKA_S_BASE.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_STOCK_DETAILS (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="r3_code">R3_CODE</isNotNull>	
			<isNotNull prepend="," property="pd_id">PD_ID</isNotNull>	
			<isNotNull prepend="," property="stock_count">STOCK_COUNT</isNotNull>	
			<isNotNull prepend="," property="stock_cost">STOCK_COST</isNotNull>	
			<isNotNull prepend="," property="regulation">REGULATION</isNotNull>	
			<isNotNull prepend="," property="current_cost">CURRENT_COST</isNotNull>	
			<isNotNull prepend="," property="current_count">CURRENT_COUNT</isNotNull>	
			<isNotNull prepend="," property="stock_date">STOCK_DATE</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">#r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="pd_id">#pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_count">#stock_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_cost">#stock_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="regulation">#regulation:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="current_cost">#current_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="current_count">#current_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_date">#stock_date:DATETIME#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaStockDetails" parameterClass="KonkaStockDetails">
		update KONKA_STOCK_DETAILS
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_count">STOCK_COUNT = #stock_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_cost">STOCK_COST = #stock_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="regulation">REGULATION = #regulation:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="current_cost">CURRENT_COST = #current_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="current_count">CURRENT_COUNT = #current_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="stock_date">STOCK_DATE = #stock_date:DATETIME#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaStockDetails" parameterClass="KonkaStockDetails">
		delete from KONKA_STOCK_DETAILS where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		<isNotEmpty prepend=" " property="r3_code">R3_CODE = #r3_code#
			<isNotEmpty prepend=" and " property="pd_id">PD_ID = #pd_id#</isNotEmpty>
		</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>