<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="J_BILL">

	<typeAlias alias="jBill" type="com.ebiz.mmt.domain.JBill" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertJBill" />
		<flushOnExecute statement="updateJBill" />
		<flushOnExecute statement="deleteJBill" />
	</cacheModel>

	<resultMap id="jBillResultForList" class="jBill">
		<result column="BILL_ID" property="bill_id" jdbcType="DECIMAL" />
		<result column="BILL_TYPE" property="bill_type" jdbcType="DECIMAL" />
		<result column="BILL_SN" property="bill_sn" jdbcType="VARCHAR" />
		<result column="BILL_MEMO" property="bill_memo" jdbcType="VARCHAR" />
		<result column="PARTNER_ID" property="partner_id" jdbcType="DECIMAL" />
		<result column="REC_MONEY" property="rec_money" jdbcType="DECIMAL" />
		<result column="SUM_MONEY" property="sum_money" jdbcType="DECIMAL" />
		<result column="DIS_MONEY" property="dis_money" jdbcType="DECIMAL" />
		<result column="DISCOUNT" property="discount" jdbcType="DECIMAL" />
		<result column="MONEY" property="money" jdbcType="DECIMAL" />
		<result column="OPR_DATE" property="opr_date" jdbcType="DATETIME" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATETIME" />
		<result column="C_ID" property="c_id" jdbcType="DECIMAL" />
		<result column="R_BILL_SN" property="r_bill_sn" jdbcType="VARCHAR" />
		<result column="BILLS_TITLE" property="bills_title" jdbcType="VARCHAR" />
		<result column="BILLS_SUMARY" property="bills_sumary" jdbcType="VARCHAR" />
		<result column="PLAN_HAND_TIME" property="plan_hand_time" jdbcType="TIMESTAMP" />
		<result column="SEND_TYPE" property="send_type" jdbcType="DECIMAL" />
		<result column="ADD_USER_NAME" property="add_user_name" jdbcType="VARCHAR" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="BILL_STATE" property="bill_state" jdbcType="DECIMAL" />
		<result column="XS_ID" property="xs_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="jBillResult" class="jBill" extends="jBillResultForList">
	</resultMap>
	<resultMap id="jBillResultForView" class="jBill" extends="jBillResultForList">
	    <result column="PART_NAME" property="map.part_name" jdbcType="VARCHAR" />
	    <result column="PART_SN" property="map.part_sn" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="jBillResultForListPrint" class="jBill" extends="jBillResultForList">
	    <result column="PARTNER_NAME" property="map.partner_name" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="khJBillForListPrint" class="jBill" extends="jBillResultForList">
	    <result column="PARTNER_NAME" property="map.partner_name" jdbcType="VARCHAR" />
	    <result column="PARTNER_SN" property="map.partner_sn" jdbcType="VARCHAR" />
	    <result column="LINK_NAME" property="map.link_name" jdbcType="VARCHAR" />
	    <result column="TOTAL_NUM" property="map.total_num" jdbcType="DECIMAL" />
	    <result column="STATUS" property="map.status" jdbcType="DECIMAL" />
	</resultMap>

	<sql id="sf-jBill">
		<isNotEmpty prepend=" and " property="bill_id">a.BILL_ID = #bill_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_sn">a.BILL_SN = #bill_sn:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_memo">a.BILL_MEMO = #bill_memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="partner_id">a.PARTNER_ID = #partner_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rec_money">a.REC_MONEY = #rec_money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sum_money">a.SUM_MONEY = #sum_money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dis_money">a.DIS_MONEY = #dis_money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="discount">a.DISCOUNT = #discount:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="money">a.MONEY = #money:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="opr_date">a.OPR_DATE = #opr_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">a.ADD_DATE = #add_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="c_id">a.C_ID = #c_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r_bill_sn">a.R_BILL_SN = #r_bill_sn:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bills_title">a.BILLS_TITLE = #bills_title:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bills_sumary">a.BILLS_SUMARY = #bills_sumary:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_hand_time">a.PLAN_HAND_TIME = #plan_hand_time:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_state">a.BILL_STATE = #bill_state:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.is_fx">a.BILL_SN like 'FX-' || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.not_fx">a.BILL_SN not like 'FX-' || '%'</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.OPR_DATE >= to_date(#map.opr_date_gt# || '00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.OPR_DATE <= to_date(#map.opr_date_lt# || '23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.bill_types">a.BILL_TYPE in ($map.bill_types$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date"><![CDATA[ a.OPR_DATE = to_date(#map.opr_date#,'yyyy-mm-dd') ]]></isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.r3_id">a.C_ID = #map.r3_id:DECIMAL#</isNotEmpty>
	</sql>

	<select id="selectJBill" resultMap="jBillResultForView" parameterClass="jBill" cacheModel="oneDayCache">
		select a.*,b.customer_name part_name,b.r3_code part_sn from J_BILL a
		left join konka_r3_shop b on b.id=a.c_id
		where 1 = 1
		<include refid="sf-jBill" />
	</select>

	<select id="selectJBillList" resultMap="jBillResultForList" parameterClass="jBill" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from J_BILL a where 1 = 1
		<include refid="sf-jBill" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectJBillCount" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		select count(*) from J_BILL a where 1 = 1
		<include refid="sf-jBill" />
	</select>
	
	<select id="selectJBillCountForFouWeek" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		select nvl (sum (b.num), 0) as fx_num from j_bill a
          left join j_bill_details b on a.bill_id = b.bill_id where 1 = 1
		<include refid="sf-jBill" />
		<isNotEmpty prepend=" and " property="map.goods_id">b.goods_id = #map.goods_id#</isNotEmpty>
	</select>

<select id="selectJBillCountNameLike" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select count(*) from ( select t_.*,(select jb.partner_name from j_base_partner jb where jb.partner_id=t_.partner_id) as partner_name, rownum rn_ from ( ]]>
		select * from J_BILL a where 1 = 1
		
		<include refid="sf-jBill" />
		<!-- order by ID asc -->
		<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by ADD_DATE desc,BIll_ID desc</isNotEmpty>
		<![CDATA[ ) t_ ) where 1=1 ]]>
		<isNotEmpty prepend=" and " property="map.partner_name_like">PARTNER_NAME like '%' || #map.partner_name_like:VARCHAR# || '%' </isNotEmpty>
	</select>
	
 	<!-- 客户端-零售查询统计数量  add by Liang Houen on 2015/06/24-->
	<select id="getSaleDataForkhCount" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select count(*) from ( 
			select t_.* from ( ]]>
			select a.BIll_ID,a.ADD_DATE, a.BILL_SN, a.BILL_TYPE, 
			(case when (a.C_ID=a.XS_ID) then (select s.customer_name from konka_r3_shop s where s.id=a.XS_ID) else
			(select store_name from konka_r3_store where store_id=a.XS_ID) end) p_name,
			(case when (a.C_ID=a.XS_ID) then (select s.r3_code from konka_r3_shop s where s.id=a.XS_ID) else
			(select store_id||'' from konka_r3_store where store_id=a.XS_ID) end) p_id,
			b.partner_name,b.LINK_MOBILE,(select sum(num) from J_BILL_DETAILS t where t.bill_id=a.bill_id) total_num,
			a.REC_MONEY,a.DIS_MONEY,a.SUM_MONEY,a.BILL_STATE,a.R_BILL_SN,a.ADD_USER_NAME
			from J_BILL a 
			left join j_base_partner b on a.partner_id=b.partner_id
			where a.bill_type in (20,21)
			<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.ADD_DATE >= to_date(#map.opr_date_gt# || '00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.ADD_DATE <= to_date(#map.opr_date_lt# || '23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type:DECIMAL#</isNotEmpty>
			<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.customer_name_like">b.partner_name like '%' || #map.customer_name_like# || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.mobile_like">b.LINK_MOBILE like '%' || #map.mobile_like# || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="c_id">a.c_id=#c_id#</isNotEmpty>
			) t_ where 1=1 
			<isNotEmpty prepend=" and " property="map.p_name_like">p_name like '%' || #map.p_name_like:VARCHAR# || '%'</isNotEmpty> 
			<isNotEmpty prepend=" and " property="map.p_id_like">p_id like '%' || #map.p_id_like:VARCHAR# || '%'</isNotEmpty> 
			<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by ADD_DATE desc,BIll_ID desc</isNotEmpty>
			)
	</select>
	
	<!-- 客户端-零售查询列表  add by Liang Houen on 2015-06-24 -->
	<select id="getSaleDataForkhList" resultClass="java.util.HashMap" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select * from ( 
			select t_.*, rownum rn_ from ( ]]>
			select tt.* from (
			select a.BIll_ID,a.ADD_DATE, a.BILL_SN, a.BILL_TYPE, 
			(case when (a.C_ID=a.XS_ID) then (select s.customer_name from konka_r3_shop s where s.id=a.XS_ID) else
			(select store_name from konka_r3_store where store_id=a.XS_ID) end) p_name,
			(case when (a.C_ID=a.XS_ID) then (select s.r3_code from konka_r3_shop s where s.id=a.XS_ID) else
			(select store_id||'' from konka_r3_store where store_id=a.XS_ID) end) p_id,
			b.partner_name,b.LINK_MOBILE,(select sum(num) from J_BILL_DETAILS t where t.bill_id=a.bill_id) total_num,
			a.REC_MONEY,a.DIS_MONEY,a.SUM_MONEY,a.MONEY,a.BILL_STATE,a.R_BILL_SN,a.ADD_USER_NAME
			from J_BILL a 
			left join j_base_partner b on a.partner_id=b.partner_id
			where bill_type in (20,21)
			<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.ADD_DATE >= to_date(#map.opr_date_gt# || '00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.ADD_DATE <= to_date(#map.opr_date_lt# || '23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
			<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type:DECIMAL#</isNotEmpty>
			<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.customer_name_like">b.partner_name like '%' || #map.customer_name_like# || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.mobile_like">b.LINK_MOBILE like '%' || #map.mobile_like# || '%'</isNotEmpty>
			<isNotEmpty prepend=" and " property="c_id">a.c_id=#c_id#</isNotEmpty>
			) tt where 1=1 
			<isNotEmpty prepend=" and " property="map.p_name_like">p_name like '%' || #map.p_name_like:VARCHAR# || '%'</isNotEmpty> 
			<isNotEmpty prepend=" and " property="map.p_id_like">p_id like '%' || #map.p_id_like:VARCHAR# || '%'</isNotEmpty> 
			<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by ADD_DATE desc,BIll_ID desc</isNotEmpty>
			<![CDATA[) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>



	<select id="selectJBillPaginatedList" resultMap="jBillResultForListPrint" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*,(select jb.partner_name from j_base_partner jb where jb.partner_id=t_.partner_id) as partner_name, rownum rn_ from ( ]]>
		select * from J_BILL a where 1 = 1
		
		<include refid="sf-jBill" />
		<!-- order by ID asc -->
		<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by ADD_DATE desc,BIll_ID desc</isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		<isNotEmpty prepend=" and " property="map.partner_name_like">PARTNER_NAME like '%' || #map.partner_name_like:VARCHAR# || '%' </isNotEmpty>
	</select>
	
	<select id="selectJBillForTHCount" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		select count(*) from (select a.*,(select jb.partner_name from j_base_partner jb where jb.partner_id=a.partner_id) as partner_name 
			from J_BILL a
			left join J_SUB_SELL_REC b on a.BILL_SN=b.SELL_BILL_SN
			where 1 = 1
			<isNotEmpty prepend=" and " property="map.fxth">
			    b.status=#map.fxth:DECIMAL# and not exists (select jb.bill_sn from J_BILL jb where jb.bill_type=42 and a.bill_sn=jb.r_bill_sn)
			</isNotEmpty>
			<include refid="sf-jBill" />)
		where 1=1
		<isNotEmpty prepend=" and " property="map.partner_name_like">PARTNER_NAME like '%' || #map.partner_name_like:VARCHAR# || '%' </isNotEmpty>
	</select>
	
	<!-- 查询可做分销退货的订单 -->
	<select id="selectJBillForTH" resultClass="java.util.HashMap" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*,(select jb.partner_name from j_base_partner jb where jb.partner_id=t_.partner_id) as partner_name, rownum rn_ from ( ]]>
		select a.BILL_SN,a.partner_id from J_BILL a 
		left join J_SUB_SELL_REC b on a.BILL_SN=b.SELL_BILL_SN
		where 1 = 1
		<isNotEmpty prepend=" and " property="map.fxth">
		    b.status=#map.fxth:DECIMAL# and not exists (select jb.bill_sn from J_BILL jb where jb.bill_type=42 and a.bill_sn=jb.r_bill_sn)
		</isNotEmpty>
		<include refid="sf-jBill" />
		<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by a.ADD_DATE desc,a.BIll_ID desc</isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		<isNotEmpty prepend=" and " property="map.partner_name_like">PARTNER_NAME like '%' || #map.partner_name_like:VARCHAR# || '%' </isNotEmpty>
	</select>
	
	<select id="selectSeqJBillId" resultClass="long" cacheModel="oneDayCache">
		select SEQ_J_BILL_ID.nextval as count from dual
	</select>

	<insert id="insertJBill" parameterClass="jBill">
		<selectKey resultClass="long" keyProperty="bill_id">select SEQ_J_BASE.nextval as bill_id from dual </selectKey>
		<![CDATA[insert into J_BILL (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="bill_id">BILL_ID</isNotNull>	
			<isNotNull prepend="," property="bill_type">BILL_TYPE</isNotNull>	
			<isNotNull prepend="," property="bill_sn">BILL_SN</isNotNull>	
			<isNotNull prepend="," property="bill_memo">BILL_MEMO</isNotNull>	
			<isNotNull prepend="," property="partner_id">PARTNER_ID</isNotNull>	
			<isNotNull prepend="," property="rec_money">REC_MONEY</isNotNull>
			<isNotNull prepend="," property="sum_money">SUM_MONEY</isNotNull>
			<isNotNull prepend="," property="dis_money">DIS_MONEY</isNotNull>	
			<isNotNull prepend="," property="discount">DISCOUNT</isNotNull>	
			<isNotNull prepend="," property="money">MONEY</isNotNull>	
			<isNotNull prepend="," property="opr_date">OPR_DATE</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="c_id">C_ID</isNotNull>
			<isNotNull prepend="," property="r_bill_sn">R_BILL_SN</isNotNull>
			<isNotNull prepend="," property="bills_title">BILLS_TITLE</isNotNull>	
			<isNotNull prepend="," property="bills_sumary">BILLS_SUMARY</isNotNull>	
			<isNotNull prepend="," property="plan_hand_time">PLAN_HAND_TIME</isNotNull>	
			<isNotNull prepend="," property="send_type">SEND_TYPE</isNotNull>	
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="bill_state">BILL_STATE</isNotNull>	
			<isNotNull prepend="," property="xs_id">XS_ID</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="bill_id">#bill_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_type">#bill_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_sn">#bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bill_memo">#bill_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="partner_id">#partner_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rec_money">#rec_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sum_money">#sum_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dis_money">#dis_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="discount">#discount:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">#money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="opr_date">#opr_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="c_id">#c_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r_bill_sn">#r_bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bills_title">#bills_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bills_sumary">#bills_sumary:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="plan_hand_time">#plan_hand_time:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="send_type">#send_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">#add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_state">#bill_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="xs_id">#xs_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateJBill" parameterClass="JBill">
		update J_BILL
		<dynamic prepend="set">
			<isNotNull prepend="," property="bill_id">BILL_ID = #bill_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_type">BILL_TYPE = #bill_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_sn">BILL_SN = #bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bill_memo">BILL_MEMO = #bill_memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="partner_id">PARTNER_ID = #partner_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rec_money">REC_MONEY = #rec_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sum_money">SUM_MONEY = #sum_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dis_money">DIS_MONEY = #dis_money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="discount">DISCOUNT = #discount:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="money">MONEY = #money:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="opr_date">OPR_DATE = #opr_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="c_id">C_ID = #c_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r_bill_sn">R_BILL_SN = #r_bill_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bills_title">BILLS_TITLE = #bills_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bills_sumary">BILLS_SUMARY = #bills_sumary:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="plan_hand_time">PLAN_HAND_TIME = #plan_hand_time:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="send_type">SEND_TYPE = #send_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_state">BILL_STATE = #bill_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="xs_id">XS_ID = #xs_id:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="bill_id">BILL_ID = #bill_id#</isNotEmpty>
		<isEmpty prepend=" " property="bill_id">
			<isNotEmpty prepend=" " property="map.pks">
				BILL_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteJBill" parameterClass="JBill">
		delete from J_BILL where
		<isNotEmpty prepend=" " property="bill_id">BILL_ID = #bill_id#</isNotEmpty>
		<isEmpty prepend=" " property="bill_id">
			<isNotEmpty prepend=" " property="map.pks">
				BILL_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
	
	<!-- 客户端-分销查询统计数量 -->
	<select id="selectKHJBillCount" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		select count(*) from J_BILL a 
		left join (select * from j_base_partner where PARTNER_TYPE=1 and PARTNER_OBJ=1) b on a.partner_id=b.partner_id
		left join J_SUB_SELL_REC c on a.BILL_SN=c.SELL_BILL_SN
		where a.BILL_TYPE in (40,42) 
		<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.OPR_DATE >= to_date(#map.opr_date_gt# || '00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.OPR_DATE <= to_date(#map.opr_date_lt# || '23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.partner_name_like">b.partner_name like '%'||#map.partner_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.partner_sn_like">upper(b.partner_sn) like '%'||upper(#map.partner_sn_like#)||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.link_name_like">b.link_name like '%'||#map.link_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.wd_state">c.STATUS = #map.wd_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cust_id">a.c_id = #map.cust_id#</isNotEmpty>
	</select>
	
	<!-- 客户端-分销查询列表 -->
	<select id="selectKHJbillList" resultMap="khJBillForListPrint" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.partner_name,b.partner_sn,b.link_name,(select sum(num) from J_BILL_DETAILS t where t.bill_id=a.bill_id) total_num,
		c.STATUS
		from J_BILL a 
		left join (select * from j_base_partner where PARTNER_TYPE=1 and PARTNER_OBJ=1) b on a.partner_id=b.partner_id
		left join J_SUB_SELL_REC c on a.BILL_SN=c.SELL_BILL_SN
		where a.BILL_TYPE in (40,42) 
		<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.ADD_DATE >= to_date(#map.opr_date_gt# || '00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.ADD_DATE <= to_date(#map.opr_date_lt# || '23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.partner_name_like">b.partner_name like '%'||#map.partner_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.partner_sn_like">upper(b.partner_sn) like '%'||upper(#map.partner_sn_like#)||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.link_name_like">b.link_name like '%'||#map.link_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.wd_state">c.STATUS = #map.wd_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cust_id">a.c_id = #map.cust_id#</isNotEmpty>
		<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by a.ADD_DATE desc,a.BIll_ID desc</isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<!-- 客户端-销售管理首页 任务完成率等查询   add by Liang Houen on 2015-07-17 -->
	<select id="selectInfoForSales" resultClass="java.util.HashMap" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[select 
			nvl((select YEAR_TOTAL from KONKA_R3_TARGET where c_id=#c_id# and SALE_YEAR=to_char(sysdate,'yyyy')),0) target_year,
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (40,20) and c_id=#c_id# and to_char(OPR_DATE,'yyyy')=to_char(sysdate,'yyyy'))+
			(select nvl(sum(ALL_PRICE),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy')=to_char(sysdate,'yyyy'))+
			(select nvl(sum(b.TOTAL_MONEY),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy')=to_char(sysdate,'yyyy') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (42,21) and c_id=#c_id# and to_char(OPR_DATE,'yyyy')=to_char(sysdate,'yyyy')) sales_year,
			nvl((select (case when (to_char(sysdate,'mm')='01') then JAN when (to_char(sysdate,'mm')='02') then FEB when (to_char(sysdate,'mm')='03') then MAR
 			when (to_char(sysdate,'mm')='04') then APR when (to_char(sysdate,'mm')='05') then MAY when (to_char(sysdate,'mm')='06') then JUNE
  			when (to_char(sysdate,'mm')='07') then JULY when (to_char(sysdate,'mm')='08') then AUG when (to_char(sysdate,'mm')='09') then SEPT
  			when (to_char(sysdate,'mm')='10') then OCT when (to_char(sysdate,'mm')='11') then NOV when (to_char(sysdate,'mm')='12') then DECE END) from KONKA_R3_TARGET where c_id=#c_id# and SALE_YEAR=to_char(sysdate,'yyyy')),0) target_month,
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (40,20) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm'))+
			(select nvl(sum(ALL_PRICE),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm'))+
			(select nvl(sum(b.TOTAL_MONEY),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (42,21) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm')) sales_month,
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (40,20) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd'))+
			(select nvl(sum(ALL_PRICE),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd'))+
			(select nvl(sum(b.TOTAL_MONEY),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (42,21) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd')) sales_money_yesterday,
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type in (40,20) and b.c_id=#c_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd'))+
			(select nvl(sum(NUM),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd'))+
			(select nvl(sum(a.COUNTS),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type in (42,21) and b.c_id=#c_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate-1,'yyyy-mm-dd')) sales_num_yesterday,
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (40,20) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))+
			(select nvl(sum(ALL_PRICE),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))+
			(select nvl(sum(b.TOTAL_MONEY),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type in (42,21) and c_id=#c_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd')) sales_money_today,
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type in (40,20) and b.c_id=#c_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))+
			(select nvl(sum(NUM),0) from KONKA_MOBILE_SAIL_DATA where is_del=0 and CUSTOMER_R3_CODE=#map.r3_code# and to_char(SALE_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))+
			(select nvl(sum(a.COUNTS),0) from KONKA_XX_SELL_BILL_DETAILS a left join KONKA_XX_SELL_BILL b on a.SELL_BILL_ID=b.SELL_BILL_ID
                 left join KONKA_XX_ZMD c on b.ZMD_ID=c.ZMD_ID where c.R3_ID=#map.r3_code# and to_char(b.SELL_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd') and b.SELL_STATE=20 and b.order_type=1)-
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type in (42,21) and b.c_id=#c_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd')) sales_num_today
			from dual]]>
	</select>
	
	
	<!-- 客户端-销售管理首页月日度数据查询  add by Liang Houen on 2015-07-17 -->
	<parameterMap class="java.util.HashMap" id="cursorMap">
		<parameter property="I_C_ID" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_R3_CODE" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_YEAR" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_MONTH" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	</parameterMap>
	<procedure id="selectSaleInfoByDate" parameterMap="cursorMap" resultClass="java.util.HashMap">
		{call SELECT_SALE_FOR_MONTH(?,?,?,?)}
	</procedure>
	
	<!-- 客户端-销售管理首页月机型销售列表数据查询  add by Liang Houen on 2015-07-21 -->
	<parameterMap class="java.util.HashMap" id="cursorMap">
		<parameter property="I_C_ID" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_R3_CODE" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_YEAR" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_MONTH" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	</parameterMap>
	<procedure id="selectSaleForMonthList" parameterMap="cursorMap" resultClass="java.util.HashMap">
		{call SELECT_SALE_MD_FOR_MONTH(?,?,?,?)}
	</procedure>
	
	
	<!-- 客户端-进货管理首页当年，当月，当日进货数据查询 -->
	<select id="selectBuyInfo" resultClass="java.util.HashMap" parameterClass="java.util.HashMap" cacheModel="oneDayCache">
	    <![CDATA[select
			(SELECT nvl(sum(MONEY-GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy') = to_char(sysdate,'yyyy') and DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(MONEY-GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy') = to_char(sysdate,'yyyy') and DOC_TYPE='ZFRE')+
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=10 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy')=to_char(sysdate,'yyyy'))-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=11 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy')=to_char(sysdate,'yyyy')) year_money,
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy') = to_char(sysdate,'yyyy') and DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy') = to_char(sysdate,'yyyy') and DOC_TYPE='ZFRE')+
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=10 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy')=to_char(sysdate,'yyyy'))-
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=11 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy')=to_char(sysdate,'yyyy')) year_num,
			(SELECT nvl(sum(b.GOOD_SUM_PRICE-b.GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO a LEFT JOIN konka_order_info_details b On a.id = b.order_id
        		WHERE a.IS_DEL = 0 AND a.IS_SUBMIT = 1 AND a.CUST_ID = #r3_id#
        		AND a.AUDIT_STATE = 3 AND to_char(a.ORDER_DATE,'yyyy-mm') = to_char(sysdate,'yyyy-mm') and a.DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(b.GOOD_SUM_PRICE-b.GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO a LEFT JOIN konka_order_info_details b ON a.id = b.order_id
        		WHERE a.IS_DEL = 0 AND a.IS_SUBMIT = 1 AND a.CUST_ID = #r3_id#
        		AND a.AUDIT_STATE = 3 AND to_char(a.ORDER_DATE,'yyyy-mm') = to_char(sysdate,'yyyy-mm') and a.DOC_TYPE='ZFRE')+
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=10 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm'))-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=11 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm')) month_money,
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm') = to_char(sysdate,'yyyy-mm') and DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm') = to_char(sysdate,'yyyy-mm') and DOC_TYPE='ZFRE')+
		    (select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=10 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm'))-
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=11 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy-mm')=to_char(sysdate,'yyyy-mm')) month_num,
			(SELECT nvl(sum(MONEY-GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd') and DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(MONEY-GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd') and DOC_TYPE='ZFRE')+
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=10 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))-
			(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=11 and c_id=#r3_id# and to_char(OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd')) today_money,
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd') and DOC_TYPE<>'ZFRE')-
			(SELECT nvl(sum(ORDER_NUM),0) FROM KONKA_ORDER_INFO
				WHERE IS_DEL = 0 AND IS_SUBMIT = 1 AND CUST_ID = #r3_id#
				AND AUDIT_STATE = 3 AND to_char(ORDER_DATE,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd') and DOC_TYPE='ZFRE')+
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=10 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd'))-
			(select nvl(sum(NUM),0) from j_bill_details a left join j_bill b on a.bill_id=b.bill_id where BILL_STATE=1 and b.bill_type=11 and b.c_id=#r3_id# and to_char(b.OPR_DATE,'yyyy-mm-dd')=to_char(sysdate,'yyyy-mm-dd')) today_num
			from dual]]>
	</select>
	
	<!-- 获取指定年月的进货金额 -->
	<select id="selectMonthMoney" resultClass="java.lang.String" parameterClass="java.util.HashMap" cacheModel="oneDayCache">
	    <![CDATA[select
	    (SELECT nvl(sum(b.GOOD_SUM_PRICE-b.GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO a LEFT JOIN konka_order_info_details b On a.id = b.order_id
        		WHERE a.IS_DEL = 0 AND a.IS_SUBMIT = 1 AND a.CUST_ID = #r3_id#
        		AND a.AUDIT_STATE = 3 AND to_char(a.ORDER_DATE,'yyyy-mm') = #year#||'-'||#month# and a.DOC_TYPE<>'ZFRE')-
		(SELECT nvl(sum(b.GOOD_SUM_PRICE-b.GOOD_DISCOUNT_PRICE),0) FROM KONKA_ORDER_INFO a LEFT JOIN konka_order_info_details b ON a.id = b.order_id
        		WHERE a.IS_DEL = 0 AND a.IS_SUBMIT = 1 AND a.CUST_ID = #r3_id#
        		AND a.AUDIT_STATE = 3 AND to_char(a.ORDER_DATE,'yyyy-mm') = #year#||'-'||#month# and a.DOC_TYPE='ZFRE')+
		(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=10 and c_id=#r3_id#
			and to_char(OPR_DATE,'yyyy-mm')=#year#||'-'||#month#)-
		(select nvl(sum(MONEY),0) from j_bill where BILL_STATE=1 and bill_type=11 and c_id=#r3_id#
			and to_char(OPR_DATE,'yyyy-mm')=#year#||'-'||#month#)
    	from dual]]>
	</select>
	
	<!-- 客户端-进货管理月机型统计  add by Liang Houen on 2015-07-22 -->
	<parameterMap class="java.util.HashMap" id="cursorMap">
		<parameter property="I_C_ID" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_R3_CODE" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_YEAR" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="I_MONTH" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	</parameterMap>
	<procedure id="selectMonthInDataList" parameterMap="cursorMap" resultClass="java.util.HashMap">
		{call SELECT_IN_FOR_MONTH(?,?,?,?)}
	</procedure>

	<!-- 客户端-进货查询统计数量 -->
	<select id="selectOtherSaleDataCount" resultClass="long" parameterClass="jBill" cacheModel="oneDayCache">
		select count(*) from J_BILL a
		left join (select * from j_base_partner where PARTNER_TYPE=0) b on a.partner_id=b.partner_id
		left join J_SUB_SELL_REC c on a.BILL_SN=c.SELL_BILL_SN
		where a.BILL_TYPE in (10,11)
		<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.OPR_DATE >= to_date(#map.opr_date_gt# || ' 00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.OPR_DATE <= to_date(#map.opr_date_lt# || ' 23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_name_like">b.partner_name like '%'||#map.p_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_id_like">upper(b.partner_sn) like '%'||upper(#map.p_id_like#)||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cust_id">a.c_id = #map.cust_id#</isNotEmpty>
	</select>

	<!-- 客户端-进货查询列表 -->
	<select id="selectOtherSaleDataList" resultClass="java.util.HashMap" parameterClass="jBill" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.partner_name,b.partner_sn,b.link_name,(select sum(num) from J_BILL_DETAILS t where t.bill_id=a.bill_id) total_num,
		c.STATUS
		from J_BILL a
		left join (select * from j_base_partner where PARTNER_TYPE=0) b on a.partner_id=b.partner_id
		left join J_SUB_SELL_REC c on a.BILL_SN=c.SELL_BILL_SN
		where a.BILL_TYPE in (10,11)
		<isNotEmpty prepend=" and " property="map.opr_date_gt"><![CDATA[ a.OPR_DATE >= to_date(#map.opr_date_gt# || ' 00:00:00','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.opr_date_lt"><![CDATA[ a.OPR_DATE <= to_date(#map.opr_date_lt# || ' 23:59:59','yyyy-mm-dd hh24:mi:ss' ) ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.bill_sn_like">upper(a.BILL_SN) like '%' || upper(#map.bill_sn_like:VARCHAR#) || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_type">a.BILL_TYPE = #bill_type#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_name_like">b.partner_name like '%'||#map.p_name_like#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.p_id_like">upper(b.partner_sn) like '%'||upper(#map.p_id_like#)||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_state">a.bill_state=#bill_state#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cust_id">a.c_id = #map.cust_id#</isNotEmpty>
		<isNotEmpty prepend=" " property="map.order_by_opt_desc"> order by a.ADD_DATE desc,a.BIll_ID desc</isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
</sqlMap>