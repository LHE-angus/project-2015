<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_DEPT">

	<typeAlias alias="konkaDept" type="com.ebiz.mmt.domain.KonkaDept" />

	

	<resultMap id="konkaDeptResultForList" class="konkaDept">
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="DEPT_SN" property="dept_sn" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="dept_name" jdbcType="VARCHAR" />
		<result column="PAR_ID" property="par_id" jdbcType="DECIMAL" />
		<result column="PD_ID" property="pd_id" jdbcType="DECIMAL" />
		<result column="DEPT_DESC" property="dept_desc" jdbcType="VARCHAR" />
		<result column="DEPT_TYPE" property="dept_type" jdbcType="DECIMAL" />
		<result column="P_AREA" property="p_area" jdbcType="DECIMAL" />
		<result column="P_INDEX" property="p_index" jdbcType="DECIMAL" />
		<result column="P_NAME" property="p_name" jdbcType="VARCHAR" />
		<result column="LEADER_USER_ID" property="leader_user_id" jdbcType="DECIMAL" />
		<result column="M_AREAS_IDS" property="m_areas_ids" jdbcType="VARCHAR" />
		<result column="M_AREAS_NAMES" property="m_areas_names" jdbcType="VARCHAR" />
		<result column="ORDER_VALUE" property="order_value" jdbcType="DECIMAL" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATETIME" />
	</resultMap>
	
	<resultMap id="konkaDeptResultWithTreeNameAndFullName" class="konkaDept" extends="konkaDeptResultForList">
		<result column="ADD_USER_NAME" property="map.add_user_name" jdbcType="VARCHAR" />
		<result column="TREE_NAME" property="map.tree_name" jdbcType="VARCHAR" />
		<result column="FULL_NAME" property="map.full_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="konkaDeptTreeNameByUserForResultCount" class="konkaDept">
	   <result column="DEPT_COUNT" property="map.dept_cout" jdbcType="DECIMAL" />
	</resultMap>
	
	<resultMap id="konkaDeptResult" class="konkaDept" extends="konkaDeptResultForList">
	</resultMap>

	<sql id="sf-konkaDept">
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_sn">DEPT_SN = #dept_sn:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="par_id">PAR_ID = #par_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_desc">DEPT_DESC = #dept_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_type">DEPT_TYPE = #dept_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_area">P_AREA = #p_area:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_index">P_INDEX = #p_index:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="p_name">P_NAME = #p_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="leader_user_id">LEADER_USER_ID = #leader_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="m_areas_ids">M_AREAS_IDS = #m_areas_ids:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="m_areas_names">M_AREAS_NAMES = #m_areas_names:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.de_type">DEPT_TYPE &lt; #map.de_type# </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_not_in">DEPT_ID not in ($map.dept_not_in$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.not_konka"><![CDATA[DEPT_ID <> #map.not_konka#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_see">DEPT_ID &gt; #map.dept_see#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_name_like">DEPT_NAME like '%' || #map.dept_name_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_ids">DEPT_ID in($map.dept_ids$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_types">DEPT_TYPE in($map.dept_types$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_id_for_fgs">
		par_id = 0
		 start with dept_id = #map.dept_id_for_fgs#
		connect by prior par_id = dept_id
		</isNotEmpty>
		<!--根据订单id，找对应的分公司id		-->
		<isNotEmpty prepend=" and " property="map.order_id_for_fgs">
			 dept_id =(
				select ba.fgs_id
				  from BRANCH_ASSIGN ba
				 where 1 = 1
				   and ba.branch_type = 1
				   and ba.konka_r3_id in (select krmm.r3_shop_id
				                            from konka_r3_mmt_match krmm
				                           where 1 = 1
				                             and krmm.mmt_shop_id = (select koi.shop_id
				                                                       from konka_order_info koi
				                                                      where 1 = 1
				                                                        and koi.id = #map.order_id_for_fgs#
				                                                     )
						                     union
		                                     select koi.cust_id
		                                    from konka_order_info koi
		                                   where 1 = 1
		                                     and koi.id = #map.order_id_for_fgs#
				                          )
		    )
		    or dept_id =(
				select ba.fgs_id
				  from BRANCH_ASSIGN ba
				 where 1 = 1
				   and ba.branch_type = 1
				   and ba.konka_r3_id in (
						   select t2.konka_r3_id
						  from konka_branch_category t2
						 where 1 = 1
						   and t2.category_id = 20
						   and t2.mmt_shop_id =
						       (select koi.shop_id
						          from konka_order_info koi
						         where 1 = 1
						           and koi.id = #map.order_id_for_fgs#)
						    union
                                     select koi.cust_id
                                    from konka_order_info koi
                                   where 1 = 1
                                     and koi.id = #map.order_id_for_fgs#      
						     
				   )
		    )
					 
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.jyb">
		par_id >1
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.letter_name_a">
			<isNotEmpty prepend=" " property="map.letter_name_b">
				dept_name is not null and F_TRANS_PINYIN_CAPITAL(substr(dept_name, 0, 1)) between #map.letter_name_a# and #map.letter_name_b#
			</isNotEmpty>
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.dept_id_gt">DEPT_ID &gt; #map.dept_id_gt#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.xxqd"><![CDATA[DEPT_ID > #map.xxqd#]]></isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.is_fgs"><![CDATA[DEPT_ID < 100]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_sn_not_null">DEPT_SN is not null</isNotEmpty>
	</sql>

	<select id="selectKonkaDept" resultMap="konkaDeptResult" parameterClass="konkaDept" >
		select * from KONKA_DEPT where 1 = 1
		<include refid="sf-konkaDept" />
	</select>

	<select id="selectKonkaDeptList" resultMap="konkaDeptResultForList" parameterClass="konkaDept" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_DEPT where 1 = 1
		<isNotEmpty prepend="and " property="map.is_jingban">dept_type in (4,5)</isNotEmpty>
		<include refid="sf-konkaDept" />
		<isNotEmpty prepend=" " property="map.order_by_dept_name">order by DEPT_NAME asc,DEPT_ID asc</isNotEmpty>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaDeptCount" resultClass="long" parameterClass="konkaDept" >
		select count(*) from KONKA_DEPT where 1 = 1
		<include refid="sf-konkaDept" />
	</select>

	<select id="selectKonkaDeptPaginatedList" resultMap="konkaDeptResult" parameterClass="konkaDept" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_DEPT where 1 = 1
		<include refid="sf-konkaDept" />
		order by DEPT_ID asc 
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectKonkaDeptListWithTreeNameAndFullName" resultMap="konkaDeptResultWithTreeNameAndFullName" parameterClass="konkaDept" >
		select * from (select t.*,
	           LPAD('　|-', (level - 1) * 4, '　| ') || LPAD('『', 2) || t.dept_name || RPAD('』', 2) TREE_NAME,
	           sys_connect_by_path(t.dept_name, '>>') FULL_NAME,
	           b.USER_NAME ADD_USER_NAME
	      from KONKA_DEPT t
	      left join KONKA_PE_PROD_USER b on t.add_user_id = b.id
	     start with t.PAR_ID = 0
	    connect by prior t.DEPT_ID = t.par_id)
		where 1 = 1
		<include refid="sf-konkaDept" />
	</select>
	
	<!-- 由部门ID查部门名称  @author Zheng,Kun , @version：2011-09-05 -->
	<select id="selectKonkaDeptByDeptId" resultMap="konkaDeptResult" parameterClass="konkaDept" >
		select * from KONKA_DEPT t  where 1 = 1
			<isNotEmpty prepend=" and " property="dept_type">DEPT_TYPE = #dept_type:DECIMAL#</isNotEmpty>
		     start with dept_id =#dept_id#  connect by prior t.par_id = t.dept_id order by t.dept_id 
	</select>
	
	<!-- 由部门ID查上级部门名称  @author Wang,Yang , @version：2011-10-10 -->
	<!-- 增加判断条件，查询所属事业部的功能  @author Hui,Gang , @version：2011-11-10 -->
	<select id="selectKonkaDeptSuperiorByDeptId" resultMap="konkaDeptResult" parameterClass="konkaDept" >
		select * from (
			select * from KONKA_DEPT t where 1 = 1
				<isNotEmpty prepend=" and " property="map.dept_type_eq">
				t.dept_type = #map.dept_type_eq# and t.dept_id != 0
				</isNotEmpty>
			     start with dept_id =#dept_id#  connect by prior t.par_id = t.dept_id order by t.dept_id
		 ) t 
		<isNotEmpty prepend=" where " property="map.par_id"> t.par_id=#map.par_id# </isNotEmpty>
	</select>
	
	<select id="selectKonkaDeptTreeNameByUserForResultCount" resultMap="konkaDeptTreeNameByUserForResultCount" parameterClass="konkaDept" >
		select count(*) as DEPT_COUNT
		  from konka_dept
		 where dept_id in
		       (select dept_id
		          from konka_dept
		         start with dept_id = #map.dept_id#
		        connect by prior par_id = dept_id
		        union
		        select dept_id 
		          from konka_dept
		         start with dept_id = #map.dept_id#
		       connect by prior dept_id = par_id)
		 	<isNotEmpty prepend=" and " property="map.pks">
				DEPT_TYPE in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.dept_types_Y">
			     DEPT_TYPE in ($map.dept_types_Y$)
		     </isNotEmpty>
			<isNotEmpty prepend=" and " property="map.dept_types_N">
			     DEPT_TYPE not in ($map.dept_types_N$)
		     </isNotEmpty>	
		    <isNotEmpty prepend=" and " property="map.dept_name_like">DEPT_NAME like '%' || #map.dept_name_like# || '%'</isNotEmpty>
		    order by dept_type,par_id
	</select>
	
	<!-- 康佳买卖提部门查看权限控制 RenZhong 2011-09-02 BEGIN -->
	<select id="selectKonkaDeptTreeNameByUserForResultList" resultMap="konkaDeptResultForList" parameterClass="konkaDept" >
		<isNotEmpty prepend=" " property="map.pager_true">
		  <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		</isNotEmpty>
		select *
		  from konka_dept
		 where dept_id in
		       (select dept_id
		          from konka_dept
		         start with dept_id = #map.dept_id#
		        connect by prior par_id = dept_id
		        union
		        select dept_id 
		          from konka_dept
		         start with dept_id = #map.dept_id#
		       connect by prior dept_id = par_id)
		 	<isNotEmpty prepend=" and " property="map.pks">
				DEPT_TYPE in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.dept_types_Y">
			     DEPT_TYPE in ($map.dept_types_Y$)
		     </isNotEmpty>
			<isNotEmpty prepend=" and " property="map.dept_types_N">
			     DEPT_TYPE not in ($map.dept_types_N$)
		     </isNotEmpty>		
		    <isNotEmpty prepend=" and " property="map.dept_name_like">DEPT_NAME like '%' || #map.dept_name_like# || '%'</isNotEmpty>
		     order by dept_type,par_id,dept_id
		   <isNotEmpty prepend=" " property="map.pager_true">
		     <![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
		   </isNotEmpty>
	</select>
	<!-- 康佳买卖提部门查看权限控制 RenZhong 2011-09-02 END -->

	<insert id="insertKonkaDept" parameterClass="konkaDept">
		<selectKey resultClass="long" keyProperty="dept_id">select KSMS_DETAILS_SEQ.nextval as dept_id from dual </selectKey>
		<![CDATA[insert into KONKA_DEPT (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="dept_sn">DEPT_SN</isNotNull>	
			<isNotNull prepend="," property="dept_name">DEPT_NAME</isNotNull>	
			<isNotNull prepend="," property="par_id">PAR_ID</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID</isNotNull>		
			<isNotNull prepend="," property="dept_desc">DEPT_DESC</isNotNull>	
			<isNotNull prepend="," property="dept_type">DEPT_TYPE</isNotNull>	
			<isNotNull prepend="," property="p_area">P_AREA</isNotNull>	
			<isNotNull prepend="," property="p_index">P_INDEX</isNotNull>	
			<isNotNull prepend="," property="p_name">P_NAME</isNotNull>	
			<isNotNull prepend="," property="leader_user_id">LEADER_USER_ID</isNotNull>	
			<isNotNull prepend="," property="m_areas_ids">M_AREAS_IDS</isNotNull>
			<isNotNull prepend="," property="m_areas_names">M_AREAS_NAMES</isNotNull>	
			<isNotNull prepend="," property="order_value">ORDER_VALUE</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_sn">#dept_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_name">#dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="par_id">#par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">#pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_desc">#dept_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_type">#dept_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_area">#p_area:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_index">#p_index:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_name">#p_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="leader_user_id">#leader_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="m_areas_ids">#m_areas_ids:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="m_areas_names">#m_areas_names:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="order_value">#order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:DATETIME#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaDept" parameterClass="KonkaDept">
		update KONKA_DEPT
		<dynamic prepend="set">
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_sn">DEPT_SN = #dept_sn:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_name">DEPT_NAME = #dept_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="par_id">PAR_ID = #par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_desc">DEPT_DESC = #dept_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_type">DEPT_TYPE = #dept_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_area">P_AREA = #p_area:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_index">P_INDEX = #p_index:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="p_name">P_NAME = #p_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="leader_user_id">LEADER_USER_ID = #leader_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="m_areas_ids">M_AREAS_IDS = #m_areas_ids:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="m_areas_names">M_AREAS_NAMES = #m_areas_names:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:DATETIME#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="dept_id">DEPT_ID = #dept_id#</isNotEmpty>
		<isEmpty prepend=" " property="dept_id">
			<isNotEmpty prepend=" " property="map.pks">
				DEPT_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaDept" parameterClass="KonkaDept">
		delete from KONKA_DEPT where
		<isNotEmpty prepend=" " property="dept_id">DEPT_ID = #dept_id#</isNotEmpty>
		<isEmpty prepend=" " property="dept_id">
			<isNotEmpty prepend=" " property="map.pks">
				DEPT_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
    <!--  -->
	<select id="selectKonkaDeptListWithTreeNameForProdUser" resultMap="konkaDeptResultWithTreeNameAndFullName" parameterClass="konkaDept" >
        SELECT *
          FROM
              (SELECT t.*,LPAD('|-', (level - 1) * 4, '　| ')
                         || LPAD('『', 2) || t.dept_name || RPAD('』', 2) TREE_NAME,
                      sys_connect_by_path(t.dept_name, '>>') FULL_NAME,
                      b.USER_NAME AS ADD_USER_NAME
                FROM KONKA_DEPT t
                LEFT JOIN KONKA_PE_PROD_USER b
                ON t.add_user_id = b.id
                <isNull prepend=" " property="map.dept_id">START WITH t.PAR_ID = 0</isNull>
                <isNotNull prepend=" " property="map.dept_id">START WITH t.DEPT_ID = #map.dept_id:DECIMAL#</isNotNull>
                CONNECT BY prior t.DEPT_ID = t.par_id
               )
        WHERE 1  = 1
        <include refid="sf-konkaDept" />
	</select>
	<select id="selectKonkaDeptListWithParTreeName" resultMap="konkaDeptResultWithTreeNameAndFullName" parameterClass="konkaDept" >
        SELECT *
          FROM
              (SELECT t.*,LPAD('|-', (level - 1) * 4, '　| ')
                         || LPAD('『', 2) || t.dept_name || RPAD('』', 2) TREE_NAME,
                      sys_connect_by_path(t.dept_name, '>>') FULL_NAME,
                      b.USER_NAME AS ADD_USER_NAME
                FROM KONKA_DEPT t
                LEFT JOIN KONKA_PE_PROD_USER b
                ON t.add_user_id = b.id
                <isNull prepend=" " property="map.dept_id">START WITH t.PAR_ID = 0</isNull>
                <isNotNull prepend=" " property="map.dept_id">START WITH t.DEPT_ID = #map.dept_id:DECIMAL#</isNotNull>
                CONNECT BY prior t.par_id = t.DEPT_ID 
               )
        WHERE 1  = 1
        <include refid="sf-konkaDept" />
	</select>

</sqlMap>