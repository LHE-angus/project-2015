<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="J_STOCKS_STACK">

	<typeAlias alias="jStocksStack" type="com.ebiz.mmt.domain.JStocksStack" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertJStocksStack" />
		<flushOnExecute statement="updateJStocksStack" />
		<flushOnExecute statement="deleteJStocksStack" />
	</cacheModel>

	<resultMap id="jStocksStackResultForList" class="jStocksStack">
		<result column="STACK_ID" property="stack_id" jdbcType="DECIMAL" />
		<result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
		<result column="GOODS_ID" property="goods_id" jdbcType="DECIMAL" />
		<result column="GOODS_COST" property="goods_cost" jdbcType="DECIMAL" />
		<result column="BILL_ID_POP" property="bill_id_pop" jdbcType="VARCHAR" />
		<result column="BILL_ID_PUSH" property="bill_id_push" jdbcType="VARCHAR" />
		<result column="STATUS" property="status" jdbcType="DECIMAL" />
		<result column="C_ID" property="c_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="jStocksStackResult" class="jStocksStack" extends="jStocksStackResultForList">
	</resultMap>

	<sql id="sf-jStocksStack">
		<isNotEmpty prepend=" and " property="stack_id">STACK_ID = #stack_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="store_id">STORE_ID = #store_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="goods_id">GOODS_ID = #goods_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="goods_cost">GOODS_COST = #goods_cost:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_id_pop">BILL_ID_POP = #bill_id_pop:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bill_id_push">BILL_ID_PUSH = #bill_id_push:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="status">STATUS = #status:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="c_id">C_ID = #c_id:DECIMAL#</isNotEmpty>
	</sql>

	<select id="selectJStocksStack" resultMap="jStocksStackResult" parameterClass="jStocksStack" cacheModel="oneDayCache">
		select * from J_STOCKS_STACK where 1 = 1
		<include refid="sf-jStocksStack" />
	</select>

	<select id="selectJStocksStackList" resultMap="jStocksStackResultForList" parameterClass="jStocksStack" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from J_STOCKS_STACK where 1 = 1
		<include refid="sf-jStocksStack" />
		<!-- order by ID asc -->
		<isNotEmpty prepend=" " property="map.order_by_stack_id_asc">order by STACK_ID asc</isNotEmpty>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectJStocksStackCount" resultClass="long" parameterClass="jStocksStack" cacheModel="oneDayCache">
		select count(*) from J_STOCKS_STACK where 1 = 1
		<include refid="sf-jStocksStack" />
	</select>

	<select id="selectJStocksStackPaginatedList" resultMap="jStocksStackResult" parameterClass="jStocksStack" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from J_STOCKS_STACK where 1 = 1
		<include refid="sf-jStocksStack" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<!-- 实时库存模块，Ren zhong，2013-06-20 -->
	<resultMap id="jStocksStackForSskcResult" class="jStocksStack">
		<result column="STORE_ID" property="store_id" jdbcType="DECIMAL" />
		<result column="GOODS_ID" property="goods_id" jdbcType="DECIMAL" />
		<result column="GOODS_COST" property="goods_cost" jdbcType="DECIMAL" />
		<result column="NUM" property="map.num" jdbcType="DECIMAL"/>
	</resultMap>
	
	<select id="selectJStocksStackForSskcResultList" resultMap="jStocksStackForSskcResult" parameterClass="jStocksStack" cacheModel="oneDayCache">
		select store_id, goods_id, goods_cost, count(1) num
		  from j_stocks_stack
		 where 1 = 1
		 <include refid="sf-jStocksStack" />
		 group by store_id, goods_id, goods_cost
		 order by goods_cost asc
	</select>
	
	<insert id="insertJStocksStack" parameterClass="jStocksStack">
		<selectKey resultClass="long" keyProperty="stack_id">select SEQ_J_STACK_ID.nextval as stack_id from dual </selectKey>
		<![CDATA[insert into J_STOCKS_STACK (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="stack_id">STACK_ID</isNotNull>	
			<isNotNull prepend="," property="store_id">STORE_ID</isNotNull>	
			<isNotNull prepend="," property="goods_id">GOODS_ID</isNotNull>	
			<isNotNull prepend="," property="goods_cost">GOODS_COST</isNotNull>	
			<isNotNull prepend="," property="bill_id_pop">BILL_ID_POP</isNotNull>	
			<isNotNull prepend="," property="bill_id_push">BILL_ID_PUSH</isNotNull>	
			<isNotNull prepend="," property="status">STATUS</isNotNull>	
			<isNotNull prepend="," property="c_id">C_ID</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="stack_id">#stack_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_id">#store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_id">#goods_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_cost">#goods_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_id_pop">#bill_id_pop:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bill_id_push">#bill_id_push:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="status">#status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="c_id">#c_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateJStocksStack" parameterClass="JStocksStack">
		update J_STOCKS_STACK
		<dynamic prepend="set">
			<isNotNull prepend="," property="stack_id">STACK_ID = #stack_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="store_id">STORE_ID = #store_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_id">GOODS_ID = #goods_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="goods_cost">GOODS_COST = #goods_cost:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bill_id_pop">BILL_ID_POP = #bill_id_pop:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bill_id_push">BILL_ID_PUSH = #bill_id_push:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="status">STATUS = #status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="c_id">C_ID = #c_id:DECIMAL#</isNotNull>
			
			<isNotNull prepend="," property="map.bill_id_pop_set_null">BILL_ID_POP = null</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="stack_id">STACK_ID = #stack_id#</isNotEmpty>
		<isEmpty prepend=" " property="stack_id">
			<isNotEmpty prepend=" " property="map.pks">
				STACK_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>
	
	<update id="updateJStocksPopStack" parameterClass="JStocksStack">
		update J_STOCKS_STACK
		<dynamic prepend="set">
			<isNotNull prepend="," property="bill_id_pop">BILL_ID_POP = null</isNotNull>
			<isNotNull prepend="," property="status">STATUS = #status:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="stack_id">STACK_ID = #stack_id#</isNotEmpty>
		<isEmpty prepend=" " property="stack_id">
			<isNotEmpty prepend=" " property="bill_id_pop">BILL_ID_POP = #bill_id_pop#</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteJStocksStack" parameterClass="JStocksStack">
		delete from J_STOCKS_STACK where
		<isNotEmpty prepend=" " property="stack_id">STACK_ID = #stack_id#</isNotEmpty>
		<isEmpty prepend=" " property="stack_id">
			<isNotEmpty prepend=" " property="map.pks">
				STACK_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" " property="c_id">C_ID = #c_id#
				<isNotEmpty prepend=" and " property="bill_id_pop">BILL_ID_POP = #bill_id_pop#</isNotEmpty>
				<isNotEmpty prepend=" and " property="bill_id_push">BILL_ID_PUSH = #bill_id_push#</isNotEmpty>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>