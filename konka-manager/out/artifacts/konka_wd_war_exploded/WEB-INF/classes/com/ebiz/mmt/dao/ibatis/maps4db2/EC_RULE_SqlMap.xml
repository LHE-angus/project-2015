<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="EC_RULE">

	<typeAlias alias="ecRule" type="com.ebiz.mmt.domain.EcRule" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertEcRule" />
		<flushOnExecute statement="updateEcRule" />
		<flushOnExecute statement="deleteEcRule" />
	</cacheModel>

	<resultMap id="ecRuleResultForList" class="ecRule">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="RULE_TYPE" property="rule_type" jdbcType="DECIMAL" />
		<result column="RULE_TITLE" property="rule_title" jdbcType="VARCHAR" />
		<result column="RULE_MSG" property="rule_msg" jdbcType="VARCHAR" />
		<result column="RULE_PRICE" property="rule_price" jdbcType="DECIMAL" />
		<result column="RULE_NUM_MIN" property="rule_num_min" jdbcType="DECIMAL" />
		<result column="RULE_NUM_MAX" property="rule_num_max" jdbcType="DECIMAL" />
		<result column="RULE_AREA_LIMIT" property="rule_area_limit" jdbcType="VARCHAR" />
		<result column="RULE_AREA_ALLOW" property="rule_area_allow" jdbcType="VARCHAR" />
		<result column="IS_NUM" property="is_num" jdbcType="DECIMAL" />
		<result column="IS_AREA_LIMIT" property="is_area_limit" jdbcType="DECIMAL" />
		<result column="IS_AREA_ALLOW" property="is_area_allow" jdbcType="DECIMAL" />
		<result column="IS_PRICE" property="is_price" jdbcType="DECIMAL" />
		<result column="RULE_GOOODS" property="rule_gooods" jdbcType="VARCHAR" />
		<result column="RULE_START_DATE" property="rule_start_date" jdbcType="TIMESTAMP" />
		<result column="RULE_END_DATE" property="rule_end_date" jdbcType="TIMESTAMP" />
		<result column="MEMO" property="memo" jdbcType="VARCHAR" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="OWN_SYS" property="own_sys" jdbcType="DECIMAL" />
		<result column="INFO_STATE" property="info_state" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="ecRuleResult" class="ecRule" extends="ecRuleResultForList">
	</resultMap>

	<sql id="sf-ecRule">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_type">RULE_TYPE = #rule_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_title">RULE_TITLE = #rule_title:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_msg">RULE_MSG = #rule_msg:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_price">RULE_PRICE = #rule_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_num_min">RULE_NUM_MIN = #rule_num_min:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_num_max">RULE_NUM_MAX = #rule_num_max:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_area_limit">RULE_AREA_LIMIT = #rule_area_limit:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_area_allow">RULE_AREA_ALLOW = #rule_area_allow:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_num">IS_NUM = #is_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_area_limit">IS_AREA_LIMIT = #is_area_limit:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_area_allow">IS_AREA_ALLOW = #is_area_allow:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_price">IS_PRICE = #is_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_gooods">RULE_GOOODS = #rule_gooods:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_start_date">RULE_START_DATE = #rule_start_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_end_date">RULE_END_DATE = #rule_end_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="memo">MEMO = #memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="own_sys">OWN_SYS = #own_sys:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="info_state">INFO_STATE = #info_state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
	
		<isNotEmpty prepend=" and " property="map.rule_title_like">RULE_TITLE like '%'||#map.rule_title_like:VARCHAR#||'%'</isNotEmpty>
		 <isNotEmpty prepend=" and " property="map.id_not_in">
				ID not in <iterate close=")" open="(" conjunction="," property="map.id_not_in">#map.id_not_in[]#</iterate>
	   </isNotEmpty> 
	</sql>
	<sql id="sf-ecRule-t">
		<isNotEmpty prepend=" and " property="id">t.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_type">t.RULE_TYPE = #rule_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_title">t.RULE_TITLE = #rule_title:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_msg">t.RULE_MSG = #rule_msg:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_price">t.RULE_PRICE = #rule_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_num_min">t.RULE_NUM_MIN = #rule_num_min:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_num_max">t.RULE_NUM_MAX = #rule_num_max:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_area_limit">t.RULE_AREA_LIMIT = #rule_area_limit:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_area_allow">t.RULE_AREA_ALLOW = #rule_area_allow:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_num">t.IS_NUM = #is_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_area_limit">t.IS_AREA_LIMIT = #is_area_limit:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_area_allow">t.IS_AREA_ALLOW = #is_area_allow:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_price">t.IS_PRICE = #is_price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_gooods">t.RULE_GOOODS = #rule_gooods:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_start_date">t.RULE_START_DATE = #rule_start_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="rule_end_date">t.RULE_END_DATE = #rule_end_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="memo">t.MEMO = #memo:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">t.DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="own_sys">t.OWN_SYS = #own_sys:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="info_state">t.INFO_STATE = #info_state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">t.IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">t.ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">t.ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
	
		<isNotEmpty prepend=" and " property="map.rule_title_like">t.RULE_TITLE like '%'||#map.rule_title_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.id_not_in"> t.ID not in <iterate close=")" open="(" conjunction="," property="map.id_not_in">#map.id_not_in[]#</iterate> </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.pd_sn_like">
			((SELECT count (*) FROM EC_RULE_GOODS 
               WHERE RULE_ID = t.ID AND GOODS_ID IN (SELECT id FROM KONKA_BCOMP_PD 
                                         WHERE 1 = 1 and PD_SN LIKE '%'||#map.pd_sn_like:VARCHAR#||'%')) > 0)
		</isNotEmpty>	
	
	</sql>

	<select id="selectEcRule" resultMap="ecRuleResult" parameterClass="ecRule" cacheModel="oneDayCache">
		select * from EC_RULE t where 1 = 1
		<include refid="sf-ecRule" />
	</select>

	<select id="selectEcRuleList" resultMap="ecRuleResultForList" parameterClass="ecRule" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from EC_RULE t where 1 = 1
		<include refid="sf-ecRule" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectEcRuleCount" resultClass="long" parameterClass="ecRule" cacheModel="oneDayCache">
		select count(*) from EC_RULE t where 1 = 1
		<include refid="sf-ecRule-t" />
	</select>

	<select id="selectEcRulePaginatedList" resultMap="ecRuleResult" parameterClass="ecRule" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from EC_RULE t where 1 = 1
		<include refid="sf-ecRule-t" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<select id="selectEcRuleForGoodsList" resultMap="ecRuleResultForList" parameterClass="ecRule" cacheModel="oneDayCache"> 
		select t.* from EC_RULE t ,EC_RULE_GOODS g where t.id=g.rule_id and g.is_del=0 
		<![CDATA[ and to_char(t.RULE_START_DATE,'yyyy-MM-dd')<= to_char(sysdate,'yyyy-MM-dd') and to_char(t.RULE_END_DATE,'yyyy-MM-dd')>=to_char(sysdate,'yyyy-MM-dd')  ]]>
		<include refid="sf-ecRule-t" />
		<isNotEmpty prepend=" and " property="map.goods_id">g.GOODS_Id = #map.goods_id:DECIMAL#</isNotEmpty>
	</select>

	<insert id="insertEcRule" parameterClass="ecRule">
		<selectKey resultClass="long" keyProperty="id">select BASE_MESSAGE_SEQ.nextval as id from dual </selectKey>
		<![CDATA[insert into EC_RULE (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="rule_type">RULE_TYPE</isNotNull>	
			<isNotNull prepend="," property="rule_title">RULE_TITLE</isNotNull>	
			<isNotNull prepend="," property="rule_msg">RULE_MSG</isNotNull>	
			<isNotNull prepend="," property="rule_price">RULE_PRICE</isNotNull>	
			<isNotNull prepend="," property="rule_num_min">RULE_NUM_MIN</isNotNull>	
			<isNotNull prepend="," property="rule_num_max">RULE_NUM_MAX</isNotNull>	
			<isNotNull prepend="," property="rule_area_limit">RULE_AREA_LIMIT</isNotNull>	
			<isNotNull prepend="," property="rule_area_allow">RULE_AREA_ALLOW</isNotNull>	
			<isNotNull prepend="," property="is_num">IS_NUM</isNotNull>	
			<isNotNull prepend="," property="is_area_limit">IS_AREA_LIMIT</isNotNull>	
			<isNotNull prepend="," property="is_area_allow">IS_AREA_ALLOW</isNotNull>	
			<isNotNull prepend="," property="is_price">IS_PRICE</isNotNull>	
			<isNotNull prepend="," property="rule_gooods">RULE_GOOODS</isNotNull>	
			<isNotNull prepend="," property="rule_start_date">RULE_START_DATE</isNotNull>	
			<isNotNull prepend="," property="rule_end_date">RULE_END_DATE</isNotNull>	
			<isNotNull prepend="," property="memo">MEMO</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="own_sys">OWN_SYS</isNotNull>	
			<isNotNull prepend="," property="info_state">INFO_STATE</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_type">#rule_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_title">#rule_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_msg">#rule_msg:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_price">#rule_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_num_min">#rule_num_min:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_num_max">#rule_num_max:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_area_limit">#rule_area_limit:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_area_allow">#rule_area_allow:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_num">#is_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_area_limit">#is_area_limit:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_area_allow">#is_area_allow:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_price">#is_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_gooods">#rule_gooods:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_start_date">#rule_start_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="rule_end_date">#rule_end_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="memo">#memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="own_sys">#own_sys:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="info_state">#info_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateEcRule" parameterClass="EcRule">
		update EC_RULE
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_type">RULE_TYPE = #rule_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_title">RULE_TITLE = #rule_title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_msg">RULE_MSG = #rule_msg:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_price">RULE_PRICE = #rule_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_num_min">RULE_NUM_MIN = #rule_num_min:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_num_max">RULE_NUM_MAX = #rule_num_max:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_area_limit">RULE_AREA_LIMIT = #rule_area_limit:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_area_allow">RULE_AREA_ALLOW = #rule_area_allow:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_num">IS_NUM = #is_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_area_limit">IS_AREA_LIMIT = #is_area_limit:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_area_allow">IS_AREA_ALLOW = #is_area_allow:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_price">IS_PRICE = #is_price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="rule_gooods">RULE_GOOODS = #rule_gooods:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="rule_start_date">RULE_START_DATE = #rule_start_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="rule_end_date">RULE_END_DATE = #rule_end_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="memo">MEMO = #memo:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="own_sys">OWN_SYS = #own_sys:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="info_state">INFO_STATE = #info_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteEcRule" parameterClass="EcRule">
		delete from EC_RULE where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>