<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_ORDER_INFO_TRANS_ENSU">

	<typeAlias alias="konkaOrderInfoTransEnsu" type="com.ebiz.mmt.domain.KonkaOrderInfoTransEnsu" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaOrderInfoTransEnsu" />
		<flushOnExecute statement="updateKonkaOrderInfoTransEnsu" />
		<flushOnExecute statement="deleteKonkaOrderInfoTransEnsu" />
	</cacheModel>

	<resultMap id="konkaOrderInfoTransEnsuResultForList" class="konkaOrderInfoTransEnsu">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="ENSU_ID" property="ensu_id" jdbcType="DECIMAL" />
		<result column="TRANS_ENSU_STATUS" property="trans_ensu_status" jdbcType="DECIMAL" />
		<result column="TRANS_ENSU_NUM" property="trans_ensu_num" jdbcType="DECIMAL" />
		<result column="TRANS_ENSU_DATE" property="trans_ensu_date" jdbcType="TIMESTAMP" />
		<result column="TRANS_ENSU_USER" property="trans_ensu_user" jdbcType="VARCHAR" />
		<result column="TRANS_ENSU_DESC" property="trans_ensu_desc" jdbcType="VARCHAR" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
	</resultMap>
	<resultMap id="konkaOrderInfoTransEnsuResult-for-details" class="konkaOrderInfoTransEnsu" extends="konkaOrderInfoTransEnsuResultForList">
		<result column="KUNNR" property="map.kunnr" jdbcType="DECIMAL" />
		<result column="VBELN" property="map.vbeln" jdbcType="DECIMAL" />
		<result column="VBEDL" property="map.vbedl" jdbcType="DECIMAL" />
		<result column="TRADE_INDEX" property="map.trade_index" jdbcType="VARCHAR" />
		<result column="TRANS_INDEX_DETAIL" property="map.trans_index_detail" jdbcType="VARCHAR" />
		<result column="MODEL_NAME" property="map.model_name" jdbcType="VARCHAR" />
		<result column="CUST_ID" property="map.cust_id" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="map.customer_name" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="konkaOrderInfoTransEnsuResult" class="konkaOrderInfoTransEnsu" extends="konkaOrderInfoTransEnsuResultForList">
	</resultMap>

	<sql id="sf-konkaOrderInfoTransEnsu">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ensu_id">ENSU_ID = #ensu_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_status">TRANS_ENSU_STATUS = #trans_ensu_status:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_num">TRANS_ENSU_NUM = #trans_ensu_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_date">TRANS_ENSU_DATE = #trans_ensu_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_user">TRANS_ENSU_USER = #trans_ensu_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_desc">TRANS_ENSU_DESC = #trans_ensu_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
	</sql>
	
	<sql id="sf-konkaOrderInfoTransEnsu-for-details">
		<isNotEmpty prepend=" and " property="id">C.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ensu_id">C.ENSU_ID = #ensu_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_status">C.TRANS_ENSU_STATUS = #trans_ensu_status:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_num">C.TRANS_ENSU_NUM = #trans_ensu_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_date">C.TRANS_ENSU_DATE = #trans_ensu_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_user">C.TRANS_ENSU_USER = #trans_ensu_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="trans_ensu_desc">C.TRANS_ENSU_DESC = #trans_ensu_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">C.ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">C.IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.trans_index_detail_like">a.trans_index_detail like '%' || #map.trans_index_detail_like:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.r3_code_like">krz.kunnr like '%' || #map.r3_code_like:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.r3_vbedl_like">krz.vbedl like '%' || #map.r3_vbedl_like:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.r3_vbeln_like">krz.vbeln like '%' || #map.r3_vbeln_like:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.customer_name_like">krz.customer like '%' || #map.customer_name_like:VARCHAR# || '%' </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.trans_ensu_type">a.trans_ensu_type =#map.trans_ensu_type:DECIMAL# </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cust_id">d.cust_id =#map.cust_id:DECIMAL# </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.trans_ensu_date_s">
			<![CDATA[c.TRANS_ENSU_DATE >= to_date(#map.trans_ensu_date_s#,'yyyy-MM-dd hh24:mi:ss')]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.trans_ensu_date_e">
			<![CDATA[c.TRANS_ENSU_DATE <= to_date(#map.trans_ensu_date_e#,'yyyy-MM-dd hh24:mi:ss')]]>
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			d.id in (select c.ID from konka_order_info c where c.add_dept_id in 
  				( select dept_id from KONKA_DEPT start with dept_id = #map.par_dept_id:DECIMAL# connect by prior dept_id = par_id))
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_or_children_dept_id">
			(
			d.add_dept_id in ( select dept_id from KONKA_DEPT start with dept_id = #map.par_or_children_dept_id:DECIMAL# connect by prior dept_id = par_id
								union 
							   select dept_id from KONKA_DEPT start with dept_id = #map.par_or_children_dept_id:DECIMAL# connect by prior par_id = dept_id)
		    <isNotEmpty prepend=" or " property="map.session_user_id">
			    d.add_dept_id in (select dept_id from konka_dept start with dept_id in (
								SELECT DISTINCT (dept_id)
				  							FROM KONKA_ROLE_DATA_LEVEL
				 							WHERE role_id IN (SELECT role_id
				                     			FROM KONKA_PE_ROLE_USER
				                    			WHERE user_id = #map.session_user_id#)
								) 
								connect by prior dept_id = par_id )
			</isNotEmpty>
			)
		</isNotEmpty>
		
	</sql>

	<select id="selectKonkaOrderInfoTransEnsu" resultMap="konkaOrderInfoTransEnsuResult" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		select * from KONKA_ORDER_INFO_TRANS_ENSU where 1 = 1
		<include refid="sf-konkaOrderInfoTransEnsu" />
	</select>

	<select id="selectKonkaOrderInfoTransEnsuList" resultMap="konkaOrderInfoTransEnsuResultForList" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_ORDER_INFO_TRANS_ENSU where 1 = 1
		<include refid="sf-konkaOrderInfoTransEnsu" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaOrderInfoTransEnsuCount" resultClass="long" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		select count(*) from KONKA_ORDER_INFO_TRANS_ENSU where 1 = 1
		<include refid="sf-konkaOrderInfoTransEnsu" />
	</select>
	
	
	<select id="selectKonkaOrderInfoTransEnsuAndDetailsCount" resultClass="long" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		select count(*) from 
			Konka_Order_Info_Trans_Ensu c 
			left join KONKA_ORDER_INFO_TRANS_DETAILS a 
			on a.ENSU_ID=c.ENSU_ID
			left join KONKA_R3_ZSOF krz
			left join konka_order_info d on krz.vbeln=d.R3_ID
			on a.R3_VBEDL = krz.VBEDL  where 1 = 1 
		<include refid="sf-konkaOrderInfoTransEnsu-for-details" />
	</select>
	
	<select id="selectKonkaOrderInfoTransEnsuAndDetailsPaginatedList" resultMap="konkaOrderInfoTransEnsuResult-for-details" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
	<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select c.*,krz.kunnr,krz.VBELN,krz.VBEDL,a.TRADE_INDEX,a.TRANS_INDEX_DETAIL,a.MODEL_NAME,d.cust_id,krz.NAME1 as customer_name from  
			Konka_Order_Info_Trans_Ensu c 
			left join KONKA_ORDER_INFO_TRANS_DETAILS a 
			on a.ENSU_ID=c.ENSU_ID
			left join KONKA_R3_ZSOF krz
			left join konka_order_info d on krz.vbeln=d.R3_ID
			on a.R3_VBEDL = krz.VBEDL  where 1 = 1 
		<include refid="sf-konkaOrderInfoTransEnsu-for-details" />
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	
	<select id="selectKonkaOrderInfoTransEnsurSumEnsured" resultClass="long" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		select COALESCE ( sum(trans_ensu_num), 0) from KONKA_ORDER_INFO_TRANS_ENSU where 1=1 
		<include refid="sf-konkaOrderInfoTransEnsu" />
	</select>

	<select id="selectKonkaOrderInfoTransEnsuPaginatedList" resultMap="konkaOrderInfoTransEnsuResult" parameterClass="konkaOrderInfoTransEnsu" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_ORDER_INFO_TRANS_ENSU where 1 = 1
		<include refid="sf-konkaOrderInfoTransEnsu" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaOrderInfoTransEnsu" parameterClass="konkaOrderInfoTransEnsu">
		<selectKey resultClass="long" keyProperty="id">select SEQ_KONKA_ORDER_INFO_TRANS.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_ORDER_INFO_TRANS_ENSU (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="ensu_id">ENSU_ID</isNotNull>	
			<isNotNull prepend="," property="trans_ensu_status">TRANS_ENSU_STATUS</isNotNull>	
			<isNotNull prepend="," property="trans_ensu_num">TRANS_ENSU_NUM</isNotNull>	
			<isNotNull prepend="," property="trans_ensu_date">TRANS_ENSU_DATE</isNotNull>	
			<isNotNull prepend="," property="trans_ensu_user">TRANS_ENSU_USER</isNotNull>	
			<isNotNull prepend="," property="trans_ensu_desc">TRANS_ENSU_DESC</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ensu_id">#ensu_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_status">#trans_ensu_status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_num">#trans_ensu_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_date">#trans_ensu_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_user">#trans_ensu_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_desc">#trans_ensu_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaOrderInfoTransEnsu" parameterClass="KonkaOrderInfoTransEnsu">
		update KONKA_ORDER_INFO_TRANS_ENSU
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ensu_id">ENSU_ID = #ensu_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_status">TRANS_ENSU_STATUS = #trans_ensu_status:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_num">TRANS_ENSU_NUM = #trans_ensu_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_date">TRANS_ENSU_DATE = #trans_ensu_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_user">TRANS_ENSU_USER = #trans_ensu_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="trans_ensu_desc">TRANS_ENSU_DESC = #trans_ensu_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaOrderInfoTransEnsu" parameterClass="KonkaOrderInfoTransEnsu">
		update KONKA_ORDER_INFO_TRANS_ENSU set is_del=1 where 
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
		
		<isNotEmpty prepend=" " property="map.trans_index_detail">
			ENSU_ID in (select ensu_id from KONKA_ORDER_INFO_TRANS_DETAILS where trans_index_detail =  #map.trans_index_detail#)
		</isNotEmpty>
		<isEmpty prepend=" " property="map.trans_index_detail">
			<isNotEmpty prepend=" " property="map.trans_index_detail_pks">
				ENSU_ID in (select ensu_id from KONKA_ORDER_INFO_TRANS_DETAILS where trans_index_detail in 
					<iterate close=")" open="(" conjunction="," property="map.trans_index_detail_pks">#map.trans_index_detail_pks[]#</iterate>
				)
			
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>