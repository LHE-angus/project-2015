<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PE_MODULE">

	<typeAlias alias="peModule" type="com.ebiz.mmt.domain.PeModule" />

	

	<resultMap id="peModuleResultForList" class="peModule">
		<result column="MOD_ID" property="mod_id" jdbcType="DECIMAL" />
		<result column="PAR_ID" property="par_id" jdbcType="DECIMAL" />
		<result column="MOD_NAME" property="mod_name" jdbcType="VARCHAR" />
		<result column="MOD_DESC" property="mod_desc" jdbcType="VARCHAR" />
		<result column="MOD_URL" property="mod_url" jdbcType="VARCHAR" />
		<result column="ORDER_VALUE" property="order_value" jdbcType="DECIMAL" />
		<result column="IS_PUBLIC" property="is_public" jdbcType="DECIMAL" />
		<result column="DEL_MARK" property="del_mark" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="peModuleResult" class="peModule" extends="peModuleResultForList">
	</resultMap>

	<sql id="sf-peModule">
		<isNotEmpty prepend=" and " property="mod_id">MOD_ID = #mod_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="par_id">PAR_ID = #par_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_name">MOD_NAME = #mod_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_desc">MOD_DESC = #mod_desc:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mod_url">MOD_URL = #mod_url:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_public">IS_PUBLIC = #is_public:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="del_mark">DEL_MARK = #del_mark:DECIMAL#</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.par_id_le"><![CDATA[ PAR_ID <= #map.par_id_le:DECIMAL# ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_id_ge"><![CDATA[ PAR_ID >= #map.par_id_ge:DECIMAL# ]]></isNotEmpty>
	</sql>

	<select id="selectPeModule" resultMap="peModuleResult" parameterClass="peModule" >
		select * from PE_MODULE where 1 = 1
		<include refid="sf-peModule" />
	</select>
	
	<select id="selectPeModuleParentList" resultMap="peModuleResultForList" parameterClass="peModule" >
	    <![CDATA[ select * from PE_MODULE where PAR_ID <> 0 AND DEL_MARK=0
		     start with MOD_ID = #mod_id:DECIMAL# connect by prior PAR_ID = MOD_ID order
		    by
		    MOD_ID, ORDER_VALUE ]]>
	</select>
	
	<select id="selectPeModuleAllParentList" resultMap="peModuleResultForList" parameterClass="peModule" >
		select *
		  from PE_MODULE
		 where DEL_MARK = 0
		 start with MOD_ID = #mod_id:DECIMAL#
		connect by prior PAR_ID = MOD_ID
		 order by level desc, MOD_ID, ORDER_VALUE
	</select>

	<select id="selectPeModuleList" resultMap="peModuleResultForList" parameterClass="peModule" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from PE_MODULE where 1 = 1
		<include refid="sf-peModule" />
		order by MOD_ID asc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<select id="selectPeModuleListForAuthor" resultMap="peModuleResultForList" >
		SELECT a.*
		  FROM (SELECT *
		          FROM pe_module
		         WHERE mod_id in
		               (SELECT DISTINCT mod_id
		                  FROM (SELECT mod_id
		                          FROM pe_module a
		                         start with mod_id in (SELECT mod_id
		                                                 FROM pe_module
		                                                WHERE is_public = 0
		                                                  AND DEL_MARK = 0)
		                        connect by prior PAR_ID = MOD_ID))) a
		 WHERE a.DEL_MARK = 0
		 start with PAR_ID = 0
		connect by prior MOD_ID = PAR_ID
		 ORDER BY a.ORDER_VALUE DESC, a.MOD_ID asc
	</select>

	<!--Jiang,JiaYong 2011-05-16 -->
	<select id="selectPeModuleForPeUserList" resultMap="peModuleResultForList" parameterClass="peModule" >
		select *
		  from pe_module
		 where del_mark = 0 
		   and mod_id in
		       (select a.mod_id
		          from pe_module a
		         start with a.mod_id in 
		         	<isEmpty property="map.mod_id_in">
		         		(select t.mod_id from pe_mod_popedom t where t.user_id = #map.user_id:DECIMAL#)
					</isEmpty>
					<isNotEmpty property="map.mod_id_in">
		         		<iterate close=")" open="(" conjunction="," property="map.mod_id_in">#map.mod_id_in[]#</iterate>
					</isNotEmpty>
		         connect by prior a.par_id = a.mod_id
		       )	
		<include refid="sf-peModule" />
		order by mod_id asc
	</select>
	
	<select id="selectPeModuleCount" resultClass="long" parameterClass="peModule" >
		select count(*) from PE_MODULE where 1 = 1
		<include refid="sf-peModule" />
	</select>

	<select id="selectPeModulePaginatedList" resultMap="peModuleResult" parameterClass="peModule" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from PE_MODULE where 1 = 1
		<include refid="sf-peModule" />
		order by MOD_ID asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertPeModule" parameterClass="peModule">
		<selectKey resultClass="long" keyProperty="id">select seq_xxx.nextval as id from dual </selectKey>
		<![CDATA[insert into PE_MODULE (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="mod_id">MOD_ID</isNotNull>	
			<isNotNull prepend="," property="par_id">PAR_ID</isNotNull>	
			<isNotNull prepend="," property="mod_name">MOD_NAME</isNotNull>	
			<isNotNull prepend="," property="mod_desc">MOD_DESC</isNotNull>	
			<isNotNull prepend="," property="mod_url">MOD_URL</isNotNull>	
			<isNotNull prepend="," property="order_value">ORDER_VALUE</isNotNull>	
			<isNotNull prepend="," property="is_public">IS_PUBLIC</isNotNull>	
			<isNotNull prepend="," property="del_mark">DEL_MARK</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="mod_id">#mod_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="par_id">#par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mod_name">#mod_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_desc">#mod_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_url">#mod_url:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="order_value">#order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_public">#is_public:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="del_mark">#del_mark:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updatePeModule" parameterClass="PeModule">
		update PE_MODULE
		<dynamic prepend="set">
			<isNotNull prepend="," property="mod_id">MOD_ID = #mod_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="par_id">PAR_ID = #par_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="mod_name">MOD_NAME = #mod_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_desc">MOD_DESC = #mod_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mod_url">MOD_URL = #mod_url:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="order_value">ORDER_VALUE = #order_value:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="is_public">IS_PUBLIC = #is_public:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="del_mark">DEL_MARK = #del_mark:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deletePeModule" parameterClass="PeModule">
		delete from PE_MODULE where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>