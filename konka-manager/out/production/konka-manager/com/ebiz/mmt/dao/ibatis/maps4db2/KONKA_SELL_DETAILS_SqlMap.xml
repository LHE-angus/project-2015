<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_SELL_DETAILS">

	<typeAlias alias="konkaSellDetails" type="com.ebiz.mmt.domain.KonkaSellDetails" />

	

	<resultMap id="konkaSellDetailsResultForList" class="konkaSellDetails">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="S_ID" property="s_id" jdbcType="DECIMAL" />
		<result column="PD_ID" property="pd_id" jdbcType="DECIMAL" />
		<result column="SELL_COUNT" property="sell_count" jdbcType="DECIMAL" />
		<result column="SELL_MONEY" property="sell_money" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="konkaSellDetailsResult" class="konkaSellDetails" extends="konkaSellDetailsResultForList">
	</resultMap>

	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<resultMap id="konkaSellDetailsResultForStatistics" class="konkaSellDetails">
		<result column="SELL_COUNT" property="sell_count" jdbcType="DECIMAL" />
		<result column="DEPT_SN" property="map.dept_sn" jdbcType="VARCHAR" />
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR" />
		<result column="CUS_SN" property="map.cus_sn" jdbcType="VARCHAR" />
		<result column="PD_NAME" property="map.pd_name" jdbcType="VARCHAR" />
		<result column="SELL_DATE" property="map.sell_date" jdbcType="VARCHAR" />
		<result column="SELL_MONEY" property="sell_money" jdbcType="DECIMAL" />
	</resultMap>
	
	<sql id="sf-konkaSellDetails">
		<isNotEmpty prepend=" and " property="id">t.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="s_id">t.S_ID = #s_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">t.PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sell_count">t.SELL_COUNT = #sell_count:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sell_money">t.SELL_MONEY = #sell_money:DECIMAL#</isNotEmpty>
		</sql>
	
	<resultMap id="konkaSellDetailsResultToSum" class="konkaSellDetails" extends="konkaSellDetailsResultForList">
		<result column="CUS_SN" property="map.cus_sn" jdbcType="VARCHAR" />
		<result column="DATEMARK" property="map.datemark" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="konkaSellDetailsForCun_cn" class="konkaSellDetails" extends="konkaSellDetailsResultForList">
		<result column="CUS_SN" property="map.cus_sn" jdbcType="VARCHAR" />
	</resultMap>
	
	<select id="selectKonkaSellDetailsToSum" resultMap="konkaSellDetailsResultToSum" parameterClass="konkaSellDetails" >
		SELECT A.*, B.CUS_SN, <![CDATA[TO_CHAR(B.SELL_DATE, 'yyyymmdd') AS DATEMARK]]>
		  FROM KONKA_SELL_DETAILS A
		  LEFT JOIN KONKA_SELL B ON A.S_ID = B.S_ID
		 WHERE 1 = 1
		 <isNotEmpty prepend=" and " property="map.date_like">
		 <![CDATA[ TO_CHAR(B.SELL_DATE, 'yyyymmdd') <= #map.date_like:VARCHAR# ]]>
		 ORDER BY B.SELL_DATE , A.ID
		 </isNotEmpty>
		 <isEmpty prepend=" " property="map.date_like">
		 ORDER BY B.SELL_DATE , A.ID
		 </isEmpty>
	</select>

	<select id="selectKonkaSellDetails" resultMap="konkaSellDetailsResult" parameterClass="konkaSellDetails" >
		select t.* from KONKA_SELL_DETAILS t where 1 = 1
		<include refid="sf-konkaSellDetails" />
	</select>

	<select id="selectKonkaSellDetailsList" resultMap="konkaSellDetailsForCun_cn" parameterClass="konkaSellDetails" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select t.*, a.cus_sn as cus_sn
		from KONKA_SELL_DETAILS t
		left join konka_sell a on t.s_id = a.s_id
		where 1 = 1 and a.is_del = 0  
		<include refid="sf-konkaSellDetails" />
		<isNotEmpty prepend=" and " property="map.state"> a.state=#map.state# </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.cus_sn"> a.cus_sn=#map.cus_sn# </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.md_name_like">t.pd_id in (select pd_id from konka_pe_pd_model where md_name like'%'|| #map.md_name_like# ||'%')</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.sell_date_start"><![CDATA[a.SELL_DATE >= to_date(#map.sell_date_start#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.sell_date_end"><![CDATA[a.SELL_DATE <= to_date(#map.sell_date_end#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.sell_date_end_lt"><![CDATA[a.SELL_DATE < to_date(#map.sell_date_end_lt#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.handle_name">a.cus_sn in (select r3_code from konka_r3_shop r where r.handle_name like '%' || #map.handle_name# || '%')</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.branch_area_name">a.cus_sn in (select r3_code from konka_r3_shop r where r.branch_area_name like '%' || #map.branch_area_name# || '%')</isNotEmpty>
		order by a.s_id asc
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaSellDetailsCount" resultClass="long" parameterClass="konkaSellDetails" >
		select count(*) from KONKA_SELL_DETAILS t where 1 = 1
		<include refid="sf-konkaSellDetails" />
	</select>
	
	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<select id="selectKonkaSellDetailsForStatisticsCount" resultClass="long" parameterClass="konkaSellDetails" >
		select count(1)
		  from (select t2.add_dept_id, t2.cus_sn, t1.pd_id, t1.sell_count, t2.sell_date
		          from KONKA_SELL_DETAILS t1,
		               (select t.s_id, t.cus_sn, t.add_dept_id, t.sell_date
		                  from KONKA_SELL t
		                 where 1 = 1 
		                   <isNotEmpty prepend=" and " property="map.is_leader_dept_id">t.add_user_id in (select k.user_id from konka_user k where k.dept_id in (select dept_id from konka_dept d start with d.dept_id in (select dept_id from konka_dept a where dept_id = #map.is_leader_dept_id:DECIMAL#) connect by prior d.dept_id = d.par_id))</isNotEmpty>
						   <isNotEmpty prepend=" and " property="map.add_user_id">t.add_user_id = #map.add_user_id:DECIMAL#</isNotEmpty>
		                   and <![CDATA[SELL_DATE >= to_date(#map.sell_date_start#,'yyyy-MM-dd hh24:mi:ss')]]>
		                   and <![CDATA[SELL_DATE <= to_date(#map.sell_date_end#,'yyyy-MM-dd hh24:mi:ss')]]>
		                   and t.is_del = 0
		                   and (t.state = 1 or t.state = 2)) t2
		         where t1.s_id = t2.s_id) t3
		  left join KONKA_PD_MODEL t4 on t3.pd_id = t4.pd_id
		  left join KONKA_DEPT t5 on t3.add_dept_id = t5.dept_id
	</select>

	<select id="selectKonkaSellDetailsPaginatedList" resultMap="konkaSellDetailsResult" parameterClass="konkaSellDetails" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select t.* from KONKA_SELL_DETAILS t where 1 = 1
		<include refid="sf-konkaSellDetails" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- @author Jiang,JiaYong @version 2011-08-25 @desc 统计下载数据 -->
	<select id="selectKonkaSellDetailsForStatisticsPaginatedList" resultMap="konkaSellDetailsResultForStatistics" parameterClass="konkaSellDetails" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
			select 
			(select dept_sn from KONKA_DEPT where dept_id = t3.add_dept_id) as dept_sn,
            (select dept_name from KONKA_DEPT where dept_id = t3.add_dept_id) as dept_name,
			t3.cus_sn,t4.pd_name,t3.sell_count,t3.sell_date, t3.sell_money
			  from (select t2.add_dept_id, t2.cus_sn, t1.pd_id, t1.sell_count, t2.sell_date, t1.sell_money
			          from KONKA_SELL_DETAILS t1,
			               (select t.s_id, t.cus_sn, t.add_dept_id, t.sell_date
			                  from KONKA_SELL t
			                 where 1 = 1 
			                   <isNotEmpty prepend=" and " property="map.is_leader_dept_id">t.add_user_id in (select k.user_id from konka_user k where k.dept_id in (select dept_id from konka_dept d start with d.dept_id in (select dept_id from konka_dept a where dept_id = #map.is_leader_dept_id:DECIMAL#) connect by prior d.dept_id = d.par_id))</isNotEmpty>
							   <isNotEmpty prepend=" and " property="map.add_user_id">t.add_user_id = #map.add_user_id:DECIMAL#</isNotEmpty>
			                   and <![CDATA[SELL_DATE >= to_date(#map.sell_date_start#,'yyyy-MM-dd hh24:mi:ss')]]>
			                   and <![CDATA[SELL_DATE <= to_date(#map.sell_date_end#,'yyyy-MM-dd hh24:mi:ss')]]>
			                   and t.is_del = 0
			                   and (t.state = 1 or t.state = 2)) t2
			         where t1.s_id = t2.s_id) t3
			  left join KONKA_PD_MODEL t4 on t3.pd_id = t4.pd_id
			  <isNotEmpty prepend=" " property="map.dept_id">
			  where t3.add_dept_id in (select t5.dept_id from KONKA_DEPT t5  where 1 = 1
         start with dept_id =#map.dept_id#  connect by prior   t5.dept_id = t5.par_id )
         </isNotEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaSellDetails" parameterClass="konkaSellDetails">
		<selectKey resultClass="long" keyProperty="id">select KONKA_S_BASE.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_SELL_DETAILS (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="s_id">S_ID</isNotNull>	
			<isNotNull prepend="," property="pd_id">PD_ID</isNotNull>	
			<isNotNull prepend="," property="sell_count">SELL_COUNT</isNotNull>
			<isNotNull prepend="," property="sell_money">SELL_MONEY</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="s_id">#s_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">#pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sell_count">#sell_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sell_money">#sell_money:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaSellDetails" parameterClass="KonkaSellDetails">
		update KONKA_SELL_DETAILS
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="s_id">S_ID = #s_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sell_count">SELL_COUNT = #sell_count:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="sell_money">SELL_MONEY = #sell_money:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaSellDetails" parameterClass="KonkaSellDetails">
		delete from KONKA_SELL_DETAILS where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>
	
	<!-- add by Jiang,JiaYong 2011-08-25 -->
	<delete id="deleteKonkaSellDetailsWithSID" parameterClass="KonkaSellDetails">
		delete from KONKA_SELL_DETAILS where S_ID = #s_id:DECIMAL#
	</delete>

</sqlMap>