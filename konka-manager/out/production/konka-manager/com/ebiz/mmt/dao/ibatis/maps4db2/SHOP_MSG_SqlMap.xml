<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="SHOP_MSG">

	<typeAlias alias="shopMsg" type="com.ebiz.mmt.domain.ShopMsg" />

	

	<resultMap id="shopMsgResultForList" class="shopMsg">
		<result column="MSG_ID" property="msg_id" jdbcType="DECIMAL" />
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="MSG_CONTENT" property="msg_content" jdbcType="VARCHAR" />
		<result column="ASK_ID" property="ask_id" jdbcType="DECIMAL" />
		<result column="ASK_DATE" property="ask_date" jdbcType="java.sql.Timestamp" />
		<result column="REPLY_CONTENT" property="reply_content" jdbcType="VARCHAR" />
		<result column="REPLY_ID" property="reply_id" jdbcType="DECIMAL" />
		<result column="DEL_MAN2" property="del_man2" jdbcType="DATETIME" />
		<result column="INFO_STATE" property="info_state" jdbcType="DECIMAL" />
		<result column="ASSESS_STATE" property="assess_state" jdbcType="DECIMAL" />
		<result column="ASSESS_DATE" property="assess_date" jdbcType="DATETIME" />
		<result column="REPLY_LINK" property="reply_link" jdbcType="VARCHAR" />
		<result column="MARK" property="mark" jdbcType="DECIMAL" />
		<result column="USER_NAME" property="map.ask_user_name" jdbcType="VARCHAR" />
		<result column="USER_IMAGE" property="map.user_image" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="shopMsgResultList" class="shopMsg">
		<result column="MSG_ID" property="msg_id" jdbcType="DECIMAL" />
		<result column="SHOP_ID" property="shop_id" jdbcType="DECIMAL" />
		<result column="MSG_CONTENT" property="msg_content" jdbcType="VARCHAR" />
		<result column="ASK_ID" property="ask_id" jdbcType="DECIMAL" />
		<result column="ASK_DATE" property="ask_date" jdbcType="java.sql.Timestamp" />
		<result column="REPLY_CONTENT" property="reply_content" jdbcType="VARCHAR" />
		<result column="REPLY_ID" property="reply_id" jdbcType="DECIMAL" />
		<result column="DEL_MAN2" property="del_man2" jdbcType="DATETIME" />
		<result column="INFO_STATE" property="info_state" jdbcType="DECIMAL" />
		<result column="ASSESS_STATE" property="assess_state" jdbcType="DECIMAL" />
		<result column="ASSESS_DATE" property="assess_date" jdbcType="DATETIME" />
		<result column="REPLY_LINK" property="reply_link" jdbcType="VARCHAR" />
		<result column="MARK" property="mark" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="shopMsgResult" class="shopMsg" extends="shopMsgResultForList">
	</resultMap>

	<resultMap id="shopMsgWithShopName" class="shopMsg" extends = "shopMsgResultList">
		<result column ="SHOP_NAME" property="map.shop_name" />
	</resultMap>
	
	<sql id="sf-shopMsg">
		<isNotEmpty prepend=" and " property="msg_id">MSG_ID = #msg_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="shop_id">SHOP_ID = #shop_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="msg_content">MSG_CONTENT = #msg_content:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ask_id">ASK_ID = #ask_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="ask_date">ASK_DATE = #ask_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="reply_content">REPLY_CONTENT = #reply_content:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="reply_id">REPLY_ID = #reply_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="del_man2">DEL_MAN2 = #del_man2:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="info_state">INFO_STATE = #info_state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="assess_state">ASSESS_STATE = #assess_state:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="assess_date">ASSESS_DATE = #assess_date:DATETIME#</isNotEmpty>
		<isNotEmpty prepend=" and " property="reply_link">REPLY_LINK = #reply_link:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="mark">MARK = #mark:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.info_state">INFO_STATE in (0,3)</isNotEmpty>
		<isNotEmpty property="map.st_ask_date">
			<isNotEmpty prepend=" and " property="map.en_ask_date">
	 	   	<![CDATA[ to_char(ASK_DATE, 'yyyy-mm-dd') >= #map.st_ask_date# and to_char(ASK_DATE, 'yyyy-mm-dd') <= #map.en_ask_date#]]>
			</isNotEmpty>
			<isEmpty prepend=" and " property="map.en_ask_date"> to_char(ASK_DATE, 'yyyy-mm-dd') >= #map.st_ask_date#</isEmpty>
		</isNotEmpty>
		<isEmpty property="map.st_ask_date">
			<isNotEmpty prepend=" and " property="map.en_ask_date">
	 			<![CDATA[to_char(ASK_DATE, 'yyyy-mm-dd') <= #map.en_ask_date#]]>
			</isNotEmpty>
		</isEmpty>
	</sql>

	<select id="selectShopMsg" resultMap="shopMsgResult" parameterClass="shopMsg" >
		select t.*,user_name,user_image from (select * from SHOP_MSG where 1 = 1
		<include refid="sf-shopMsg" />
		) t
		left join user_info u on u.id = t.ask_id
	</select>

	<select id="selectShopMsgList" resultMap="shopMsgResultForList" parameterClass="shopMsg" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( 
			select t.*,user_name,user_image from (
			]]>
		</isNotEmpty>
		select * from SHOP_MSG where 1 = 1
		<include refid="sf-shopMsg" />
		order by ASK_DATE desc,msg_id desc
		<isNotEmpty property="row.count">
			<![CDATA[ )t
			left join user_info u on u.id = t.ask_id
			) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectShopMsgCount" resultClass="long" parameterClass="shopMsg" >
		select count(*) from SHOP_MSG where 1 = 1
		<include refid="sf-shopMsg" />
	</select>

	<select id="selectShopMsgPaginatedList" resultMap="shopMsgResult" parameterClass="shopMsg" >
		<![CDATA[ 
		select t.*,user_name,user_image from (
		select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from SHOP_MSG where 1 = 1
		<include refid="sf-shopMsg" />
		order by ASK_DATE desc,msg_id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1))t
			left join user_info u on u.id = t.ask_id
		 ]]>
	</select>
	
	<select id="selectUserMsgShopCount" resultClass="long" parameterClass="shopMsg" >
		select count(*) from (
		select a.*,b.shop_name from SHOP_MSG a left join ENTP_SHOP b on a.shop_id = b.shop_id where 1 = 1 and a.info_state!=-1
		<include refid="sf-shopMsg" />
		<isNotEmpty prepend=" and " property="map.shop_name">UPPER(b.SHOP_NAME) like '%' || UPPER(#map.shop_name:VARCHAR#) || '%'</isNotEmpty>
		order by ASK_DATE desc,msg_id desc)		
	</select>
	
	<select id="selectShopPdWithShopNameList" resultMap="shopMsgWithShopName" parameterClass ="shopMsg" >
		<![CDATA[ 
		select * from (
		select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.shop_name from SHOP_MSG a left join ENTP_SHOP b on a.shop_id = b.shop_id where 1 = 1 and a.info_state!=-1
		<include refid="sf-shopMsg" />
		<isNotEmpty prepend=" and " property="map.shop_name">UPPER(b.SHOP_NAME) like '%' || UPPER(#map.shop_name:VARCHAR#) || '%'</isNotEmpty>
		order by ASK_DATE desc,msg_id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1))t
		 ]]>

	</select>

	<insert id="insertShopMsg" parameterClass="shopMsg">
		<selectKey resultClass="long" keyProperty="msg_id">select OPR_SEQUENCE.nextval as msg_id from dual</selectKey>
		<![CDATA[insert into SHOP_MSG (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="msg_id">MSG_ID</isNotNull>	
			<isNotNull prepend="," property="shop_id">SHOP_ID</isNotNull>	
			<isNotNull prepend="," property="msg_content">MSG_CONTENT</isNotNull>	
			<isNotNull prepend="," property="ask_id">ASK_ID</isNotNull>	
			<isNotNull prepend="," property="ask_date">ASK_DATE</isNotNull>	
			<isNotNull prepend="," property="reply_content">REPLY_CONTENT</isNotNull>	
			<isNotNull prepend="," property="reply_id">REPLY_ID</isNotNull>	
			<isNotNull prepend="," property="del_man2">DEL_MAN2</isNotNull>	
			<isNotNull prepend="," property="info_state">INFO_STATE</isNotNull>	
			<isNotNull prepend="," property="assess_state">ASSESS_STATE</isNotNull>	
			<isNotNull prepend="," property="assess_date">ASSESS_DATE</isNotNull>	
			<isNotNull prepend="," property="reply_link">REPLY_LINK</isNotNull>	
			<isNotNull prepend="," property="mark">MARK</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="msg_id">#msg_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shop_id">#shop_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="msg_content">#msg_content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="ask_id">#ask_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ask_date">sysdate</isNotNull>
			<isNotNull prepend="," property="reply_content">#reply_content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="reply_id">#reply_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="del_man2">sysdate</isNotNull>
			<isNotNull prepend="," property="info_state">#info_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="assess_state">#assess_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="assess_date">sysdate</isNotNull>
			<isNotNull prepend="," property="reply_link">#reply_link:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mark">#mark:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>
	
	<update id="updateShopMsg" parameterClass="shopMsg">
		update SHOP_MSG
		<dynamic prepend="set">
			<isNotNull prepend="," property="msg_id">MSG_ID = #msg_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shop_id">SHOP_ID = #shop_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="msg_content">MSG_CONTENT = #msg_content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="ask_id">ASK_ID = #ask_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="ask_date">ASK_DATE = #ask_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="reply_content">REPLY_CONTENT = #reply_content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="reply_id">REPLY_ID = #reply_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="del_man2">DEL_MAN2 = #del_man2:DATETIME#</isNotNull>
			<isNotNull prepend="," property="info_state">INFO_STATE = #info_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="assess_state">ASSESS_STATE = #assess_state:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="assess_date">ASSESS_DATE = #assess_date:DATETIME#</isNotNull>
			<isNotNull prepend="," property="reply_link">REPLY_LINK = #reply_link:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="mark">MARK = #mark:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="msg_id">MSG_ID = #msg_id#</isNotEmpty>
		<isEmpty prepend=" " property="msg_id">
			<isNotEmpty prepend=" " property="map.pks">
				MSG_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteShopMsg" parameterClass="shopMsg">
		delete from SHOP_MSG where
		<isNotEmpty prepend=" " property="msg_id">MSG_ID = #msg_id#</isNotEmpty>
		<isEmpty prepend=" " property="msg_id">
			<isNotEmpty prepend=" " property="map.pks">
				MSG_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>