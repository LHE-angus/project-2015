<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

	<!-- Code by AutoGenerated Builder -->
	<!-- AutoGenerated Builder Version 2.1 -->
	<!-- @author Hui,Gang -->
	<!-- @datetime 2011-09-29 19:26:37 -->
<sqlMap namespace="KONKA_PE_ROLE_INFO">
	
	<typeAlias alias="peRoleInfo" type="com.ebiz.mmt.domain.PeRoleInfo" />
	
	<resultMap id="peRoleInfoResultForList" class="peRoleInfo">
		<result column="ROLE_ID" property="role_id" jdbcType="DECIMAL" />
		<result column="ROLE_NAME" property="role_name" jdbcType="VARCHAR" />
		<result column="ROLE_DESC" property="role_desc" jdbcType="VARCHAR" />
		<result column="ENTP_ID" property="entp_id" jdbcType="DECIMAL" />
		<result column="ADD_E_USER_ID" property="add_e_user_id" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="DATETIME" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="DECIMAL" />
		<result column="D_LEVEL" property="d_level" jdbcType="DECIMAL" />
		<result column="DEPT_SN" property="dept_sn" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="peRoleInfoResult" class="peRoleInfo" extends="peRoleInfoResultForList">
	</resultMap>

	<resultMap id="peRoleInfoForDeptNameResult" class="peRoleInfo" extends="peRoleInfoResultForList">
		<result column="DEPT_NAME" property="map.dept_name" jdbcType="DECIMAL" />
	</resultMap>
	
	<resultMap id="peRoleInfoForRoleNameResult" class="peRoleInfo">
		<result column="ROLE_NAMES" property="map.role_names" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="sf-peRoleInfo">
		<isNotEmpty prepend=" and " property="role_id">ROLE_ID = #role_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="role_name">ROLE_NAME = #role_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="entp_id">ENTP_ID = #entp_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_e_user_id">ADD_E_USER_ID = #add_e_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">ADD_DATE = #add_date:DATE#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="d_level">D_LEVEL = #d_level:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_sn">DEPT_SN = #dept_sn:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.ge_role_id">role_id >= #map.ge_role_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_name_like">ROLE_NAME like '%' || #map.role_name_like# || '%'</isNotEmpty>
		<!-- 取审核角色列表  add by du,zhiming 20111201 -->
		<isNotEmpty prepend=" and " property="map.role_id_audit_gt"><![CDATA[role_id <= #map.role_id_audit_gt:DECIMAL#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_id_audit_lt"><![CDATA[role_id >= #map.role_id_audit_lt:DECIMAL#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.selectedIds">role_id in ($map.selectedIds$)</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_id_is_not_188">role_id != 188 </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_id_is_not_400">role_id != 400 </isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.dept_id_value">ENTP_ID = #entp_id:DECIMAL# or <![CDATA[role_id < 188 and role_id >= 30  ]]> or <![CDATA[role_id <= 488 and role_id >= 300  ]]></isNotEmpty>
		<isNotEmpty prepend=" or " property="map.role_id_60_32_187_188">role_id in(60,188,32,187,8003,8004,8005,8008,300,50,40,47,41,57,58,69,128,302,402,403) </isNotEmpty>
	</sql>

	<select id="selectPeRoleInfo" resultMap="peRoleInfoResult" parameterClass="peRoleInfo" >
		select * from KONKA_PE_ROLE_INFO where 1 = 1
		<include refid="sf-peRoleInfo" />
	</select>
	
	<select id="selectPeRoleInfoForRoleNames" parameterClass="peRoleInfo" resultMap="peRoleInfoForRoleNameResult" >
		SELECT to_char (listagg (role_name, ',')) AS role_names
		  FROM KONKA_PE_ROLE_INFO
		 WHERE  1 = 1
		 <isNotEmpty prepend=" and " property="map.user_id"> 
		 	role_id IN (SELECT DISTINCT (role_id)
		                     FROM konka_pe_role_user
		                    WHERE user_id = #map.user_id#)
		 </isNotEmpty>
		 <isNotEmpty prepend=" and " property="map.role_ids"> 
		 	role_id IN (SELECT DISTINCT (role_id)
		                     FROM konka_pe_role_user
		                    WHERE role_id in ($map.role_ids$))
		 </isNotEmpty>
	</select>
	

	<select id="selectPeRoleInfoList" resultMap="peRoleInfoResultForList" parameterClass="peRoleInfo" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_PE_ROLE_INFO where 1 = 1
			<isNotEmpty prepend=" " property="map.is_pec_user">
				and role_id between 1000 and 1100
			</isNotEmpty>
			<isEmpty prepend=" " property="map.is_pec_user">
				and role_id not between 1000 and 1100
			</isEmpty>
			<!-- 
			<isEmpty prepend=" " property="map.is_pec_user">
				<isNotEmpty prepend=" " property="map.is_pe_prod_user">
					and role_id not between 200 and 600
				</isNotEmpty>
				<isEmpty prepend=" " property="map.is_pe_prod_user">
					<isNotEmpty prepend=" " property="map.is_zmd_manager_pe">
						and role_id between 390 and 400
					</isNotEmpty>
					<isEmpty prepend=" " property="map.is_zmd_manager_pe">
							and role_id between 200 and 600
					</isEmpty>
				</isEmpty>
         	</isEmpty>
         	 -->
        <isNotEmpty prepend=" and " property="map.todo_role">
            role_id in ($map.todo_role$)
        </isNotEmpty>
		<include refid="sf-peRoleInfo" />
		<isEmpty prepend=" " property="map.order_by_id">
			order by ROLE_ID asc
		</isEmpty>
		<isNotEmpty prepend=" " property="map.order_by_id">
		    order by ROLE_ID desc
		</isNotEmpty>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<!-- 根据用户IDS获取去除重复的角色列表 -->
	<select id="selectPeRoleInfoByUserIdsList" resultMap="peRoleInfoResultForList" parameterClass="peRoleInfo" >
		select distinct *
		  from konka_pe_role_info a
		 where a.role_id in
		       (select t.role_id
		          from konka_pe_role_user t
		         where t.user_id in ($map.user_ids$))
		 order by a.role_id
	</select>

	<select id="selectPeRoleInfoCount" resultClass="long" parameterClass="peRoleInfo" >
		select count(*) from KONKA_PE_ROLE_INFO where 1 = 1
		<include refid="sf-peRoleInfo" />
	</select>

	<select id="selectPeRoleInfoPaginatedList" resultMap="peRoleInfoResultForList" parameterClass="peRoleInfo" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_PE_ROLE_INFO where 1 = 1
		<include refid="sf-peRoleInfo" />
		order by ROLE_ID asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!--Hu,Hao 2013-05-25-->
	<select id="selectPeRoleInfoForDeptNamePaginatedList" resultMap="peRoleInfoForDeptNameResult" parameterClass="peRoleInfo" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select t.*,t1.dept_name from KONKA_PE_ROLE_INFO t left join konka_dept t1 on t.dept_id = t1.dept_id
		 where 1 = 1 and t.is_del=0
		<isNotEmpty prepend=" and " property="dept_id">t.DEPT_ID = #dept_id:DECIMAL# and t1.dept_id is not null</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_name_like">t.ROLE_NAME like '%' || #map.role_name_like# || '%'</isNotEmpty>
		order by t.ROLE_ID asc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertPeRoleInfoWithoutAutoKey" parameterClass="peRoleInfo">
		<![CDATA[insert into KONKA_PE_ROLE_INFO (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="role_id">ROLE_ID</isNotNull>	
			<isNotNull prepend="," property="role_name">ROLE_NAME</isNotNull>
			<isNotNull prepend="," property="role_desc">ROLE_DESC</isNotNull>		
			<isNotNull prepend="," property="entp_id">ENTP_ID</isNotNull>	
			<isNotNull prepend="," property="add_e_user_id">ADD_E_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>
			<isNotNull prepend="," property="d_level">D_LEVEL</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>
			<isNotNull prepend="," property="dept_sn">DEPT_SN</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="role_id">#role_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="role_name">#role_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="role_desc">#role_desc:VARCHAR#</isNotNull>		
			<isNotNull prepend="," property="entp_id">#entp_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="add_e_user_id">#add_e_user_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="add_date">#add_date:DATE#</isNotNull>	
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="d_level">#d_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_sn">#dept_sn:VARCHAR#</isNotNull>		
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<insert id="insertPeRoleInfo" parameterClass="peRoleInfo">
		<selectKey resultClass="long" keyProperty="role_id">select KONKA_PROD_SEQUENCE.nextval as role_id from dual</selectKey>
		<![CDATA[insert into KONKA_PE_ROLE_INFO (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="role_id">ROLE_ID</isNotNull>	
			<isNotNull prepend="," property="role_name">ROLE_NAME</isNotNull>
			<isNotNull prepend="," property="role_desc">ROLE_DESC</isNotNull>		
			<isNotNull prepend="," property="entp_id">ENTP_ID</isNotNull>	
			<isNotNull prepend="," property="add_e_user_id">ADD_E_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>
			<isNotNull prepend="," property="d_level">D_LEVEL</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>
			<isNotNull prepend="," property="dept_sn">DEPT_SN</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="role_id">#role_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="role_name">#role_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="role_desc">#role_desc:VARCHAR#</isNotNull>		
			<isNotNull prepend="," property="entp_id">#entp_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="add_e_user_id">#add_e_user_id:DECIMAL#</isNotNull>	
			<isNotNull prepend="," property="add_date">#add_date:DATE#</isNotNull>	
			<isNotNull prepend="," property="is_del">#is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="d_level">#d_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_sn">#dept_sn:VARCHAR#</isNotNull>		
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updatePeRoleInfo" parameterClass="peRoleInfo">
		update KONKA_PE_ROLE_INFO
		<dynamic prepend="set">
			<isNotNull prepend="," property="role_id">ROLE_ID = #role_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="role_name">ROLE_NAME = #role_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="role_desc">ROLE_DESC = #role_desc:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="entp_id">ENTP_ID = #entp_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_e_user_id">ADD_E_USER_ID = #add_e_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:DATE#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="d_level">D_LEVEL = #d_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_sn">DEPT_SN = #dept_sn:VARCHAR#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="role_id">ROLE_ID = #role_id#</isNotEmpty>
		<isEmpty prepend=" " property="role_id">
			<isNotEmpty prepend=" " property="map.pks">
				ROLE_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deletePeRoleInfo" parameterClass="peRoleInfo">
		update KONKA_PE_ROLE_INFO set is_del = 1 where
		<isNotEmpty prepend=" " property="role_id">ROLE_ID = #role_id#</isNotEmpty>
		<isEmpty prepend=" " property="role_id">
			<isNotEmpty prepend=" " property="map.pks">
				ROLE_ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>