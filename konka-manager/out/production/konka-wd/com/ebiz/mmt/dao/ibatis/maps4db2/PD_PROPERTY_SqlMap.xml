<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="PD_PROPERTY">
	<typeAlias alias="pdProperty" type="com.ebiz.mmt.domain.PdProperty" />
	<typeAlias alias="pdPropertyValue" type="com.ebiz.mmt.domain.PdPropertyValue" />

	

	<resultMap id="pdPropertyResultForList" class="pdProperty">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="PROPERTY_NAME" property="property_name" jdbcType="VARCHAR" />
		<result column="PD_TYPE" property="pd_type" jdbcType="DECIMAL" />
		<result column="PD_TYPE_SIGN" property="pd_type_sign" jdbcType="VARCHAR" />
		<result column="P_UNIT" property="p_unit" jdbcType="VARCHAR" />
		<result column="P_TYPE" property="p_type" jdbcType="DECIMAL" />
		<result column="IS_MANDATORY" property="is_mandatory" jdbcType="DECIMAL" />		
	</resultMap>
	
	<resultMap id="pdPropertyResult" class="pdProperty" extends="pdPropertyResultForList">
	</resultMap>
	
	<resultMap id="pdPropertyForModelResult" class="pdProperty" extends="pdPropertyResultForList">
		<result column="PROPERTY_VALUE" property="map.property_value" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- 商城比价查询value -->
	<resultMap id="pdPropertyValueResult" class="pdPropertyValue">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="P_TYPE" property="p_type" jdbcType="DECIMAL" />
	    <result column="FIX_VALUE" property="fix_value" jdbcType="VARCHAR" />
	    <result column="MIN_VALUE" property="min_value" jdbcType="DECIMAL" />
	    <result column="MAX_VALUE" property="max_value" jdbcType="DECIMAL" />
	    <result column="P_UNIT" property="p_unit" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="pdPropertyResultForShopPdContrast" class="pdProperty" extends="pdPropertyResultForList" groupBy="id">
		<result property="pdPropertyValueList" resultMap="PD_PROPERTY.pdPropertyValueResult" />
	</resultMap>
	
	<sql id="sf-pdProperty">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="property_name">PROPERTY_NAME = #property_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_type">PD_TYPE = #pd_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_type_sign">PD_TYPE_SIGN = #pd_type_sign:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.productCenterRemove3"><![CDATA[ P_TYPE < 2 ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="is_mandatory">IS_MANDATORY = #is_mandatory:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.src_type">SRC_TYPE = #map.src_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.property_name_like">PROPERTY_NAME like '%' ||#map.property_name_like#|| '%'</isNotEmpty>
	</sql>

	<select id="selectPdProperty" resultMap="pdPropertyResult" parameterClass="pdProperty" >
		select * from PD_PROPERTY where 1 = 1
		<include refid="sf-pdProperty" />
	</select>

	<select id="selectPdPropertyForModelList" resultMap="pdPropertyForModelResult" parameterClass="pdProperty">
		  select a.*,c.property_value
          from pd_property a
          left join (select b.*
                 from pd_property_custom b
                where b.del_mark = 0
		          <isNotEmpty prepend=" and " property="map.pd_id">b.PD_ID = #map.pd_id:DECIMAL#</isNotEmpty>
		          ) c 
		          on a.id = c.property_id
         where 1 = 1 and a.src_type = 0
         <isNotEmpty prepend=" and " property="pd_type">a.PD_TYPE = #pd_type:DECIMAL#</isNotEmpty>
	</select>

	<select id="selectPdPropertyList" resultMap="pdPropertyResultForList" parameterClass="pdProperty" >
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from PD_PROPERTY where 1 = 1
		<include refid="sf-pdProperty" />
		order by PD_TYPE desc,id desc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>
	
	<!-- 商城比价查询value -->
	<select id="selectPdPropertyListForShopPdContrast" resultMap="pdPropertyResultForShopPdContrast" parameterClass="pdProperty" >
		select t1.*, t2.* from (
			select * from PD_PROPERTY where 1 = 1
			<isNotEmpty prepend=" and " property="pd_type_sign">PD_TYPE_SIGN = #pd_type_sign:VARCHAR#</isNotEmpty>
			and P_TYPE in (0, 1)) t1
		left join PD_PROPERTY_VALUE t2 on t1.ID = t2.ID
		order by t1.PD_TYPE desc,t1.ID desc
	</select>

	<select id="selectPdPropertyCount" resultClass="long" parameterClass="pdProperty" >
		select count(*) from PD_PROPERTY where 1 = 1
		<include refid="sf-pdProperty" />
	</select>

	<select id="selectPdPropertyPaginatedList" resultMap="pdPropertyResult" parameterClass="pdProperty" >
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from PD_PROPERTY where 1 = 1 
		<include refid="sf-pdProperty" />
		order by PD_TYPE desc,id desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertPdProperty" parameterClass="pdProperty">
		<selectKey resultClass="long" keyProperty="id">select pd_sequence.nextval as id from dual</selectKey>
		<![CDATA[
		insert into PD_PROPERTY 
		(
			ID,
			PROPERTY_NAME,
			PD_TYPE,
			PD_TYPE_SIGN,
			P_UNIT,
			P_TYPE,
			IS_MANDATORY
		) 
		values 
		(
			#id:DECIMAL#,
			#property_name:VARCHAR#,
			#pd_type:DECIMAL#,
			#pd_type_sign:VARCHAR#,
			#p_unit:VARCHAR#,
			#p_type:DECIMAL#,
			#is_mandatory:DECIMAL#
		)
		]]>
	</insert>

	<update id="updatePdProperty" parameterClass="pdProperty">
		update PD_PROPERTY
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="property_name">PROPERTY_NAME = #property_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="pd_type">PD_TYPE = #pd_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_type_sign">PD_TYPE_SIGN = #pd_type_sign:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="p_unit" >P_UNIT = #p_unit:VARCHAR#</isNotNull>
      		<isNotNull prepend="," property="p_type" >P_TYPE = #p_type:DECIMAL#</isNotNull>
      		<isNotNull prepend="," property="is_mandatory" >IS_MANDATORY = #is_mandatory:DECIMAL#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deletePdProperty" parameterClass="pdProperty">
		delete from PD_PROPERTY where 1 = 1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_type">PD_TYPE = #pd_type:DECIMAL#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" and " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>