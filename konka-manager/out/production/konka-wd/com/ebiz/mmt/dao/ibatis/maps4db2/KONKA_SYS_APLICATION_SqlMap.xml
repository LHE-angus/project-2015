<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_SYS_APLICATION">

	<typeAlias alias="konkaSysAplication" type="com.ebiz.mmt.domain.KonkaSysAplication" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaSysAplication" />
		<flushOnExecute statement="updateKonkaSysAplication" />
		<flushOnExecute statement="deleteKonkaSysAplication" />
	</cacheModel>

	<resultMap id="konkaSysAplicationResultForList" class="konkaSysAplication">
		<result column="ID" property="id" jdbcType="BIGINT" />
		<result column="BACK_ID" property="back_id" jdbcType="VARCHAR" />
		<result column="USER_ID" property="user_id" jdbcType="BIGINT" />
		<result column="WRITE_NAME" property="write_name" jdbcType="VARCHAR" />
		<result column="DEPT_ID" property="dept_id" jdbcType="BIGINT" />
		<result column="NAME" property="name" jdbcType="VARCHAR" />
		<result column="TYPE" property="type" jdbcType="VARCHAR" />
		<result column="TITLE" property="title" jdbcType="VARCHAR" />
		<result column="CONTENT" property="content" jdbcType="VARCHAR" />
		<result column="ACCESSORY" property="accessory" jdbcType="VARCHAR" />
		<result column="AUDIT_ID1" property="audit_id1" jdbcType="BIGINT" />
		<result column="AUDIT_NAME1" property="audit_name1" jdbcType="VARCHAR" />
		<result column="AUDIT_ID2" property="audit_id2" jdbcType="BIGINT" />
		<result column="AUDIT_NAME2" property="audit_name2" jdbcType="VARCHAR" />
		<result column="AUDIT_ID3" property="audit_id3" jdbcType="BIGINT" />
		<result column="AUDIT_NAME3" property="audit_name3" jdbcType="VARCHAR" />
		<result column="AUDIT_ID4" property="audit_id4" jdbcType="BIGINT" />
		<result column="AUDIT_NAME4" property="audit_name4" jdbcType="VARCHAR" />
		<result column="LINK_ID" property="link_id" jdbcType="VARCHAR" />
		<result column="CREATE_DATE" property="create_date" jdbcType="TIMESTAMP" />
		<result column="DEAL_STATUS" property="deal_status" jdbcType="SMALLINT" />
		<result column="DEAL_DATE" property="deal_date" jdbcType="TIMESTAMP" />
		<result column="DEAL_NAME" property="deal_name" jdbcType="VARCHAR" />
		<result column="RESULT" property="result" jdbcType="VARCHAR" />
		<result column="IS_DEL" property="is_del" jdbcType="SMALLINT" />
		<result column="BAK1" property="bak1" jdbcType="VARCHAR" />
		<result column="BAK2" property="bak2" jdbcType="VARCHAR" />
		<result column="BAK3" property="bak3" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="konkaSysAplicationResult" class="konkaSysAplication" extends="konkaSysAplicationResultForList">
	</resultMap>

	<sql id="sf-konkaSysAplication">
		<isNotEmpty prepend=" and " property="id">ID = #id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="back_id">BACK_ID like '%'||#back_id:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="user_id">USER_ID = #user_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="write_name">WRITE_NAME = #write_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="name">NAME = #name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="type">TYPE = #type:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="title">TITLE like '%'||#title:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="content">CONTENT = #content:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="accessory">ACCESSORY = #accessory:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_id1">AUDIT_ID1 = #audit_id1:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_name1">AUDIT_NAME1 = #audit_name1:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_id2">AUDIT_ID2 = #audit_id2:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_name2">AUDIT_NAME2 = #audit_name2:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_id3">AUDIT_ID3 = #audit_id3:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_name3">AUDIT_NAME3 = #audit_name3:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_id4">AUDIT_ID4 = #audit_id4:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_name4">AUDIT_NAME4 = #audit_name4:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="create_date">CREATE_DATE = #create_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="deal_status">DEAL_STATUS = #deal_status:SMALLINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="deal_date">DEAL_DATE = #deal_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="deal_name">DEAL_NAME = #deal_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="result">RESULT = #result:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:SMALLINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bak1">BAK1 = #bak1:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bak2">BAK2 = #bak2:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bak3">BAK3 = #bak3:VARCHAR#</isNotEmpty>
	</sql>

	<!-- 返回申请详情 -->
	<select id="selectKonkaSysAplication" resultClass="java.util.HashMap" parameterClass="konkaSysAplication" cacheModel="oneDayCache">
		select BACK_ID,to_char(s.create_date,'yyyy-MM-dd') create_date,WRITE_NAME,d.dept_name,NAME,c.C_NAME,
		s.TITLE,s.CONTENT,s.DEAL_STATUS,to_char(a1.AUDIT_DATETIME,'yyyy-MM-dd hh24:mi:ss') DEAL_DATE,a1.AUDIT_USER DEAL_NAME,a1.AUDIT_COMMENT RESULT,s.LINK_ID from KONKA_SYS_APLICATION s
		LEFT join KONKA_DEPT d on s.DEPT_ID=d.DEPT_ID
		LEFT JOIN (select C_INDEX,C_NAME from KONKA_CATEGORY where C_TYPE=84) c on s.type=c.c_index
		left join (select t.LINK_ID, t.AUDIT_RESULT,t.AUDIT_COMMENT,t.AUDIT_USER, t.AUDIT_DATETIME from KONKAOA_FILES_AUDIT_NODE t 
		where t.id in (select max(m.id) from KONKAOA_FILES_AUDIT_NODE m where m.node_type=2 and m.AUDIT_RESULT is not null group by m.LINK_ID)) a1
        on a1.LINK_ID=s.LINK_ID
		where s.is_del=0 
		<isNotEmpty prepend=" and " property="id">s.ID = #id:BIGINT#</isNotEmpty>
	</select>

	<select id="selectKonkaSysAplicationList" resultMap="konkaSysAplicationResultForList" parameterClass="konkaSysAplication" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_SYS_APLICATION where 1 = 1
		<include refid="sf-konkaSysAplication" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaSysAplicationCount" resultClass="long" parameterClass="konkaSysAplication" cacheModel="oneDayCache">
		select count(*) from KONKA_SYS_APLICATION 
		 where is_del=0 
		<include refid="sf-konkaSysAplication" />
		<isNotEmpty prepend=" and " property="map.fgs_dept_value">dept_id = #map.fgs_dept_value#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.filter_by_ywy_id_eq">
			USER_ID = #map.filter_by_ywy_id_eq#
		</isNotEmpty> 
	</select>
	
	<!-- 需求申请列表 -->
	<select id="selectKonkaSysAplicationPaginatedList" resultClass="java.util.HashMap" parameterClass="konkaSysAplication" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select ID,BACK_ID,TITLE,c.C_NAME,s.LINK_ID,CONTENT,s.DEPT_ID,NAME,to_char(s.CREATE_DATE,'yyyy-MM-dd hh24:mi:ss') CREATE_DATE,DEAL_STATUS,
			d.DEPT_NAME,s.bak1,a.AUDIT_USER_ID,a.AUDIT_RESULT,a.AUDIT_LEVEL from KONKA_SYS_APLICATION S
		LEFT join KONKA_DEPT d on s.DEPT_ID=d.DEPT_ID
		LEFT JOIN (select C_INDEX,C_NAME from KONKA_CATEGORY where C_TYPE=84) c on s.type=c.c_index
		left join (select LINK_ID,AUDIT_USER_ID,AUDIT_RESULT,AUDIT_LEVEL from KONKAOA_FILES_AUDIT_NODE t where t.NODE_TYPE=2 
         <isNotEmpty prepend=" and " property="map.user_id">t.AUDIT_USER_ID = #map.user_id:BIGINT#</isNotEmpty>
         ) a on s.link_id=a.link_id
		 where s.is_del=0 
		<include refid="sf-konkaSysAplication" />
		<isNotEmpty prepend=" and " property="map.wait_audit">a.AUDIT_RESULT is null and a.LINK_ID is not null</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.have_audit">a.AUDIT_RESULT is not null</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.fgs_dept_value">S.dept_id = #map.fgs_dept_value#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.filter_by_ywy_id_eq">
			S.USER_ID = #map.filter_by_ywy_id_eq#
		</isNotEmpty> 
		<!-- order by ID asc -->
		order by s.CREATE_DATE desc
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaSysAplication" parameterClass="konkaSysAplication">
		<selectKey resultClass="long" keyProperty="id">select seq_KONKA_SYS_APLICATION.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_SYS_APLICATION (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="back_id">BACK_ID</isNotNull>	
			<isNotNull prepend="," property="user_id">USER_ID</isNotNull>	
			<isNotNull prepend="," property="write_name">WRITE_NAME</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="name">NAME</isNotNull>	
			<isNotNull prepend="," property="type">TYPE</isNotNull>	
			<isNotNull prepend="," property="title">TITLE</isNotNull>	
			<isNotNull prepend="," property="content">CONTENT</isNotNull>	
			<isNotNull prepend="," property="accessory">ACCESSORY</isNotNull>	
			<isNotNull prepend="," property="audit_id1">AUDIT_ID1</isNotNull>	
			<isNotNull prepend="," property="audit_name1">AUDIT_NAME1</isNotNull>	
			<isNotNull prepend="," property="audit_id2">AUDIT_ID2</isNotNull>	
			<isNotNull prepend="," property="audit_name2">AUDIT_NAME2</isNotNull>	
			<isNotNull prepend="," property="audit_id3">AUDIT_ID3</isNotNull>	
			<isNotNull prepend="," property="audit_name3">AUDIT_NAME3</isNotNull>	
			<isNotNull prepend="," property="audit_id4">AUDIT_ID4</isNotNull>	
			<isNotNull prepend="," property="audit_name4">AUDIT_NAME4</isNotNull>	
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>	
			<isNotNull prepend="," property="create_date">CREATE_DATE</isNotNull>	
			<isNotNull prepend="," property="deal_status">DEAL_STATUS</isNotNull>	
			<isNotNull prepend="," property="deal_date">DEAL_DATE</isNotNull>	
			<isNotNull prepend="," property="deal_name">DEAL_NAME</isNotNull>	
			<isNotNull prepend="," property="result">RESULT</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="bak1">BAK1</isNotNull>	
			<isNotNull prepend="," property="bak2">BAK2</isNotNull>	
			<isNotNull prepend="," property="bak3">BAK3</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="back_id">#back_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="user_id">#user_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="write_name">#write_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="name">#name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="type">#type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="title">#title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="content">#content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="accessory">#accessory:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id1">#audit_id1:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name1">#audit_name1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id2">#audit_id2:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name2">#audit_name2:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id3">#audit_id3:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name3">#audit_name3:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id4">#audit_id4:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name4">#audit_name4:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="create_date">#create_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="deal_status">#deal_status:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="deal_date">#deal_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="deal_name">#deal_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="result">#result:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="bak1">#bak1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bak2">#bak2:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bak3">#bak3:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaSysAplication" parameterClass="KonkaSysAplication">
		update KONKA_SYS_APLICATION
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="back_id">BACK_ID = #back_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="user_id">USER_ID = #user_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="write_name">WRITE_NAME = #write_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="name">NAME = #name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="type">TYPE = #type:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="title">TITLE = #title:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="content">CONTENT = #content:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="accessory">ACCESSORY = #accessory:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id1">AUDIT_ID1 = #audit_id1:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name1">AUDIT_NAME1 = #audit_name1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id2">AUDIT_ID2 = #audit_id2:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name2">AUDIT_NAME2 = #audit_name2:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id3">AUDIT_ID3 = #audit_id3:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name3">AUDIT_NAME3 = #audit_name3:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_id4">AUDIT_ID4 = #audit_id4:BIGINT#</isNotNull>
			<isNotNull prepend="," property="audit_name4">AUDIT_NAME4 = #audit_name4:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="create_date">CREATE_DATE = #create_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="deal_status">DEAL_STATUS = #deal_status:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="deal_date">DEAL_DATE = #deal_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="deal_name">DEAL_NAME = #deal_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="result">RESULT = #result:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="bak1">BAK1 = #bak1:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bak2">BAK2 = #bak2:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="bak3">BAK3 = #bak3:VARCHAR#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaSysAplication" parameterClass="KonkaSysAplication">
		delete from KONKA_SYS_APLICATION where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

	<update id="modifyAplicationStatus" parameterClass="KonkaSysAplication">
		update KONKA_SYS_APLICATION
		<dynamic prepend="set">
			<isNotNull prepend="," property="deal_status">DEAL_STATUS = #deal_status:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="bak1">bak1 = #bak1:SMALLINT#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="link_id">LINK_ID = #link_id:VARCHAR#</isNotEmpty>
	</update>
</sqlMap>