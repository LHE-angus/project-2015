<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

	<!-- @author Hui,Gang -->
	<!-- @version Build 2010-12-13 14:49:33 -->
<sqlMap namespace="FILES_AUDIT_NODE">

	<typeAlias alias="filesAuditNode" type="com.ebiz.mmt.domain.KonkaoaFilesAuditNode" />

	

	<resultMap id="filesAuditNodeResultForList" class="filesAuditNode">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="LINK_ID" property="link_id" jdbcType="DECIMAL" />
		<result column="AUDIT_NODE_NAME" property="audit_node_name" jdbcType="VARCHAR" />
		<result column="AUDIT_LEVEL" property="audit_level" jdbcType="DECIMAL" />
		<result column="AUDIT_USER" property="audit_user" jdbcType="VARCHAR" />
		<result column="AUDIT_USER_ID" property="audit_user_id" jdbcType="DECIMAL" />
		<result column="AGENT_AUDIT_USER" property="agent_audit_user" jdbcType="VARCHAR" />
		<result column="AGENT_AUDIT_USER_ID" property="agent_audit_user_id" jdbcType="DECIMAL" />
		<result column="AUDIT_RESULT" property="audit_result" jdbcType="DECIMAL" />
		<result column="AUDIT_COMMENT" property="audit_comment" jdbcType="VARCHAR" />
		<result column="AUDIT_DATETIME" property="audit_datetime" jdbcType="DATETIME" />
		<result column="AUDIT_TYPE" property="audit_type" jdbcType="DATETIME" />
		<result column="NODE_TYPE" property="node_type" jdbcType="DATETIME" />
		<result column="DEPT_ID" property="dept_id" jdbcType="DECIMAL" />
	</resultMap>

	<resultMap id="filesAuditNodeResultForView" class="filesAuditNode" extends="filesAuditNodeResultForList">
		<result column="ORG_NAME" property="map.org_name" jdbcType="DATETIME" />
	</resultMap>

	<resultMap id="filesAuditNodeResult" class="filesAuditNode" extends="filesAuditNodeResultForList">
	</resultMap>

	<sql id="sf-filesAuditNode">
		<isNotEmpty prepend=" and " property="id">ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_level">AUDIT_LEVEL = #audit_level:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_user">AUDIT_USER = #audit_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_user_id">AUDIT_USER_ID = #audit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_user">AGENT_AUDIT_USER = #agent_audit_user:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_node_name">AUDIT_NODE_NAME = #audit_node_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="agent_audit_user_id">AGENG_AUDIT_USER_ID = #agent_audit_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_result">AUDIT_RESULT = #audit_result:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_comment">AUDIT_COMMENT = #audit_comment:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="node_type">NODE_TYPE = #node_type:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.audit_result_not_null">AUDIT_RESULT is not null</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.audit_result_is_null">AUDIT_RESULT is null</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.is_audit">AUDIT_RESULT is not null</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.audit_node_name_like">AUDIT_NODE_NAME like '%' || #map.audit_node_name_like:VARCHAR# || '%'</isNotEmpty>
	</sql>

	<select id="selectKonkaoaFilesAuditNode" resultMap="filesAuditNodeResult" parameterClass="filesAuditNode" >
		select * from KONKAOA_FILES_AUDIT_NODE where 1 = 1
		<include refid="sf-filesAuditNode" />
		<![CDATA[and rownum<2 order by id desc]]>
	</select>

	<select id="selectKonkaoaFilesAuditNodeList" resultMap="filesAuditNodeResultForList" parameterClass="filesAuditNode">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKAOA_FILES_AUDIT_NODE where 1 = 1
		<isNotEmpty prepend=" and " property="map.audit_result_gt"><![CDATA[ AUDIT_RESULT > #map.audit_result_gt:DECIMAL#]]></isNotEmpty>
		<include refid="sf-filesAuditNode" />
<!-- 		有指定倒叙的那就倒叙 -->
		<isNotEmpty prepend="" property="map.order_by_id_desc">
		order by id desc
		</isNotEmpty >
<!-- 		没有就默认拍序 -->
		<isEmpty prepend="" property="map.order_by_id_desc">
		order by id asc
		</isEmpty>
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<!-- 审批节点倒序排 -->
	<select id="selectKonkaoaFilesAuditNodeListForView" resultMap="filesAuditNodeResultForView" parameterClass="filesAuditNode">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from 
		(select t.*, o.dept_name as org_name
  		from (select u.dept_id, f.id,
							f.link_id,
							f.audit_type,
							f.audit_level,
							f.audit_user,
							f.audit_user_id,
							f.agent_audit_user,
							f.agent_audit_user_id,
							f.audit_result,
							f.audit_comment,
							f.audit_datetime,
							f.audit_node_name,
							f.node_type
          	from KONKAOA_FILES_AUDIT_NODE f
          	left join konka_pe_prod_user u on f.audit_user_id = u.id
         where 1 = 1
         <isNotEmpty prepend=" and " property="link_id">f.LINK_ID = #link_id:DECIMAL#</isNotEmpty>
         <isNotEmpty prepend=" and " property="audit_type">f.AUDIT_TYPE = #audit_type:DECIMAL#</isNotEmpty>
         <isNotEmpty prepend=" and " property="map.is_audit">f.AUDIT_RESULT is not null</isNotEmpty>
         <isNotEmpty prepend=" and " property="map.audit_result_gt"><![CDATA[ f.AUDIT_RESULT > #map.audit_result_gt:DECIMAL#]]></isNotEmpty>
         ) t
  		left join KONKA_DEPT o on t.dept_id = o.dept_id)
		order by id desc
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaoaFilesAuditNodeCount" resultClass="long" parameterClass="filesAuditNode" >
		select count(*) from KONKAOA_FILES_AUDIT_NODE where 1 = 1
		<include refid="sf-filesAuditNode" />
	</select>

	<select id="selectKonkaoaFilesAuditNodePaginatedList" resultMap="filesAuditNodeResult" parameterClass="filesAuditNode"
		>
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKAOA_FILES_AUDIT_NODE where 1 = 1
		<include refid="sf-filesAuditNode" />
		<isNotEmpty property="map.is_audit_node_manager">order by ID desc</isNotEmpty>
		<isEmpty property="map.is_audit_node_manager">order by ID asc</isEmpty>
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaoaFilesAuditNode" parameterClass="filesAuditNode">
		<selectKey resultClass="long" keyProperty="id">select KONKA_FILES_AUDIT_NODE_SEQ.nextval as id from dual</selectKey>
		<![CDATA[insert into KONKAOA_FILES_AUDIT_NODE (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>
			<isNotNull prepend="," property="audit_level">AUDIT_LEVEL</isNotNull>
			<isNotNull prepend="," property="audit_user">AUDIT_USER</isNotNull>
			<isNotNull prepend="," property="audit_node_name">AUDIT_NODE_NAME</isNotNull>
			<isNotNull prepend="," property="audit_user_id">AUDIT_USER_ID</isNotNull>
			<isNotNull prepend="," property="agent_audit_user">AGENT_AUDIT_USER</isNotNull>
			<isNotNull prepend="," property="agent_audit_user_id">AGENT_AUDIT_USER_ID</isNotNull>
			<isNotNull prepend="," property="audit_result">AUDIT_RESULT</isNotNull>
			<isNotNull prepend="," property="audit_comment">AUDIT_COMMENT</isNotNull>
			<isNotNull prepend="," property="audit_type">AUDIT_TYPE</isNotNull>
			<isNotNull prepend="," property="audit_datetime">AUDIT_DATETIME</isNotNull>
			<isNotNull prepend="," property="node_type">NODE_TYPE</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_level">#audit_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user">#audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_node_name">#audit_node_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_user_id">#audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user">#agent_audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user_id">#agent_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_result">#audit_result:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_comment">#audit_comment:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_type">#audit_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_datetime">#audit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="node_type">#node_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:DECIMAL#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaoaFilesAuditNode" parameterClass="filesAuditNode">
		update KONKAOA_FILES_AUDIT_NODE
		<dynamic prepend="set">
			<isNotNull prepend="," property="audit_level">AUDIT_LEVEL = #audit_level:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_user">AUDIT_USER = #audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_user_id">AUDIT_USER_ID = #audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user">AGENT_AUDIT_USER = #agent_audit_user:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_node_name">AUDIT_NODE_NAME = #audit_node_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="agent_audit_user_id">AGENT_AUDIT_USER_ID = #agent_audit_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_result">AUDIT_RESULT = #audit_result:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="audit_comment">AUDIT_COMMENT = #audit_comment:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="audit_datetime">AUDIT_DATETIME = #audit_datetime:DATETIME#</isNotNull>
			<isNotNull prepend="," property="node_type">NODE_TYPE = #node_type:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:DECIMAL#</isNotNull>
		</dynamic>
		where LINK_ID = #link_id:DECIMAL# and AUDIT_USER_ID = #audit_user_id:DECIMAL#
		<isNotNull prepend=" and " property="map.is_null_comm">(AUDIT_RESULT is null or AUDIT_RESULT = 0)</isNotNull>
		<isNotNull prepend=" and " property="audit_level">AUDIT_LEVEL = #audit_level:DECIMAL#</isNotNull>
		<isNotNull prepend=" and " property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotNull>
	</update>

	<delete id="deleteKonkaoaFilesAuditNode" parameterClass="filesAuditNode">
		delete from KONKAOA_FILES_AUDIT_NODE where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
		<isNotEmpty prepend=" " property="link_id">LINK_ID = #link_id#</isNotEmpty>
       <isNotEmpty prepend=" " property="map.link_ids">
	 			link_id in
				<iterate close=")" open="(" conjunction="," property="map.link_ids">#map.link_ids[]#</iterate>
		 </isNotEmpty>
		<isNotEmpty prepend=" and " property="audit_type">AUDIT_TYPE = #audit_type#</isNotEmpty>
	</delete>

	<!-- 返回最后一个审批人的level -->
	<select id="selectMaxLevel" resultClass="long" parameterClass="filesAuditNode" >
		select AUDIT_USER_ID from KONKAOA_FILES_AUDIT_NODE where AUDIT_LEVEL=(select max(AUDIT_LEVEL) from KONKAOA_FILES_AUDIT_NODE 
		where 1 = 1 
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>)
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>
	</select>
	
	<!-- 查询需求申请审批结果列表 -->
	<select id="selecAuditList" resultClass="java.util.HashMap" parameterClass="filesAuditNode" cacheModel="oneDayCache">
		select decode(AUDIT_USER_ID,b.AUDIT_ID1,'部门主管',b.AUDIT_ID2,'分司领导',b.AUDIT_ID3,'总部领导',b.AUDIT_ID4,'处理人') role_name,
			AUDIT_USER,AUDIT_RESULT,AUDIT_COMMENT,to_CHAR(AUDIT_DATETIME,'yyyy-mm-dd hh24:mi:ss') as AUDIT_DATETIME from KONKAOA_FILES_AUDIT_NODE a
			left join KONKA_SYS_APLICATION b on a.link_id=b.link_id
			where 1=1 and node_type=2 
		<isNotEmpty prepend=" and " property="link_id">a.LINK_ID = #link_id:DECIMAL#</isNotEmpty>
	</select>
	
	<!-- 查询审批信息列表返回map -->
	<select id="getAuditInfoList" resultClass="java.util.HashMap" parameterClass="filesAuditNode" cacheModel="oneDayCache">
		select ID, LINK_ID, AUDIT_TYPE, AUDIT_LEVEL, AUDIT_USER, AUDIT_USER_ID, AGENT_AUDIT_USER, AGENT_AUDIT_USER_ID, 
			AUDIT_RESULT, AUDIT_COMMENT, AUDIT_NODE_NAME, NODE_TYPE, DEPT_ID,
			to_char(AUDIT_DATETIME,'yyyy-mm-dd hh24:mi:ss') as AUDIT_DATETIME
		from KONKAOA_FILES_AUDIT_NODE
		where 1=1 
		<include refid="sf-filesAuditNode"/>
	</select>
	
	<!-- 待审客户中查看审批记录 -->
	<select id="selectKonkaoaFilesAuditNodeListForCust" resultClass="java.util.HashMap" parameterClass="filesAuditNode" cacheModel="oneDayCache">
		select AUDIT_USER,AGENT_AUDIT_USER,AUDIT_RESULT,AUDIT_COMMENT,AUDIT_DATETIME,AUDIT_NODE_NAME from KONKAOA_FILES_AUDIT_NODE
		where 1=1 
		<include refid="sf-filesAuditNode"/>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="audit_type">AUDIT_TYPE = #audit_type:DECIMAL#</isNotEmpty>
        <isNotEmpty prepend=" and " property="map.is_audit">AUDIT_RESULT is not null</isNotEmpty>
	</select>
	
	<!-- 更新审批记录，将前记录设置为旧记录 -->
	<update id="updateOldNode" parameterClass="filesAuditNode">
		update KONKAOA_FILES_AUDIT_NODE set AUDIT_LEVEL = 0
		where LINK_ID = #link_id:DECIMAL# and AUDIT_USER_ID = #audit_user_id:DECIMAL#
	</update>
</sqlMap>