<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_ORDER_PLAN">

	<typeAlias alias="konkaOrderPlan" type="com.ebiz.mmt.domain.KonkaOrderPlan" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaOrderPlan" />
		<flushOnExecute statement="updateKonkaOrderPlan" />
		<flushOnExecute statement="deleteKonkaOrderPlan" />
	</cacheModel>

	<resultMap id="konkaOrderPlanResultForList" class="konkaOrderPlan">
		<result column="ID" property="id" jdbcType="DECIMAL" />
		<result column="R3_CODE" property="r3_code" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="customer_name" jdbcType="VARCHAR" />
		<result column="PLAN_YEAR" property="plan_year" jdbcType="DECIMAL" />
		<result column="PLAN_MONTH" property="plan_month" jdbcType="DECIMAL" />
		<result column="PD_ID" property="pd_id" jdbcType="DECIMAL" />
		<result column="PD_NAME" property="pd_name" jdbcType="VARCHAR" />
		<result column="LAST_STOCK_NUM" property="last_stock_num" jdbcType="DECIMAL" />
		<result column="PLAN_STOCK_NUM" property="plan_stock_num" jdbcType="DECIMAL" />
		<result column="PLAN_SALE_NUM" property="plan_sale_num" jdbcType="DECIMAL" />
		<result column="ADD_DATE" property="add_date" jdbcType="TIMESTAMP" />
		<result column="ADD_USER_ID" property="add_user_id" jdbcType="DECIMAL" />
		<result column="ADD_USER_NAME" property="add_user_name" jdbcType="VARCHAR" />
		<result column="MODIFY_DATE" property="modify_date" jdbcType="TIMESTAMP" />
		<result column="MODIFY_USER_ID" property="modify_user_id" jdbcType="DECIMAL" />
		<result column="MODIFY_USER_NAME" property="modify_user_name" jdbcType="VARCHAR" />
		<result column="MEMO" property="memo" jdbcType="VARCHAR" />
	</resultMap>

	<resultMap id="konkaOrderPlanResult" class="konkaOrderPlan" extends="konkaOrderPlanResultForList">
	</resultMap>
	
	<!-- 管理端 -->
	<resultMap id="konkaOrderPlanForServerResult" class="konkaOrderPlan" extends="konkaOrderPlanResultForList">
	     <result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR"/>
	     <result column="DEPT_ID" property="map.dept_id" jdbcType="VARCHAR"/>
	     <result column="L4_DEPT_NAME" property="map.l4_dept_name" jdbcType="VARCHAR"/>
	     <result column="CUSTOMER_TYPE_NAME" property="map.customer_type_name" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 报表（渠道） -->
	<resultMap id="konkaOrderPlanStatementForChannel" class="konkaOrderPlan">
	     <result column="C_COMM" property="map.c_comm" jdbcType="VARCHAR"/>
	     <result column="C_NAME" property="map.c_name" jdbcType="VARCHAR"/>
	     <result column="LAST_STOCK_NUM" property="map.last_stock_num" jdbcType="VARCHAR"/>
	     <result column="STOCK" property="map.stock" jdbcType="VARCHAR"/>
	     <result column="PLAN_STOCK_NUM" property="map.plan_stock_num" jdbcType="VARCHAR"/>
	     <result column="COME_NUM" property="map.come_num" jdbcType="VARCHAR"/>
	     <result column="PLAN_SALE_NUM" property="map.plan_sale_num" jdbcType="VARCHAR"/>
	     <result column="OUT_NUM" property="map.out_num" jdbcType="VARCHAR"/>
	     <result column="STOCK_DIF" property="map.stock_dif" jdbcType="VARCHAR"/>
	     <result column="CUSTOMER_TYPE" property="map.customer_type" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 报表（客户） -->
	<resultMap id="konkaOrderPlanStatementForCustomer" class="konkaOrderPlan">
	     <result column="LAST_STOCK_NUM" property="map.last_stock_num" jdbcType="VARCHAR"/>
	     <result column="PLAN_STOCK_NUM" property="map.plan_stock_num" jdbcType="VARCHAR"/>
	     <result column="R3_CODE" property="map.r3_code" jdbcType="VARCHAR"/>
	     <result column="PLAN_SALE_NUM" property="map.plan_sale_num" jdbcType="VARCHAR"/>
	     <result column="CUSTOMER_NAME" property="map.customer_name" jdbcType="VARCHAR"/>
	     <result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR"/>
	     <result column="L4_DEPT_NAME" property="map.l4_dept_name" jdbcType="VARCHAR"/>
	     <result column="L5_DEPT_NAME" property="map.l5_dept_name" jdbcType="VARCHAR"/>
	     <result column="YWY_USER_NAME" property="map.ywy_user_name" jdbcType="VARCHAR"/>
	     <result column="CUSTOMER_TYPE_NAME" property="map.customer_type_name" jdbcType="VARCHAR"/>
	     <result column="PAR_CUSTOMER_TYPE_NAME" property="map.par_customer_type_name" jdbcType="VARCHAR"/>
	     <result column="COME_NUM" property="map.come_num" jdbcType="VARCHAR"/>
	     <result column="OUT_NUM" property="map.out_num" jdbcType="VARCHAR"/>
	     <result column="STOCK" property="map.stock" jdbcType="VARCHAR"/>
	     <result column="STOCK_DIF" property="map.stock_dif" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 报表（机型） -->
	<resultMap id="konkaOrderPlanStatementForModels" class="konkaOrderPlan">
	     <result column="LAST_STOCK_NUM" property="map.last_stock_num" jdbcType="VARCHAR"/>
	     <result column="PLAN_STOCK_NUM" property="map.plan_stock_num" jdbcType="VARCHAR"/>
	     <result column="DEPT_NAME" property="map.dept_name" jdbcType="VARCHAR"/>
	     <result column="PLAN_SALE_NUM" property="map.plan_sale_num" jdbcType="VARCHAR"/>
	     <result column="PD_NAME" property="map.pd_name" jdbcType="VARCHAR"/>
	     <result column="COME_NUM" property="map.come_num" jdbcType="VARCHAR"/>
	     <result column="OUT_NUM" property="map.out_num" jdbcType="VARCHAR"/>
	     <result column="STOCK" property="map.stock" jdbcType="VARCHAR"/>
	     <result column="STOCK_DIF" property="map.stock_dif" jdbcType="VARCHAR"/>
	</resultMap>
	
	<sql id="sf-konkaOrderPlan">
		<isNotEmpty prepend=" and " property="id">a.ID = #id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="r3_code">a.R3_CODE = #r3_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="customer_name">a.CUSTOMER_NAME = #customer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_year">a.PLAN_YEAR = #plan_year:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_month">a.PLAN_MONTH = #plan_month:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_id">a.PD_ID = #pd_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="pd_name">a.PD_NAME = #pd_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="last_stock_num">a.LAST_STOCK_NUM = #last_stock_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_stock_num">a.PLAN_STOCK_NUM = #plan_stock_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="plan_sale_num">a.PLAN_SALE_NUM = #plan_sale_num:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_date">a.ADD_DATE = #add_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_id">a.ADD_USER_ID = #add_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="add_user_name">a.ADD_USER_NAME = #add_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="modify_date">a.MODIFY_DATE = #modify_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="modify_user_id">a.MODIFY_USER_ID = #modify_user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="modify_user_name">a.MODIFY_USER_NAME = #modify_user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="memo">a.MEMO = #memo:VARCHAR#</isNotEmpty>
		
		
		<isNotEmpty prepend=" and " property="map.add_date_s"><![CDATA[ a.ADD_DATE >= to_date(#map.add_date_s#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.add_date_e"><![CDATA[ a.ADD_DATE <= to_date(#map.add_date_e#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.modify_date_s"><![CDATA[ a.MODIFY_DATE >= to_date(#map.modify_date_s#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.modify_date_e"><![CDATA[ a.MODIFY_DATE <= to_date(#map.modify_date_e#,'yyyy-MM-dd hh24:mi:ss')]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.customer_name_like">b.CUSTOMER_NAME like '%' || #map.customer_name_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.r3_code_like">a.R3_CODE like '%'|| #map.r3_code_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.pd_name_like">a.PD_NAME like '%'|| #map.pd_name_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.add_user_name_like">a.ADD_USER_NAME like '%'|| #map.add_user_name_like# || '%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id1">b.PAR_CUSTOMER_TYPE = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">b.CUSTOMER_TYPE = #map.category_id2#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_id">b.DEPT_ID =#map.dept_id#</isNotEmpty>
		 <isNotEmpty prepend=" and " property="map.fgs_dept_value"> b.dept_id = #map.fgs_dept_value#</isNotEmpty>
		 <isNotEmpty prepend=" and " property="map.dept_id_start">
			(b.cur_dept_id is not null and  ee.cur_dept_id in (
						select dept_id from konka_dept start with dept_id in (
						SELECT DISTINCT (dept_id)
		  							FROM KONKA_ROLE_DATA_LEVEL
		 							WHERE role_id IN (SELECT role_id
		                     			FROM KONKA_PE_ROLE_USER
		                    			WHERE user_id = #map.session_user_id#)
						) or dept_id = #map.dept_id_start# 
						connect by prior dept_id = par_id 
					)
			)
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.filter_by_ywy_id_eq">
			b.user_id = #map.filter_by_ywy_id_eq#
		</isNotEmpty>
	</sql>

	<select id="selectKonkaOrderPlan" resultMap="konkaOrderPlanResult" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select * from KONKA_ORDER_PLAN a where 1 = 1
		<include refid="sf-konkaOrderPlan" />
	</select>

	<select id="selectKonkaOrderPlanList" resultMap="konkaOrderPlanResultForList" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_ORDER_PLAN a where 1 = 1
		<include refid="sf-konkaOrderPlan" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaOrderPlanCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) from KONKA_ORDER_PLAN a where 1 = 1
		<include refid="sf-konkaOrderPlan" />
	</select>

	<select id="selectKonkaOrderPlanPaginatedList" resultMap="konkaOrderPlanResult" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_ORDER_PLAN a where 1 = 1
		<include refid="sf-konkaOrderPlan" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	
	
	<!-- 进货计划上报（管理端） 2014.11.20 分页 -->
    <select id="selectKonkaOrderPlanForServerCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) from KONKA_ORDER_PLAN a 
		left join MV_ORG_OF_CUSTOMER_ALL b on b.R3_CODE=a.R3_CODE
		where 1 = 1		
		<include refid="sf-konkaOrderPlan" />
	</select>
	
	<!-- 进货计划上报（管理端） 2014.11.20 查询-->
	<select id="selectKonkaOrderPlanForServerPaginatedList" resultMap="konkaOrderPlanForServerResult" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
	    <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.*,b.DEPT_ID,b.DEPT_NAME,b.l4_dept_name,b.CUSTOMER_TYPE_NAME from KONKA_ORDER_PLAN a 
	    left join MV_ORG_OF_CUSTOMER_ALL b on b.R3_CODE=a.R3_CODE
		where 1 = 1
		<include refid="sf-konkaOrderPlan" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 进货计划上报（客户端） 2014.11.20 分页 -->
    <select id="selectKonkaOrderPlanForCustomerCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) from KONKA_ORDER_PLAN a 
		where 1 = 1		
		<include refid="sf-konkaOrderPlan" />
	</select>
	
	<!-- 进货计划上报（客户端） 2014.11.20 查询-->
	<select id="selectKonkaOrderPlanForCustomerPaginatedList" resultMap="konkaOrderPlanResultForList" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
	    <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select a.* from KONKA_ORDER_PLAN a 
		where 1 = 1
		<include refid="sf-konkaOrderPlan" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 进货计划报表（渠道） 2014.12.1 分页 -->
    <select id="selectKonkaOrderPlanStatementForChannelCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) from KONKA_CATEGORY   where C_TYPE =10 and PAR_INDEX not in (60,50,91)
		<isNotEmpty prepend=" and " property="map.category_id1">par_index = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">c_index = #map.category_id2#</isNotEmpty>	
	</select>
	
	<!-- 进货计划报表（渠道） 2014.12.1 查询-->
	<select id="selectKonkaOrderPlanStatementForChannelPaginatedList" resultMap="konkaOrderPlanStatementForChannel" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
	    <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
	    select e.C_COMM,e.C_NAME,f.* from KONKA_CATEGORY e left join 
        (SELECT b.CUSTOMER_TYPE,
                sum (a.LAST_STOCK_NUM) AS last_stock_num,
                sum (a.PLAN_STOCK_NUM) AS plan_stock_num,
                sum (a.PLAN_SALE_NUM) as plan_sale_num,
                sum (c.come_num) AS come_num,
                sum (c.OUT_NUM) AS out_num,
                sum ( (c.init_num+c.COME_NUM - c.OUT_NUM)) AS stock,
                sum ( ( (c.init_num+c.COME_NUM - c.OUT_NUM) - a.LAST_STOCK_NUM)) stock_dif
                FROM MV_ORG_OF_CUSTOMER_ALL b
                left join  konka_order_plan a  on a.R3_CODE = b.R3_CODE  and  a.PLAN_YEAR = #map.plan_year:DECIMAL#
                and a.PLAN_MONTH = #map.plan_month:DECIMAL# 
                left join J_STOCKS_SUMMARY c on b.r3_code = c.R3_CODE  and c.type=1   
                and to_char (c.ADD_DATE, 'yyyy') = #map.plan_year:DECIMAL# 
                and to_char (c.ADD_DATE, 'mm') = #map.plan_month:DECIMAL#
                where 1=1 
        <isNotEmpty prepend=" and " property="map.category_id1">b.par_customer_type = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">b.customer_type = #map.category_id2#</isNotEmpty>   
		GROUP BY b.CUSTOMER_TYPE) f
		on e.C_INDEX = f.CUSTOMER_TYPE
		where e.C_TYPE =10 and e.PAR_INDEX not in (60,50,91)
		 <isNotEmpty prepend=" and " property="map.category_id1">e.par_index = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">e.c_index = #map.category_id2#</isNotEmpty>	 
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 进货计划报表（客户） 2014.12.1 分页 -->
    <select id="selectKonkaOrderPlanStatementForCustomerCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) FROM MV_ORG_OF_CUSTOMER_ALL b
	LEFT JOIN  konka_order_plan a
	ON a.R3_CODE = b.R3_CODE
	and a.PLAN_YEAR = #map.plan_year:DECIMAL# 
	AND a.PLAN_MONTH = #map.plan_month:DECIMAL#
	LEFT JOIN J_STOCKS_SUMMARY c
	ON b.r3_code = c.R3_CODE  and c.type=1  
	AND to_char (c.ADD_DATE, 'yyyy') = #map.plan_year:VARCHAR#
	AND to_char (c.ADD_DATE, 'mm') = #map.plan_month:VARCHAR#
	WHERE 1=1
		<include refid="sf-konkaOrderPlan" />
	</select>
	
	
	<!-- 进货计划报表（客户） 2014.12.1 查询-->
	<select id="selectKonkaOrderPlanStatementForCustomerPaginatedList" resultMap="konkaOrderPlanStatementForCustomer" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
	    <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
	SELECT a.R3_CODE, b.CUSTOMER_NAME,b.DEPT_NAME,b.L4_DEPT_NAME,b.L5_DEPT_NAME,
	       b.YWY_USER_NAME,b.CUSTOMER_TYPE_NAME,b.PAR_CUSTOMER_TYPE_NAME,
	       a.PD_NAME,a.PLAN_YEAR,a.PLAN_MONTH,b.CUSTOMER_TYPE,	a.LAST_STOCK_NUM,
	       a.PLAN_STOCK_NUM,a.PLAN_SALE_NUm,
	       c.come_num AS come_num,c.OUT_NUM AS OUT_NUM,(c.init_num+c.COME_NUM - c.OUT_NUM) AS stock,
	       ((c.init_num+c.COME_NUM - c.OUT_NUM) - a.LAST_STOCK_NUM) stock_dif
	       FROM MV_ORG_OF_CUSTOMER_ALL b
	       LEFT JOIN  konka_order_plan a
	       ON a.R3_CODE = b.R3_CODE
	       and a.PLAN_YEAR = #map.plan_year:DECIMAL#
	       AND a.PLAN_MONTH = #map.plan_month:DECIMAL#
	       LEFT JOIN J_STOCKS_SUMMARY c
	       ON b.r3_code = c.R3_CODE  and c.type=1  
	       AND to_char (c.ADD_DATE, 'yyyy') = #map.plan_year:VARCHAR#
	       AND to_char (c.ADD_DATE, 'mm') = #map.plan_month:VARCHAR#
	       WHERE 1=1 
		   <include refid="sf-konkaOrderPlan" />
		   <!-- order by ID asc -->
		   <![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 进货计划报表（机型） 2014.12.1 分页 -->
    <select id="selectKonkaOrderPlanStatementForModelsCount" resultClass="long" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
		select count(*) FROM konka_order_plan a
        LEFT JOIN  MV_ORG_OF_CUSTOMER_ALL b 
        ON a.R3_CODE = b.R3_CODE  and a.PLAN_YEAR = #map.plan_year:DECIMAL# AND a.PLAN_MONTH = #map.plan_month:DECIMAL#
        LEFT JOIN J_STOCKS_SUMMARY c
        ON b.r3_code = c.R3_CODE  AND a.PD_ID = c.GOODS_ID  and c.type=1  
        AND to_char (c.ADD_DATE, 'yyyy') = #map.plan_year:VARCHAR#
        AND to_char (c.ADD_DATE, 'mm') = #map.plan_month:VARCHAR#
		where 1=1 
		<isNotEmpty prepend=" and " property="map.category_id1">b.par_customer_type = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">b.customer_type = #map.category_id2#</isNotEmpty>	
		<include refid="sf-konkaOrderPlan" />
	</select>
	
	<!-- 进货计划报表（机型） 2014.12.1 查询-->
	<select id="selectKonkaOrderPlanStatementForModelsPaginatedList" resultMap="konkaOrderPlanStatementForModels" parameterClass="konkaOrderPlan" cacheModel="oneDayCache">
	    <![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
				SELECT b.dept_name,a.PD_NAME,sum (a.LAST_STOCK_NUM) AS last_stock_num,
				sum (a.PLAN_STOCK_NUM) AS PLAN_STOCK_NUM,sum (a.PLAN_SALE_NUm) as
				PLAN_SALE_NUM,
				sum (c.come_num) AS come_num,sum (c.OUT_NUM) AS
				OUT_NUM,sum((c.init_num+c.COME_NUM - c.OUT_NUM)) AS stock,
				sum (((c.init_num+c.COME_NUM - c.OUT_NUM) - a.LAST_STOCK_NUM)) stock_dif
				FROM  konka_order_plan a
				LEFT JOIN  MV_ORG_OF_CUSTOMER_ALL b
				ON a.R3_CODE = b.R3_CODE
				AND a.PLAN_YEAR = #map.plan_year:DECIMAL#
				AND a.PLAN_MONTH = #map.plan_month:DECIMAL#
				LEFT JOIN J_STOCKS_SUMMARY c
				ON b.r3_code = c.R3_CODE AND a.PD_ID = c.GOODS_ID and c.type=1
				AND to_char (c.ADD_DATE, 'yyyy') = #map.plan_year:VARCHAR#
				AND to_char (c.ADD_DATE, 'mm') = #map.plan_month:VARCHAR#
				WHERE 1=1
        <include refid="sf-konkaOrderPlan" />
        <isNotEmpty prepend=" and " property="map.category_id1">b.par_customer_type = #map.category_id1#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.category_id2">b.customer_type = #map.category_id2#</isNotEmpty>   
		GROUP BY b.DEPT_ID,dept_name,a.PD_NAME		
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	

	<insert id="insertKonkaOrderPlan" parameterClass="konkaOrderPlan">
		<selectKey resultClass="long" keyProperty="id">select seq_konka_order_plan.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_ORDER_PLAN (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="r3_code">R3_CODE</isNotNull>	
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME</isNotNull>	
			<isNotNull prepend="," property="plan_year">PLAN_YEAR</isNotNull>	
			<isNotNull prepend="," property="plan_month">PLAN_MONTH</isNotNull>	
			<isNotNull prepend="," property="pd_id">PD_ID</isNotNull>	
			<isNotNull prepend="," property="pd_name">PD_NAME</isNotNull>	
			<isNotNull prepend="," property="last_stock_num">LAST_STOCK_NUM</isNotNull>	
			<isNotNull prepend="," property="plan_stock_num">PLAN_STOCK_NUM</isNotNull>	
			<isNotNull prepend="," property="plan_sale_num">PLAN_SALE_NUM</isNotNull>	
			<isNotNull prepend="," property="add_date">ADD_DATE</isNotNull>	
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID</isNotNull>	
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="modify_date">MODIFY_DATE</isNotNull>	
			<isNotNull prepend="," property="modify_user_id">MODIFY_USER_ID</isNotNull>	
			<isNotNull prepend="," property="modify_user_name">MODIFY_USER_NAME</isNotNull>	
			<isNotNull prepend="," property="memo">MEMO</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">#r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">#customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="plan_year">#plan_year:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_month">#plan_month:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">#pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_name">#pd_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="last_stock_num">#last_stock_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_stock_num">#plan_stock_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_sale_num">#plan_sale_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">#add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">#add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">#add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="modify_date">#modify_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="modify_user_id">#modify_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="modify_user_name">#modify_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="memo">#memo:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateKonkaOrderPlan" parameterClass="KonkaOrderPlan">
		update KONKA_ORDER_PLAN
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="r3_code">R3_CODE = #r3_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="customer_name">CUSTOMER_NAME = #customer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="plan_year">PLAN_YEAR = #plan_year:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_month">PLAN_MONTH = #plan_month:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_id">PD_ID = #pd_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="pd_name">PD_NAME = #pd_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="last_stock_num">LAST_STOCK_NUM = #last_stock_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_stock_num">PLAN_STOCK_NUM = #plan_stock_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="plan_sale_num">PLAN_SALE_NUM = #plan_sale_num:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_date">ADD_DATE = #add_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="add_user_id">ADD_USER_ID = #add_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="add_user_name">ADD_USER_NAME = #add_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="modify_date">MODIFY_DATE = #modify_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="modify_user_id">MODIFY_USER_ID = #modify_user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="modify_user_name">MODIFY_USER_NAME = #modify_user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="memo">MEMO = #memo:VARCHAR#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>

	<delete id="deleteKonkaOrderPlan" parameterClass="KonkaOrderPlan">
		delete from KONKA_ORDER_PLAN where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>