<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="KONKA_YW_HZ_TJ">

	<typeAlias alias="konkaYwHzTj" type="com.ebiz.mmt.domain.KonkaYwHzTj" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertKonkaYwHzTj" />
		<flushOnExecute statement="updateKonkaYwHzTj" />
		<flushOnExecute statement="deleteKonkaYwHzTj" />
	</cacheModel>

	<resultMap id="konkaYwHzTjResultForList" class="konkaYwHzTj">
		<result column="USER_ID" property="user_id" jdbcType="DECIMAL" />
		<result column="USER_NAME" property="user_name" jdbcType="VARCHAR" />
		<result column="DEPT_ID" property="dept_id" jdbcType="BIGINT" />
		<result column="DEPT_ONE" property="dept_one" jdbcType="BIGINT" />
		<result column="DEPT_NAME_ONE" property="dept_name_one" jdbcType="VARCHAR" />
		<result column="DEPT_TWO" property="dept_two" jdbcType="BIGINT" />
		<result column="DEPT_NAME_TWO" property="dept_name_two" jdbcType="VARCHAR" />
		<result column="DEPT_THREE" property="dept_three" jdbcType="BIGINT" />
		<result column="DEPT_NAME_THREE" property="dept_name_three" jdbcType="VARCHAR" />
		<result column="JH_VISIT_CUST_COUNT" property="jh_visit_cust_count" jdbcType="INTEGER" />
		<result column="JH_VISIT_SHOP_COUNT" property="jh_visit_shop_count" jdbcType="INTEGER" />
		<result column="JH_VISIT_COUNT" property="jh_visit_count" jdbcType="INTEGER" />
		<result column="BF_COUNT" property="bf_count" jdbcType="INTEGER" />
		<result column="BF_CUST_COUNT" property="bf_cust_count" jdbcType="INTEGER" />
		<result column="BF_SHOP_COUNT" property="bf_shop_count" jdbcType="INTEGER" />
		<result column="ZC_CUST_VISIT_COUNT" property="zc_cust_visit_count" jdbcType="INTEGER" />
		<result column="ZC_SHOP_VISIT_COUNT" property="zc_shop_visit_count" jdbcType="INTEGER" />
		<result column="CS_CUST_VISIT_COUNT" property="cs_cust_visit_count" jdbcType="INTEGER" />
		<result column="CS_SHOP_VISIT_COUNT" property="cs_shop_visit_count" jdbcType="INTEGER" />
		<result column="JH_DEV_CUST_COUNT" property="jh_dev_cust_count" jdbcType="INTEGER" />
		<result column="KT_CUST_COUNT" property="kt_cust_count" jdbcType="INTEGER" />
		<result column="KT_CUST_VISIT_COUNT" property="kt_cust_visit_count" jdbcType="INTEGER" />
		<result column="CUSTBFB" property="custbfb" jdbcType="DECIMAL" />
		<result column="SHOPBFB" property="shopbfb" jdbcType="DECIMAL" />
		<result column="BF_BFB" property="bf_bfb" jdbcType="DECIMAL" />
		<result column="UPDATE_TIME" property="update_time" jdbcType="TIMESTAMP" />
		<result column="LAST_UPDATE_TIME" property="last_update_time" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="konkaYwHzTjResult" class="konkaYwHzTj" extends="konkaYwHzTjResultForList">
	</resultMap>
    <resultMap id="konkaYwHzTjLastTimeResult" class="konkaYwHzTj" extends="konkaYwHzTjResultForList">
        <result column="LAST_TIME" property="map.last_time" jdbcType="TIMESTAMP" />
	</resultMap>
	<sql id="sf-konkaYwHzTj">
		<isNotEmpty prepend=" and " property="user_id">USER_ID = #user_id:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="user_name">USER_NAME = #user_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_id">DEPT_ID = #dept_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_one">DEPT_ONE = #dept_one:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name_one">DEPT_NAME_ONE = #dept_name_one:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_two">DEPT_TWO = #dept_two:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name_two">DEPT_NAME_TWO = #dept_name_two:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_three">DEPT_THREE = #dept_three:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="dept_name_three">DEPT_NAME_THREE = #dept_name_three:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="jh_visit_cust_count">JH_VISIT_CUST_COUNT = #jh_visit_cust_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="jh_visit_shop_count">JH_VISIT_SHOP_COUNT = #jh_visit_shop_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="jh_visit_count">JH_VISIT_COUNT = #jh_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bf_count">BF_COUNT = #bf_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bf_cust_count">BF_CUST_COUNT = #bf_cust_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bf_shop_count">BF_SHOP_COUNT = #bf_shop_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="zc_cust_visit_count">ZC_CUST_VISIT_COUNT = #zc_cust_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="zc_shop_visit_count">ZC_SHOP_VISIT_COUNT = #zc_shop_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cs_cust_visit_count">CS_CUST_VISIT_COUNT = #cs_cust_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cs_shop_visit_count">CS_SHOP_VISIT_COUNT = #cs_shop_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="jh_dev_cust_count">JH_DEV_CUST_COUNT = #jh_dev_cust_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="kt_cust_count">KT_CUST_COUNT = #kt_cust_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="kt_cust_visit_count">KT_CUST_VISIT_COUNT = #kt_cust_visit_count:INTEGER#</isNotEmpty>
		<isNotEmpty prepend=" and " property="custbfb">CUSTBFB = #custbfb:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="shopbfb">SHOPBFB = #shopbfb:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="bf_bfb">BF_BFB = #bf_bfb:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="update_time">UPDATE_TIME = #update_time:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="last_update_time">LAST_UPDATE_TIME = #last_update_time:TIMESTAMP#</isNotEmpty>
	</sql>

	<select id="selectKonkaYwHzTj" resultMap="konkaYwHzTjResult" parameterClass="konkaYwHzTj" cacheModel="oneDayCache">
		select * from KONKA_YW_HZ_TJ where 1 = 1
		<include refid="sf-konkaYwHzTj" />
	</select>
     <!--取得需要跟新的最后跟新时间-->
    <select id="selectLastUpdateTime" resultClass="java.util.HashMap" parameterClass="konkaYwHzTj" cacheModel="oneDayCache">
		select distinct tj.LAST_UPDATE_TIME from KONKA_YW_HZ_TJ tj where 1 = 1 
		<isNotEmpty prepend=" and " property="map.begin_time"><![CDATA[ tj.UPDATE_TIME >= to_date(#map.begin_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_time"><![CDATA[ tj.UPDATE_TIME <= to_date(#map.end_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
	</select>
	
	<select id="selectKonkaYwHzTjList" resultMap="konkaYwHzTjResultForList" parameterClass="konkaYwHzTj" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from KONKA_YW_HZ_TJ where 1 = 1
		<include refid="sf-konkaYwHzTj" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectKonkaYwHzTjCount" resultClass="long" parameterClass="konkaYwHzTj" cacheModel="oneDayCache">
		select count(*) from KONKA_YW_HZ_TJ where 1=1
		<isNotEmpty prepend=" and " property="map.user_name_like">
			USER_NAME like '%'
			||#map.user_name_like:VARCHAR# ||'%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.user_id">
			USER_ID
			=#map.user_id:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			DEPT_ONE=#map.par_dept_id:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_two">
			DEPT_TWO=#map.dept_two:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_three">
			DEPT_THREE=#map.dept_three:DECIMAL#
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			DEPT_ID in ( select
			dept_id from KONKA_DEPT start with dept_id =
			#map.par_dept_id:DECIMAL# connect by prior dept_id = par_id)
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_or_children_dept_id">
			DEPT_ID in ( select
			dept_id from KONKA_DEPT start with dept_id =
			#map.par_or_children_dept_id:DECIMAL# connect by prior dept_id =
			par_id)
	     </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_ids">
			USER_ID in (SELECT USER_ID FROM KONKA_PE_ROLE_USER WHERE ROLE_ID in
			<iterate close=")" open="(" conjunction="," property="map.role_ids">#map.role_ids[]#
			</iterate>
			)
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.begin_time"><![CDATA[ UPDATE_TIME >= to_date(#map.begin_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_time"><![CDATA[ UPDATE_TIME <= to_date(#map.end_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		
		<isNotEmpty prepend="" property="map.jh_visit_count">
			<isNotEmpty prepend=" and " property="map.yjh">
	             <![CDATA[  JH_VISIT_COUNT >0 ]]>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.wjh">
	            <![CDATA[  JH_VISIT_COUNT <= 0 ]]>
			</isNotEmpty>
		</isNotEmpty>
		
	</select>

	<select id="selectKonkaYwHzTjPaginatedList" resultMap="konkaYwHzTjResult" parameterClass="konkaYwHzTj" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from KONKA_YW_HZ_TJ where 1=1
		<isNotEmpty prepend=" and " property="map.user_name_like">
			USER_NAME like '%'
			||#map.user_name_like:VARCHAR# ||'%'
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.user_id">
			USER_ID
			=#map.user_id:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			DEPT_ONE=#map.par_dept_id:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_two">
			DEPT_TWO=#map.dept_two:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.dept_three">
			DEPT_THREE=#map.dept_three:DECIMAL#
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.par_dept_id">
			DEPT_ID in ( select
			dept_id from KONKA_DEPT start with dept_id =
			#map.par_dept_id:DECIMAL# connect by prior dept_id = par_id)
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.par_or_children_dept_id">
			DEPT_ID in ( select
			dept_id from KONKA_DEPT start with dept_id =
			#map.par_or_children_dept_id:DECIMAL# connect by prior dept_id =
			par_id)
	     </isNotEmpty>
		<isNotEmpty prepend=" and " property="map.role_ids">
			USER_ID in (SELECT USER_ID FROM KONKA_PE_ROLE_USER WHERE ROLE_ID in
			<iterate close=")" open="(" conjunction="," property="map.role_ids">#map.role_ids[]#
			</iterate>
			)
		</isNotEmpty>
		
		<isNotEmpty prepend=" and " property="map.begin_time"><![CDATA[ UPDATE_TIME >= to_date(#map.begin_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_time"><![CDATA[ UPDATE_TIME <= to_date(#map.end_time#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		
		<isNotEmpty prepend="" property="map.jh_visit_count">
			<isNotEmpty prepend=" and " property="map.yjh">
	             <![CDATA[  JH_VISIT_COUNT >0 ]]>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="map.wjh">
	            <![CDATA[  JH_VISIT_COUNT <= 0 ]]>
			</isNotEmpty>
		</isNotEmpty>
		<!--<include refid="sf-konkaYwHzTj" />-->
		 order by CUSTBFB desc, SHOPBFB desc 
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>

	<insert id="insertKonkaYwHzTj" parameterClass="konkaYwHzTj">
		<selectKey resultClass="long" keyProperty="id">select seq_xxx.nextval as id from dual </selectKey>
		<![CDATA[insert into KONKA_YW_HZ_TJ (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="user_id">USER_ID</isNotNull>	
			<isNotNull prepend="," property="user_name">USER_NAME</isNotNull>	
			<isNotNull prepend="," property="dept_id">DEPT_ID</isNotNull>	
			<isNotNull prepend="," property="dept_one">DEPT_ONE</isNotNull>	
			<isNotNull prepend="," property="dept_name_one">DEPT_NAME_ONE</isNotNull>	
			<isNotNull prepend="," property="dept_two">DEPT_TWO</isNotNull>	
			<isNotNull prepend="," property="dept_name_two">DEPT_NAME_TWO</isNotNull>	
			<isNotNull prepend="," property="dept_three">DEPT_THREE</isNotNull>	
			<isNotNull prepend="," property="dept_name_three">DEPT_NAME_THREE</isNotNull>	
			<isNotNull prepend="," property="jh_visit_cust_count">JH_VISIT_CUST_COUNT</isNotNull>	
			<isNotNull prepend="," property="jh_visit_shop_count">JH_VISIT_SHOP_COUNT</isNotNull>	
			<isNotNull prepend="," property="jh_visit_count">JH_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="bf_count">BF_COUNT</isNotNull>	
			<isNotNull prepend="," property="bf_cust_count">BF_CUST_COUNT</isNotNull>	
			<isNotNull prepend="," property="bf_shop_count">BF_SHOP_COUNT</isNotNull>	
			<isNotNull prepend="," property="zc_cust_visit_count">ZC_CUST_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="zc_shop_visit_count">ZC_SHOP_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="cs_cust_visit_count">CS_CUST_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="cs_shop_visit_count">CS_SHOP_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="jh_dev_cust_count">JH_DEV_CUST_COUNT</isNotNull>	
			<isNotNull prepend="," property="kt_cust_count">KT_CUST_COUNT</isNotNull>	
			<isNotNull prepend="," property="kt_cust_visit_count">KT_CUST_VISIT_COUNT</isNotNull>	
			<isNotNull prepend="," property="custbfb">CUSTBFB</isNotNull>	
			<isNotNull prepend="," property="shopbfb">SHOPBFB</isNotNull>	
			<isNotNull prepend="," property="bf_bfb">BF_BFB</isNotNull>	
			<isNotNull prepend="," property="update_time">UPDATE_TIME</isNotNull>	
			<isNotNull prepend="," property="last_update_time">LAST_UPDATE_TIME</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="user_id">#user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="user_name">#user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">#dept_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_one">#dept_one:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_one">#dept_name_one:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_two">#dept_two:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_two">#dept_name_two:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_three">#dept_three:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_three">#dept_name_three:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="jh_visit_cust_count">#jh_visit_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_visit_shop_count">#jh_visit_shop_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_visit_count">#jh_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_count">#bf_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_cust_count">#bf_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_shop_count">#bf_shop_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="zc_cust_visit_count">#zc_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="zc_shop_visit_count">#zc_shop_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="cs_cust_visit_count">#cs_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="cs_shop_visit_count">#cs_shop_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_dev_cust_count">#jh_dev_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="kt_cust_count">#kt_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="kt_cust_visit_count">#kt_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="custbfb">#custbfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shopbfb">#shopbfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bf_bfb">#bf_bfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_time">#update_time:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="last_update_time">#last_update_time:TIMESTAMP#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>
 <!--定时跟新表汇总统计报表-->
	<insert id="insertKonkaYwHzTjForTongJi" parameterClass="konkaYwHzTj">
	<![CDATA[insert into KONKA_YW_HZ_TJ (]]>
	  SELECT a.id user_id ,
       a.user_name ,
       a.dept_id,
       b.dept_id dept_one,
       b.dept_name dept_name_one,
       b.l4_dept_id dept_two,
       b.l4_dept_name dept_name_two,
       b.L5_DEPT_ID  dept_three,
       b.L5_DEPT_NAME dept_name_three,
       nvl(( select sum (plan_of_access_cust) from konka_mobile_visit_plan where add_user_id = a.id 
      <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0) jh_visit_cust_count,
          nvl(( select sum (plan_of_access_shop) from konka_mobile_visit_plan where add_user_id = a.id 
      <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0) jh_visit_shop_count,
       nvl(( select sum (plan_of_access) from konka_mobile_visit_plan where add_user_id = a.id
       <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0) jh_visit_count,
        nvl( ( SELECT  count(*) from    KONKA_MOBILE_CUST_VISIT  where  add_user_id= a.id and  report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0) bf_count,
        nvl( ( SELECT  sum(decode(detail.R3_CODE,null,0,1))
         FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit
       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0) bf_cust_count,
       nvl( ( SELECT  sum(decode(detail.shop_id,null,0,1))
         FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit
       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0) bf_shop_count,
         nvl(( SELECT  sum(decode(detail.R3_CODE,null,0,1))
        FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail
       LEFT JOIN
          KONKA_MOBILE_CUST_VISIT visit
       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type =1 
          <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ),0) zc_cust_visit_count,
            nvl(( SELECT  sum(decode(detail.shop_id,null,0,1))  FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail
       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type =1 
          <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ),0) zc_shop_visit_count,
        nvl( ( SELECT sum(decode(detail.R3_CODE,null,0,1))  FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail
       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type =2
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty> 
       ),0) cs_cust_visit_count,
             nvl( ( SELECT  sum(decode(detail.shop_id,null,0,1))  FROM                 KONKA_MOBILE_CUST_VISIT_DETAIL detail       LEFT JOIN         
              KONKA_MOBILE_CUST_VISIT visit       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type =2
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty> 
       ),0) cs_shop_visit_count,
       nvl((SELECT sum (plan_of_dev_cust) FROM konka_mobile_visit_plan WHERE add_user_id = a.id 
        <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ),0) jh_dev_cust_count,
       nvl(( select count (*) from KONKA_R3_SHOP_DEV g where a.ID =YWY_USER_ID 
        <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ),0) kt_cust_count,
       nvl( ( SELECT sum(decode(detail.R3_CODE,null,0,1))  FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail
       LEFT JOIN    KONKA_MOBILE_CUST_VISIT visit    ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id  and  visit.report_type =3 
        <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0) kt_cust_visit_count,
        
        decode(nvl(( select sum (plan_of_access_cust) from konka_mobile_visit_plan where add_user_id = a.id 
	      <isNotEmpty prepend=" and " property="map.begin_time">
	      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
	       </isNotEmpty>
	        <isNotEmpty prepend=" and " property="map.end_time">
	      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
	       </isNotEmpty>
       ), 0),0,'-0.5',
       nvl( ( SELECT  sum(decode(detail.R3_CODE,null,0,1))
        FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit
       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0)/
       nvl(( select sum (plan_of_access_cust) from konka_mobile_visit_plan where add_user_id = a.id 
      <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0)
       )CUSTBFB,
        decode(nvl(( select sum (plan_of_access_shop) from konka_mobile_visit_plan where add_user_id = a.id 
	      <isNotEmpty prepend=" and " property="map.begin_time">
	      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
	       </isNotEmpty>
	        <isNotEmpty prepend=" and " property="map.end_time">
	      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
	       </isNotEmpty>
       ), 0),0,'-0.5',
       nvl( ( SELECT  sum(decode(detail.shop_id,null,0,1))
       FROM    KONKA_MOBILE_CUST_VISIT_DETAIL detail       LEFT JOIN          KONKA_MOBILE_CUST_VISIT visit
       ON visit.VISIT_ID = detail.VISIT_ID where  visit.add_user_id= a.id and  visit.report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(visit.begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0)/
       nvl(( select sum (plan_of_access_shop) from konka_mobile_visit_plan where add_user_id = a.id 
      <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0)
       )SHOPBFB,
       decode(nvl(( select sum (plan_of_access) from konka_mobile_visit_plan where add_user_id = a.id
       <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0),0,'-0.5',
       nvl( ( SELECT  count(*) from    KONKA_MOBILE_CUST_VISIT  where  add_user_id= a.id and  report_type in( '1', '2', '3')
         <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
        ),0)/
       nvl(( select sum (plan_of_access) from konka_mobile_visit_plan where add_user_id = a.id
       <isNotEmpty prepend=" and " property="map.begin_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') >= #map.begin_time#]]>
       </isNotEmpty>
        <isNotEmpty prepend=" and " property="map.end_time">
      <![CDATA[  to_char(plan_begin_date,'yyyy-MM-dd hh24:mi:ss') <= #map.end_time#]]>
       </isNotEmpty>
       ), 0)
       )BF_BFB,
       #map.update_time# update_time,
       #map.last_update_time# last_update_time
       from konka_pe_prod_user  a left join V_ORG_OF_DEPT b on a.dept_id= b.CUR_DEPT_ID 
       where a.cust_id is null and a.is_del=0
       <isNotEmpty prepend=" and " property="map.user_id">
			a.id=#map.user_id:DECIMAL#
		</isNotEmpty>
		
	  <![CDATA[)]]>
	</insert>
	<update id="updateKonkaYwHzTj" parameterClass="KonkaYwHzTj">
		update KONKA_YW_HZ_TJ
		<dynamic prepend="set">
			<isNotNull prepend="," property="user_id">USER_ID = #user_id:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="user_name">USER_NAME = #user_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_id">DEPT_ID = #dept_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_one">DEPT_ONE = #dept_one:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_one">DEPT_NAME_ONE = #dept_name_one:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_two">DEPT_TWO = #dept_two:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_two">DEPT_NAME_TWO = #dept_name_two:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="dept_three">DEPT_THREE = #dept_three:BIGINT#</isNotNull>
			<isNotNull prepend="," property="dept_name_three">DEPT_NAME_THREE = #dept_name_three:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="jh_visit_cust_count">JH_VISIT_CUST_COUNT = #jh_visit_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_visit_shop_count">JH_VISIT_SHOP_COUNT = #jh_visit_shop_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_visit_count">JH_VISIT_COUNT = #jh_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_count">BF_COUNT = #bf_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_cust_count">BF_CUST_COUNT = #bf_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="bf_shop_count">BF_SHOP_COUNT = #bf_shop_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="zc_cust_visit_count">ZC_CUST_VISIT_COUNT = #zc_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="zc_shop_visit_count">ZC_SHOP_VISIT_COUNT = #zc_shop_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="cs_cust_visit_count">CS_CUST_VISIT_COUNT = #cs_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="cs_shop_visit_count">CS_SHOP_VISIT_COUNT = #cs_shop_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="jh_dev_cust_count">JH_DEV_CUST_COUNT = #jh_dev_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="kt_cust_count">KT_CUST_COUNT = #kt_cust_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="kt_cust_visit_count">KT_CUST_VISIT_COUNT = #kt_cust_visit_count:INTEGER#</isNotNull>
			<isNotNull prepend="," property="custbfb">CUSTBFB = #custbfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="shopbfb">SHOPBFB = #shopbfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="bf_bfb">BF_BFB = #bf_bfb:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="update_time">UPDATE_TIME = #update_time:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="last_update_time">LAST_UPDATE_TIME = #last_update_time:TIMESTAMP#</isNotNull>
		</dynamic>
		where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</update>
	
	<delete id="deleteKonkaYwHzTj" parameterClass="KonkaYwHzTj">
		delete from KONKA_YW_HZ_TJ where 1=1
		<isNotEmpty prepend=" and " property="map.begin_time"><![CDATA[UPDATE_TIME >= to_data(#map.begin_time:VARCHAR#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.end_time"><![CDATA[UPDATE_TIME <= to_data(#map.end_time:VARCHAR#,'yyyy-MM-dd hh24:mi:ss') ]]></isNotEmpty>
	</delete>

</sqlMap>