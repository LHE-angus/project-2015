<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CONSUMER_INFO">

	<typeAlias alias="consumerInfo" type="com.ebiz.mmt.domain.ConsumerInfo" />

	<cacheModel id="oneDayCache" type="OSCACHE">
		<flushInterval hours="24" />
		<flushOnExecute statement="insertConsumerInfo" />
		<flushOnExecute statement="updateConsumerInfo" />
		<flushOnExecute statement="deleteConsumerInfo" />
	</cacheModel>

	<resultMap id="consumerInfoResultForList" class="consumerInfo">
		<result column="ID" property="id" jdbcType="BIGINT" />
		<result column="CONSUMER_NAME" property="consumer_name" jdbcType="VARCHAR" />
		<result column="CONSUMER_PHONE" property="consumer_phone" jdbcType="VARCHAR" />
		<result column="CONSUMER_ADDR" property="consumer_addr" jdbcType="VARCHAR" />
		<result column="MASTER_CODE" property="master_code" jdbcType="VARCHAR" />
		<result column="DATA_SOURCE" property="data_source" jdbcType="SMALLINT" />
		<result column="REPORT_NAME" property="report_name" jdbcType="VARCHAR" />
		<result column="REPORT_ID" property="report_id" jdbcType="BIGINT" />
		<result column="SALE_DATE" property="sale_date" jdbcType="TIMESTAMP" />
		<result column="REPORT_DATE" property="report_date" jdbcType="TIMESTAMP" />
		<result column="NUM" property="num" jdbcType="BIGINT" />
		<result column="PRICE" property="price" jdbcType="DECIMAL" />
		<result column="CUST_ID" property="cust_id" jdbcType="BIGINT" />
		<result column="LINK_ID" property="link_id" jdbcType="BIGINT" />
		<result column="IS_DEL" property="is_del" jdbcType="SMALLINT" />
		<result column="CONSUMER_P_INDEX" property="consumer_p_index" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="consumerInfoResultForList" class="consumerInfo">
		<result column="CONSUMER_NAME" property="consumer_name" jdbcType="VARCHAR" />
		<result column="CONSUMER_PHONE" property="consumer_phone" jdbcType="VARCHAR" />
		<result column="CONSUMER_ADDR" property="consumer_addr" jdbcType="VARCHAR" />
		<result column="MASTER_CODE" property="master_code" jdbcType="VARCHAR" />
		<result column="NUM" property="num" jdbcType="BIGINT" />
		<result column="PRICE" property="price" jdbcType="DECIMAL" />
		<result column="IS_DEL" property="is_del" jdbcType="SMALLINT" />
	</resultMap>

	<resultMap id="consumerInfoResult" class="consumerInfo" extends="consumerInfoResultForList">
	</resultMap>

	<sql id="sf-consumerInfo">
		<isNotEmpty prepend=" and " property="id">ID = #id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="consumer_name">CONSUMER_NAME = #consumer_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="consumer_phone">CONSUMER_PHONE = #consumer_phone:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="consumer_addr">CONSUMER_ADDR = #consumer_addr:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="master_code">MASTER_CODE = #master_code:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="data_source">DATA_SOURCE = #data_source:SMALLINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_name">REPORT_NAME = #report_name:VARCHAR#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_id">REPORT_ID = #report_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="sale_date">SALE_DATE = #sale_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotEmpty>
		<isNotEmpty prepend=" and " property="num">NUM = #num:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="price">PRICE = #price:DECIMAL#</isNotEmpty>
		<isNotEmpty prepend=" and " property="cust_id">CUST_ID = #cust_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="link_id">LINK_ID = #link_id:BIGINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="is_del">IS_DEL = #is_del:SMALLINT#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.consumer_name_like">CONSUMER_NAME like '%'||#map.consumer_name_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.report_name_like">REPORT_NAME like '%'||#map.report_name_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.consumer_phone_like">CONSUMER_PHONE like '%'||#map.consumer_phone_like:VARCHAR#||'%'</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.date_begin"><![CDATA[to_char(SALE_DATE,'yyyy-MM-dd') >= #map.date_begin:VARCHAR#]]></isNotEmpty>
		<isNotEmpty prepend=" and " property="map.date_end"><![CDATA[to_char(SALE_DATE,'yyyy-MM-dd') <= #map.date_end:VARCHAR#]]></isNotEmpty>
	</sql>

	<select id="selectConsumerInfo" resultMap="consumerInfoResult" parameterClass="consumerInfo" cacheModel="oneDayCache">
		select * from CONSUMER_INFO where 1 = 1
		<include refid="sf-consumerInfo" />
	</select>

	<select id="selectConsumerInfoList" resultMap="consumerInfoResultForList" parameterClass="consumerInfo" cacheModel="oneDayCache">
		<isNotEmpty property="row.count">
			<![CDATA[ select * from ( ]]>
		</isNotEmpty>
		select * from CONSUMER_INFO where 1 = 1
		<include refid="sf-consumerInfo" />
		<!-- order by ID asc -->
		<isNotEmpty property="row.count">
			<![CDATA[ ) where rownum <= #row.count# ]]>
		</isNotEmpty>
	</select>

	<select id="selectConsumerInfoCount" resultClass="long" parameterClass="consumerInfo" cacheModel="oneDayCache">
		select count(*) from CONSUMER_INFO where 1 = 1
		<include refid="sf-consumerInfo" />
	</select>

	<select id="selectConsumerInfoPaginatedList" resultMap="consumerInfoResult" parameterClass="consumerInfo" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select * from CONSUMER_INFO where 1 = 1
		<include refid="sf-consumerInfo" />
		<!-- order by ID asc -->
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 客户端-消费者信息库统计数 -->
	<select id="selectConsumerInfoAllCount" resultClass="long" parameterClass="consumerInfo" cacheModel="oneDayCache">
		select count(1) from (
			select consumer_phone,CONSUMER_NAME,CONSUMER_ADDR,MASTER_CODE,IS_DEL from CONSUMER_INFO
			where 1=1
			<include refid="sf-consumerInfo" />
			group by consumer_phone,CONSUMER_NAME,CONSUMER_ADDR,MASTER_CODE,IS_DEL
		)
	</select>
	
	<!-- 客户端-消费者信息库查询 -->
	<select id="selectConsumerInfoForList" resultMap="consumerInfoResultForList" parameterClass="consumerInfo" cacheModel="oneDayCache">
		<![CDATA[ select * from ( select t_.*, rownum rn_ from ( ]]>
		select consumer_phone,CONSUMER_NAME,CONSUMER_ADDR,MASTER_CODE,IS_DEL,sum(num) num,sum(price) price from CONSUMER_INFO
			where 1=1
			<include refid="sf-consumerInfo" />
			group by consumer_phone,CONSUMER_NAME,CONSUMER_ADDR,MASTER_CODE,IS_DEL
			order by CONSUMER_NAME
		<![CDATA[ ) t_ where rownum <= (#row.first# + #row.count#)) where rn_ >= (#row.first# + 1) ]]>
	</select>
	
	<!-- 客户端-消费者信息库查看详情 -->
	<select id="selectConsumerInfoDetails" resultClass="java.util.HashMap" parameterClass="consumerInfo" cacheModel="oneDayCache">
		select m.MODEL_NAME,m.REPORT_NAME,m.SALE_DATE,m.num,m.all_price from KONKA_MOBILE_SAIL_DATA m 
			left join (select link_id from CONSUMER_INFO where data_source=0 
			<isNotEmpty prepend=" and " property="consumer_phone">
			    consumer_phone = #consumer_phone#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="consumer_name">
			    consumer_name = #consumer_name#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="cust_id">
			    cust_id = #cust_id#
			</isNotEmpty>
			) c on m.id=c.link_id
			where c.link_id is not null
		union
		select jbg.goods_name,jb.ADD_USER_NAME,jb.opr_date,jbd.num,jbd.money from J_BILL_DETAILS jbd 
			left join J_BILL jb on jbd.bill_id=jb.bill_id
			left join J_BASE_GOODS jbg on jbg.goods_id=jbd.goods_id
			left join (select link_id from CONSUMER_INFO where data_source=1
			<isNotEmpty prepend=" and " property="consumer_phone">
			    consumer_phone = #consumer_phone#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="consumer_name">
			    consumer_name = #consumer_name#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="cust_id">
			    cust_id = #cust_id#
			</isNotEmpty>
			) c on jb.bill_id=c.link_id
			where c.link_id is not null
	</select>

	<insert id="insertConsumerInfo" parameterClass="consumerInfo">
		<selectKey resultClass="long" keyProperty="id">select SEQ_CONSUMER_INFO.nextval as id from dual </selectKey>
		<![CDATA[insert into CONSUMER_INFO (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">ID</isNotNull>	
			<isNotNull prepend="," property="consumer_name">CONSUMER_NAME</isNotNull>	
			<isNotNull prepend="," property="consumer_phone">CONSUMER_PHONE</isNotNull>	
			<isNotNull prepend="," property="consumer_addr">CONSUMER_ADDR</isNotNull>	
			<isNotNull prepend="," property="master_code">MASTER_CODE</isNotNull>	
			<isNotNull prepend="," property="data_source">DATA_SOURCE</isNotNull>	
			<isNotNull prepend="," property="report_name">REPORT_NAME</isNotNull>	
			<isNotNull prepend="," property="report_id">REPORT_ID</isNotNull>	
			<isNotNull prepend="," property="sale_date">SALE_DATE</isNotNull>	
			<isNotNull prepend="," property="report_date">REPORT_DATE</isNotNull>	
			<isNotNull prepend="," property="num">NUM</isNotNull>	
			<isNotNull prepend="," property="price">PRICE</isNotNull>	
			<isNotNull prepend="," property="cust_id">CUST_ID</isNotNull>	
			<isNotNull prepend="," property="link_id">LINK_ID</isNotNull>	
			<isNotNull prepend="," property="is_del">IS_DEL</isNotNull>	
			<isNotNull prepend="," property="consumer_p_index">CONSUMER_P_INDEX</isNotNull>	
		</dynamic>
		<![CDATA[) values (]]>
		<dynamic prepend=" ">
			<isNotNull prepend="," property="id">#id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="consumer_name">#consumer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="consumer_phone">#consumer_phone:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="consumer_addr">#consumer_addr:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="master_code">#master_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="data_source">#data_source:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="report_name">#report_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_id">#report_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="sale_date">#sale_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="report_date">#report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="num">#num:BIGINT#</isNotNull>
			<isNotNull prepend="," property="price">#price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="cust_id">#cust_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="link_id">#link_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="is_del">#is_del:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="consumer_p_index">#consumer_p_index:VARCHAR#</isNotNull>
		</dynamic>
		<![CDATA[)]]>
	</insert>

	<update id="updateConsumerInfo" parameterClass="ConsumerInfo">
		update CONSUMER_INFO
		<dynamic prepend="set">
			<isNotNull prepend="," property="id">ID = #id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="consumer_name">CONSUMER_NAME = #consumer_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="consumer_phone">CONSUMER_PHONE = #consumer_phone:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="consumer_addr">CONSUMER_ADDR = #consumer_addr:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="master_code">MASTER_CODE = #master_code:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="data_source">DATA_SOURCE = #data_source:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="report_name">REPORT_NAME = #report_name:VARCHAR#</isNotNull>
			<isNotNull prepend="," property="report_id">REPORT_ID = #report_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="sale_date">SALE_DATE = #sale_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="report_date">REPORT_DATE = #report_date:TIMESTAMP#</isNotNull>
			<isNotNull prepend="," property="num">NUM = #num:BIGINT#</isNotNull>
			<isNotNull prepend="," property="price">PRICE = #price:DECIMAL#</isNotNull>
			<isNotNull prepend="," property="cust_id">CUST_ID = #cust_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="link_id">LINK_ID = #link_id:BIGINT#</isNotNull>
			<isNotNull prepend="," property="is_del">IS_DEL = #is_del:SMALLINT#</isNotNull>
			<isNotNull prepend="," property="consumer_p_index">CONSUMER_P_INDEX = #consumer_p_index:VARCHAR#</isNotNull>
		</dynamic>
		where 1=1
		<isNotEmpty prepend=" and " property="id">ID = #id#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.phone">CONSUMER_PHONE = #consumer_phone#</isNotEmpty>
		<isNotEmpty prepend=" and " property="map.update">
		    LINK_ID = #link_id# and data_source=1
		</isNotEmpty>
	</update>

	<delete id="deleteConsumerInfo" parameterClass="ConsumerInfo">
		delete from CONSUMER_INFO where
		<isNotEmpty prepend=" " property="id">ID = #id#</isNotEmpty>
		<isEmpty prepend=" " property="id">
			<isNotEmpty prepend=" " property="map.pks">
				ID in
				<iterate close=")" open="(" conjunction="," property="map.pks">#map.pks[]#</iterate>
			</isNotEmpty>
		</isEmpty>
	</delete>

</sqlMap>